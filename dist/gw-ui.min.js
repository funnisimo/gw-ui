!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,i,s){"use strict";function e(t){if(t&&t.__esModule)return t;var i=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var e=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(i,s,e.get?e:{enumerable:!0,get:function(){return t[s]}})}})),i.default=t,Object.freeze(i)}var h=e(i),r=e(s);h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class o{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t){}}class n extends o{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t){this.actor.drawStatus(t)}}class l extends o{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t){this.item.drawStatus(t)}}class a extends o{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t){this.cell.drawStatus(t)}}t.ActorEntry=n,t.CellEntry=a,t.EntryBase=o,t.Flavor=class{constructor(t){var i,s,e;this.text="",this.needsUpdate=!1,this.isPrompt=!1,this.overflow=!1,this.ui=t.ui,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,1),this.fg=h.color.from(null!==(i=t.fg)&&void 0!==i?i:"flavorText"),this.bg=h.color.from(null!==(s=t.bg)&&void 0!==s?s:"black"),this.promptFg=h.color.from(null!==(e=t.promptFg)&&void 0!==e?e:"flavorPrompt")}showText(t){this.text=h.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!1,this.draw()}clear(){this.text="",this.needsUpdate=!0,this.isPrompt=!1,this.draw()}showPrompt(t){this.text=h.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!0,this.draw()}draw(t=!1){if(!t&&!this.needsUpdate)return!1;const i=this.ui.buffer,s=this.isPrompt?this.fg:this.promptFg,e=i.wrapText(this.bounds.x,this.bounds.y,this.bounds.width,this.text,s,this.bg);return this.overflow=e!==this.bounds.y+1,this.ui.render(),this.needsUpdate=!1,!0}getFlavorText(t,i,s,e){const o=t.cell(i,s);let n,l="";const a=!e||e.isAnyKindOfVisible(i,s),u=!e||e.isDirectlyVisible(i,s),f=!!e&&e.isRevealed(i,s),c=!!e&&e.isMagicMapped(i,s);let d;if(u)d="you see";else if(a)d="you sense";else if(f)d="you remember";else{if(!c)return"";d="you expect to see"}const g=o.hasActor()?t.actorAt(i,s):null,b=o.hasItem()?t.itemAt(i,s):null,p=o.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let y=!1;g?(l=g.getFlavor({color:!1,article:!0,action:!0}),y=!0):b&&(l=b.getFlavor({color:!1,article:!0}),y=!0);let w=p?" in ":" on ";const x=o.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,m=o.depthTile(r.flags.Depth.SURFACE),E=o.depthTile(r.flags.Depth.LIQUID);let Y="";if(m){y&&(y=!1,l+=" on "),m.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(w=" over "),Y=m.getFlavor()+w}let v="";E&&(v=E.getFlavor()+" covering ",y&&(y=!1,l+=" in ")),y&&(y=!1,l+=" on ");let _=x.getFlavor({article:!0});return n=h.text.apply("§intro§ §text§.",{intro:d,text:l+Y+v+_}),n}},t.ItemEntry=l,t.Messages=class{constructor(t){const i=t.ui.buffer;this.bounds=new h.xy.Bounds(t.x,t.y,Math.min(t.width||i.width,i.width-t.x),Math.min(t.height||i.height,i.height-t.y)),this.cache=new h.message.MessageCache({width:this.bounds.width,length:i.height}),this.ui=t.ui,this.bg=h.color.from(t.bg||"black"),this.fg=h.color.from(t.fg||"white")}contains(t){return this.bounds.contains(t.x,t.y)}get needsUpdate(){return this.cache.needsUpdate}get buffer(){return this.ui.buffer}draw(t=!1){if(!t&&!this.cache.needsUpdate)return!1;let i;const s=h.color.make(),e=this.bounds.y<10;return this.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",0,this.bg),this.cache.forEach(((t,r,o)=>{if(o>=this.bounds.height)return;i=s,i.copy(this.fg),r&&(i.mix(this.bg,50),i.mix(this.bg,75*o/(2*this.bounds.height)));const n=e?this.bounds.height-o-1:o,l=this.toBufferY(n);h.text.eachChar(t,((t,e,h,n)=>{const a=this.toBufferX(n);e&&i!==e&&r&&(e.mix(this.bg,50),e.mix(this.bg,75*o/(2*this.bounds.height))),i=e||s,this.buffer.draw(a,l,t,i,this.bg)}))})),this.cache.needsUpdate=!1,!0}toBufferY(t){return this.bounds.y+t}toBufferX(t){return this.bounds.x+t}async showArchive(){let t,i,s,e=0,h=0;if(this.cache.forEach((()=>++h)),h<=this.bounds.height)return;const r=this.bounds.y<10,o=this.ui.startDialog();for(t=0;t<=1;t++){for(s=!1,e=t?h:this.bounds.height;t?e>=this.bounds.height:e<=h;e+=t?-1:1)this.ui.resetDialogBuffer(o),this.cache.forEach(((t,s,h)=>{if(h>=e||h>=o.height)return;const n=r?h:o.height-h-1;i=Math.floor(50*(e-h)/e);const l=this.fg.clone().mix(this.bg,i);o.wrapText(this.toBufferX(0),n,this.bounds.width,t,l,this.bg)})),o.render(),!s&&await this.ui.loop.pause(t?15:45)&&(s=!0,e=t?this.bounds.height+1:h-1);if(!t){const t=r?0:o.height-1,i=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,this.buffer.width-8);o.wrapText(i,t,8,"--DONE--",this.bg,this.fg),o.render(),await this.ui.loop.waitForAck()}}this.ui.finishDialog(),this.cache.confirmAll(),this.cache.needsUpdate=!0}},t.Sidebar=class{constructor(t){this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.mixer=new h.sprite.Mixer,this.currentY=0,this.follow=null,this.highlight=null,this.currentEntry=null,this.ui=t.ui,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.bg=h.color.from(t.bg||"black"),this.fg=h.color.from(t.fg||"purple")}get buffer(){return this.ui.buffer}contains(t){return this.bounds.contains(t.x,t.y)}toInnerY(t){return h.clamp(t-this.bounds.top,0,this.bounds.height)}updateHighlight(t){return this.contains(t)?this.highlightRow(this.toInnerY(t.y)):(this.clearHighlight(),!1)}highlightRow(t){const i=h.clamp(t,0,this.bounds.height);return this.highlight=null,this.entries.forEach((t=>{t.sidebarY<=i&&-1!==t.sidebarY&&(this.highlight=t)})),!!this.highlight&&(this.highlight.highlight=!0,!0)}clearHighlight(){this.highlight=null}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((i,s)=>{const e=t.cell(i,s);e.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(e)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new n(t)}_makeItemEntry(t){return new l(t)}_makeCellEntry(t){return new a(t)}_getPriority(t,i,s,e){return e?e.isDirectlyVisible(i,s)?1:e.isAnyKindOfVisible(i,s)?2:e.isRevealed(i,s)?3:-1:t.cell(i,s).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(!!this.highlight||t.priority>2)}_addActorEntry(t,i,s,e,r){const o=this._getPriority(i,t.x,t.y,r);if(o<0)return!1;const n=this._makeActorEntry(t);return n.dist=h.xy.distanceBetween(s,e,t.x,t.y),n.priority=t.isPlayer()?0:o,this.entries.push(n),!0}_addItemEntry(t,i,s,e,r){const o=this._getPriority(i,t.x,t.y,r);if(o<0)return!1;const n=this._makeItemEntry(t);return n.dist=h.xy.distanceBetween(s,e,t.x,t.y),n.priority=o,this.entries.push(n),!0}_addCellEntry(t,i,s,e,r){const o=this._getPriority(i,t.x,t.y,r);if(o<0)return!1;const n=this._makeCellEntry(t);return n.dist=h.xy.distanceBetween(s,e,t.x,t.y),n.priority=o,this.entries.push(n),!0}findEntries(t,i,s,e){if(t===this.lastMap&&i===this.lastX&&s===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=i,this.lastY=s,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const o=h.x,n=h.y;r[o][n]||this._addActorEntry(h,t,i,s,e)&&(r[o][n]=1)})),t.eachItem((h=>{const o=h.x,n=h.y;r[o][n]||this._addItemEntry(h,t,i,s,e)&&(r[o][n]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,i,s,e)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,i)=>t.priority!=i.priority?t.priority-i.priority:t.dist-i.dist)),h.grid.free(r)}clearSidebar(){this.ui.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg)}drawFor(t){return this.draw(t.memory||t.map,t.x,t.y,t.fov)}draw(t,i,s,e){if(arguments.length<3){if(this.follow)return this.drawFor(this.follow);throw new Error("Not following a subject - map, cx, cy required.")}this.updateCellCache(t),this.findEntries(t,i,s,e),this.clearSidebar(),this.currentY=this.bounds.y,this.entries.forEach((t=>t.sidebarY=-1));for(let t=0;t<this.entries.length&&this.currentY<this.bounds.bottom;++t)this.currentEntry=this.entries[t],this.currentEntry.sidebarY=this.currentY,this.currentEntry.draw(this),++this.currentY;return this.currentEntry=null,!0}drawTitle(t,i,s){s=h.color.from(s||this.fg);const e=this._isDim(this.currentEntry)?s.clone().darken(50):s;this.buffer.drawSprite(this.bounds.x+1,this.currentY,t),this.buffer.wrapText(this.bounds.x+3,this.currentY,this.bounds.width-3,i,e),++this.currentY}drawTextLine(t,i){i=h.color.from(i||this.fg);const s=this._isDim(this.currentEntry)?i.clone().darken(50):i;this.buffer.drawText(this.bounds.x+3,this.currentY,t,s,this.bounds.width-3),++this.currentY}drawProgressBar(t,i,s,e,r,o){e=h.color.from(e||this.fg),r=h.color.from(r||e.clone().darken(50)),o=h.color.from(o||e.clone().lighten(50)),this._isDim(this.currentEntry)&&(r.darken(50),o.darken(50),e.darken(50)),this.buffer.fillRect(this.bounds.x+1,this.currentY,this.bounds.width-1,1,void 0,void 0,r);const n=Math.floor((this.bounds.width-1)*t/i);this.buffer.fillRect(this.bounds.x+1,this.currentY,n,1,void 0,void 0,e);const l=h.text.center(s,this.bounds.width);this.buffer.drawText(this.bounds.x+1,this.currentY,l,o,void 0,this.bounds.width-1),++this.currentY}},t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}startDialog(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||new h.canvas.Buffer(this.canvas),this.buffer.copy(t),this.buffer}resetDialogBuffer(t){const i=this.layers[this.layers.length-1]||this.canvas.buffer;t.copy(i)}finishDialog(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.render(),this.inDialog=this.layers.length>0)}},t.Viewport=class{constructor(t){this.center=!1,this.snap=!1,this.filter=null,this.offsetX=0,this.offsetY=0,this.lockX=!1,this.lockY=!1,this._follow=null,this.ui=t.ui,this.snap=t.snap||!1,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}get follow(){return this._follow}set follow(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight(),this.centerOn(t.x,t.y,t.map)),this._follow=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}contains(t){return this.bounds.contains(t.x,t.y)}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,i,s){this.center=!0,this.updateOffset({x:t,y:i},s)}updateOffset(t,i){const s=i||this.bounds;if(t&&h.xy.contains(s,t.x,t.y))if(this.snap){let i=this.offsetX,e=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<i||t.x>e)&&(i=this.offsetX=t.x-this.halfWidth(),e=i+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const o=Math.floor(this.bounds.width/5),n=Math.floor(this.bounds.height/5),l=Math.floor(this.bounds.width/3);i+o>=t.x?this.offsetX=Math.max(0,t.x+l-this.bounds.width):e-o<=t.x&&(this.offsetX=Math.min(t.x-l,s.width-this.bounds.width));const a=Math.floor(this.bounds.height/3);h+n>=t.y?this.offsetY=Math.max(0,t.y+a-this.bounds.height):r-n<=t.y&&(this.offsetY=Math.min(t.y-a,s.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&i&&(this.offsetX=h.clamp(this.offsetX,0,i.width-this.bounds.width)),this.lockY&&i&&(this.offsetY=h.clamp(this.offsetY,0,i.height-this.bounds.height))}drawFor(t){if(!t.map)throw new Error("No map!");return this.draw(t.memory||t.map,t.fov)}draw(t,i){if(!t){if(!this._follow)throw new Error("Either map or follow must be set.");return this.drawFor(this._follow)}this.updateOffset(this._follow,t);const s=new h.sprite.Mixer;for(let e=0;e<this.bounds.width;++e)for(let h=0;h<this.bounds.height;++h){const r=e+this.offsetX,o=h+this.offsetY;if(t.hasXY(r,o)){const e=t.cell(r,o);t.drawer.drawCell(s,e,i)}else s.blackOut();this.filter&&this.filter(s,r,o,t),this.ui.buffer.drawSprite(e+this.bounds.x,h+this.bounds.y,s)}return!0}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
