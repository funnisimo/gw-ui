!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,i,s){"use strict";function e(t){if(t&&t.__esModule)return t;var i=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var e=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(i,s,e.get?e:{enumerable:!0,get:function(){return t[s]}})}})),i.default=t,Object.freeze(i)}var h=e(i),n=e(s);class r{constructor(t,i){this.active=!1,this.hovered=!1,this.tabStop=!1,this.fg=4095,this.bg=-1,this.activeFg=4095,this.activeBg=-1,this.hoverFg=4095,this.hoverBg=-1,this.text="",this.align="left",this.valign="middle",this.bounds=new h.xy.Bounds(0,0,0,0),this.id=t,i&&this.init(i),this.reset()}init(t){void 0!==t.x&&(this.bounds.x=t.x),void 0!==t.y&&(this.bounds.y=t.y),void 0!==t.width&&(this.bounds.width=t.width),void 0!==t.height&&(this.bounds.height=t.height),t.text&&(this.text=t.text,this.bounds.width||(this.bounds.width=t.text.length),this.bounds.height||(this.bounds.height=1)),void 0!==t.fg&&(this.fg=t.fg,this.activeFg=t.fg,this.hoverFg=t.fg),void 0!==t.bg&&(this.bg=t.bg,this.activeBg=t.bg,this.hoverBg=t.bg),void 0!==t.activeFg&&(this.activeFg=t.activeFg,this.hoverFg=t.activeFg),void 0!==t.activeBg&&(this.activeBg=t.activeBg,this.hoverBg=t.activeBg),void 0!==t.hoverFg&&(this.hoverFg=t.hoverFg),void 0!==t.hoverBg&&(this.hoverBg=t.hoverBg),void 0!==t.tabStop&&(this.tabStop=t.tabStop),this.action=t.action||this.id}reset(){}contains(t,i){return 1==arguments.length?this.bounds.contains(t):this.bounds.contains(t,i)}mousemove(t,i){return this.hovered=this.contains(t),this.hovered}tick(t,i){}click(t,i){return!1}keypress(t,i){return!1}draw(t){const i=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,s=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg,e=h.text.length(this.text);(this.bounds.width>e||this.bounds.height>1)&&t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",i,s);let n=this.bounds.x;"center"==this.align?n+=Math.floor((this.bounds.width-e)/2):"right"==this.align&&(n+=this.bounds.width-e);let r=this.bounds.y;this.bounds.height>1&&("middle"==this.valign?r+=Math.floor(this.bounds.height/2):"bottom"==this.valign&&(r+=this.bounds.height-1)),t.drawText(n,r,this.text,i,s)}}class o extends r{constructor(t,i){super(t,i)}init(t){if(this.text=t.text||"",t.wrap)t.width=t.wrap,this.lines=h.text.splitIntoLines(this.text,t.width);else{const i=h.text.length(this.text);t.width=t.width||i||10,t.width<i&&(t.text=h.text.truncate(this.text,t.width)),this.lines=[this.text]}t.height=Math.max(this.lines.length,t.height||1),super.init(t)}draw(t){const i=this.active?this.activeFg:this.fg,s=this.active?this.activeBg:this.bg;this.lines.forEach(((e,h)=>{t.drawText(this.bounds.x,this.bounds.y+h,e,i,s,this.bounds.width)}))}}class a extends r{constructor(t,i){super(t,i)}init(t){var i;if(this.actionFn=null,!t.text)throw new Error("Must have text value in config for Button widget - "+this.id);t.tabStop=null===(i=t.tabStop)||void 0===i||i,super.init(t),t.actionFn&&(this.actionFn=t.actionFn)}click(t){if(!this.contains(t))return!1;let i;return i=this.actionFn?this.actionFn(t,this):this.parent.fireAction(this.action,this),!i||i.then((()=>!0))}keypress(t){if(!t.key)return!1;if("Enter"===t.key){const t=this.parent.fireAction(this.action,this);return!t||t.then((()=>!0))}return!1}}class d extends r{constructor(t,i){super(t,i)}init(t){var i,s,e;this.minLength=t.minLength||1,t.width||(t.width=Math.max(this.minLength,10)),t.tabStop=null===(i=t.tabStop)||void 0===i||i,super.init(t),this.default=t.default||"",this.errorFg=t.errorFg||this.fg,this.hint=t.hint||"",this.hintFg=t.hintFg||this.errorFg,this.numbersOnly=t.numbersOnly||!1,this.min=null!==(s=t.min)&&void 0!==s?s:Number.MIN_SAFE_INTEGER,this.max=null!==(e=t.max)&&void 0!==e?e:Number.MAX_SAFE_INTEGER,this.bounds.width||(this.hint&&(this.bounds.width=this.hint.length),this.default&&(this.bounds.width=this.default.length)),this.bounds.height||(this.bounds.height=1),this.reset()}reset(){this.text=this.default}isValid(){if(this.numbersOnly){const t=Number.parseInt(this.text);return!(void 0!==this.min&&t<this.min)&&(!(void 0!==this.max&&t>this.max)&&t>0)}return this.text.length>=this.minLength}get value(){return this.numbersOnly?Number.parseInt(this.text):this.text}keypress(t,i){const s=this.numbersOnly?["0","9"]:[" ","~"];if(!t.key)return!1;if("Enter"===t.key&&this.isValid()){const t=this.parent.fireAction(this.action,this);return!t||t.then((()=>!0))}return"Delete"==t.key||"Backspace"==t.key?(this.text.length&&(this.text=h.text.spliceRaw(this.text,this.text.length-1,1)),!0):!(t.key.length>1)&&(t.key>=s[0]&&t.key<=s[1]&&this.text.length<this.bounds.width&&(this.text+=t.key),!0)}draw(t){const i=this.bounds.x,s=this.bounds.y,e=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,h=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;if(t.fillRect(i,s,this.bounds.width,1," ",e,h),!this.text.length&&this.hint&&this.hint.length)t.drawText(i,s,this.hint,this.hintFg);else{const h=this.isValid()?e:this.errorFg;t.drawText(i,s,this.text,h)}}}class l{constructor(t,i){this.title="",this.titleFg=4095,this.bg=2457,this.borderBg=2457,this.widgets=[],this.actionHandlers={},this.keypressHandlers={},this.clickHandlers={},this._activeWidget=null,this.result=null,this.done=!1,this.timers={},this.needsRedraw=!0,this.ui=t,this.id="DIALOG",this.bounds=new h.xy.Bounds(-1,-1,0,0),i&&this.init(i)}init(t){t.id&&(this.id=t.id),void 0!==t.x&&(this.bounds.x=t.x),void 0!==t.y&&(this.bounds.y=t.y),void 0!==t.height&&(this.bounds.height=t.height),void 0!==t.width&&(this.bounds.width=t.width),t.title&&(this.title=t.title),t.titleFg&&(this.titleFg=t.titleFg),t.bg&&(this.bg=t.bg,this.borderBg=t.bg),t.borderBg&&(this.borderBg=t.borderBg)}get activeWidget(){return this._activeWidget}set activeWidget(t){this._activeWidget&&(this._activeWidget.active=!1),this._activeWidget=t,this._activeWidget&&(this._activeWidget.active=!0)}contains(t){return this.bounds.contains(t)}requestRedraw(){this.needsRedraw=!0}setTimeout(t,i){this.timers[t]=i}clearTimeout(t){delete this.timers[t]}fireAction(t,i){const s=this.actionHandlers[t];if(s)return s(t,i,this)}setActionHandlers(t){this.actionHandlers=t}setKeyHandlers(t){this.keypressHandlers=t}setClickHandlers(t){this.clickHandlers=t}async show(){this.done=!1,this.widgets.forEach((t=>t.reset())),this.activeWidget=this.widgets.find((t=>t.tabStop))||null;const t=this.ui.startLayer();return await this.ui.loop.run({keypress:this.keypress.bind(this),mousemove:this.mousemove.bind(this),click:this.click.bind(this),tick:this.tick.bind(this),draw:()=>{this.draw(t),t.render()}},100),this.ui.finishLayer(),this.result}close(t){this.result=t,this.done=!0}widgetAt(t,i){return this.widgets.find((s=>s.contains(t,i)))||null}getWidget(t){return this.widgets.find((i=>i.id===t))||null}nextTabstop(){if(!this.activeWidget)return this.activeWidget=this.widgets.find((t=>t.tabStop))||null,!!this.activeWidget;const t=h.arrayNext(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.activeWidget=t,!0)}prevTabstop(){if(!this.activeWidget)return this.activeWidget=this.widgets.find((t=>t.tabStop))||null,!!this.activeWidget;const t=h.arrayPrev(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.activeWidget=t,!0)}tick(t){const i=t.dt;let s=[];Object.entries(this.timers).forEach((([t,e])=>{if((e-=i)<=0){delete this.timers[t];const i=this.fireAction(t,null);i&&i.then&&s.push(i)}else this.timers[t]=e}));for(let i of this.widgets){const e=i.tick(t,this.ui);e&&e.then&&s.push(e)}return s.length?Promise.all(s).then((()=>this.done)):this.done}mousemove(t){return this.widgets.forEach((i=>{i.mousemove(t,this.ui),i.hovered&&i.tabStop&&(this.activeWidget=i)})),this.done}click(t){this.mousemove(t);let i=null;if(this.activeWidget&&(i=this.clickHandlers[this.activeWidget.id]),!i&&this.contains(t)&&(i=this.clickHandlers[this.id]),i||(i=this.clickHandlers.click),i){const s=i(t,this.activeWidget,this);if(s&&s.then)return s.then((()=>this.done))}else if(this.activeWidget){const i=this.activeWidget.click(t,this.ui);if("boolean"!=typeof i)return i.then((()=>this.done))}return this.done}keypress(t){if(!t.key)return!1;const i=this.keypressHandlers[t.key]||t.code&&this.keypressHandlers[t.code]||this.keypressHandlers.keypress;if(i){const s=i(t,this.activeWidget,this);return s&&s.then?s.then((()=>this.done)):this.done}if(this.activeWidget){const i=this.activeWidget.keypress(t,this.ui);if("boolean"!=typeof i)return i.then((()=>this.done));"Tab"===t.key?this.nextTabstop():"TAB"===t.key&&this.prevTabstop()}return this.done}draw(t,i=!1){if(this.needsRedraw||i){if(this.borderBg?(t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.borderBg,this.borderBg),t.fillRect(this.bounds.x+1,this.bounds.y+1,this.bounds.width-2,this.bounds.height-2," ",this.bg,this.bg)):t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),this.title){const i=this.bounds.x+Math.floor((this.bounds.width-h.text.length(this.title))/2);t.drawText(i,this.bounds.y,this.title,this.titleFg)}this.widgets.forEach((i=>i.draw(t)))}}}class u{constructor(t,i={}){this.nextY=0,this.padY=1,this.padX=1,this.padX=i.padX||i.pad||1,this.padY=i.padY||i.pad||1,this.nextY=this.padY,this.dialog=new l(t,i)}with(t){let i=t.bounds.y;i>=0&&i<this.padY?i=this.nextY:i<0&&i>-this.padY&&(i=-this.padY),t.bounds.y=i;let s=t.bounds.x;return s>=0&&s<this.padX?s=this.padX:s<0&&s>-this.padX&&(s=-this.padX),t.bounds.x=s,this.addWidget(t),this.nextY=Math.max(this.nextY,t.bounds.bottom+1+this.padY),this}center(){const t=this.dialog.ui.buffer,i=this.dialog.bounds;return i.x=Math.floor((t.width-i.width)/2),i.y=Math.floor((t.height-i.height)/2),this}place(t,i){const s=this.dialog.bounds;return s.x=t,s.y=i,this}done(){return this.dialog.widgets.forEach((t=>{t.bounds.x+=this.dialog.bounds.x,t.bounds.y+=this.dialog.bounds.y})),this.dialog}addWidget(t){t.parent=this.dialog;const i=this.dialog.bounds,s=t.bounds.x,e=t.bounds.y;return s>=0?i.width=Math.max(i.width,t.bounds.width+s+this.padX):t.bounds.x=i.width-t.bounds.width+s,e>=0?i.height=Math.max(i.height,t.bounds.height+e+this.padY):t.bounds.y=i.height-t.bounds.height+e,this.dialog.widgets.push(t),t}}function c(t,i={}){return new u(t,i)}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class g{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,i){return 0}}class f extends g{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,i){return this.actor.drawStatus(t,i)}}class b extends g{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,i){return this.item.drawStatus(t,i)}}class p extends g{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,i){return this.cell.drawStatus(t,i)}}class w{constructor(t){this.hovered=!1,this.x=999,this.text=t}get width(){return this.text.length}}class y extends w{constructor(t,i){super(t),this.fn=i}activate(t,i){return this.fn(t,i,this)}}class x extends w{constructor(t,i,s,e){super(s),this.buttons=[],this.parent=null,this.menu=t,this.parent=i,this.text=s,this.bounds=new h.xy.Bounds(0,0,0,0),Object.entries(e).forEach((([t,i])=>{this.addButton(t,i)}))}addButton(t,i){let s;s="function"==typeof i?new y(t,i):"string"==typeof i?new y(t,(()=>{const t=this.menu.parent.fireAction(i,this.menu);return!t||!t.then||t.then((()=>!0))})):new x(this.menu,this,t,i),this.buttons.push(s),++this.bounds.height,this.bounds.width=Math.max(this.bounds.width,t.length+2)}setBounds(t,i,s,e){const h=i+e,n=t.width;if(this.bounds.width<n-h)this.bounds.x=h;else{if(!(this.bounds.width<i))throw new Error("Menu does not fit - too wide.");this.bounds.x=i-this.bounds.width}const r=t.height;if(this.bounds.height<=r-s)this.bounds.y=s;else{if(!(this.bounds.height<r))throw new Error("Menu does not fit - too tall.");this.bounds.y=r-this.bounds.height-1}}contains(t){return this.bounds.contains(t)}buttonAt(t){const i=t.y-this.bounds.y;return this.buttons[i]||null}draw(t){const i=this.bounds.width,s=this.bounds.height,e=this.bounds.x;let h=this.bounds.y;t.fillRect(e,h,i,s,0,0,this.menu.dropBg),this.buttons.forEach((i=>{t.drawText(e+1,h,i.text,i.hovered?this.menu.activeFg:this.menu.dropFg,i.hovered?this.menu.activeBg:this.menu.dropBg),++h})),this.parent&&this.parent.draw(t)}}async function v(t,i,s){const e=s.startLayer();let h=i;await s.loop.run({Escape:()=>!0,mousemove:i=>{if(!h)return!0;let e=h;for(;e&&!e.contains(i);)e=e.parent;if(e){h=e;const t=h.buttonAt(i);t&&(h.buttons.forEach((t=>{t.hovered=!1})),t.hovered=!0,t instanceof x&&(t.buttons.forEach((t=>{t.hovered=!1})),t.setBounds(s.buffer,h.bounds.x,i.y,h.bounds.width),h=t))}else if(t.contains(i)){t.parent&&t.parent.requestRedraw();const s=t.getButtonAt(i.x,i.y);s instanceof x?(h.hovered=!1,h=s,h.hovered=!0):(h=null,s&&(s.hovered=!0))}return!h},click:async i=>{if(!h)return!0;if(!h.contains(i))return t.clearHighlight(),!0;const e=h.buttonAt(i);return!e||(e instanceof y?e.activate(i,s):void 0)},draw:()=>{h&&(s.resetLayerBuffer(e),h.draw(e),t.draw(e),e.render())}}),s.finishLayer(),t.clearHighlight()}t.ActionButton=y,t.ActorEntry=f,t.Button=w,t.CellEntry=p,t.DropDownButton=x,t.EntryBase=g,t.Flavor=class extends o{constructor(t,i){super(t,i)}init(t){t.fg=t.fg||"flavorText",t.bg=t.bg||"black",super.init(t),this.promptFg=h.color.from(t.promptFg||"flavorPrompt"),this.overflow=t.overflow||!1,this.isPrompt=!1}showText(t){this.text=h.text.capitalize(t);h.text.length(this.text)>this.bounds.width?(this.lines=h.text.splitIntoLines(this.text,this.bounds.width),!this.overflow&&this.lines.length>this.bounds.height&&(1==this.bounds.height?(this.text=h.text.truncate(this.text,this.bounds.width),this.lines=[this.text]):this.lines.length=this.bounds.height)):this.lines=[this.text],this.isPrompt=!1,this.parent&&this.parent.requestRedraw()}clear(){this.text="",this.lines=[""],this.isPrompt=!1,this.parent&&this.parent.requestRedraw()}showPrompt(t){this.showText(t),this.isPrompt=!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),super.draw(t)}getFlavorText(t,i,s,e){const r=t.cell(i,s);let o,a="";const d=!e||e.isAnyKindOfVisible(i,s),l=!e||e.isDirectlyVisible(i,s),u=!!e&&e.isRevealed(i,s),c=!!e&&e.isMagicMapped(i,s);let g;if(l)g="you see";else if(d)g="you sense";else if(u)g="you remember";else{if(!c)return"";g="you expect to see"}const f=r.hasActor()?t.actorAt(i,s):null,b=r.hasItem()?t.itemAt(i,s):null,p=r.hasTileFlag(n.flags.Tile.T_STAND_IN_TILE);let w=!1;f?(a=f.getFlavor({color:!1,article:!0,action:!0}),w=!0):b&&(a=b.getFlavor({color:!1,article:!0}),w=!0);let y=p?" in ":" on ";const x=r.depthTile(n.flags.Depth.GROUND)||n.tile.tiles.NULL,v=r.depthTile(n.flags.Depth.SURFACE),m=r.depthTile(n.flags.Depth.LIQUID);let k="";if(v){w&&(w=!1,a+=" on "),v.hasTileFlag(n.flags.Tile.T_BRIDGE)&&(y=" over "),k=v.getFlavor()+y}let E="";m&&(E=m.getFlavor()+" covering ",w&&(w=!1,a+=" in ")),w&&(w=!1,a+=" on ");let B=x.getFlavor({article:!0});return o=h.text.apply("§intro§ §text§.",{intro:g,text:a+k+E+B}),o}},t.ItemEntry=b,t.Menu=class extends r{constructor(t,i){super(t,i)}init(t){var i,s;t.fg=null!==(i=t.fg)&&void 0!==i?i:"black",t.bg=null!==(s=t.bg)&&void 0!==s?s:"light_gray",t.height=t.height||1,super.init(t),this.dropFg=h.color.from(t.dropFg||this.fg),this.dropBg=h.color.from(t.dropBg||this.bg),this.buttons=[],this.separator=t.separator||" | ",this.lead=t.lead||" ",Object.entries(t.buttons).forEach((([t,i])=>{this._addButton(t,i)})),t.separator&&(this.separator=t.separator),void 0!==t.lead&&(this.lead=t.lead?t.lead:"")}mousemove(t){if(this.buttons.forEach((t=>{t.hovered&&(t.hovered=!1)})),this.bounds.contains(t)){let i=null;return this.buttons.forEach((s=>{s.hovered=!1,s.x<t.x&&(i=s)})),i&&(i.hovered=!0),this.parent&&this.parent.requestRedraw(),!0}return!1}clearHighlight(){this.buttons.forEach((t=>{t.hovered=!1})),this.parent&&this.parent.requestRedraw()}getButtonAt(t,i){return h.arrayFindRight(this.buttons,(i=>i.x<t))||null}async click(t,i){if(this.bounds.contains(t)){let s=this.getButtonAt(t.x,t.y);return!!s&&(s instanceof x?await v(this,s,i):s instanceof y&&await s.activate(t,i),!0)}return!1}_addButton(t,i){const s=this.buttons.reduce(((t,i)=>t+i.text.length+this.separator.length),this.lead.length+this.bounds.x);if(s+t.length+2>this.bounds.width)throw new Error("Button makes menu too wide :"+t);let e;if("function"==typeof i)e=new y(t,i);else{const h=new x(this,null,t,i);h.bounds.x=s,this.bounds.y?h.bounds.y=this.bounds.y-h.bounds.height:h.bounds.y=this.bounds.y+1,e=h}e.x=s,this.buttons.push(e)}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,1,0,0,this.bg);let i=this.bounds.x;const s=this.bounds.y;return t.drawText(i,s,this.lead,this.fg),this.buttons.forEach((e=>{const h=e.hovered?this.activeFg:this.fg,n=e.hovered?this.activeBg:this.bg;t.drawText(e.x,s,e.text,h,n),i=e.x+e.text.length,t.drawText(i,s,this.separator,this.fg)})),!0}},t.Messages=class extends r{constructor(t,i){super(t,i)}init(t){if(super.init(t),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:t.length||40,match:(t,i)=>(this.parent&&this.parent.requestRedraw(),!0)})}click(t,i){return!!this.contains(t)&&this.showArchive(i).then((()=>!0))}draw(t){const i=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),this.cache.forEach(((s,e,h)=>{if(h>=this.bounds.height)return;const n=(i?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,n,s,this.fg),e&&t.mix(this.bg,50,this.bounds.x,n,this.bounds.width,1)})),!0}async showArchive(t){let i,s,e=0,n=this.cache.length;if(n<=this.bounds.height)return!1;const r=this.bounds.y<10,o=t.startLayer(),a=h.color.from(this.fg);for(n=Math.min(n,r?o.height-this.bounds.top:this.bounds.bottom+1),i=0;i<=1;i++){s=!1;const h=i?-1:1,d=i?n:this.bounds.height,l=i?this.bounds.height+h+1:n+h;for(let n=d;n!=l;n+=h){const d=r?this.bounds.y+n-1:this.bounds.bottom-n+1,u=r?this.bounds.y:this.bounds.bottom,c=r?-1:1;t.resetLayerBuffer(o),o.fillRect(this.bounds.x,Math.min(d,u),this.bounds.width,n," ",this.bg,this.bg),this.cache.forEach(((t,i,s)=>{const h=d+s*c;if(r){if(h<u)return}else if(h>u)return;e=Math.floor(50*s/n);const l=a.clone().mix(this.bg,e);o.drawText(this.bounds.x,h,t,l,this.bg)})),o.render(),s||await t.loop.pause(i?15:45)&&(s=!0,n=l-2*h)}if(!i){const i=r?0:o.height-1,s=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,o.width-8);o.wrapText(s,i,8,"--DONE--",this.bg,this.fg),o.render(),await t.loop.waitForAck()}}return t.finishLayer(),this.cache.confirmAll(),this.parent&&this.parent.requestRedraw(),!0}},t.Sidebar=class extends r{constructor(t,i){super(t,i),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}init(t){t.fg=t.fg||"purple",t.bg=t.bg||"black",super.init(t)}reset(){super.reset(),this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((i=>i.sidebarY<=t.y&&-1!==i.sidebarY))||null}mousemove(t,i){return super.mousemove(t,i),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const i=this.highlight;return this.highlight=null,this.entries.forEach((i=>{i.sidebarY<=t&&-1!==i.sidebarY&&(this.highlight=i)})),this.parent&&this.parent.requestRedraw(),this.highlight!==i}clearHighlight(){const t=!!this.highlight;return this.highlight=null,this.parent&&this.parent.requestRedraw(),t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(n.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((i,s)=>{const e=t.cell(i,s);e.hasEntityFlag(n.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(e)})),t.clearMapFlag(n.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new f(t)}_makeItemEntry(t){return new b(t)}_makeCellEntry(t){return new p(t)}_getPriority(t,i,s,e){return e?e.isDirectlyVisible(i,s)?1:e.isAnyKindOfVisible(i,s)?2:e.isRevealed(i,s)?3:-1:t.cell(i,s).hasCellFlag(n.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,i,s,e,n){const r=this._getPriority(i,t.x,t.y,n);if(r<0)return!1;const o=this._makeActorEntry(t);return o.dist=h.xy.distanceBetween(s,e,t.x,t.y),o.priority=t.isPlayer()?0:r,this.entries.push(o),!0}_addItemEntry(t,i,s,e,n){const r=this._getPriority(i,t.x,t.y,n);if(r<0)return!1;const o=this._makeItemEntry(t);return o.dist=h.xy.distanceBetween(s,e,t.x,t.y),o.priority=r,this.entries.push(o),!0}_addCellEntry(t,i,s,e,n){const r=this._getPriority(i,t.x,t.y,n);if(r<0)return!1;const o=this._makeCellEntry(t);return o.dist=h.xy.distanceBetween(s,e,t.x,t.y),o.priority=r,this.entries.push(o),!0}findEntries(t,i,s,e){if(t===this.lastMap&&i===this.lastX&&s===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=i,this.lastY=s,this.entries.length=0;const n=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const r=h.x,o=h.y;n[r][o]||this._addActorEntry(h,t,i,s,e)&&(n[r][o]=1)})),t.eachItem((h=>{const r=h.x,o=h.y;n[r][o]||this._addItemEntry(h,t,i,s,e)&&(n[r][o]=1)})),this.cellCache.forEach((h=>{n[h.x][h.y]||this._addCellEntry(h,t,i,s,e)&&(n[h.x][h.y]=1)})),this.entries.sort(((t,i)=>t.priority!=i.priority?t.priority-i.priority:t.dist-i.dist)),h.grid.free(n)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,i,s,e){return this.updateCellCache(t),this.findEntries(t,i,s,e),this.parent&&this.parent.requestRedraw(),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg),this.entries.forEach((t=>t.sidebarY=-1));const i=this.bounds.clone();let s;for(let e=0;e<this.entries.length&&i.height>0;++e){s=this.entries[e],s.sidebarY=i.y;let h=s.draw(t,i);this._isDim(s)&&t.mix(this.bg,50,i.x,i.y,i.width,h),h&&(++h,i.y+=h,i.height-=h)}return!0}},t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}get baseBuffer(){return this.layers[this.layers.length-1]||this.canvas.buffer}get canvasBuffer(){return this.canvas.buffer}startLayer(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||new h.canvas.Buffer(this.canvas),this.buffer.copy(t),this.buffer}resetLayerBuffer(t){const i=this.layers[this.layers.length-1]||this.canvas.buffer;t.copy(i)}finishLayer(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.render(),this.inDialog=this.layers.length>0)}async fadeTo(t="black",i=1e3){t=h.color.from(t);const s=this.startLayer();let e=0,n=0;for(;n<i;)n+=32,await this.loop.pause(32)&&(n=i),e=Math.floor(100*n/i),this.resetLayerBuffer(s),s.mix(t,e),s.render();this.finishLayer()}async alert(t,i,s){"number"==typeof t&&(t={duration:t}),s&&(i=h.text.apply(i,s));const e=t.padX||t.pad||1,n=t.padY||t.pad||1;t.width=t.width||h.text.length(i)+2*e;const r={fg:t.fg,text:i,x:e,y:n,wrap:t.width-2*e};r.text=i,r.wrap=t.width;const a=c(this,t).with(new o("TEXT",r)).center().done();return a.setClickHandlers({click:()=>a.close(!0)}),a.setKeyHandlers({keypress:()=>a.close(!0)}),a.setActionHandlers({TIMEOUT:()=>a.close(!1)}),t.waitForAck||a.setTimeout("TIMEOUT",t.duration||3e3),await a.show()}async confirm(...t){let i,s,e=null;t.length<=2&&"string"==typeof t[0]?(i={},s=t[0],e=t[1]||null):(i=t[0],s=t[1],e=t[2]||null),e&&(s=h.text.apply(s,e));const n=i.padX||i.pad||1,r=i.padY||i.pad||1;i.width=i.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(s)+2*n);let d=i.width-2*n;const l={fg:i.fg,text:s,wrap:d},u=new o("TEXT",l);i.height=u.bounds.height+2*r+2,i.allowCancel=!1!==i.allowCancel,i.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},i.buttons||{}),"string"==typeof i.ok&&(i.ok={text:i.ok}),"string"==typeof i.cancel&&(i.cancel={text:i.cancel}),i.ok=i.ok||{},i.cancel=i.cancel||{};const g=Object.assign({},i.buttons,{text:"OK",y:-r,x:n},i.ok),f=Object.assign({},i.buttons,{text:"CANCEL",y:-r,x:-n},i.cancel),b=c(this,i).with(u).with(new a("OK",g));i.allowCancel&&b.with(new a("CANCEL",f));const p=b.center().done();return p.setClickHandlers({OK(){p.close(!0)},CANCEL(){p.close(!1)}}),p.setKeyHandlers({Escape(){p.close(!1)},Enter(){p.close(!0)}}),await p.show()}async getInputAt(t,i,s,e={}){e.width=s,e.x=t,e.y=i;const h=new d("INPUT",e),n=this.startLayer();return await this.loop.run({Enter:()=>!0,Escape:()=>(h.text="",!0),keypress:t=>{h.keypress(t,this)},draw(){h.draw(n),n.render()}}),this.finishLayer(),h.text}async inputBox(t,i,s){const e=t.padX||t.pad||1,n=t.padY||t.pad||1;s&&(i=h.text.apply(i,s)),t.width=t.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(i)+2*e);let r=t.width-2*e;const l={fg:t.fg,text:i,wrap:r},u=new o("TEXT",l);t.height=u.bounds.height+2*n+4,t.allowCancel=!1!==t.allowCancel,t.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},t.buttons||{}),"string"==typeof t.ok&&(t.ok={text:t.ok}),"string"==typeof t.cancel&&(t.cancel={text:t.cancel}),t.ok=t.ok||{},t.cancel=t.cancel||{};const g=Object.assign({},t.buttons,{text:"OK",y:-n,x:e},t.ok),f=Object.assign({},t.buttons,{text:"CANCEL",y:-n,x:-e},t.cancel);t.input=t.input||{},t.input.width=t.input.width||r,t.input.bg=t.input.bg||t.fg,t.input.fg=t.input.fg||t.bg;const b=new d("INPUT",t.input||{}),p=c(this,t).with(u).with(b).with(new a("OK",g));t.allowCancel&&p.with(new a("CANCEL",f));const w=p.center().done();return w.setClickHandlers({OK(){w.close(b.text)},CANCEL(){w.close("")}}),w.setKeyHandlers({Escape(){w.close("")},Enter(){w.close(b.text)}}),await w.show()}},t.Viewport=class extends r{constructor(t,i){super(t,i),this.offsetX=0,this.offsetY=0,this._subject=null}init(t){t.bg=t.bg||"black",super.init(t),this.snap=t.snap||!1,this.center=t.center||!1,this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}get subject(){return this._subject}set subject(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t,this.parent&&this.parent.requestRedraw()}set lock(t){this.lockX=t,this.lockY=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,i,s){this.center=!0,this.subject={x:i,y:s,map:t}}showMap(t,i=0,s=0){this.subject={x:i,y:s,map:t},this.offsetX=i,this.offsetY=s,this.center=!1,this.snap=!1}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,i=t.memory||t.map,s=i;if(t&&i.hasXY(t.x,t.y))if(this.snap){let i=this.offsetX,e=this.offsetX+this.bounds.width,h=this.offsetY,n=this.offsetY+this.bounds.height;(t.x<i||t.x>e)&&(i=this.offsetX=t.x-this.halfWidth(),e=i+this.bounds.width),(t.y<h||t.y>n)&&(h=this.offsetY=t.y-this.halfHeight(),n=h+this.bounds.height);const r=Math.floor(this.bounds.width/5),o=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);i+r>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):e-r<=t.x&&(this.offsetX=Math.min(t.x-a,s.width-this.bounds.width));const d=Math.floor(this.bounds.height/3);h+o>=t.y?this.offsetY=Math.max(0,t.y+d-this.bounds.height):n-o<=t.y&&(this.offsetY=Math.min(t.y-d,s.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&i&&(this.offsetX=h.clamp(this.offsetX,0,i.width-this.bounds.width)),this.lockY&&i&&(this.offsetY=h.clamp(this.offsetY,0,i.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this.bg),!this._subject)return!1;this.updateOffset();const i=this._subject.memory||this._subject.map,s=this._subject.fov,e=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let n=0;n<this.bounds.height;++n){const r=h+this.offsetX,o=n+this.offsetY;if(i.hasXY(r,o)){const t=i.cell(r,o);i.drawer.drawCell(e,t,s)}else e.draw(" ",this.bg,this.bg);this.filter&&this.filter(e,r,o,i),t.drawSprite(h+this.bounds.x,n+this.bounds.y,e)}return!0}},t.showDropDown=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
