!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU)}(this,(function(t,s){"use strict";function i(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var h=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(s,i,h.get?h:{enumerable:!0,get:function(){return t[i]}})}})),s.default=t,Object.freeze(s)}var h=i(s);t.Messages=class{constructor(t){const s=t.ui.buffer;this.bounds=new h.xy.Bounds(t.x,t.y,Math.min(t.width||s.width,s.width-t.x),Math.min(t.height||s.height,s.height-t.y)),this.cache=new h.message.MessageCache({width:this.bounds.width,length:s.height}),this.ui=t.ui,this.bg=h.color.from(t.bg||"black"),this.fg=h.color.from(t.fg||"white")}contains(t,s){return this.bounds.contains(t,s)}get needsUpdate(){return this.cache.needsUpdate}get buffer(){return this.ui.buffer}draw(t=!1){if(!t&&!this.cache.needsUpdate)return!1;let s;const i=h.color.make(),e=this.bounds.y<10;return this.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",0,this.bg),this.cache.forEach(((t,o,f)=>{if(f>=this.bounds.height)return;s=i,s.copy(this.fg),o&&(s.mix(this.bg,50),s.mix(this.bg,75*f/(2*this.bounds.height)));const n=e?this.bounds.height-f-1:f,r=this.toBufferY(n);h.text.eachChar(t,((t,h,e,n)=>{const u=this.toBufferX(n);h&&s!==h&&o&&(h.mix(this.bg,50),h.mix(this.bg,75*f/(2*this.bounds.height))),s=h||i,this.buffer.draw(u,r,t,s,this.bg)}))})),this.cache.needsUpdate=!1,!0}toBufferY(t){return this.bounds.y+t}toBufferX(t){return this.bounds.x+t}async showArchive(){let t,s,i,h=0,e=0;if(this.cache.forEach((()=>++e)),e<=this.bounds.height)return;const o=this.bounds.y<10,f=this.ui.startDialog();for(t=0;t<=1;t++){for(i=!1,h=t?e:this.bounds.height;t?h>=this.bounds.height:h<=e;h+=t?-1:1)this.ui.resetDialogBuffer(f),this.cache.forEach(((t,i,e)=>{if(e>=h||e>=f.height)return;const n=o?e:f.height-e-1;s=Math.floor(50*(h-e)/h);const r=this.fg.clone().mix(this.bg,s);f.wrapText(this.toBufferX(0),n,this.bounds.width,t,r,this.bg)})),f.render(),!i&&await this.ui.loop.pause(t?15:45)&&(i=!0,h=t?this.bounds.height+1:e-1);if(!t){const t=o?0:f.height-1,s=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,this.buffer.width-8);f.wrapText(s,t,8,"--DONE--",this.bg,this.fg),f.render(),await this.ui.loop.waitForAck()}}this.ui.finishDialog(),this.cache.confirmAll(),this.cache.needsUpdate=!0}},t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}startDialog(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||new h.canvas.Buffer(this.canvas),this.buffer.copy(t),this.buffer}resetDialogBuffer(t){const s=this.layers[this.layers.length-1]||this.canvas.buffer;t.copy(s)}finishDialog(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.render(),this.inDialog=this.layers.length>0)}},t.Viewport=class{constructor(t){this.follow=!1,this.snap=!1,this.filter=null,this.offsetX=0,this.offsetY=0,this.lockX=!1,this.lockY=!1,this.ui=t.ui,this.follow=t.follow||!1,this.snap=t.snap||!1,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}toMapX(t){return t+this.offsetX}toMapY(t){return t+this.offsetY}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}contains(t,s){return this.bounds.contains(t,s)}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}draw(t,s,i){if(!t)return!1;if(this.follow&&void 0!==s&&void 0!==i)this.offsetX=s-this.halfWidth(),this.offsetY=i-this.halfHeight();else if(this.snap&&void 0!==s&&void 0!==i){const h=this.offsetX,e=this.offsetX+this.bounds.width,o=this.offsetY,f=this.offsetY+this.bounds.height,n=Math.floor(this.bounds.width/5),r=Math.floor(this.bounds.height/5),u=Math.floor(this.bounds.width/3);h+n>=s?this.offsetX=Math.max(0,s+u-this.bounds.width):e-n<=s&&(this.offsetX=Math.min(s-u,t.width-this.bounds.width));const a=Math.floor(this.bounds.height/3);o+r>=i?this.offsetY=Math.max(0,i+a-this.bounds.height):f-r<=i&&(this.offsetY=Math.min(i-a,t.height-this.bounds.height))}else void 0!==s&&void 0!==i&&(this.offsetX=s,this.offsetY=i);this.lockX&&(this.offsetX=h.clamp(this.offsetX,0,t.width-this.bounds.width)),this.lockY&&(this.offsetY=h.clamp(this.offsetY,0,t.height-this.bounds.height));const e=new h.sprite.Mixer;for(let s=0;s<this.bounds.width;++s)for(let i=0;i<this.bounds.height;++i){const h=s+this.offsetX,o=i+this.offsetY;t.hasXY(h,o)?t.getAppearanceAt(h,o,e):e.blackOut(),this.filter&&this.filter(e,h,o,t),this.ui.buffer.drawSprite(s+this.bounds.x,i+this.bounds.y,e)}return!0}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
