!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,e){"use strict";function i(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(e){if("default"!==e){var i=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(s,e,i.get?i:{enumerable:!0,get:function(){return t[e]}})}})),s.default=t,Object.freeze(s)}var h=i(s),r=i(e);class n{constructor(t){this.priority=0,(t.startsWith(":")||t.startsWith("."))&&(t="*"+t),this.text=t,this.matchFn=this._parse(t)}_parse(t){const s=t.split(/ +/g).map((t=>t.trim())),e=[];for(let t=0;t<s.length;++t){let i=s[t];">"===i?(e.push(this._parentMatch()),++t,i=s[t]):t>0&&e.push(this._ancestorMatch()),e.push(this._matchElement(i))}return e.reduce(((t,s)=>s.bind(void 0,t)),h.TRUE)}_parentMatch(){return function(t,s){return!!s.parent&&t(s.parent)}}_ancestorMatch(){return function(t,s){let e=s.parent;for(;e;)if(t(e))return!0;return!1}}_matchElement(t){const s=[],e=new RegExp(/(?:(\w+|\*|\$)|#(\w+)|\.([^\.: ]+))|(?::(?:(?:not\(\.([^\)]+)\))|(?:not\(:([^\)]+)\))|([^\.: ]+)))/g,"g");let i=e.exec(t);for(;i;){if(i[1]){const t=this._matchTag(i[1]);t&&s.push(t)}else i[2]?s.push(this._matchId(i[2])):i[3]?s.push(this._matchClass(i[3])):i[4]?s.push(this._matchNot(this._matchClass(i[4]))):i[5]?s.push(this._matchNot(this._matchProp(i[5]))):s.push(this._matchProp(i[6]));i=e.exec(t)}return(t,e)=>!!s.every((t=>t(e)))&&t(e)}_matchTag(t){return"*"===t?null:"$"===t?(this.priority+=1e4,null):(this.priority+=10,s=>s.tag===t)}_matchClass(t){return this.priority+=100,s=>s.classes.includes(t)}_matchProp(t){return t.startsWith("first")?this._matchFirst():t.startsWith("last")?this._matchLast():"invalid"===t?this._matchNot(this._matchProp("valid")):"optional"===t?this._matchNot(this._matchProp("required")):"enabled"===t?this._matchNot(this._matchProp("disabled")):"unchecked"===t?this._matchNot(this._matchProp("checked")):(this.priority+=1,s=>!!s.prop(t))}_matchId(t){return this.priority+=1e3,s=>s.attr("id")===t}_matchFirst(){return this.priority+=1,t=>!!t.parent&&!!t.parent.children&&t.parent.children[0]===t}_matchLast(){return this.priority+=1,t=>!!t.parent&&(!!t.parent.children&&t.parent.children[t.parent.children.length-1]===t)}_matchNot(t){return s=>!t(s)}matches(t){return this.matchFn(t)}}class o{constructor(t="$",s){this._dirty=!1,this.selector=new n(t),s&&this.set(s),this._dirty=!1}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get fg(){return this._fg}get bg(){return this._bg}dim(t=25,s=!0,e=!1){return s&&(this._fg=h.color.from(this._fg).darken(t)),e&&(this._bg=h.color.from(this._bg).darken(t)),this}bright(t=25,s=!0,e=!1){return s&&(this._fg=h.color.from(this._fg).lighten(t)),e&&(this._bg=h.color.from(this._bg).lighten(t)),this}invert(){return[this._fg,this._bg]=[this._bg,this._fg],this}get align(){return this._align}get valign(){return this._valign}get(t){return this["_"+t]}set(t,s,e=!0){if("string"==typeof t){const e="_"+t;"string"==typeof s&&(s.match(/^[+-]?\d+$/)?s=Number.parseInt(s):"true"===s?s=!0:"false"===s&&(s=!1)),this[e]=s}else t instanceof o?(e=!(!s&&void 0!==s),Object.entries(t).forEach((([t,s])=>{"selector"!==t&&"_dirty"!==t&&(null!=s?this[t]=s:null===s&&this.unset(t))}))):(e=!(!s&&void 0!==s),Object.entries(t).forEach((([t,s])=>{null===s?this.unset(t):this.set(t,s,e)})));return this.dirty||(this.dirty=e),this}unset(t){return delete this[t.startsWith("_")?t:"_"+t],this.dirty=!0,this}clone(){const t=new this.constructor;return t.copy(this),t}copy(t){return Object.assign(this,t),this}}class a extends o{constructor(t){super(),this.sources=[],t&&(t.sort(((t,s)=>t.selector.priority-s.selector.priority)),this.sources=t),this.sources.forEach((t=>super.set(t))),this._dirty=!1}get dirty(){return this._dirty||this.sources.some((t=>t.dirty))}set dirty(t){this._dirty=t}}class d{constructor(t){this.rules=[],this._dirty=!0,void 0===t&&(t=l),t&&(this.rules=t.rules.slice())}get dirty(){return this._dirty}set dirty(t){this._dirty=t,this._dirty||this.rules.forEach((t=>t.dirty=!1))}add(t,s){if(t.includes(","))return t.split(",").map((t=>t.trim())).forEach((t=>this.add(t,s))),this;if(t.includes(" "))throw new Error("Hierarchical selectors not supported.");let e=new o(t,s);const i=this.rules.findIndex((t=>t.selector.text===e.selector.text));if(i>-1){const t=this.rules[i];t.set(e),e=t}else this.rules.push(e);return this.dirty=!0,this}get(t){return this.rules.find((s=>s.selector.text===t))||null}remove(t){const s=this.rules.findIndex((s=>s.selector.text===t));s>-1&&(this.rules.splice(s,1),this.dirty=!0)}computeFor(t){const s=this.rules.filter((s=>s.selector.matches(t))),e=t.style();return e&&s.push(e),e.dirty=!1,new a(s)}}const l=new d(null);l.add("*",{fg:"white",bg:-1,align:"left",valign:"top"});class u{constructor(t,s={}){this.tag="text",this.bounds=new h.xy.Bounds(0,0,0,1),this._depth=0,this.events={},this.children=[],this._style=new o,this._parent=null,this.classes=[],this._props={},this._attrs={},this.layer=t,this.bounds.x=s.x||0,this.bounds.y=s.y||0,this.bounds.width=s.width||0,this.bounds.height=s.height||1,s.tag&&(this.tag=s.tag),s.id&&(this.attr("id",s.id),this.attr("action",s.id)),void 0!==s.depth&&(this._depth=s.depth),this._style.set(s),s.class&&("string"==typeof s.class&&(s.class=s.class.split(/ +/g)),this.classes=s.class.map((t=>t.trim()))),s.tabStop&&this.prop("tabStop",!0),s.action,s.disabled&&this.prop("disabled",!0),s.hidden&&this.prop("hidden",!0),s.action&&this.attr("action",s.action),this.attr("action")&&this.on("click",((t,s,e)=>{const i=this._attrStr("action");return i&&this._bubbleEvent(i,s,e),!1})),this.layer.attach(this),this.updateStyle()}get depth(){return this._depth}set depth(t){this._depth=t,this.layer.sortWidgets()}get parent(){return this._parent}set parent(t){this.setParent(t)}setParent(t,s={}){this._parent&&this._parent._removeChild(this),this._parent=t,this._parent&&(this.depth=this._depth||this._parent.depth+1,this._parent._addChild(this,s))}pos(t,s){return void 0===t?this.bounds:("number"==typeof t?(this.bounds.x=t,this.bounds.y=s||0):(this.bounds.x=t.x,this.bounds.y=t.y),this.layer.needsDraw=!0,this)}text(t){return void 0===t?this._attrStr("text"):(this.attr("text",t),this)}attr(t,s){return void 0===s?this._attrs[t]:(this._attrs[t]=s,this)}_attrInt(t){const s=this._attrs[t]||0;return"number"==typeof s?s:"string"==typeof s?Number.parseInt(s):s?1:0}_attrStr(t){const s=this._attrs[t]||"";return"string"==typeof s?s:"number"==typeof s?""+s:s?"true":"false"}_attrBool(t){return!!this._attrs[t]}prop(t,s){if(void 0===s)return this._props[t];return this._props[t]!==s&&this._setProp(t,s),this}_setProp(t,s){this._props[t]=s,this.updateStyle()}_propInt(t){const s=this._props[t]||0;return"number"==typeof s?s:"string"==typeof s?Number.parseInt(s):s?1:0}_propStr(t){const s=this._props[t]||"";return"string"==typeof s?s:"number"==typeof s?""+s:s?"true":"false"}_propBool(t){return!!this._props[t]}toggleProp(t){const s=!!this._props[t];return this.prop(t,!s),this}incProp(t,s=1){let e=this.prop(t)||0;return"boolean"==typeof e?e=e?1:0:"string"==typeof e&&(e=Number.parseInt(e)||0),e+=s,this.prop(t,e),this}contains(...t){return this.bounds.contains(t[0],t[1])}style(t){return void 0===t?this._style:(this._style.set(t),this.updateStyle(),this)}addClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)||this.classes.push(t)})),this}removeClass(t){return t.split(/ +/g).forEach((t=>{h.arrayDelete(this.classes,t)})),this}hasClass(t){const s=t.split(/ +/g);return h.arrayIncludesAll(this.classes,s)}toggleClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)?h.arrayDelete(this.classes,t):this.classes.push(t)})),this}get focused(){return!!this.prop("focus")}focus(t=!1){return!!this.prop("focus")||(this.prop("focus",!0),this._fireEvent("focus",this,{reverse:t}))}blur(t=!1){return!!this.prop("focus")&&(this.prop("focus",!1),this._fireEvent("blur",this,{reverse:t}))}get hovered(){return!!this.prop("hover")}set hovered(t){this.prop("hover",t)}get hidden(){let t=this;for(;t;){if(t.prop("hidden"))return!0;t=t.parent}return!1}set hidden(t){this.prop("hidden",t)}updateStyle(){this._used=this.layer.styles.computeFor(this),this.layer.needsDraw=!0}draw(t){return!this.hidden&&this._draw(t)}_draw(t){return this._drawFill(t),!0}_drawFill(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this._used.bg,this._used.bg)}childAt(...t){return this.children.find((s=>s.contains(t[0],t[1])))||null}_addChild(t,s){let e=-1;if(s&&void 0!==s.beforeIndex&&(e=s.beforeIndex),t._parent&&t._parent!==this)throw new Error("Trying to add child that already has a parent.");return this.children.includes(t)||(e<0||e>=this.children.length?this.children.push(t):this.children.splice(e,0,t)),t._parent=this,this}_removeChild(t){if(!t._parent||t._parent!==this)throw new Error("Removing child that does not have this widget as parent.");return t._parent=null,h.arrayDelete(this.children,t),this}resize(t,s){return this.bounds.width=t||this.bounds.width,this.bounds.height=s||this.bounds.height,this.layer.needsDraw=!0,this}mouseenter(t,s){this.contains(t)&&(this.hovered||(this.hovered=!0,this._fireEvent("mouseenter",this,t),this._parent&&this._parent.mouseenter(t,s)))}mousemove(t){return!this.contains(t)||t.defaultPrevented||this.hidden?this.mouseleave(t):this._fireEvent("mousemove",this,t),!1}mouseleave(t){this.contains(t)||this.hovered&&(this.hovered=!1,this._fireEvent("mouseleave",this,t))}click(t){return!this.hidden&&this._fireEvent("click",this,t)}keypress(t){return this._fireEvent("keypress",this,t)}dir(t){return this._fireEvent("dir",this,t)}tick(t){return this._fireEvent("tick",this,t)}on(t,s){let e=this.events[t];return e||(e=this.events[t]=[]),e.includes(s)||e.push(s),this}off(t,s){let e=this.events[t];return e?(s?h.arrayDelete(e,s):e.length=0,this):this}_fireEvent(t,s,e){return(this.events[t]||[]).reduce(((i,h)=>h(t,s||this,e)||i),!1)}_bubbleEvent(t,s,e){let i=this;for(;i;){if(i._fireEvent(t,s,e))return!0;i=i.parent}return!1}}class c{constructor(t){this._left=0,this._top=0,this._colWidths=[],this._rowHeights=[],this._col=0,this._row=-1,this.target=t;const s=t.pos();this._left=s.x,this._top=s.y}cols(...t){return 0===t.length?this._colWidths:(2==t.length&&(t[0]=new Array(t[0]).fill(t[1])),Array.isArray(t[0])&&(this._colWidths=t[0]),this)}rows(...t){return 0===t.length?this._rowHeights:("number"==typeof t[0]&&(t[0]=new Array(t[0]).fill(t[1]||1)),Array.isArray(t[0])&&(this._rowHeights=t[0]),this)}col(t){return void 0===t&&(t=this._col),this._col=h.clamp(t,0,this._colWidths.length-1),this._setPos()}nextCol(){return this.col(this._col+1)}row(t){return void 0===t&&(t=this._row),this._row=h.clamp(t,0,this._rowHeights.length-1),this._setPos()}nextRow(){return this.row(this._row+1).col(0)}endRow(t){return t<=0||(this._rowHeights[this._row]=t),this}_setPos(){let t=this._left;for(let s=0;s<this._col;++s)t+=this._colWidths[s];let s=this._top;for(let t=0;t<this._row;++t)s+=this._rowHeights[t];return this.target.pos(t,s),this}}class p{constructor(t,s={}){this.id="",this.depth=0,this.hidden=!1,this.needsDraw=!0,this.result=void 0,this._attachOrder=[],this._depthOrder=[],this._focusWidget=null,this._hasTabStop=!1,this.timers=[],this._opts={x:0,y:0},this.ui=t,this.id=s.id||"root",this.depth=s.depth||0,this.hidden=void 0!==s.hidden&&s.hidden,this.buffer=t.canvas.buffer.clone(),this.styles=new d(t.styles),this.body=new u(this,{tag:"body",id:"BODY",depth:-1,width:this.buffer.width,height:this.buffer.height})}get width(){return this.ui.width}get height(){return this.ui.height}reset(){return this._opts={x:0,y:0},this}fg(t){return this._opts.fg=t,this}bg(t){return this._opts.bg=t,this}dim(t=25,s=!0,e=!1){return s&&(this._opts.fg=h.color.from(this._opts.fg||"white").darken(t)),e&&(this._opts.bg=h.color.from(this._opts.bg||"black").darken(t)),this}bright(t=25,s=!0,e=!1){return s&&(this._opts.fg=h.color.from(this._opts.fg||"white").lighten(t)),e&&(this._opts.bg=h.color.from(this._opts.bg||"black").lighten(t)),this}invert(){return[this._opts.fg,this._opts.bg]=[this._opts.bg,this._opts.fg],this}style(t){return Object.assign(this._opts,t),this}pos(t,s){return void 0===t?this._opts:(this._opts.x=h.clamp(t,0,this.width),this._opts.y=h.clamp(s,0,this.height),this)}moveTo(t,s){return this.pos(t,s)}move(t,s){return this._opts.x=h.clamp(this._opts.x+t,0,this.width),this._opts.y=h.clamp(this._opts.y+s,0,this.height),this}up(t=1){return this.move(0,-t)}down(t=1){return this.move(0,t)}left(t=1){return this.move(-t,0)}right(t=1){return this.move(t,0)}nextLine(t=1){return this.pos(0,this._opts.y+t)}prevLine(t=1){return this.pos(0,this._opts.y-t)}grid(){return new c(this)}clear(t){return this.body.children=[],this._depthOrder=[this.body],t?this.body.style().set("bg",t):this.body.style().unset("bg"),this}fadeTo(t,s){throw new Error("Method not implemented.")}sortWidgets(){return this._depthOrder.sort(((t,s)=>s.depth-t.depth)),this}attach(t){if(!this._attachOrder.includes(t)){const s=this._depthOrder.findIndex((s=>s.depth<=t.depth));s<0?this._depthOrder.push(t):this._depthOrder.splice(s,0,t),this._attachOrder.push(t),this.needsDraw=!0}return!t.parent&&t!==this.body&&this.body&&(t.setParent(this.body),this.needsDraw=!0),this._hasTabStop=this._hasTabStop||t._propBool("tabStop"),this}detach(t){return t.setParent(null),h.arrayDelete(this._depthOrder,t),h.arrayDelete(this._attachOrder,t),this._focusWidget===t&&(this._hasTabStop=this.nextTabStop()),this.needsDraw=!0,this}widgetAt(...t){return this._depthOrder.find((s=>s.contains(t[0],t[1])&&!s.hidden))||this.body}get focusWidget(){return this._focusWidget}setFocusWidget(t,s=!1){t!==this._focusWidget&&(this._focusWidget&&this._focusWidget.blur(s)||t&&t.focus(s)||(this._focusWidget=t))}getWidget(t){return this._depthOrder.find((s=>s.attr("id")===t))||null}nextTabStop(){if(!this.focusWidget)return this.setFocusWidget(this._attachOrder.find((t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden))||null),!!this.focusWidget;const t=h.arrayNext(this._attachOrder,this.focusWidget,(t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden));return!!t&&(this.setFocusWidget(t),!0)}prevTabStop(){if(!this.focusWidget)return this.setFocusWidget(this._attachOrder.find((t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden))||null),!!this.focusWidget;const t=h.arrayPrev(this._attachOrder,this.focusWidget,(t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden));return!!t&&(this.setFocusWidget(t,!0),!0)}on(t,s){return this.body.on(t,s),this}off(t,s){return this.body.off(t,s),this}mousemove(t){const s=this.widgetAt(t);return s.mouseenter(t,s),this._depthOrder.forEach((s=>{s.mousemove(t)})),!1}click(t){let s=this.widgetAt(t),e=!1;for(;s;){if(e||!s.prop("tabStop")||s.prop("disabled")||(this.setFocusWidget(s),e=!0),s.click(t))return!1;s=s.parent}return!1}keypress(t){if(!t.key)return!1;let s=this.focusWidget||this.body;for(;s;){if(s.keypress(t))return!1;s=s.parent}return t.defaultPrevented||("Tab"===t.key?this.nextTabStop():"TAB"===t.key&&this.prevTabStop()),!1}dir(t){let s=this.focusWidget||this.body;for(;s;){if(s.dir(t))return!1;s=s.parent}return!1}tick(t){const s=t.dt;let e=[];this.timers.forEach((t=>{t.time<=0||(t.time-=s,t.time<=0&&("string"==typeof t.action?e.push(this.body._fireEvent(t.action,this.body)):e.push(t.action())))}));for(let s of this._depthOrder)s.tick(t);return!1}draw(){if(this._hasTabStop&&!this._focusWidget&&this.nextTabStop(),this.styles.dirty&&(this.needsDraw=!0,this._depthOrder.forEach((t=>t.updateStyle())),this.styles.dirty=!1),this.needsDraw){this.needsDraw=!1,this.ui.copyUIBuffer(this.buffer);for(let t=this._depthOrder.length-1;t>=0;--t){this._depthOrder[t].draw(this.buffer)}console.log("draw"),this.buffer.render()}}setTimeout(t,s){const e=this.timers.findIndex((t=>t.time<=0));e<0?this.timers.push({action:t,time:s}):this.timers[e]={action:t,time:s}}clearTimeout(t){const s=this.timers.find((s=>s.action===t));s&&(s.time=-1)}finish(t){this.result=t,this.ui.finishLayer(this)}}const g={};function f(t,s){g[t]=s}class b extends u{constructor(t,s){super(t,s),this._text="",this._lines=[],this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!s.height,this._fixedWidth=!!s.width,this.bounds.width=s.width||0,this.bounds.height=s.height||1,this.text(s.text)}text(t){if(void 0===t)return this._text;this._text=t;let s=this._fixedWidth?this.bounds.width:100;return this._lines=h.text.splitIntoLines(this._text,s),this._fixedWidth||(this.bounds.width=this._lines.reduce(((t,s)=>Math.max(t,h.text.length(s))),0)),this._fixedHeight?this._lines.length>this.bounds.height&&(this._lines.length=this.bounds.height):this.bounds.height=Math.max(1,this._lines.length),this.layer.needsDraw=!0,this}resize(t,s){return super.resize(t,s),this._fixedWidth=t>0,this._fixedHeight=s>0,this.text(this._text),this}_draw(t){this._drawFill(t);let s=0;return"bottom"===this._used.valign?s=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(s=Math.floor((this.bounds.height-this._lines.length)/2)),this._lines.forEach(((e,i)=>{t.drawText(this.bounds.x,this.bounds.y+i+s,e,this._used.fg,-1,this.bounds.width,this._used.align)})),!0}}f("text",((t,s)=>new b(t,s))),p.prototype.text=function(t,s={}){const e=Object.assign({},this._opts,s,{text:t}),i=new b(this,e);return s.parent&&i.setParent(s.parent,s),this.pos(i.bounds.x,i.bounds.bottom),i};class _ extends u{constructor(t,s){super(t,s),this.ascii=!1,(s.ascii||s.fg&&!1!==s.ascii)&&(this.ascii=!0)}contains(...t){return!1}_draw(t){const s=this.bounds.width,e=this.bounds.height,i=this.bounds.x,h=this.bounds.y,r=this.ascii;return y(t,i,h,s,e,this._used,r),!0}}function y(t,s,e,i,r,n,o){const a=n.fg,d=n.bg;if(o){for(let h=1;h<i;++h)t.draw(s+h,e,"-",a,d),t.draw(s+h,e+r-1,"-",a,d);for(let h=1;h<r;++h)t.draw(s,e+h,"|",a,d),t.draw(s+i-1,e+h,"|",a,d);t.draw(s,e,"+",a,d),t.draw(s+i-1,e,"+",a,d),t.draw(s,e+r-1,"+",a,d),t.draw(s+i-1,e+r-1,"+",a,d)}else h.xy.forBorder(s,e,i,r,((s,e)=>{t.draw(s,e," ",d,d)}))}f("border",((t,s)=>new _(t,s))),p.prototype.border=function(t){const s=Object.assign({},this._opts,t),e=new _(this,s);return t.parent&&e.setParent(t.parent,t),e};class m extends b{constructor(t,s){super(t,(s.text=s.text||"",s.action=s.action||s.id,s.tag=s.tag||"button",s))}keypress(t){if(!t.key)return!1;if("Enter"===t.key){const t=this._attrStr("action");return t&&t.length&&this._bubbleEvent(t,this),!0}return!1}click(t){if(!this.contains(t))return!1;const s=this._attrStr("action");return s&&s.length&&this._bubbleEvent(s,this),!0}}f("button",((t,s)=>new m(t,s)));class w extends _{constructor(t,s){super(t,(()=>{const t=Object.assign({},s);return t.height||(t.height=4),t.width||(t.width=4),t.tag=t.tag||"fieldset",t})()),this._fixedWidth=!1,this._fixedHeight=!1,this.legend=null,this._addLegend(s),this._fixedHeight=!!s.height,this._fixedWidth=!!s.width}_addLegend(t){return t.legend?(this.legend=new b(this.layer,{text:t.legend,x:this.bounds.x+2,y:this.bounds.y,depth:this.depth+1,tag:t.legendTag||w.default.legendTag,class:t.legendClass||w.default.legendClass}),this.bounds.width<this.legend.bounds.width+4&&(this.bounds.width=this.legend.bounds.width+4),this.legend.setParent(this),this.layer.attach(this.legend),this):this}_addChild(t,s={}){return t!==this.legend&&(t.bounds.x=this.bounds.x+2,this._fixedHeight||(t.bounds.y=this.bounds.bottom-2,this.bounds.height+=t.bounds.height),this._fixedWidth?t.bounds.width=Math.min(t.bounds.width,this.bounds.width-4):t.bounds.width>this.bounds.width-4&&(this.bounds.width=t.bounds.width+4)),super._addChild(t,s)}}w.default={legendTag:"legend",legendClass:"legend"},p.prototype.fieldset=function(t={}){const s=Object.assign({},this._opts,t),e=new w(this,s);return t.parent&&e.setParent(t.parent,t),e};class x extends u{constructor(t,s){super(t,(s.tag=s.tag||"ol",s)),this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!s.height,this._fixedWidth=!!s.width,this.prop("pad",s.pad||x.default.pad)}_addChild(t,s={}){return t.bounds.x=this.bounds.x+2,this._fixedHeight||(t.bounds.y=this.bounds.bottom-2,this.bounds.height+=t.bounds.height),this._fixedWidth?t.bounds.width=Math.min(t.bounds.width,this.bounds.width-4):t.bounds.width>this.bounds.width-4&&(this.bounds.width=t.bounds.width+4),super._addChild(t,s)}_draw(t){return this._drawFill(t),this.children.forEach(((s,e)=>{this._drawBulletFor(s,t,e)})),!0}_getBullet(t){return""+(t+1)}_drawBulletFor(t,s,e){const i=this._getBullet(e),h=this._attrInt("pad")+i.length,r=t.bounds.x-h,n=t.bounds.y;s.drawText(r,n,i,t._used.fg,t._used.bg,h)}}x.default={pad:1};class v extends x{constructor(t,s){super(t,(s.tag=s.tag||"ul",s)),this.prop("bullet",s.bullet||v.default.bullet),this.prop("pad",s.pad||v.default.pad)}_getBullet(t){return this._attrStr("bullet")}}v.default={bullet:"•",pad:1},p.prototype.ol=function(t={}){const s=Object.assign({},this._opts,t),e=new x(this,s);return t.parent&&e.setParent(t.parent,t),e},p.prototype.ul=function(t={}){const s=Object.assign({},this._opts,t),e=new v(this,s);return t.parent&&e.setParent(t.parent,t),e};class E extends b{constructor(t,s){super(t,(s.text=s.text||"",s.tag=s.tag||"input",s.action=s.action||s.id,s.width=s.width||s.maxLength||Math.max(s.minLength||0,10),s)),this.placeholder="",this.minLength=0,this.maxLength=0,this.numbersOnly=!1,this.min=0,this.max=0,this.default=this._text,s.placeholder&&(this.placeholder=s.placeholder),s.numbersOnly?(this.numbersOnly=!0,this.min=s.min||0,this.max=s.max||0):(this.minLength=s.minLength||0,this.maxLength=s.maxLength||0),s.required&&(this.attr("required",!0),this.prop("required",!0)),s.disabled&&(this.attr("disabled",!0),this.prop("disabled",!0)),this.prop("valid",this.isValid()),this.on("blur",(()=>this._fireEvent("change",this)))}reset(){this.text(this.default)}_setProp(t,s){super._setProp(t,s),this._props.valid=this.isValid()}isValid(){const t=this._text||"";if(this.numbersOnly){const s=Number.parseInt(t);return!(void 0!==this.min&&s<this.min)&&(!(void 0!==this.max&&s>this.max)&&s>0)}const s=Math.max(this.minLength,this.prop("required")?1:0);return t.length>=s&&(!this.maxLength||t.length<=this.maxLength)}keypress(t){if(!t.key)return!1;const s=this.numbersOnly?["0","9"]:[" ","~"];if("Enter"===t.key&&this.isValid()){const t=this._attrStr("action");return t&&t.length?this._fireEvent(t,this):this.layer.nextTabStop(),!0}return"Delete"==t.key||"Backspace"==t.key?(this._text.length&&(this.text(h.text.spliceRaw(this._text,this._text.length-1,1)),this._fireEvent("input",this)),!0):!(t.key.length>1)&&(t.key>=s[0]&&t.key<=s[1]&&(!this.maxLength||this._text.length<this.maxLength)&&(this.text(this._text+t.key),this._fireEvent("input",this)),!0)}text(t){return void 0===t?this._text:(super.text(t),this.prop("empty",0===this._text.length),this.prop("valid",this.isValid()),this)}_draw(t,s=!1){this._drawFill(t);let e=0;"bottom"===this._used.valign?e=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(e=Math.floor((this.bounds.height-this._lines.length)/2));let i=this._text;return this._text.length>this.bounds.width&&(i=this._text.slice(this._text.length-this.bounds.width)),t.drawText(this.bounds.x,this.bounds.y+e,i,this._used.fg,-1,this.bounds.width,this._used.align),!0}}f("input",((t,s)=>new E(t,s))),p.prototype.input=function(t){const s=Object.assign({},this._opts,t),e=new E(this,s);return t.parent&&e.setParent(t.parent,t),e};class T{constructor(t){this.format=h.IDENTITY,this.width=t.width||C.default.columnWidth,"function"==typeof t.format?this.format=t.format:t.format&&(this.format=h.text.compile(t.format)),this.header=t.header||"",this.headerTag=t.headerTag||C.default.headerTag,this.empty=t.empty||C.default.empty,this.dataTag=t.dataTag||C.default.dataTag}addHeader(t,s,e,i){const h=new b(t.layer,{x:s,y:e,class:t.classes,tag:t._attrStr("headerTag"),width:this.width,height:t.rowHeight,depth:t.depth+1,text:this.header});return h.prop("row",-1),h.prop("col",i),h.setParent(t),t.layer.attach(h),h}addData(t,s,e,i,h,r){let n;n=Array.isArray(s)?""+(s[h]||this.empty):"object"!=typeof s?""+s:this.format(s);const o=new k(t.layer,{text:n,x:e,y:i,class:t.classes,tag:t._attrStr("dataTag"),width:this.width,height:t.rowHeight,depth:t.depth+1});return o.prop(r%2==0?"even":"odd",!0),o.prop("row",r),o.prop("col",h),o.setParent(t),t.layer.attach(o),o}addEmpty(t,s,e,i,h){return this.addData(t,[],s,e,i,h)}}T.default={select:"row",hover:"select",tag:"datatable",headerTag:"th",dataTag:"td",border:"ascii"};class C extends u{constructor(t,s){super(t,(s.tag=s.tag||C.default.tag,s.tabStop=void 0===s.tabStop||s.tabStop,s)),this._data=[],this.columns=[],this.showHeader=!1,this.rowHeight=1,this.selectedRow=-1,this.selectedColumn=0,this.size=s.size||t.height,this.bounds.width=0,s.columns.forEach((t=>{const s=new T(t);this.columns.push(s),this.bounds.width+=s.width})),s.border?!0===s.border&&(s.border="ascii"):!1===s.border&&(s.border="none"),this.attr("border",s.border||C.default.border),this.rowHeight=s.rowHeight||1,this.bounds.height=1,this.attr("wrap",void 0===s.wrap?C.default.wrap:s.wrap),this.attr("header",void 0===s.header?C.default.header:s.header),this.attr("headerTag",s.headerTag||C.default.headerTag),this.attr("dataTag",s.dataTag||C.default.dataTag),this.attr("prefix",s.prefix||C.default.prefix),this.attr("select",s.select||C.default.select),this.attr("hover",s.hover||C.default.hover),this.data(s.data||[])}get selectedData(){if(!(this.selectedRow<0))return this._data[this.selectedRow]}select(t,s){if(!this._data||0==this._data.length)return this.selectedRow=this.selectedColumn=0,this;this.attr("wrap")&&((t<0||t>=this.columns.length)&&(t+=this.columns.length,t%=this.columns.length),(s<0||s>=this._data.length)&&(s+=this._data.length,s%=this._data.length)),t=this.selectedColumn=h.clamp(t,0,this.columns.length-1),s=this.selectedRow=h.clamp(s,0,this._data.length-1);const e=this._attrStr("select");return"none"===e?this.children.forEach((t=>{t.prop("selected",!1)})):"row"===e?this.children.forEach((t=>{const e=s==t.prop("row");t.prop("selected",e)})):"column"===e?this.children.forEach((s=>{const e=t==s.prop("col");s.prop("selected",e)})):"cell"===e&&this.children.forEach((e=>{const i=t==e.prop("col")&&s==e.prop("row");e.prop("selected",i)})),this._bubbleEvent("input",this,{row:s,col:t,data:this.selectedData}),this}selectNextRow(){return this.select(this.selectedColumn,this.selectedRow+1)}selectPrevRow(){return this.select(this.selectedColumn,this.selectedRow-1)}selectNextCol(){return this.select(this.selectedColumn+1,this.selectedRow)}selectPrevCol(){return this.select(this.selectedColumn-1,this.selectedRow)}blur(t){return this._bubbleEvent("change",this,{col:this.selectedColumn,row:this.selectedRow,data:this.selectedData}),super.blur(t)}data(t){if(!t)return this._data;this._data=t;for(let t=this.children.length-1;t>=0;--t){const s=this.children[t];s.tag!==this.attr("headerTag")&&this.layer.detach(s)}const s="none"!==this.attr("border")?1:0;let e=this.bounds.x+s,i=this.bounds.y+s;return this.attr("header")&&(this.columns.forEach(((t,h)=>{t.addHeader(this,e,i,h),e+=t.width+s})),i+=this.rowHeight+s),this._data.forEach(((t,h)=>{h>=this.size||(e=this.bounds.x+s,this.columns.forEach(((r,n)=>{r.addData(this,t,e,i,n,h),e+=r.width+s})),i+=this.rowHeight+s)})),0==this._data.length?(e=this.bounds.x+s,this.columns.forEach(((t,h)=>{t.addEmpty(this,e,i,h,0),e+=t.width+s})),i+=1,this.select(-1,-1)):this.select(0,0),this.bounds.height=i-this.bounds.y,this.bounds.width=e-this.bounds.x,this.updateStyle(),this}_draw(t){return this._drawFill(t),this.children.forEach((s=>{s.prop("row")>=this.size||"none"!==this.attr("border")&&y(t,s.bounds.x-1,s.bounds.y-1,s.bounds.width+2,s.bounds.height+2,this._used,"ascii"==this.attr("border"))})),!0}mouseenter(t,s){if(super.mouseenter(t,s),!this.hovered)return;const e=this.children.find((s=>s.contains(t)));if(e){const t=e._propInt("col"),s=e._propInt("row");if(t!==this.selectedColumn||s!==this.selectedRow){this.selectedColumn=t,this.selectedRow=s;let e=!1,i=this._attrStr("hover");"select"===i&&(i=this._attrStr("select"),e=!0),"none"===i?this.children.forEach((t=>{t.hovered=!1,e&&t.prop("selected",!1)})):"row"===i?this.children.forEach((t=>{const i=s==t.prop("row");t.hovered=i,e&&t.prop("selected",i)})):"column"===i?this.children.forEach((s=>{const i=t==s.prop("col");s.hovered=i,e&&s.prop("selected",i)})):"cell"===i&&this.children.forEach((i=>{const h=t==i.prop("col")&&s==i.prop("row");i.hovered=h,e&&i.prop("selected",h)})),this._bubbleEvent("input",this,{row:s,col:t,data:this.selectedData})}}}click(t){return!!this.contains(t)&&(this._bubbleEvent("change",this,{row:this.selectedRow,col:this.selectedColumn,data:this.selectedData}),!1)}keypress(t){return!!t.key&&("Enter"===t.key&&(this._bubbleEvent("change",this,{row:this.selectedRow,col:this.selectedColumn,data:this.selectedData}),!0))}dir(t){return!!t.dir&&(1==t.dir[1]?this.selectNextRow():-1==t.dir[1]&&this.selectPrevRow(),1==t.dir[0]?this.selectNextCol():-1==t.dir[0]&&this.selectPrevCol(),!0)}}C.default={columnWidth:10,header:!0,empty:"-",tag:"datatable",headerTag:"th",dataTag:"td",select:"cell",hover:"select",prefix:"none",border:"ascii",wrap:!0},f("datatable",((t,s)=>new C(t,s)));class k extends b{mouseleave(t){if(super.mouseleave(t),this.parent){const t=this.parent;"row"===t.attr("select")?this.hovered=this._propInt("row")===t.selectedRow:"column"===t.attr("select")&&(this.hovered=this._propInt("col")===t.selectedColumn)}}}p.prototype.datatable=function(t){const s=Object.assign({},this._opts,t),e=new C(this,s);return t.parent&&e.setParent(t.parent,t),e};class S extends C{constructor(t,s){super(t,(()=>{const t=s;return"none"!==s.border&&s.width&&(s.width-=2),t.columns=[Object.assign({},s)],s.header&&s.header.length||(t.header=!1),t})())}}f("list",((t,s)=>new S(t,s))),p.prototype.datalist=function(t){const s=Object.assign({},this._opts,t),e=new S(this,s);return t.parent&&e.setParent(t.parent,t),e};class O extends u{constructor(t,s){super(t,(s.tag=s.tag||O.default.tag,s.class=s.class||O.default.class,s)),Array.isArray(s.buttonClass)?this.attr("buttonClass",s.buttonClass.join(" ")):this.attr("buttonClass",s.buttonClass||O.default.buttonClass),this.attr("buttonTag",s.buttonTag||O.default.buttonTag),this.attr("marker",s.marker||O.default.marker),this._initButtons(s),this.bounds.height=this.children.length,this.on("mouseenter",((t,s,e)=>(this.children.forEach((t=>{t.contains(e)?t.expand():t.collapse()})),!0)))}_initButtons(t){this.children=[];const s=t.buttons,e=this._attrStr("marker"),i=Object.entries(s);this.bounds.width<=0&&(this.bounds.width=Math.max(t.minWidth||0,i.reduce(((t,[s,i])=>{const r=h.text.length(s)+("string"==typeof i?0:e.length);return Math.max(t,r)}),0))),i.forEach((([t,s],i)=>{const r={x:this.bounds.x,y:this.bounds.y+i,class:this._attrStr("buttonClass"),tag:this._attrStr("buttonTag"),width:this.bounds.width,height:1,depth:this.depth+1,buttons:s,text:t};"string"==typeof s?r.action=s:r.text=h.text.padEnd(t,this.bounds.width-e.length," ")+e;const n=new I(this.layer,r);n.setParent(this),n.on("mouseenter",(()=>(this._bubbleEvent("change",n),!1))),n.setParent(this)}))}collapse(){return this.children.forEach((t=>{t.collapse()})),this}}O.default={tag:"menu",class:"",buttonClass:"",buttonTag:"mi",marker:" ▶",minWidth:4};class I extends b{constructor(t,s){super(t,(s.tag=s.tag||"mi",s)),this.menu=null,this.tag=s.tag||"mi","string"!=typeof s.buttons&&(this.menu=this._initMenu(s),this.on("mouseenter",(()=>(this.menu.hidden=!1,this.menu._bubbleEvent("change",this),!0))),this.on("mouseleave",((t,s,e)=>{var i;return!!(null===(i=this.parent)||void 0===i?void 0:i.contains(e))&&(this.menu.hidden=!0,!0)})),this.on("click",(()=>!0)))}collapse(){return this.menu&&(this.menu.collapse(),this.menu.hidden=!0),this}expand(){return this.menu&&(this.menu.hidden=!1),this}_setMenuPos(t,s){t.x=this.bounds.x+this.bounds.width,t.y=this.bounds.y;const e=Object.keys(s.buttons).length;t.y+e>=this.layer.height&&(t.y=this.layer.height-e-1)}_initMenu(t){if("string"==typeof t.buttons)return null;const s={x:this.bounds.x+this.bounds.width,y:this.bounds.y,class:t.class,tag:t.tag||"mi",buttons:t.buttons,depth:this.depth+1};this._setMenuPos(s,t);const e=new O(this.layer,s);return e.hidden=!0,e.setParent(this),e}}f("menu",((t,s)=>new O(t,s))),p.prototype.menu=function(t){const s=Object.assign({},this._opts,t),e=new O(this,s);return t.parent&&e.setParent(t.parent,t),e};class M extends u{constructor(t,s){super(t,(s.tabStop=!0,s.tag=s.tag||"menu",s)),this._buttons=[],this._selectedIndex=-1,s.buttonClass?Array.isArray(s.buttonClass)?this.attr("buttonClass",s.buttonClass.join(" ")):this.attr("buttonClass",s.buttonClass):this.attr("buttonClass",M.default.buttonClass),this.attr("buttonTag",s.buttonTag||M.default.buttonTag),s.menuClass?Array.isArray(s.menuClass)?this.attr("menuClass",s.menuClass.join(" ")):this.attr("menuClass",s.menuClass):this.attr("menuClass",M.default.menuClass),this.attr("menuTag",s.menuTag||M.default.menuTag),this.attr("prefix",s.prefix||M.default.prefix),this.attr("separator",s.separator||M.default.separator),this._initButtons(s),this.on("click",this._buttonClick.bind(this))}get selectedIndex(){return this._selectedIndex}set selectedIndex(t){this._selectedIndex>=0&&this._buttons[this._selectedIndex].prop("focus",!1).collapse(),this._selectedIndex=t,t>=0&&t<this._buttons.length?this._buttons[t].prop("focus",!0).expand():this._selectedIndex=-1}get selectedButton(){return this._buttons[this._selectedIndex]}focus(t=!1){return this.selectedIndex=t?this._buttons.length-1:0,super.focus(t)}blur(t=!1){return this.selectedIndex=-1,super.blur(t)}collapse(){return this._buttons.reduce(((t,s)=>s.collapse()||t),!1)}keypress(t){return!!t.key&&(!!this.focused&&("Tab"===t.key?(this.selectedIndex+=1,this._selectedIndex>=0):"TAB"===t.key&&(this.selectedIndex-=1,this._selectedIndex>=0)))}mousemove(t){if(!this.contains(t)||!this.focused)return super.mousemove(t);const s=this._buttons.findIndex((s=>s.contains(t)));return!(s<0||s===this._selectedIndex)&&(this.selectedIndex=s,!0)}_initButtons(t){this._config=t.buttons;const s=Object.entries(this._config),e=this._attrStr("buttonTag"),i=this._attrStr("buttonClass");let h=this.bounds.x;const r=this.bounds.y;s.forEach((([t,s],n)=>{const o=0==n?this._attrStr("prefix"):this._attrStr("separator");this.layer.text(o,{x:h,y:r,parent:this}),h+=o.length;const a=new P(this.layer,{text:t,x:h,y:r,tag:e,class:i,depth:this.depth+1,buttons:s});a.setParent(this),this._buttons.push(a),h+=a.bounds.width}))}_buttonClick(t,s){if(!s)return!1;this.layer.setFocusWidget(this),console.log("clicked = "+s.text(),s._attrStr("action"));const e=s;return this.selectedIndex=this._buttons.indexOf(e),e.menu?e.expand():this.collapse(),!0}}M.default={buttonClass:"",buttonTag:"mi",menuClass:"",menuTag:"mi",prefix:" ",separator:" | "},f("menubar",((t,s)=>new M(t,s)));class P extends b{constructor(t,s){super(t,(s.tag=s.tag||"mi","string"==typeof s.buttons&&(s.action=s.buttons),s)),this.menu=null,this.tag=s.tag||"mi","string"!=typeof s.buttons&&(this.menu=this._initMenu(s),this.on("mouseenter",(()=>(this.menu.hidden=!1,this.menu._bubbleEvent("change",this),!0))),this.on("mouseleave",((t,s,e)=>{var i;return!!(null===(i=this.parent)||void 0===i?void 0:i.contains(e))&&(this.menu.hidden=!0,!0)})),this.on("click",(()=>!0)))}collapse(){return!(!this.menu||this.menu.hidden)&&(this.menu.collapse(),this.menu.hidden=!0,!0)}expand(){return this.menu&&(this.menu.hidden=!1),this}_setMenuPos(t,s){t.x=this.bounds.x;const e=s.height||Object.keys(s.buttons).length;this.bounds.y<e?t.y=this.bounds.y+1:t.y=this.bounds.top-e}_initMenu(t){if("string"==typeof t.buttons)return null;const s={x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"mi",height:t.height,buttons:t.buttons,depth:this.depth+1};this._setMenuPos(s,t);const e=new O(this.layer,s);return e.hidden=!0,e.setParent(this),e}}p.prototype.menubar=function(t){const s=Object.assign({},this._opts,t),e=new M(this,s);return t.parent&&e.setParent(t.parent,t),e};class W extends u{constructor(t,s){super(t,s),this.tag=s.tag||"select",this._initText(s),this._initMenu(s),this.bounds.height=1}_initText(t){this.dropdown=new b(this.layer,{text:t.text+" ▼",x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"select",width:this.bounds.width,height:1,depth:this.depth+1}).on("click",(()=>(this.menu.toggleProp("hidden"),!1))),this.dropdown.setParent(this,{beforeIndex:0})}_initMenu(t){this.menu=new O(this.layer,{x:this.bounds.x,y:this.bounds.y+1,class:t.buttonClass,tag:t.buttonTag||"select",width:t.width,minWidth:this.dropdown.bounds.width,height:t.height,buttons:t.buttons,depth:this.depth+1}).on("click",(()=>(this.menu.hidden=!0,!1))),this.menu.hidden=!0,this.menu.setParent(this)}}f("select",((t,s)=>new W(t,s))),p.prototype.select=function(t){const s=Object.assign({},this._opts,t),e=new W(this,s);return t.parent&&e.setParent(t.parent,t),e};class D extends u{constructor(t,s){super(t,(s.tag=s.tag||D.default.tag,s)),this._prompt=null,this._done=null,this.choiceWidth=s.choiceWidth,this.attr("border",s.border||D.default.border),this.attr("promptTag",s.promptTag||D.default.promptTag),this.attr("promptClass",s.promptClass||D.default.promptClass),this.attr("choiceTag",s.choiceTag||D.default.choiceTag),this.attr("choiceClass",s.choiceClass||D.default.choiceClass),this.attr("infoTag",s.infoTag||D.default.infoTag),this.attr("infoClass",s.infoClass||D.default.infoClass),this._addLegend(),this._addList(),this._addInfo(),s.prompt&&this.showPrompt(s.prompt)}showPrompt(t){return this._prompt=t,t.choose(0),this.prompt.text(t.prompt()),this.list.data(t.choices()),this.info.text(t.info(t.selection)),this._bubbleEvent("input",this,this._prompt),new Promise((t=>this._done=t))}_addList(){return this.list=new S(this.layer,{height:this.bounds.height-2,x:this.bounds.x+1,width:this.choiceWidth,y:this.bounds.y+1,dataTag:this._attrStr("choiceTag"),dataClass:this._attrStr("choiceClass"),tabStop:!0,border:"none",hover:"select"}),this.list.setParent(this),this.list.on("input",(()=>{if(!this._prompt)return!1;const t=this._prompt,s=this.list.selectedRow;return t.choose(s),-1==s?this.info.text(""):this.info.text(t.info(s)),this._bubbleEvent("input",this,t),!0})),this.list.on("change",(()=>{if(!this._prompt)return!1;const t=this._prompt;return t.choose(this.list.selectedRow),this._bubbleEvent("change",this,t),this._done(t.value()),!0})),this}_addInfo(){return this.info=new b(this.layer,{text:"",x:this.bounds.x+this.choiceWidth+2,y:this.bounds.y+1,width:this.bounds.width-this.choiceWidth-3,height:this.bounds.height-2,tag:this._attrStr("infoTag"),class:this._attrStr("infoClass")}),this.info.setParent(this),this}_addLegend(){return this.prompt=new b(this.layer,{text:"",width:this.bounds.width-4,x:this.bounds.x+2,y:this.bounds.y,tag:this._attrStr("promptTag"),class:this._attrStr("promptClass")}),this.prompt.setParent(this),this}_draw(t){let s=this.choiceWidth+2;const e=this.bounds.height;let i=this.bounds.x;const h=this.bounds.y,r="ascii"===this.attr("border");return y(t,i,h,s,e,this._used,r),s=this.bounds.width-this.choiceWidth-1,i=this.bounds.x+this.choiceWidth+1,y(t,i,h,s,e,this._used,r),!0}}D.default={tag:"choice",border:"ascii",promptTag:"prompt",promptClass:"",choiceTag:"choice",choiceClass:"",infoTag:"info",infoClass:""},p.prototype.choice=function(t){const s=Object.assign({},this._opts,t),e=new D(this,s);return t.parent&&e.setParent(t.parent,t),e};class A extends u{constructor(t,s){super(t,{id:"ARCHIVE",tag:"messages",class:s.classes.concat("archive"),height:s.bounds.height,width:s.bounds.width,x:0,y:0,tabStop:!0,depth:100}),this.mode="forward",this.source=s,this.isOnTop=this.source.bounds.y<10,this.bounds.height=this.isOnTop?t.height-s.bounds.y:s.bounds.bottom,this.totalCount=Math.min(s.cache.length,this.isOnTop?t.height-this.source.bounds.top:this.source.bounds.bottom),this.shown=s.bounds.height,this.layer.on("FORWARD",this._forward.bind(this)),this.layer.on("REVERSE",this._reverse.bind(this)),this.layer.setTimeout("FORWARD",16),this.source.cache.confirmAll()}contains(){return!0}finish(){this.layer.finish()}keypress(t){if("ack"===this.mode)"Enter"!==t.key&&" "!==t.key||(this.mode="reverse",this.layer.needsDraw=!0,this.layer.setTimeout("REVERSE",16));else{if("reverse"===this.mode)return this.finish(),!0;this.mode="ack",this.shown=this.totalCount,this.layer.needsDraw=!0}return!1}click(t){return"ack"===this.mode?(this.mode="reverse",this.layer.needsDraw=!0,this.layer.setTimeout("REVERSE",16)):"reverse"===this.mode?this.finish():(this.mode="ack",this.shown=this.totalCount,this.layer.needsDraw=!0),!1}_forward(){return++this.shown,this.layer.needsDraw=!0,this.shown<this.totalCount?this.layer.setTimeout("FORWARD",16):this.mode="ack",!0}_reverse(){return--this.shown,this.shown<=this.source.bounds.height?this.finish():(this.layer.needsDraw=!0,this.layer.setTimeout("REVERSE",16)),!0}_draw(t){let s=0;const e=this.isOnTop,i=t,r=h.color.from(this.source._used.fg),n=e?this.shown-1:this.bounds.bottom-this.shown,o=e?0:this.bounds.bottom-1,a=e?-1:1;if(i.fillRect(this.source.bounds.x,Math.min(n,o),this.bounds.width,this.shown," ",this._used.bg,this._used.bg),this.source.cache.forEach(((t,h,d)=>{const l=n+d*a;if(e){if(l<o)return}else if(l>o)return;s=Math.floor(50*d/this.shown);const u=r.clone().mix(this._used.bg,s);i.drawText(this.source.bounds.x,l,t,u,this._used.bg)})),"ack"===this.mode){const t=this.isOnTop?0:i.height-1,s=this.source.bounds.x>8?this.source.bounds.x-8:Math.min(this.source.bounds.x+this.bounds.width,i.width-8);i.wrapText(s,t,8,"--DONE--",this._used.bg,this._used.fg)}return!0}}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class R{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,s){return 0}}class j extends R{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,s){return this.actor.drawStatus(t,s)}}class B extends R{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,s){return this.item.drawStatus(t,s)}}class L extends R{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,s){return this.cell.drawStatus(t,s)}}t.ActorEntry=j,t.Border=_,t.Button=m,t.CellEntry=L,t.Choice=D,t.Column=T,t.ComputedStyle=a,t.DataList=S,t.DataTable=C,t.EntryBase=R,t.Fieldset=w,t.Flavor=class extends b{constructor(t,s){super(t,(s.tag=s.tag||"flavor",s.text="",s)),this.overflow=s.overflow||!1,this.isPrompt=!1}showText(t){return this.text(t),this.removeClass("prompt"),this}clear(){return this.text(""),this.removeClass("prompt"),this}showPrompt(t){return this.showText(t),this.addClass("prompt"),this}getFlavorText(t,s,e,i){const n=t.cell(s,e);let o,a="";const d=!i||i.isAnyKindOfVisible(s,e),l=!i||i.isDirectlyVisible(s,e),u=!!i&&i.isRevealed(s,e),c=!!i&&i.isMagicMapped(s,e);let p;if(l)p="You see";else if(d)p="You sense";else if(u)p="You remember";else{if(!c)return"";p="You expect to see"}const g=n.hasActor()?t.actorAt(s,e):null,f=n.hasItem()?t.itemAt(s,e):null,b=n.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let _=!1;g?(a=g.getFlavor({color:!1,article:!0,action:!0}),_=!0):f&&(a=f.getFlavor({color:!1,article:!0}),_=!0);let y=b?" in ":" on ";const m=n.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,w=n.depthTile(r.flags.Depth.SURFACE),x=n.depthTile(r.flags.Depth.LIQUID);let v="";if(w){_&&(_=!1,a+=" on "),w.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(y=" over "),v=w.getFlavor()+y}let E="";x&&(E=x.getFlavor()+" covering ",_&&(_=!1,a+=" in ")),_&&(_=!1,a+=" on ");let T=m.getFlavor({article:!0});return o=h.text.apply("§intro§ §text§.",{intro:p,text:a+v+E+T}),o}},t.Input=E,t.Inquiry=class{constructor(t){this._prompts=[],this.widget=t}prompt(t){return this._prompts.push(t),this}},t.ItemEntry=B,t.Layer=p,t.Menu=O,t.MenuButton=I,t.MenuViewer=class extends u{constructor(t,s){super(t.layer,{tabStop:!0,x:0,y:0,width:t.layer.width,height:t.layer.height,tag:t.attr("menuTag"),class:t.attr("menuClass")}),this.menubar=t,this.mainMenu=this._initMenu(s)}contains(){return!0}finish(){this.layer.finish()}_initMenu(t){return new O(this.layer,{buttonTag:this.menubar._attrStr("buttonTag"),buttonClass:this.menubar._attrStr("buttonClass"),minWidth:this.menubar.selectedButton.bounds.width,buttons:t})}keypress(t){return!!t.key&&("Escape"===t.key?(this.finish(),!0):("Tab"===t.key||"TAB"===t.key)&&(this.finish(),this.menubar.keypress(t),!0))}},t.Menubar=M,t.MenubarButton=P,t.MessageArchive=A,t.Messages=class extends u{constructor(t,s){if(super(t,(s.tag=s.tag||"messages",s)),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:s.length||40,match:(t,s)=>(this.layer.needsDraw=!0,!0)})}click(t){return!!this.contains(t)&&(this.showArchive(),!0)}draw(t){const s=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this._used.bg,this._used.bg),this.cache.forEach(((e,i,h)=>{if(h>=this.bounds.height)return;const r=(s?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,r,e,this._used.fg),i&&this._used.bg&&t.mix(this._used.bg,50,this.bounds.x,r,this.bounds.width,1)})),!0}showArchive(){if(this.cache.length<=this.bounds.height)return;const t=this.layer.ui.startNewLayer();new A(t,this)}},t.OrderedList=x,t.Prompt=class{constructor(t,s={}){this._id=null,this._defaultNext=null,this.selection=-1,"string"==typeof s&&(s={field:s}),this._prompt=t,this._field=s.field||"",this._choices=[],this._infos=[],this._values=[],this._next=[],this._defaultNext=s.next||null,this._id=s.id||s.field||""}field(t){return void 0===t?this._field:(this._field=t,this)}id(t){return void 0===t?this._id:(this._id=t,this)}prompt(t){return void 0===t?this._prompt:(this._prompt=t,this)}next(t){return void 0===t?this._next[this.selection]||this._defaultNext:(this._defaultNext=t,this)}choices(t,s){if(void 0===t)return this._choices;if(Array.isArray(t)?Array.isArray(s)||(s=new Array(t.length).fill("")):(s=Object.values(t),t=Object.keys(t)),t.length!==s.length)throw new Error("Choices and Infos must have same length.");return t.forEach(((t,e)=>{this.choice(t,s[e])})),this}choice(t,s={}){return"string"==typeof s&&(s={text:s}),this._choices.push(t),this._infos.push(s.text||""),this._next.push(s.next||null),this._values.push(s.value||t),this}infos(){return this._infos}info(t){return this._infos[t]}choose(t){return this.selection=t,this}value(){return this._values[this.selection]}},t.Select=W,t.Sheet=d,t.Sidebar=class extends u{constructor(t,s){super(t,s),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}reset(){this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((s=>s.sidebarY<=t.y&&-1!==s.sidebarY))||null}mousemove(t){return super.mousemove(t),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const s=this.highlight;return this.highlight=null,this.entries.forEach((s=>{s.sidebarY<=t&&-1!==s.sidebarY&&(this.highlight=s)})),this.highlight!==s}clearHighlight(){const t=!!this.highlight;return this.highlight=null,t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((s,e)=>{const i=t.cell(s,e);i.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(i)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new j(t)}_makeItemEntry(t){return new B(t)}_makeCellEntry(t){return new L(t)}_getPriority(t,s,e,i){return i?i.isDirectlyVisible(s,e)?1:i.isAnyKindOfVisible(s,e)?2:i.isRevealed(s,e)?3:-1:t.cell(s,e).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,s,e,i,r){const n=this._getPriority(s,t.x,t.y,r);if(n<0)return!1;const o=this._makeActorEntry(t);return o.dist=h.xy.distanceBetween(e,i,t.x,t.y),o.priority=t.isPlayer()?0:n,this.entries.push(o),!0}_addItemEntry(t,s,e,i,r){const n=this._getPriority(s,t.x,t.y,r);if(n<0)return!1;const o=this._makeItemEntry(t);return o.dist=h.xy.distanceBetween(e,i,t.x,t.y),o.priority=n,this.entries.push(o),!0}_addCellEntry(t,s,e,i,r){const n=this._getPriority(s,t.x,t.y,r);if(n<0)return!1;const o=this._makeCellEntry(t);return o.dist=h.xy.distanceBetween(e,i,t.x,t.y),o.priority=n,this.entries.push(o),!0}findEntries(t,s,e,i){if(t===this.lastMap&&s===this.lastX&&e===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=s,this.lastY=e,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const n=h.x,o=h.y;r[n][o]||this._addActorEntry(h,t,s,e,i)&&(r[n][o]=1)})),t.eachItem((h=>{const n=h.x,o=h.y;r[n][o]||this._addItemEntry(h,t,s,e,i)&&(r[n][o]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,s,e,i)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),h.grid.free(r)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,s,e,i){return this.updateCellCache(t),this.findEntries(t,s,e,i),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this._used.bg),this.entries.forEach((t=>t.sidebarY=-1));const s=this.bounds.clone();let e;for(let i=0;i<this.entries.length&&s.height>0;++i){e=this.entries[i],e.sidebarY=s.y;let h=e.draw(t,s);this._isDim(e)&&this._used.bg&&t.mix(this._used.bg,50,s.x,s.y,s.width,h),h&&(++h,s.y+=h,s.height-=h)}return!0}},t.Style=o,t.TD=k,t.Text=b,t.UI=class{constructor(t={}){if(this.layer=null,this.layers=[],this._done=!1,this._promise=null,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.loop=t.loop||h.loop}get width(){return this.canvas.width}get height(){return this.canvas.height}get styles(){return l}get baseBuffer(){const t=this.layers[this.layers.length-2]||null;return t?t.buffer:this.canvas.buffer}get canvasBuffer(){return this.canvas.buffer}startNewLayer(){const t=new p(this);return this.layers.push(t),this._promise||(this._promise=this.loop.run(this)),this.layer=t,t}copyUIBuffer(t){const s=this.baseBuffer;t.copy(s),t.changed=!1}finishLayer(t){h.arrayDelete(this.layers,t),this.layer===t&&(this.layer=this.layers[this.layers.length-1]||null)}stop(){for(this._done=!0;this.layer;)this.finishLayer(this.layer)}mousemove(t){return this.layer&&this.layer.mousemove(t),this._done}click(t){return this.layer&&this.layer.click(t),this._done}keypress(t){return this.layer&&this.layer.keypress(t),this._done}dir(t){return this.layer&&this.layer.dir(t),this._done}tick(t){return this.layer&&this.layer.tick(t),this._done}draw(){this.layer&&this.layer.draw()}},t.UnorderedList=v,t.Viewport=class extends u{constructor(t,s){super(t,s),this.offsetX=0,this.offsetY=0,this._subject=null,this.snap=s.snap||!1,this.center=s.center||!1,this.filter=s.filter||null,s.lock?(this.lockX=!0,this.lockY=!0):(s.lockX&&(this.lockX=!0),s.lockY&&(this.lockY=!0))}get subject(){return this._subject}set subject(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t}set lock(t){this.lockX=t,this.lockY=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,s,e){this.center=!0,this.subject={x:s,y:e,map:t}}showMap(t,s=0,e=0){this.subject={x:s,y:e,map:t},this.offsetX=s,this.offsetY=e,this.center=!1,this.snap=!1}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,s=t.memory||t.map,e=s;if(t&&s.hasXY(t.x,t.y))if(this.snap){let s=this.offsetX,i=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<s||t.x>i)&&(s=this.offsetX=t.x-this.halfWidth(),i=s+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const n=Math.floor(this.bounds.width/5),o=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);s+n>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):i-n<=t.x&&(this.offsetX=Math.min(t.x-a,e.width-this.bounds.width));const d=Math.floor(this.bounds.height/3);h+o>=t.y?this.offsetY=Math.max(0,t.y+d-this.bounds.height):r-o<=t.y&&(this.offsetY=Math.min(t.y-d,e.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&s&&(this.offsetX=h.clamp(this.offsetX,0,s.width-this.bounds.width)),this.lockY&&s&&(this.offsetY=h.clamp(this.offsetY,0,s.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this._used.bg),!this._subject)return!1;this.updateOffset();const s=this._subject.memory||this._subject.map,e=this._subject.fov,i=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let r=0;r<this.bounds.height;++r){const n=h+this.offsetX,o=r+this.offsetY;if(s.hasXY(n,o)){const t=s.cell(n,o);s.drawer.drawCell(i,t,e)}else i.draw(" ",this._used.bg,this._used.bg);this.filter&&this.filter(i,n,o,s),t.drawSprite(h+this.bounds.x,r+this.bounds.y,i)}return!0}},t.Widget=u,t.defaultStyle=l,t.drawBorder=y,t.makeStyle=function(t,s="$"){const e={};return t.trim().split(";").map((t=>t.trim())).forEach((t=>{const[s,i]=t.split(":").map((t=>t.trim()));if(!s)return;const h=i.split(/ +/g);1==h.length?e[s]=i:e[s]=h})),new o(s,e)},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
