!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,e,s){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i.get?i:{enumerable:!0,get:function(){return t[s]}})}})),e.default=t,Object.freeze(e)}var h=i(e),r=i(s);class n{constructor(t,e){this.active=!1,this.hovered=!1,this.tabStop=!1,this.depth=0,this.fg=4095,this.bg=-1,this.activeFg=4095,this.activeBg=-1,this.hoverFg=4095,this.hoverBg=-1,this.text="",this.align="left",this.valign="middle",this.bounds=new h.xy.Bounds(-1,-1,-1,-1),this.id=t,e&&this.init(e),this.reset()}init(t){void 0!==t.x&&(this.bounds.x=t.x),void 0!==t.y&&(this.bounds.y=t.y),void 0!==t.width&&(this.bounds.width=t.width),void 0!==t.height&&(this.bounds.height=t.height),void 0!==t.depth&&(this.depth=t.depth),t.text&&(this.text=t.text,this.bounds.width<=0&&(this.bounds.width=t.text.length),this.bounds.height<=0&&(this.bounds.height=1)),this.bounds.height<=0&&(this.bounds.height=1),void 0!==t.fg&&(this.fg=t.fg,this.activeFg=t.fg,this.hoverFg=t.fg),void 0!==t.bg&&(this.bg=t.bg,this.activeBg=t.bg,this.hoverBg=t.bg),void 0!==t.activeFg&&(this.activeFg=t.activeFg,this.hoverFg=t.activeFg),void 0!==t.activeBg&&(this.activeBg=t.activeBg,this.hoverBg=t.activeBg),void 0!==t.hoverFg&&(this.hoverFg=t.hoverFg),void 0!==t.hoverBg&&(this.hoverBg=t.hoverBg),void 0!==t.tabStop&&(this.tabStop=t.tabStop),this.action=t.action||this.id}reset(){}activate(t=!1){this.active=!0}deactivate(){this.active=!1}contains(t,e){return 1==arguments.length?this.bounds.contains(t):this.bounds.contains(t,e)}mousemove(t,e){return this.hovered=this.contains(t),this.hovered}tick(t,e){}click(t,e){return!1}keypress(t,e){return!1}dir(t,e){return!1}draw(t){const e=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,s=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg,i=h.text.length(this.text);(this.bounds.width>i||this.bounds.height>1)&&t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",e,s);let r=this.bounds.x;"center"==this.align?r+=Math.floor((this.bounds.width-i)/2):"right"==this.align&&(r+=this.bounds.width-i);let n=this.bounds.y;this.bounds.height>1&&("middle"==this.valign?n+=Math.floor(this.bounds.height/2):"bottom"==this.valign&&(n+=this.bounds.height-1)),t.drawText(r,n,this.text,e,s)}}class o extends n{constructor(t,e){super(t,e)}init(t){if(this.text=t.text||"",t.wrap)this.wrap=!0,t.width=t.wrap,this.lines=h.text.splitIntoLines(this.text,t.width);else{const e=h.text.length(this.text);t.width=t.width||e||10,t.width<e&&(t.text=h.text.truncate(this.text,t.width)),this.lines=[this.text]}t.height=Math.max(this.lines.length,t.height||1),super.init(t)}setText(t){if(this.text=t,this.wrap)this.lines=h.text.splitIntoLines(this.text,this.bounds.width);else{h.text.length(this.text)>this.bounds.width&&(this.text=h.text.truncate(this.text,this.bounds.width)),this.lines=[this.text]}}draw(t){const e=this.active?this.activeFg:this.fg,s=this.active?this.activeBg:this.bg;this.lines.forEach(((i,h)=>{t.drawText(this.bounds.x,this.bounds.y+h,i,e,s,this.bounds.width)}))}}class a extends n{constructor(t,e){super(t,e)}init(t){if(!t.text)throw new Error("Must have text value in config for Button widget - "+this.id);t.tabStop=h.first(t.tabStop,!0),super.init(t)}async click(t,e){return!!this.contains(t)&&(await e.fireAction(this.action,this),!0)}async keypress(t,e){return!!t.key&&("Enter"===t.key&&(await e.fireAction(this.action,this),!0))}}class d extends n{constructor(t,e){super(t,e)}init(t){this.minLength=t.minLength||1,t.width||(t.width=Math.max(this.minLength,10)),t.tabStop=h.first(t.tabStop,!0),super.init(t),this.default=t.default||"",this.errorFg=t.errorFg||this.fg,this.hint=t.hint||"",this.hintFg=t.hintFg||this.errorFg,this.numbersOnly=t.numbersOnly||!1,this.min=h.first(t.min,Number.MIN_SAFE_INTEGER),this.max=h.first(t.max,Number.MAX_SAFE_INTEGER),this.bounds.width<=0&&(this.hint&&(this.bounds.width=this.hint.length),this.default&&(this.bounds.width=this.default.length)),this.bounds.height<=0&&(this.bounds.height=1),this.reset()}reset(){this.text=this.default}isValid(){if(this.numbersOnly){const t=Number.parseInt(this.text);return!(void 0!==this.min&&t<this.min)&&(!(void 0!==this.max&&t>this.max)&&t>0)}return this.text.length>=this.minLength}get value(){return this.numbersOnly?Number.parseInt(this.text):this.text}keypress(t,e){const s=this.numbersOnly?["0","9"]:[" ","~"];if(!t.key)return!1;if("Enter"===t.key&&this.isValid()){const t=e.fireAction(this.action,this);return!t||t.then((()=>!0))}return"Delete"==t.key||"Backspace"==t.key?(this.text.length&&(this.text=h.text.spliceRaw(this.text,this.text.length-1,1)),!0):!(t.key.length>1)&&(t.key>=s[0]&&t.key<=s[1]&&this.text.length<this.bounds.width&&(this.text+=t.key),!0)}draw(t){const e=this.bounds.x,s=this.bounds.y,i=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,h=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;if(t.fillRect(e,s,this.bounds.width,1," ",i,h),!this.text.length&&this.hint&&this.hint.length)t.drawText(e,s,this.hint,this.hintFg);else{const h=this.isValid()?i:this.errorFg;t.drawText(e,s,this.text,h)}}}class l{constructor(t){this.active=!1,this.hovered=!1,this.fg=null,this.bg=null,this.activeFg=null,this.activeBg=null,this.hoverFg=null,this.hoverBg=null,this.align="left",this.header="",this.empty="",this._value=h.IDENTITY,this.x=-1,this.width=-1,this.index=-1,h.object.assignOmitting("value",this,t),this.width<=0&&(this.width=this.header.length||1),"string"==typeof t.value?this._value=h.text.compile(t.value):this._value=t.value||h.IDENTITY,t.align&&(this.align=t.align)}value(t,e){const s=this._value(t,e);return h.text.truncate(s,this.width)}}class u extends n{constructor(t,e){super(t,e),this.data=null,this.selectedColumn=null,this.selectedIndex=-1}init(t){if(!t.height)throw new Error("Height is required.");if(!t.columns||0==t.columns.length)throw new Error("Must have at least 1 column.");t.tabStop=h.first(t.tabStop,!0),super.init(t),this.headers=h.first(t.headers,!0),this.letters=h.first(t.letters,!0),this.columns=[],this.hoverType=t.hover||"row",this.wrapColumns=h.first(t.wrapColumns,t.wrap,!0),this.wrapRows=h.first(t.wrapRows,t.wrap,!0),this.headerFg=t.headerFg||this.fg,this.headerBg=t.headerBg||this.bg;let e=0;t.letters&&(this.columns.push(new l({width:2,value:(t,e)=>String.fromCharCode(97+e)+")"})),e+=2),t.columns&&t.columns.forEach((t=>{const s=new l(t);this.columns.push(s),e+=s.width})),this.columns.forEach(((t,e)=>t.index=e)),this.bounds.width=this.bounds.width>0?this.bounds.width:e}setData(t){this.data=t,this.selectedIndex=-1}selectRow(t){if(!this.data)return!1;return!(t>=(Array.isArray(this.data)?this.data.length:h.list.length(this.data)))&&(!(t<-1)&&(this.selectedIndex=t,!0))}selectNextRow(t=!0){if(!this.data)return-1;const e=Array.isArray(this.data)?this.data.length:h.list.length(this.data);return this.selectedIndex=h.nextIndex(this.selectedIndex,e,t),this.selectedIndex>-1&&!this.selectedColumn&&(this.selectedColumn=this.columns[0]),this.selectedIndex}selectPrevRow(t=!0){if(!this.data)return-1;const e=Array.isArray(this.data)?this.data.length:h.list.length(this.data);return this.selectedIndex=h.prevIndex(this.selectedIndex,e,t),this.selectedIndex>-1&&!this.selectedColumn&&(this.selectedColumn=this.columns[0]),this.selectedIndex}selectNextColumn(t=!0){if(this.selectedColumn){let e=h.nextIndex(this.selectedColumn.index,this.columns.length,t);this.selectedColumn=this.columns[e]||null}else this.selectedColumn=this.columns[0];return this.selectedColumn&&this.selectedIndex<0&&this.data&&(this.selectedIndex=0),this.selectedColumn}selectPrevColumn(t=!0){if(this.selectedColumn){let e=h.prevIndex(this.selectedColumn.index,this.columns.length,t);this.selectedColumn=this.columns[e]||null}else this.selectedColumn=this.columns[this.columns.length-1];return this.selectedColumn&&this.selectedIndex<0&&this.data&&(this.selectedIndex=0),this.selectedColumn}get selectedData(){return this.data?Array.isArray(this.data)?this.data[this.selectedIndex]||null:h.list.at(this.data,this.selectedIndex):null}draw(t){const e=this.bounds;t.fillRect(e.x,e.y,e.width,e.height," ",this.bg,this.bg);let s=e.x;this.columns.forEach((e=>{this.drawColumn(t,e,s),s+=e.width}))}drawColumn(t,e,s){let i=this.bounds.y;e.header&&(t.fillRect(s,i,e.width,1," ",this.headerFg,this.headerBg),t.drawText(s,i,e.header,this.headerFg,this.headerBg,e.width,e.align),++i),this.data&&(Array.isArray(this.data)?this.data.forEach(((h,r)=>{this.drawCell(t,e,h,r,s,i),++i})):h.list.forEach(this.data,((h,r)=>{this.drawCell(t,e,h,r,s,i),++i})))}drawCell(t,e,s,i,h,r){if(r>this.bounds.bottom)return;let n=e._value(s,i);0==n.length&&(n=e.empty);let o=this.fg,a=this.bg;"row"===this.hoverType?i===this.selectedIndex&&(o=this.hoverFg,a=this.hoverBg):"column"===this.hoverType?e===this.selectedColumn&&(o=this.hoverFg,a=this.hoverBg):"cell"===this.hoverType&&e===this.selectedColumn&&i===this.selectedIndex&&(o=this.hoverFg,a=this.hoverBg),t.fillRect(h,r,e.width,1," ",a,a),t.drawText(h,r,n,o,a,e.width,e.align)}async mousemove(t,e){if(!super.mousemove(t,e))return!1;const s=this.selectedColumn,i=this.selectedIndex;let h=t.x-this.bounds.x;const r=this.selectedColumn=this.columns.find((t=>t.width>=h||(h-=t.width,!1)))||null;let n=-1;return this.data&&(n=t.y-this.bounds.y-(this.headers?1:0),Array.isArray(this.data)&&n>=this.data.length&&(n=-1)),this.selectedIndex=n,s===r&&i===n||(e.fireAction(this.id+"_HOVER",this),e.requestRedraw()),!0}dir(t){return!!t.dir&&(t.dir[0]>0?this.selectNextColumn(this.wrapColumns):t.dir[0]<0&&this.selectPrevColumn(this.wrapColumns),t.dir[1]>0?this.selectNextRow(this.wrapRows):t.dir[1]<0&&this.selectPrevRow(this.wrapRows),!0)}}class c extends n{constructor(t,e){super(t,e?(void 0===e.depth&&(e.depth=-10),e.title&&(e.text=e.title),e.bg=e.bg||"gray",e):e)}init(t){super.init(t),this.borderBg=t.borderBg||null}mousemove(t,e){return!1}draw(t){const e=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,s=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;this.borderBg?(t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.borderBg,this.borderBg),t.fillRect(this.bounds.x+1,this.bounds.y+1,this.bounds.width-2,this.bounds.height-2," ",s,s)):t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",s,s),this.text&&t.drawText(this.bounds.x,this.bounds.y,this.text,e,-1,this.bounds.width,"center")}}class g{constructor(t,e){this.widgets=[],this.eventHandlers={},this._activeWidget=null,this.result=null,this.done=!1,this.timers={},this.needsRedraw=!0,this.ui=t,this.id=e||"DIALOG"}init(){this.widgets.sort(((t,e)=>t.depth<e.depth?-1:1))}get activeWidget(){return this._activeWidget}setActiveWidget(t,e=!1){t!==this._activeWidget&&(this._activeWidget&&this._activeWidget.deactivate(),this._activeWidget=t,this._activeWidget&&this._activeWidget.activate(e))}requestRedraw(){this.needsRedraw=!0}setTimeout(t,e){this.timers[t]=e}clearTimeout(t){delete this.timers[t]}async fireAction(t,e){const s=this.eventHandlers[t];s&&await s(t,this,e)}setEventHandlers(t){Object.assign(this.eventHandlers,t)}async show(){this.done=!1,this.widgets.forEach((t=>t.reset())),this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null);const t=this.ui.startLayer();return await this.ui.loop.run({keypress:this.keypress.bind(this),dir:this.dir.bind(this),mousemove:this.mousemove.bind(this),click:this.click.bind(this),tick:this.tick.bind(this),draw:()=>{this.draw(t),t.render()}},100),this.ui.finishLayer(),this.result}close(t){this.result=t,this.done=!0}widgetAt(t,e){return this.widgets.find((s=>s.contains(t,e)&&s.depth>=0))||null}getWidget(t){return this.widgets.find((e=>e.id===t))||null}nextTabstop(){if(!this.activeWidget)return this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null),!!this.activeWidget;const t=h.arrayNext(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.setActiveWidget(t),!0)}prevTabstop(){if(!this.activeWidget)return this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null),!!this.activeWidget;const t=h.arrayPrev(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.setActiveWidget(t,!0),!0)}async tick(t){const e=t.dt;let s=[];Object.entries(this.timers).forEach((([t,i])=>{(i-=e)<=0?(delete this.timers[t],s.push(this.fireAction(t,null))):this.timers[t]=i}));for(let e of this.widgets)s.push(e.tick(t,this));return s.length?Promise.all(s).then((()=>this.done)):this.done}async mousemove(t){return await Promise.all(this.widgets.map((async e=>{await e.mousemove(t,this),e.hovered&&e.tabStop&&this.setActiveWidget(e)}))),this.done}async click(t){const e=this.widgetAt(t.x,t.y);let s=null;if(e){if(await e.click(t,this))return this.done;s=this.eventHandlers[e.id]}return s=s||this.eventHandlers[this.id]||this.eventHandlers.click,s&&await s(t,this,this.activeWidget),this.done}async keypress(t){if(!t.key)return!1;if(this.activeWidget&&await this.activeWidget.keypress(t,this))return this.done;const e=this.eventHandlers[t.key]||this.eventHandlers[t.code]||this.eventHandlers.keypress;return e&&await e(t,this,this.activeWidget)?this.done:"Tab"===t.key?(this.nextTabstop(),!1):"TAB"===t.key?(this.prevTabstop(),!1):this.done}async dir(t){if(this.activeWidget&&await this.activeWidget.dir(t,this))return this.done;const e=this.eventHandlers.dir||this.eventHandlers.keypress;return e&&await e(t,this,this.activeWidget),this.done}draw(t,e=!1){(this.needsRedraw||e)&&(this.ui.resetLayerBuffer(),this.widgets.forEach((e=>e.draw(t))))}}class f{constructor(t,e,s){this.nextY=0,this.box=null,this.nextY=1,this.dialog=new g(t),this.bounds=new h.xy.Bounds(-1,-1,e,s)}with(t,e){const s=this.bounds;return e?(void 0!==e.right?(s.width=Math.max(s.width,t.bounds.width+e.right),t.bounds.right=s.width-e.right-1):(t.bounds.x=e.x||0,s.width=Math.max(s.width,t.bounds.width+t.bounds.x)),void 0!==e.bottom?(s.height=Math.max(s.height,t.bounds.height+e.bottom),t.bounds.bottom=s.height-e.bottom-1):(t.bounds.y=e.y||0,s.height=Math.max(s.height,t.bounds.height+t.bounds.y))):(s.width=Math.max(s.width,t.bounds.right),s.height=Math.max(s.height,t.bounds.bottom)),this.dialog.widgets.push(t),this.nextY=Math.max(this.nextY,t.bounds.bottom+1),this}center(){const t=this.dialog.ui.buffer,e=this.bounds;return e.x=Math.floor((t.width-e.width)/2),e.y=Math.floor((t.height-e.height)/2),this}place(t,e){const s=this.bounds;return s.x=t,s.y=e,this}addBox(t){return this.box=t||{},this}done(){if(this.bounds.x<0&&(this.bounds.x=0),this.bounds.y<0&&(this.bounds.y=0),this.bounds.right>this.dialog.ui.buffer.width)throw new Error("Dialog is off screen!");if(this.bounds.bottom>this.dialog.ui.buffer.height)throw new Error("Dialog is off screen!");if(this.box){const t=this.box.padX||this.box.pad||1,e=this.box.padY||this.box.pad||1;this.box.x=0,this.box.y=0,this.box.width=this.bounds.width+2*t,this.box.height=this.bounds.height+2*e;const s=new c(this.dialog.id+"_BOX",this.box);this.dialog.widgets.forEach((s=>{s.bounds.x+=t,s.bounds.y+=e})),this.dialog.widgets.unshift(s)}return this.dialog.widgets.forEach((t=>{t.bounds.x+=this.bounds.x,t.bounds.y+=this.bounds.y})),this.dialog}}function b(t,e=0,s=0){return new f(t,e,s)}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class p{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,e){return 0}}class y extends p{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,e){return this.actor.drawStatus(t,e)}}class w extends p{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,e){return this.item.drawStatus(t,e)}}class x extends p{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,e){return this.cell.drawStatus(t,e)}}class m{constructor(t){this.hovered=!1,this.x=999,this.text=t}get width(){return this.text.length}}class v extends m{constructor(t,e){super(t),this.action=e}}class _ extends m{constructor(t,e,s,i){super(s),this.buttons=[],this.parent=null,this.menu=t,this.parent=e,this.text=s,this.bounds=new h.xy.Bounds(0,0,0,0),Object.entries(i).forEach((([t,e])=>{this.addButton(t,e)}))}addButton(t,e){let s;s="string"==typeof e?new v(t,e):new _(this.menu,this,t,e),this.buttons.push(s),++this.bounds.height,this.bounds.width=Math.max(this.bounds.width,t.length+2)}setBounds(t,e,s,i){const h=e+i,r=t.width;if(this.bounds.width<r-h)this.bounds.x=h;else{if(!(this.bounds.width<e))throw new Error("Menu does not fit - too wide.");this.bounds.x=e-this.bounds.width}const n=t.height;if(this.bounds.height<=n-s)this.bounds.y=s;else{if(!(this.bounds.height<n))throw new Error("Menu does not fit - too tall.");this.bounds.y=n-this.bounds.height-1}}contains(t){return this.bounds.contains(t)}buttonAt(t){const e=t.y-this.bounds.y;return this.buttons[e]||null}draw(t){const e=this.bounds.width,s=this.bounds.height,i=this.bounds.x;let h=this.bounds.y;t.fillRect(i,h,e,s,0,0,this.menu.dropBg),this.buttons.forEach((e=>{t.drawText(i+1,h,e.text,e.hovered?this.menu.activeFg:this.menu.dropFg,e.hovered?this.menu.activeBg:this.menu.dropBg),++h})),this.parent&&this.parent.draw(t)}}async function E(t,e,s){const i=t.ui,r=i.startLayer();s.buttons.forEach((t=>t.hovered=!1));let n=s;await i.loop.run({Escape:()=>!0,Tab(){e.activeIndex=(e.activeIndex+1)%e.buttons.length;const s=e.buttons[e.activeIndex];return s&&(s.hovered=!0),n&&s instanceof _?(n.hovered=!1,n=s):n=null,t.requestRedraw(),!n},TAB(){e.activeIndex=(e.buttons.length+e.activeIndex-1)%e.buttons.length;const s=e.buttons[e.activeIndex];return s&&(s.hovered=!0),n&&s instanceof _?(n.hovered=!1,n=s):n=null,t.requestRedraw(),!n},mousemove:s=>{if(!n)return!0;let h=n;for(;h&&!h.contains(s);)h=h.parent;if(h){n=h;const t=n.buttonAt(s);t&&(n.buttons.forEach((t=>{t.hovered=!1})),t.hovered=!0,t instanceof _&&(t.buttons.forEach((t=>{t.hovered=!1})),t.buttons[0].hovered=!0,t.setBounds(i.buffer,n.bounds.x,s.y,n.bounds.width),n=t))}else if(e.contains(s)){t&&t.requestRedraw();const i=e.getButtonAt(s.x,s.y);i&&(i.hovered=!0,e.activeIndex=e.buttons.indexOf(i)),i instanceof _?(n.hovered=!1,n=i):n=null,t&&t.requestRedraw()}return!n},click:async s=>{if(!n)return!0;if(!n.contains(s))return e.clearHighlight(),!0;const i=n.buttonAt(s);return!i||i instanceof v&&(e.actionButton=i,await t.fireAction(i.action,e),!0)},dir:async t=>{if(!n)return!0;if(t.dir&&t.dir[1]){const e=n.buttons.findIndex((t=>t.hovered));if(e<1&&t.dir[1]<0)return n.buttons.forEach((t=>t.hovered=!1)),!0;const s=h.clamp(e+t.dir[1],0,n.buttons.length-1);n.buttons.forEach(((t,e)=>t.hovered=e===s));const r=n.buttons[s];r instanceof _&&(r.buttons.forEach((t=>{t.hovered=!1})),r.buttons[0].hovered=!0,r.setBounds(i.buffer,n.bounds.x,t.y,n.bounds.width),n=r)}},draw:()=>{n&&(i.resetLayerBuffer(),n.draw(r),e.draw(r),r.render())}}),i.finishLayer(),e.clearHighlight()}function B(t){return!!t&&("string"!=typeof t||"false"!==t&&"0"!==t)}const C=/^(\*|\#\w+|\$|\w+)(\.(\w+))?(\:(\w+))?$/;class T{constructor(t){this.tag="",this.id="",this.class="",this.prop="",this.priority=0,(t.startsWith(":")||t.startsWith("."))&&(t="*"+t);const e=t.match(C);if(!e)throw new Error("Invalid selector - "+t);this.text=t,"*"===e[1]||("$"===e[1]?this.priority+=1e4:e[1].startsWith("#")?(this.priority+=1e3,this.id=e[1].substring(1)):(this.tag=e[1],this.priority+=10)),e[3]&&(this.class=e[3],this.priority+=100),e[5]&&(this.prop=e[5],this.priority+=1)}matches(t){if(this.tag.length&&t.tag!==this.tag)return!1;if(this.id.length&&t.id!==this.id)return!1;if(this.class.length&&!t.classes.includes(this.class))return!1;if(this.prop.length){if(!B(t.props[this.prop]||!1))return!1}return!0}}class k{constructor(t="$",e){this._dirty=!1,this.selector=new T(t),e&&this.set(e),this._dirty=!1}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get fg(){return this._fg}get bg(){return this._bg}get depth(){return this._depth}get align(){return this._align}get valign(){return this._valign}get position(){return this._position}get minWidth(){return this._minWidth}get maxWidth(){return this._maxWidth}get width(){return this._width}get minHeight(){return this._minHeight}get maxHeight(){return this._maxHeight}get height(){return this._height}get x(){return this._x}get left(){return this._left}get right(){return this._right}get y(){return this._y}get top(){return this._top}get bottom(){return this._bottom}get padLeft(){return this._padLeft}get padRight(){return this._padRight}get padTop(){return this._padTop}get padBottom(){return this._padBottom}get(t){return this["_"+t]}set(t,e,s=!0){if("string"==typeof t)if("padding"===t)"number"==typeof e?e=[e]:"string"==typeof e&&(e=e.split(" ").map((t=>Number.parseInt(t)))),1==e.length?this._padLeft=this._padRight=this._padTop=this._padBottom=e[0]:2==e.length?(this._padLeft=this._padRight=e[0],this._padTop=this._padBottom=e[1]):4==e.length&&(this._padTop=e[0],this._padRight=e[1],this._padBottom=e[2],this._padLeft=e[3]);else{this["_"+t]=e}else t instanceof k?(s=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{"selector"!==t&&"_dirty"!==t&&(e?this[t]=e:null===e&&this.unset(t))}))):(s=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{null===e?this.unset(t):this.set(t,e,s)})));return this.dirty||(this.dirty=s),this}unset(t){return delete this[t.startsWith("_")?t:"_"+t],this.dirty=!0,this}clone(){const t=new this.constructor;return t.copy(this),t}copy(t){return Object.assign(this,t),this}}class I extends k{constructor(t){super(),this.sources=[],t&&(t.sort(((t,e)=>t.selector.priority-e.selector.priority)),this.sources=t),this.sources.forEach((t=>super.set(t))),this._dirty=!1}get dirty(){return this._dirty||this.sources.some((t=>t.dirty))}set dirty(t){this._dirty=t}}class A{constructor(t){this.rules=[],this._dirty=!0,t?this.rules=t.rules.slice():this.rules.push(new k("*",{fg:"white",bg:"black",align:"left",valign:"top",position:"static"}))}get dirty(){return this._dirty}set dirty(t){this._dirty=t,this._dirty||this.rules.forEach((t=>t.dirty=!1))}add(t,e){if(t.includes(" "))throw new Error("Hierarchical selectors not supported.");if("*"===t)throw new Error("Cannot re-install global style.");const s=new k(t,e),i=this.rules.findIndex((t=>t.selector.text===s.selector.text));if(i>-1)if("*"===t){this.rules[i].set(s)}else this.rules[i]=s;else this.rules.push(s);return this.dirty=!0,s}get(t){return this.rules.find((e=>e.selector.text===t))||null}remove(t){const e=this.rules.findIndex((e=>e.selector.text===t));e>-1&&(this.rules.splice(e,1),this.dirty=!0)}computeFor(t){const e=this.rules.filter((e=>e.selector.matches(t))),s=t.style();return s&&e.push(s),s.dirty=!1,new I(e)}}class L{constructor(t,e){this.id="",this.parent=null,this.props={},this.classes=[],this.children=[],this._bounds=new h.xy.Bounds(0,0,0,0),this._text="",this._lines=[],this._dirty=!1,this._attached=!1,this._style=null,this.tag=t,this._usedStyle=e?e.computeFor(this):new I}clone(){if(this._attached&&!this.parent)throw new Error("Cannot clone a root widget.");const t=new this.constructor(this.tag);return Object.assign(t.props,this.props),t.classes=this.classes.slice(),t._text=this._text,this._style&&(t._style=this._style.clone()),t.parent=null,t._attached=!1,t.dirty=!0,t.children=this.children.map((t=>t.clone())),t.children.forEach((e=>e.parent=t)),t}get dirty(){return this._dirty||this._usedStyle.dirty}set dirty(t){if(this._dirty=t,this.parent){const t=this.used("position");"static"!==t&&"relative"!==t||(this.parent.dirty=!0)}}addChild(t,e=-1){if(t.parent){if(t.parent===this)return this;throw new Error("Cannot add a currently attached child to another element.  Detach it first.")}return 0==e?this.children.unshift(t):e>0&&e<=this.children.length-1?this.children.splice(e,0,t):this.children.push(t),t.parent=this,t.dirty=!0,this.dirty=!0,this}removeChild(t){if(!t.parent)return this;if(t.parent!==this)throw new Error("Cannot remove child that is not attached to this widget.");return h.arrayDelete(this.children,t)&&(t.parent=null,t.dirty=!0,this.dirty=!0),this}empty(){this.text("");const t=this.children;return this.children=[],t.forEach((t=>{t.parent=null,t.dirty=!0})),this.dirty=!0,t}root(){let t=this;for(;t.parent;)t=t.parent;return t!==this?t:null}positionedParent(){let t=this.parent;if(t)for(;t&&!["absolute","fixed","relative"].includes(t.used("position"));)t=t.parent;return t||this.root()}get bounds(){return this._bounds}get innerLeft(){return this._bounds.left+(this._usedStyle.padLeft||0)}get innerRight(){return this._bounds.right-(this._usedStyle.padRight||0)}get innerWidth(){return this._bounds.width-(this._usedStyle.padLeft||0)-(this._usedStyle.padRight||0)}get innerHeight(){return this._bounds.height-(this._usedStyle.padTop||0)-(this._usedStyle.padBottom||0)}get innerTop(){return this._bounds.top+(this._usedStyle.padTop||0)}get innerBottom(){return this._bounds.bottom+(this._usedStyle.padBottom||0)}updateLayout(){if(!this.dirty)return this.children.forEach((t=>t.updateLayout())),this;const t=this._usedStyle.position||"static";return"fixed"===t?this._updateLayoutFixed():"relative"===t?this._updateLayoutRelative():"absolute"===t?this._updateLayoutAbsolute():this._updateLayoutStatic(),this}_updateWidth(t=0){const e=this.used(),s=this.bounds;let i=e.width||t;i||(this._lines=h.text.splitIntoLines(this._text,(e.maxWidth||999)-(e.padLeft||0)-(e.padRight||0)),i=this.contentWidth()||h.text.length(this._text));const r=e.maxWidth||i,n=e.minWidth||i;return s.width=h.clamp(i,n,r),this._text.length?s.width?this._lines=h.text.splitIntoLines(this._text,s.width-(e.padLeft||0)-(e.padRight||0)):h.text.length(this._text)&&(this._lines=[this._text]):this._lines=[],this}_updateLeft(t=0,e=0){const s=this._usedStyle;let i=t;if("static"!==s.position)if(s.left)i+=s.left;else if(s.right){i=t+e-s.right-this.bounds.width}return this.bounds.left=i,this}_updateTop(t=0){return this.bounds.top=t,this}_updateHeight(){const t=this._usedStyle,e=this.bounds;e.height=this._lines.length+(t.padTop||0),this.children.forEach((t=>{t.updateLayout(),e.height+=t.bounds.height})),e.height+=t.padBottom||0,t.height&&(e.height=t.height);const s=t.maxHeight||e.height,i=t.minHeight||e.height;return e.height=h.clamp(e.height,i,s),e.height<this._lines.length&&(this._lines.length=e.height),this}applyLayoutOffset(){const t=this._usedStyle;if("static"!==(t.position||"static")){let e=this;if("fixed"===t.position){const t=this.root();t&&(e=t)}else if("absolute"===t.position){const t=this.positionedParent();t&&(e=t)}t.top?this.bounds.top=e.innerTop+t.top:t.bottom&&(this.bounds.bottom=e.innerBottom-t.bottom)}return this.children.forEach((t=>t.applyLayoutOffset())),this}_updateLayoutStatic(){const t=this.parent;return this._updateWidth(t?t.innerWidth:0),this._updateLeft(t?t.innerLeft:0,t?t.innerWidth:0),this._updateTop(t?t.bounds.bottom:0),this._updateHeight(),this.dirty=!1,this}_updateLayoutRelative(){this._updateLayoutStatic(),this.applyLayoutOffset()}_updateLayoutFixed(){const t=this.root();return this._updateWidth(0),this._updateLeft(t?t.innerLeft:0),this._updateTop(t?t.bounds.bottom:0),this._updateHeight(),this.applyLayoutOffset(),this.dirty=!1,this}_updateLayoutAbsolute(){let t=this.positionedParent();return this._updateWidth(0),this._updateLeft(t?t.innerLeft:0),this._updateTop(t?t.bounds.bottom:0),this._updateHeight(),this.applyLayoutOffset(),this.dirty=!1,this}style(...t){if(this._style||(this._style=new k),0===t.length)return this._style;if(1===t.length){const e=t[0];if("string"==typeof e)return this._style.get(e);this._style.set(t[0],!1),this._usedStyle.set(t[0],!1),this.dirty=!0}else this._style.set(t[0],t[1],!1),this._usedStyle.set(t[0],t[1],!1),this.dirty=!0;return this}removeStyle(t){return this._style?(this._style.unset(t),this._usedStyle.dirty=!0,this):this}used(t){return t?t instanceof I?(this._usedStyle=t,this.dirty=!0,this):this._usedStyle.get(t):this._usedStyle}addClass(t){return this.classes.includes(t)||(this.classes.push(t),this._usedStyle.dirty=!0),this}removeClass(t){return h.arrayDelete(this.classes,t)?(this._usedStyle.dirty=!0,this):this}toggleClass(t){return h.arrayDelete(this.classes,t)||this.classes.push(t),this._usedStyle.dirty=!0,this}pos(...t){if(0===t.length)return this.bounds;let e;return e=2==t.length?{left:t[0],top:t[1]}:t[0],void 0!==e.right&&this.style("right",e.right),void 0!==e.left&&this.style("left",e.left),void 0!==e.top&&this.style("top",e.top),void 0!==e.bottom&&this.style("bottom",e.bottom),this}size(t,e){return void 0===t?this.bounds:("number"==typeof t&&(t={width:t,height:e}),void 0!==t.minWidth&&this.style("minWidth",t.minWidth),void 0!==t.minHeight&&this.style("minHeight",t.minHeight),void 0!==t.maxWidth&&this.style("maxWidth",t.maxWidth),void 0!==t.maxHeight&&this.style("maxHeight",t.maxHeight),void 0!==t.width&&this.style("width",t.width),void 0!==t.height&&this.style("height",t.height),this)}text(t){return void 0===t?this._text:(this._text=t,this.dirty=!0,this)}contentWidth(){return this._lines.reduce(((t,e)=>Math.max(t,e.length)),0)}draw(t){const e=this.used("bg"),s=this.bounds;if(t.fillRect(s.x,s.y,s.width,s.height," ",e,e),this.children.length)this.children.forEach((e=>e.draw(t)));else if(this._lines.length){const e=this.used("fg")||"white",s=this.innerTop,i=this.innerWidth,h=this.innerLeft,r=this.used("align");this._lines.forEach(((n,o)=>{t.drawText(h,s+o,n,e,-1,i,r)}))}return!0}}class F{constructor(t,e=[]){this.layer=t,this.selected=e.slice()}get(t){return this.selected[t]}length(){return this.selected.length}add(t){return t instanceof F||(t=this.layer.$(t)),t.forEach((t=>{this.selected.includes(t)||this.selected.push(t)})),this}clone(){return this.selected=this.selected.map((t=>t.clone())),this}forEach(t){return this.selected.forEach(t),this}after(t){if(t instanceof F||(t=this.layer.$(t)),0==t.length())return this;t.detach();let e=t;const s=this.selected.length-1;return this.selected.forEach(((i,h)=>{if(!i.parent)throw new Error("Cannot add after detached widgets.");e=h<s?t.clone():t;const r=i.parent;let n=r.children.indexOf(i)+1;e.forEach((t=>{r.addChild(t,n),r._attached&&this.layer._attach(t)}))})),this}append(t){if(t instanceof F||(t=this.layer.$(t)),0==t.length())return this;t.detach();let e=t;const s=this.selected.length-1;return this.selected.forEach(((i,h)=>{e=h<s?t.clone():t,e.forEach((t=>{i.addChild(t),i._attached&&this.layer._attach(t)}))})),this}appendTo(t){return t instanceof F||(t=this.layer.$(t)),t.append(this),this}before(t){if(t instanceof F||(t=this.layer.$(t)),0==t.length())return this;t.detach();let e=t;const s=this.selected.length-1;return this.selected.forEach(((i,h)=>{if(!i.parent)throw new Error("Cannot add before detached widgets.");e=h<s?t.clone():t;const r=i.parent;let n=r.children.indexOf(i);e.forEach((t=>{r.addChild(t,n++),r._attached&&this.layer._attach(t)}))})),this}detach(){return this.selected.forEach((t=>{if(t._attached){if(!t.parent)throw new Error("Cannot detach root widget.");t.parent.removeChild(t),this.layer._detach(t)}})),this}empty(){return this.selected.forEach((t=>{const e=t.empty();this.layer._detach(e)})),this}insertAfter(t){return t instanceof F||(t=this.layer.$(t)),t.after(this),this}insertBefore(t){return t instanceof F||(t=this.layer.$(t)),t.before(this),this}prepend(t){if(t instanceof F||(t=this.layer.$(t)),0==t.length())return this;t.detach();let e=t;const s=this.selected.length-1;return this.selected.forEach(((i,h)=>{e=h<s?t.clone():t,e.forEach((t=>{i.addChild(t,0),i._attached&&this.layer._attach(t)}))})),this}prependTo(t){return t instanceof F||(t=this.layer.$(t)),t.prepend(this),this}remove(t){return this.detach()}replaceAll(t){return t instanceof F||(t=this.layer.$(t)),t.before(this),t.detach(),this}replaceWith(t){return t instanceof F||(t=this.layer.$(t)),t.replaceAll(this),this}text(t){var e;return t?(this.selected.forEach((e=>e.text(t))),this):null===(e=this.selected[0])||void 0===e?void 0:e.text()}addClass(t){return this.selected.forEach((e=>e.addClass(t))),this}hasClass(t){return 0!=this.selected.length&&this.selected[0].classes.includes(t)}removeClass(t){return this.selected.forEach((e=>e.removeClass(t))),this}toggleClass(t){return this.selected.forEach((e=>e.toggleClass(t))),this}style(t,e){return t?void 0===e&&"string"==typeof t?this.selected[0].style(t):(this.selected.forEach((s=>{"string"==typeof t?s.style(t,e):s.style(t)})),this):this.selected[0].style()}removeStyle(t){return this.selected.forEach((e=>e.removeStyle(t))),this}animate(t,e){return this}clearQueue(t){return this}delay(t,e){return this}dequeue(){return this}fadeIn(t){return this}fadeOut(t){return this}fadeTo(t,e){return this}fadeToggle(t){return this}finish(t){return this}hide(t){return this}queue(...t){return[]}show(t){return this}slideDown(t){return this}slideToggle(t){return this}slideUp(t){return this}stop(){return this}toggle(t){return this}on(t,e){return this}off(t){return this}click(t){return this}keypress(t){return this}dir(t){return this}mouseenter(t){return this}mouseleave(t){return this}mousemove(t){return this}}var W=Object.freeze({__proto__:null,Callbacks:class{constructor(t){this._items=[],this._disabled=!1,this._fired=!1,this._once=!1,this._stopOnFalse=!1,this._unique=!1;const e=t.split(" ");this._once=e.includes("once"),this._stopOnFalse=e.includes("stopOnFalse"),this._unique=e.includes("unique")}add(t){return Array.isArray(t)?t.forEach((t=>this.add(t))):this._unique&&this._items.includes(t)||this._items.push(t),this}disable(){return this._disabled=!0,this}disabled(){return!this._disabled}empty(){return this._items.length=0,this}async fire(...t){if(this._disabled)return this;if(this._once&&this._fired)return this;this._fired=!0;for(let e of this._items){const s=await e(...t);if(this._stopOnFalse&&!1===s)break}return this}fired(){return this._fired}async fireWith(t,e){if(this._disabled)return this;if(this._once&&this._fired)return this;this._fired=!0;for(let s of this._items){const i=await s.apply(t,e);if(this._stopOnFalse&&!1===i)break}return this}has(t){return this._items.includes(t)}remove(t){const e=this._items.indexOf(t);return e>=0&&this._items.splice(e,1),this}},isTruthy:B,Selector:T,selector:function(t){return new T(t)},Style:k,ComputedStyle:I,Sheet:A,Element:L,Document:class{constructor(t,e="body"){this.ui=t,this.stylesheet=new A,this.body=new L(e),this.body.style({width:t.buffer.width,maxWidth:t.buffer.width,height:t.buffer.height,maxHeight:t.buffer.height,position:"fixed",top:0,left:0}),this.body._attached=!0,this.children=[this.body]}$(t){return this.select(t)}select(t){let e;if(void 0===t)e=[this.body];else{if(t instanceof F)return t;if("string"==typeof t)if(t.startsWith("<"))e=[this.createElement(t)];else if("document"===t)e=[this.body];else{const s=new T(t);e=this.children.filter((t=>s.matches(t)))}else e=Array.isArray(t)?t:[t]}return new F(this,e)}createElement(t){if(t.startsWith("<")){if(!t.endsWith(">"))throw new Error('Need brackets around new tag - e.g. "<tag>"');t=t.substring(1,t.length-1)}return new L(t,this.stylesheet)}create(t){return this.select(this.createElement(t))}rule(t,e){if("string"==typeof t){if(e)return this.stylesheet.add(t,e),this;let s=this.stylesheet.get(t);return s||this.stylesheet.add(t,{})}return Object.entries(t).forEach((([t,e])=>{this.stylesheet.add(t,e)})),this}removeRule(t){return this.stylesheet.remove(t),this}_attach(t){return Array.isArray(t)?(t.forEach((t=>this._attach(t))),this):(this.children.includes(t)||(this.children.push(t),t._attached=!0,t.children.forEach((t=>this._attach(t)))),this)}_detach(t){if(Array.isArray(t))return t.forEach((t=>this._detach(t))),this;if(t===this.body)throw new Error("Cannot detach root widget.");return h.arrayDelete(this.children,t),t._attached=!1,t.children.forEach((t=>this._detach(t))),this}computeStyles(){this.children.forEach((t=>{(t.used().dirty||this.stylesheet.dirty)&&t.used(this.stylesheet.computeFor(t))})),this.stylesheet.dirty=!1}updateLayout(t){(t=t||this.body).updateLayout()}draw(t){this.computeStyles(),this.updateLayout(),t=t||this.ui.buffer,this.body.draw(t),t.render()}},Selection:F});t.ActionButton=v,t.ActorEntry=y,t.Box=c,t.Button=a,t.CellEntry=x,t.Column=l,t.Dialog=g,t.DialogBuilder=f,t.DropDownButton=_,t.EntryBase=p,t.Flavor=class extends o{constructor(t,e){super(t,e)}init(t){t.fg=t.fg||"flavorText",t.bg=t.bg||"black",super.init(t),this.promptFg=h.color.from(t.promptFg||"flavorPrompt"),this.overflow=t.overflow||!1,this.isPrompt=!1}showText(t){this.text=h.text.capitalize(t);h.text.length(this.text)>this.bounds.width?(this.lines=h.text.splitIntoLines(this.text,this.bounds.width),!this.overflow&&this.lines.length>this.bounds.height&&(1==this.bounds.height?(this.text=h.text.truncate(this.text,this.bounds.width),this.lines=[this.text]):this.lines.length=this.bounds.height)):this.lines=[this.text],this.isPrompt=!1}clear(){this.text="",this.lines=[""],this.isPrompt=!1}showPrompt(t){this.showText(t),this.isPrompt=!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),super.draw(t)}getFlavorText(t,e,s,i){const n=t.cell(e,s);let o,a="";const d=!i||i.isAnyKindOfVisible(e,s),l=!i||i.isDirectlyVisible(e,s),u=!!i&&i.isRevealed(e,s),c=!!i&&i.isMagicMapped(e,s);let g;if(l)g="you see";else if(d)g="you sense";else if(u)g="you remember";else{if(!c)return"";g="you expect to see"}const f=n.hasActor()?t.actorAt(e,s):null,b=n.hasItem()?t.itemAt(e,s):null,p=n.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let y=!1;f?(a=f.getFlavor({color:!1,article:!0,action:!0}),y=!0):b&&(a=b.getFlavor({color:!1,article:!0}),y=!0);let w=p?" in ":" on ";const x=n.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,m=n.depthTile(r.flags.Depth.SURFACE),v=n.depthTile(r.flags.Depth.LIQUID);let _="";if(m){y&&(y=!1,a+=" on "),m.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(w=" over "),_=m.getFlavor()+w}let E="";v&&(E=v.getFlavor()+" covering ",y&&(y=!1,a+=" in ")),y&&(y=!1,a+=" on ");let B=x.getFlavor({article:!0});return o=h.text.apply("§intro§ §text§.",{intro:g,text:a+_+E+B}),o}},t.Input=d,t.ItemEntry=w,t.List=class extends u{constructor(t,e){super(t,(()=>{const t=e;return t.columns=[e],t.headers=!!e.header,t.hover=!1===e.hover?"none":"row",t})())}},t.Menu=class extends n{constructor(t,e){super(t,e),this.activeIndex=-1,this.actionButton=null}init(t){t.fg=h.first(t.fg,"black"),t.bg=h.first(t.bg,"light_gray"),t.height=t.height||1,t.tabStop=h.first(t.tabStop,!0),super.init(t),this.dropFg=h.color.from(t.dropFg||this.fg),this.dropBg=h.color.from(t.dropBg||this.bg),this.buttons=[],this.separator=t.separator||" | ",this.lead=t.lead||" ",Object.entries(t.buttons).forEach((([t,e])=>{this._addButton(t,e)})),t.separator&&(this.separator=t.separator),void 0!==t.lead&&(this.lead=t.lead?t.lead:"")}reset(){super.reset();const t=this.bounds.y<=10;this.buttons.forEach((e=>{e instanceof _&&(t?e.bounds.top=this.bounds.bottom+1:e.bounds.bottom=this.bounds.top-1)}))}activate(t=!1){super.activate(t),this.activeIndex<0&&(this.activeIndex=t?this.buttons.length-1:0)}deactivate(){super.deactivate(),this.activeIndex=-1}mousemove(t,e){if(this.buttons.forEach((t=>{t.hovered&&(t.hovered=!1)})),!super.mousemove(t,e))return!1;if(this.bounds.contains(t)){let s=null;return this.buttons.forEach((e=>{e.hovered=!1,e.x<t.x&&(s=e)})),s&&(s.hovered=!0,this.activeIndex=this.buttons.indexOf(s)),e&&e.requestRedraw(),!0}return!1}clearHighlight(){this.buttons.forEach((t=>{t.hovered=!1}))}getButtonAt(t,e){return h.arrayFindRight(this.buttons,(e=>e.x<t))||null}async click(t,e){if(this.bounds.contains(t)){let s=this.getButtonAt(t.x,t.y);return!!s&&(this.activeIndex=this.buttons.indexOf(s),s instanceof _?await E(e,this,s):s instanceof v&&(this.actionButton=s,await e.fireAction(s.action,this)),!0)}return!1}async keypress(t,e){if(this.active){if("Tab"===t.key)return++this.activeIndex,!(this.activeIndex>=this.buttons.length)||(this.deactivate(),!1);if("TAB"===t.key)return--this.activeIndex,!(this.activeIndex<0)||(this.deactivate(),!1);if("Enter"===t.key){const t=this.buttons[this.activeIndex];return t instanceof _?await E(e,this,t):t instanceof v&&(this.actionButton=t,await e.fireAction(t.action,this)),!0}}return super.keypress(t,e)}_addButton(t,e){const s=this.buttons.reduce(((t,e)=>t+e.text.length+this.separator.length),this.lead.length+this.bounds.x);if(s+t.length+this.separator.length>this.bounds.width)throw new Error("Button makes menu too wide :"+t);let i;if("string"==typeof e)i=new v(t,e);else{const h=new _(this,null,t,e);h.bounds.x=s-1,i=h}i.x=s,this.buttons.push(i)}draw(t){const e=this.active?this.activeBg:this.bg,s=this.active?this.activeFg:this.fg;t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,1,0,e,e);let i=this.bounds.x;const h=this.bounds.y;return t.drawText(i,h,this.lead,s),this.buttons.forEach(((r,n)=>{const o=n===this.activeIndex,a=o?this.hoverFg:s,d=o?this.hoverBg:e;t.drawText(r.x,h,r.text,a,d),i=r.x+r.text.length,t.drawText(i,h,this.separator,s)})),!0}},t.MenuButton=m,t.Messages=class extends n{constructor(t,e){super(t,e)}init(t){if(t.x=t.x||0,t.y=t.y||0,super.init(t),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:t.length||40,match:(t,e)=>!0})}click(t,e){return!!this.contains(t)&&this.showArchive(e).then((()=>!0))}draw(t){const e=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),this.cache.forEach(((s,i,h)=>{if(h>=this.bounds.height)return;const r=(e?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,r,s,this.fg),i&&t.mix(this.bg,50,this.bounds.x,r,this.bounds.width,1)})),!0}async showArchive(t){let e,s,i=0;const r=t.ui;let n=this.cache.length;if(n<=this.bounds.height)return!1;const o=this.bounds.y<10,a=r.startLayer(),d=h.color.from(this.fg);for(n=Math.min(n,o?a.height-this.bounds.top:this.bounds.bottom),e=0;e<=1;e++){s=!1;const t=e?-1:1,h=e?n:this.bounds.height,l=e?this.bounds.height+t+1:n+t;for(let n=h;n!=l;n+=t){const h=o?this.bounds.y+n-1:this.bounds.bottom-n,u=o?this.bounds.y:this.bounds.bottom,c=o?-1:1;r.resetLayerBuffer(),a.fillRect(this.bounds.x,Math.min(h,u),this.bounds.width,n," ",this.bg,this.bg),this.cache.forEach(((t,e,s)=>{const r=h+s*c;if(o){if(r<u)return}else if(r>u)return;i=Math.floor(50*s/n);const l=d.clone().mix(this.bg,i);a.drawText(this.bounds.x,r,t,l,this.bg)})),a.render(),s||await r.loop.pause(e?15:45)&&(s=!0,n=l-2*t)}if(!e){const t=o?0:a.height-1,e=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,a.width-8);a.wrapText(e,t,8,"--DONE--",this.bg,this.fg),a.render(),await r.loop.waitForAck()}}return r.finishLayer(),this.cache.confirmAll(),t.requestRedraw(),!0}},t.Sidebar=class extends n{constructor(t,e){super(t,e),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}init(t){t.fg=t.fg||"purple",t.bg=t.bg||"black",super.init(t)}reset(){super.reset(),this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((e=>e.sidebarY<=t.y&&-1!==e.sidebarY))||null}mousemove(t,e){return super.mousemove(t,e),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const e=this.highlight;return this.highlight=null,this.entries.forEach((e=>{e.sidebarY<=t&&-1!==e.sidebarY&&(this.highlight=e)})),this.highlight!==e}clearHighlight(){const t=!!this.highlight;return this.highlight=null,t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((e,s)=>{const i=t.cell(e,s);i.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(i)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new y(t)}_makeItemEntry(t){return new w(t)}_makeCellEntry(t){return new x(t)}_getPriority(t,e,s,i){return i?i.isDirectlyVisible(e,s)?1:i.isAnyKindOfVisible(e,s)?2:i.isRevealed(e,s)?3:-1:t.cell(e,s).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,e,s,i,r){const n=this._getPriority(e,t.x,t.y,r);if(n<0)return!1;const o=this._makeActorEntry(t);return o.dist=h.xy.distanceBetween(s,i,t.x,t.y),o.priority=t.isPlayer()?0:n,this.entries.push(o),!0}_addItemEntry(t,e,s,i,r){const n=this._getPriority(e,t.x,t.y,r);if(n<0)return!1;const o=this._makeItemEntry(t);return o.dist=h.xy.distanceBetween(s,i,t.x,t.y),o.priority=n,this.entries.push(o),!0}_addCellEntry(t,e,s,i,r){const n=this._getPriority(e,t.x,t.y,r);if(n<0)return!1;const o=this._makeCellEntry(t);return o.dist=h.xy.distanceBetween(s,i,t.x,t.y),o.priority=n,this.entries.push(o),!0}findEntries(t,e,s,i){if(t===this.lastMap&&e===this.lastX&&s===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=e,this.lastY=s,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const n=h.x,o=h.y;r[n][o]||this._addActorEntry(h,t,e,s,i)&&(r[n][o]=1)})),t.eachItem((h=>{const n=h.x,o=h.y;r[n][o]||this._addItemEntry(h,t,e,s,i)&&(r[n][o]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,e,s,i)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,e)=>t.priority!=e.priority?t.priority-e.priority:t.dist-e.dist)),h.grid.free(r)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,e,s,i){return this.updateCellCache(t),this.findEntries(t,e,s,i),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg),this.entries.forEach((t=>t.sidebarY=-1));const e=this.bounds.clone();let s;for(let i=0;i<this.entries.length&&e.height>0;++i){s=this.entries[i],s.sidebarY=e.y;let h=s.draw(t,e);this._isDim(s)&&t.mix(this.bg,50,e.x,e.y,e.width,h),h&&(++h,e.y+=h,e.height-=h)}return!0}},t.Table=u,t.Text=o,t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}get baseBuffer(){return this.layers[this.layers.length-1]||this.canvas.buffer}get canvasBuffer(){return this.canvas.buffer}startLayer(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||this.canvas.buffer.clone(),this.buffer.copy(t),this.buffer.changed=!1,this.buffer}resetLayerBuffer(){const t=this.baseBuffer;this.buffer.copy(t),this.buffer.changed=!1}finishLayer(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.changed=!0,this.buffer.render(),this.inDialog=this.layers.length>0)}async fadeTo(t="black",e=1e3){t=h.color.from(t);const s=this.startLayer();let i=0,r=0;for(;r<e;)r+=32,await this.loop.pause(32)&&(r=e),i=Math.floor(100*r/e),this.resetLayerBuffer(),s.mix(t,i),s.render();this.finishLayer()}async alert(t,e,s){"number"==typeof t&&(t={duration:t}),s&&(e=h.text.apply(e,s));const i=t.width||h.text.length(e);t.box=t.box||{bg:t.bg};const r={fg:t.fg,text:e,x:0,y:0,wrap:i},n=new o("TEXT",r),a=b(this,i,n.bounds.height).with(n,{x:0,y:0}).addBox(t.box).center().done();return a.setEventHandlers({click:()=>a.close(!0),keypress:()=>a.close(!0),TIMEOUT:()=>a.close(!1)}),t.waitForAck||a.setTimeout("TIMEOUT",t.duration||3e3),await a.show()}async confirm(...t){let e,s,i=null;t.length<=2&&"string"==typeof t[0]?(e={},s=t[0],i=t[1]||null):(e=t[0],s=t[1],i=t[2]||null),i&&(s=h.text.apply(s,i));const r=e.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(s)),n={fg:e.fg,text:s,wrap:r},d=new o("TEXT",n),l=d.bounds.height+2;e.allowCancel=!1!==e.allowCancel,e.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},e.buttons||{}),"string"==typeof e.ok&&(e.ok={text:e.ok}),"string"==typeof e.cancel&&(e.cancel={text:e.cancel}),e.ok=e.ok||{},e.cancel=e.cancel||{};const u=Object.assign({},e.buttons,{text:"OK"},e.ok),c=Object.assign({},e.buttons,{text:"CANCEL"},e.cancel),g=b(this,r,l).with(d,{x:0,y:0}).with(new a("OK",u),{x:0,bottom:0});e.allowCancel&&g.with(new a("CANCEL",c),{right:0,bottom:0});const f=g.center().addBox(e.box).done();return f.setEventHandlers({OK(){f.close(!0)},CANCEL(){f.close(!1)},Escape(){f.close(!1)},Enter(){f.close(!0)}}),await f.show()}async showWidget(t,e={}){const s=t.bounds.x<0||t.bounds.y<0,i={x:t.bounds.x,y:t.bounds.y},h=b(this).with(t,{x:0,y:0});s?h.center():h.place(i.x,i.y);const r=h.done();return e.Escape=e.Escape||(()=>{r.close(!1)}),r.setEventHandlers(e),await r.show()}async getInputAt(t,e,s,i={}){i.width=s,i.x=t,i.y=e;const h=new d("INPUT",i);return this.showWidget(h,{INPUT(t,e){e.close(h.text)},Escape(t,e){e.close("")}})}async inputBox(t,e,s){s&&(e=h.text.apply(e,s));const i=t.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(e)),r={fg:t.fg,text:e,wrap:i},n=new o("TEXT",r),l=n.bounds.height+2+2;t.allowCancel=!1!==t.allowCancel,t.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},t.buttons||{}),"string"==typeof t.ok&&(t.ok={text:t.ok}),"string"==typeof t.cancel&&(t.cancel={text:t.cancel}),t.ok=t.ok||{},t.cancel=t.cancel||{};const u=Object.assign({},t.buttons,{text:"OK"},t.ok),c=Object.assign({},t.buttons,{text:"CANCEL"},t.cancel);t.input=t.input||{},t.input.width=t.input.width||i,t.input.bg=t.input.bg||t.fg,t.input.fg=t.input.fg||t.bg;const g=new d("INPUT",t.input||{}),f=b(this,i,l).with(n,{x:0,y:0}).with(g,{bottom:2,x:0}).with(new a("OK",u),{bottom:0,x:0}).addBox(t.box);t.allowCancel&&f.with(new a("CANCEL",c),{bottom:0,right:0});const p=f.center().done();return p.setEventHandlers({OK(){p.close(g.text)},CANCEL(){p.close("")},Escape(){p.close("")},INPUT(){p.close(g.text)}}),await p.show()}},t.Viewport=class extends n{constructor(t,e){super(t,e),this.offsetX=0,this.offsetY=0,this._subject=null}init(t){t.bg=t.bg||"black",t.x=t.x||0,t.y=t.y||0,super.init(t),this.snap=t.snap||!1,this.center=t.center||!1,this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}get subject(){return this._subject}set subject(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t}set lock(t){this.lockX=t,this.lockY=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,e,s){this.center=!0,this.subject={x:e,y:s,map:t}}showMap(t,e=0,s=0){this.subject={x:e,y:s,map:t},this.offsetX=e,this.offsetY=s,this.center=!1,this.snap=!1}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,e=t.memory||t.map,s=e;if(t&&e.hasXY(t.x,t.y))if(this.snap){let e=this.offsetX,i=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<e||t.x>i)&&(e=this.offsetX=t.x-this.halfWidth(),i=e+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const n=Math.floor(this.bounds.width/5),o=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);e+n>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):i-n<=t.x&&(this.offsetX=Math.min(t.x-a,s.width-this.bounds.width));const d=Math.floor(this.bounds.height/3);h+o>=t.y?this.offsetY=Math.max(0,t.y+d-this.bounds.height):r-o<=t.y&&(this.offsetY=Math.min(t.y-d,s.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&e&&(this.offsetX=h.clamp(this.offsetX,0,e.width-this.bounds.width)),this.lockY&&e&&(this.offsetY=h.clamp(this.offsetY,0,e.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this.bg),!this._subject)return!1;this.updateOffset();const e=this._subject.memory||this._subject.map,s=this._subject.fov,i=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let r=0;r<this.bounds.height;++r){const n=h+this.offsetX,o=r+this.offsetY;if(e.hasXY(n,o)){const t=e.cell(n,o);e.drawer.drawCell(i,t,s)}else i.draw(" ",this.bg,this.bg);this.filter&&this.filter(i,n,o,e),t.drawSprite(h+this.bounds.x,r+this.bounds.y,i)}return!0}},t.Widget=n,t.buildDialog=b,t.html=W,t.makeTable=function(t,e){return new u(t,e)},t.showDropDown=E,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
