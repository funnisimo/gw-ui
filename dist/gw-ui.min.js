!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,i){"use strict";function e(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var e=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(s,i,e.get?e:{enumerable:!0,get:function(){return t[i]}})}})),s.default=t,Object.freeze(s)}var h=e(s),o=e(i);h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class r{constructor(){this.dist=0,this.priority=0,this.changed=!1}}class n extends r{constructor(t){super(),this.actor=t}}class a extends r{constructor(t){super(),this.item=t}}class l extends r{constructor(t){super(),this.cell=t}}t.ActorEntry=n,t.CellEntry=l,t.EntryBase=r,t.Flavor=class{constructor(t){var s,i,e;this.text="",this.needsUpdate=!1,this.isPrompt=!1,this.overflow=!1,this.ui=t.ui,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,1),this.fg=h.color.from(null!==(s=t.fg)&&void 0!==s?s:"flavorText"),this.bg=h.color.from(null!==(i=t.bg)&&void 0!==i?i:"black"),this.promptFg=h.color.from(null!==(e=t.promptFg)&&void 0!==e?e:"flavorPrompt")}showText(t){this.text=h.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!1,this.draw()}clear(){this.text="",this.needsUpdate=!0,this.isPrompt=!1,this.draw()}showPrompt(t){this.text=h.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!0,this.draw()}draw(t=!1){if(!t&&!this.needsUpdate)return!1;const s=this.ui.buffer,i=this.isPrompt?this.fg:this.promptFg,e=s.wrapText(this.bounds.x,this.bounds.y,this.bounds.width,this.text,i,this.bg);return this.overflow=e!==this.bounds.y+1,this.ui.render(),this.needsUpdate=!1,!0}getFlavorText(t,s,i){const e=t.knowledge(s,i);let r,n="";const a=t.fov.isAnyKindOfVisible(s,i),l=t.fov.isDirectlyVisible(s,i)||!t.fov.isEnabled&&a,f=t.fov.isRevealed(s,i),u=t.fov.isMagicMapped(s,i);let c;if(l)c="you see";else if(a)c="you sense";else if(f)c="you remember";else{if(!u)return"";c="you expect to see"}const d=e.actor||null,b=e.item,g=e.hasTileFlag(o.flags.Tile.T_STAND_IN_TILE);let p=!1;d?(n=d.getFlavor({color:!1,article:!0,action:!0}),p=!0):b&&(n=b.getFlavor({color:!1,article:!0}),p=!0);let y=g?" in ":" on ";const w=e.depthTile(o.flags.Depth.GROUND)||o.tile.tiles.NULL,x=e.depthTile(o.flags.Depth.SURFACE),m=e.depthTile(o.flags.Depth.LIQUID);let v="";if(x){p&&(p=!1,n+=" on "),x.hasTileFlag(o.flags.Tile.T_BRIDGE)&&(y=" over "),v=x.getFlavor()+y}let M="";m&&(M=m.getFlavor()+" covering ",p&&(p=!1,n+=" in ")),p&&(p=!1,n+=" on ");let E=w.getFlavor({article:!0});return r=h.text.apply("§intro§ §text§.",{intro:c,text:n+v+M+E}),r}},t.ItemEntry=a,t.Messages=class{constructor(t){const s=t.ui.buffer;this.bounds=new h.xy.Bounds(t.x,t.y,Math.min(t.width||s.width,s.width-t.x),Math.min(t.height||s.height,s.height-t.y)),this.cache=new h.message.MessageCache({width:this.bounds.width,length:s.height}),this.ui=t.ui,this.bg=h.color.from(t.bg||"black"),this.fg=h.color.from(t.fg||"white")}contains(t,s){return this.bounds.contains(t,s)}get needsUpdate(){return this.cache.needsUpdate}get buffer(){return this.ui.buffer}draw(t=!1){if(!t&&!this.cache.needsUpdate)return!1;let s;const i=h.color.make(),e=this.bounds.y<10;return this.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",0,this.bg),this.cache.forEach(((t,o,r)=>{if(r>=this.bounds.height)return;s=i,s.copy(this.fg),o&&(s.mix(this.bg,50),s.mix(this.bg,75*r/(2*this.bounds.height)));const n=e?this.bounds.height-r-1:r,a=this.toBufferY(n);h.text.eachChar(t,((t,e,h,n)=>{const l=this.toBufferX(n);e&&s!==e&&o&&(e.mix(this.bg,50),e.mix(this.bg,75*r/(2*this.bounds.height))),s=e||i,this.buffer.draw(l,a,t,s,this.bg)}))})),this.cache.needsUpdate=!1,!0}toBufferY(t){return this.bounds.y+t}toBufferX(t){return this.bounds.x+t}async showArchive(){let t,s,i,e=0,h=0;if(this.cache.forEach((()=>++h)),h<=this.bounds.height)return;const o=this.bounds.y<10,r=this.ui.startDialog();for(t=0;t<=1;t++){for(i=!1,e=t?h:this.bounds.height;t?e>=this.bounds.height:e<=h;e+=t?-1:1)this.ui.resetDialogBuffer(r),this.cache.forEach(((t,i,h)=>{if(h>=e||h>=r.height)return;const n=o?h:r.height-h-1;s=Math.floor(50*(e-h)/e);const a=this.fg.clone().mix(this.bg,s);r.wrapText(this.toBufferX(0),n,this.bounds.width,t,a,this.bg)})),r.render(),!i&&await this.ui.loop.pause(t?15:45)&&(i=!0,e=t?this.bounds.height+1:h-1);if(!t){const t=o?0:r.height-1,s=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,this.buffer.width-8);r.wrapText(s,t,8,"--DONE--",this.bg,this.fg),r.render(),await this.ui.loop.waitForAck()}}this.ui.finishDialog(),this.cache.confirmAll(),this.cache.needsUpdate=!0}},t.Sidebar=class{constructor(t){this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.ui=t.ui,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.bg=h.color.from(t.bg||"black")}contains(t,s){return this.bounds.contains(t,s)}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(o.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((s,i)=>{const e=t.knowledge(s,i);e.hasEntityFlag(o.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(e)})),t.clearMapFlag(o.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}makeActorEntry(t){return new n(t)}makeItemEntry(t){return new a(t)}makeCellEntry(t){return new l(t)}getPriority(t,s,i){return t.fov.isDirectlyVisible(s,i)?1:t.fov.isAnyKindOfVisible(s,i)?2:t.fov.isRevealed(s,i)?3:-1}addActor(t,s,i,e){const o=this.getPriority(s,t.x,t.y);if(o<0)return!1;const r=this.makeActorEntry(t);return r.dist=h.xy.distanceBetween(i,e,t.x,t.y),r.priority=t.isPlayer()?0:o,this.entries.push(r),!0}addItem(t,s,i,e){const o=this.getPriority(s,t.x,t.y);if(o<0)return!1;const r=this.makeItemEntry(t);return r.dist=h.xy.distanceBetween(i,e,t.x,t.y),r.priority=o,this.entries.push(r),!0}addCell(t,s,i,e){const o=this.getPriority(s,t.x,t.y);if(o<0)return!1;const r=this.makeCellEntry(t);return r.dist=h.xy.distanceBetween(i,e,t.x,t.y),r.priority=o,this.entries.push(r),!0}findEntries(t,s,i){if(t===this.lastMap&&s===this.lastX&&i===this.lastY)return;this.lastMap=t,this.lastX=s,this.lastY=i,this.entries.length=0;const e=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const o=h.lastSeen?h.lastSeen.x:h.x,r=h.lastSeen?h.lastSeen.y:h.y;e[o][r]||this.addActor(h,t,s,i)&&(e[o][r]=1)})),t.eachItem((h=>{const o=h.lastSeen?h.lastSeen.x:h.x,r=h.lastSeen?h.lastSeen.y:h.y;e[o][r]||this.addItem(h,t,s,i)&&(e[o][r]=1)})),this.cellCache.forEach((h=>{e[h.x][h.y]||this.addCell(h,t,s,i)&&(e[h.x][h.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),h.grid.free(e)}clearSidebar(){this.ui.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg)}update(t,s,i){return this.updateCellCache(t),this.findEntries(t,s,i),this.clearSidebar(),!0}},t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}startDialog(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||new h.canvas.Buffer(this.canvas),this.buffer.copy(t),this.buffer}resetDialogBuffer(t){const s=this.layers[this.layers.length-1]||this.canvas.buffer;t.copy(s)}finishDialog(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.render(),this.inDialog=this.layers.length>0)}},t.Viewport=class{constructor(t){this.follow=!1,this.snap=!1,this.filter=null,this.offsetX=0,this.offsetY=0,this.lockX=!1,this.lockY=!1,this.ui=t.ui,this.follow=t.follow||!1,this.snap=t.snap||!1,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}contains(t,s){return this.bounds.contains(t,s)}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}draw(t,s,i){if(!t)return!1;if(this.follow&&void 0!==s&&void 0!==i)this.offsetX=s-this.halfWidth(),this.offsetY=i-this.halfHeight();else if(this.snap&&void 0!==s&&void 0!==i){const e=this.offsetX,h=this.offsetX+this.bounds.width,o=this.offsetY,r=this.offsetY+this.bounds.height,n=Math.floor(this.bounds.width/5),a=Math.floor(this.bounds.height/5),l=Math.floor(this.bounds.width/3);e+n>=s?this.offsetX=Math.max(0,s+l-this.bounds.width):h-n<=s&&(this.offsetX=Math.min(s-l,t.width-this.bounds.width));const f=Math.floor(this.bounds.height/3);o+a>=i?this.offsetY=Math.max(0,i+f-this.bounds.height):r-a<=i&&(this.offsetY=Math.min(i-f,t.height-this.bounds.height))}else void 0!==s&&void 0!==i&&(this.offsetX=s,this.offsetY=i);this.lockX&&(this.offsetX=h.clamp(this.offsetX,0,t.width-this.bounds.width)),this.lockY&&(this.offsetY=h.clamp(this.offsetY,0,t.height-this.bounds.height));const e=new h.sprite.Mixer;for(let s=0;s<this.bounds.width;++s)for(let i=0;i<this.bounds.height;++i){const h=s+this.offsetX,o=i+this.offsetY;t.hasXY(h,o)?t.getAppearanceAt(h,o,e):e.blackOut(),this.filter&&this.filter(e,h,o,t),this.ui.buffer.drawSprite(s+this.bounds.x,i+this.bounds.y,e)}return!0}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
