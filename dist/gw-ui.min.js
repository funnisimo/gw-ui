!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,i){"use strict";function e(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var e=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(s,i,e.get?e:{enumerable:!0,get:function(){return t[i]}})}})),s.default=t,Object.freeze(s)}var h=e(s),r=e(i);h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class o{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t){}}class n extends o{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t){this.actor.drawStatus(t)}}class a extends o{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t){this.item.drawStatus(t)}}class u extends o{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t){this.cell.drawStatus(t)}}class l{constructor(t){this.hovered=!1,this.x=999,this.text=t}get width(){return this.text.length}}class d extends l{constructor(t,s){super(t),this.fn=s}activate(){return this.fn(this)}}class f extends l{constructor(t,s,i,e){super(i),this.buttons=[],this.parent=null,this.menu=t,this.parent=s,this.text=i,this.bounds=new h.xy.Bounds(0,0,0,0),Object.entries(e).forEach((([t,s])=>{this.addButton(t,s)})),this.buttons.forEach(((t,s)=>{t instanceof f&&t.setBounds(this.bounds.x,this.bounds.y+s,this.bounds.width)}))}addButton(t,s){if(this.buttons.length>=this.menu.ui.buffer.height-1)throw new Error("Too many menu options.");let i;i="function"==typeof s?new d(t,s):new f(this.menu,this,t,s),this.buttons.push(i),++this.bounds.height,this.bounds.width=Math.max(this.bounds.width,t.length+2)}setBounds(t,s,i){const e=t+i,h=t,r=this.menu.ui.buffer.width;if(this.bounds.width<r-e)this.bounds.x=e;else{if(!(this.bounds.width<h))throw new Error("Menu does not fit - too wide.");this.bounds.x=h-this.bounds.width}const o=this.menu.ui.buffer.height;if(this.bounds.height<=o-s)this.bounds.y=s;else{if(!(this.bounds.height<o))throw new Error("Menu does not fit - too tall.");this.bounds.y=o-this.bounds.height-1}}contains(t){return this.bounds.contains(t.x,t.y)}buttonAt(t){const s=t.y-this.bounds.y;return this.buttons[s]||null}drawInto(t){const s=this.bounds.width,i=this.bounds.height,e=this.bounds.x;let h=this.bounds.y;t.fillRect(e,h,s,i,0,0,this.menu.hoverBg),this.buttons.forEach((s=>{t.drawText(e,h,s.text,s.hovered?this.menu.hoverFg:this.menu.fg),++h})),this.parent&&this.parent.drawInto(t)}}async function c(t,s){const i=s.menu.ui,e=i.startDialog();let h=s;await i.loop.run({mousemove:s=>{if(!h)return!0;let i=h;for(;i&&!i.contains(s);)i=i.parent;if(i){h=i;const t=h.buttonAt(s);t&&(h.buttons.forEach((t=>{t.hovered=!1})),t.hovered=!0)}else if(t.contains(s)){t.needsRedraw=!0;const i=t.getButtonAt(s.x,s.y);i instanceof f?(h.hovered=!1,h=i,h.hovered=!0):(h=null,i&&(i.hovered=!0))}return!h},click:async t=>{if(!h)return!0;if(!h.contains(t))return!0;const s=h.buttonAt(t);return!s||(s instanceof d?s.activate():void 0)},draw:()=>{h&&(i.resetDialogBuffer(e),h.drawInto(e),t.drawInto(e),e.render())}}),i.finishDialog(),t.needsRedraw=!0}t.ActionButton=d,t.ActorEntry=n,t.Button=l,t.CellEntry=u,t.DropDownButton=f,t.EntryBase=o,t.Flavor=class{constructor(t){var s,i,e;this.text="",this.needsUpdate=!1,this.isPrompt=!1,this.overflow=!1,this.ui=t.ui,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,1),this.fg=h.color.from(null!==(s=t.fg)&&void 0!==s?s:"flavorText"),this.bg=h.color.from(null!==(i=t.bg)&&void 0!==i?i:"black"),this.promptFg=h.color.from(null!==(e=t.promptFg)&&void 0!==e?e:"flavorPrompt")}showText(t){this.text=h.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!1,this.draw()}clear(){this.text="",this.needsUpdate=!0,this.isPrompt=!1,this.draw()}showPrompt(t){this.text=h.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!0,this.draw()}draw(t=!1){if(!t&&!this.needsUpdate)return!1;const s=this.ui.buffer,i=this.isPrompt?this.fg:this.promptFg,e=s.wrapText(this.bounds.x,this.bounds.y,this.bounds.width,this.text,i,this.bg);return this.overflow=e!==this.bounds.y+1,this.ui.render(),this.needsUpdate=!1,!0}getFlavorText(t,s,i,e){const o=t.cell(s,i);let n,a="";const u=!e||e.isAnyKindOfVisible(s,i),l=!e||e.isDirectlyVisible(s,i),d=!!e&&e.isRevealed(s,i),f=!!e&&e.isMagicMapped(s,i);let c;if(l)c="you see";else if(u)c="you sense";else if(d)c="you remember";else{if(!f)return"";c="you expect to see"}const b=o.hasActor()?t.actorAt(s,i):null,g=o.hasItem()?t.itemAt(s,i):null,w=o.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let y=!1;b?(a=b.getFlavor({color:!1,article:!0,action:!0}),y=!0):g&&(a=g.getFlavor({color:!1,article:!0}),y=!0);let p=w?" in ":" on ";const x=o.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,m=o.depthTile(r.flags.Depth.SURFACE),v=o.depthTile(r.flags.Depth.LIQUID);let E="";if(m){y&&(y=!1,a+=" on "),m.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(p=" over "),E=m.getFlavor()+p}let B="";v&&(B=v.getFlavor()+" covering ",y&&(y=!1,a+=" in ")),y&&(y=!1,a+=" on ");let Y=x.getFlavor({article:!0});return n=h.text.apply("§intro§ §text§.",{intro:c,text:a+E+B+Y}),n}},t.ItemEntry=a,t.Menu=class{constructor(t){this.buttons=[],this.separator=" | ",this.lead=" ",this.needsRedraw=!1,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,1),this.ui=t.ui,this.needsRedraw=!0,this.fg=h.color.from(t.fg||"white"),this.bg=h.color.from(t.bg||"black"),this.hoverFg=h.color.from(t.hoverFg||"teal"),this.hoverBg=h.color.from(t.hoverBg||"black"),Object.entries(t.buttons).forEach((([t,s])=>{this.addButton(t,s)})),t.separator&&(this.separator=t.separator),void 0!==t.lead&&(this.lead=t.lead?t.lead:"")}contains(t){return this.bounds.contains(t)}handleMouse(t){if(this.buttons.forEach((t=>{t.hovered&&(this.needsRedraw=!0,t.hovered=!1)})),this.bounds.contains(t.x,t.y)){this.needsRedraw=!0;let s=null;return this.buttons.forEach((i=>{i.hovered=!1,i.x<t.x&&(s=i)})),s&&(s.hovered=!0),!0}return!1}getButtonAt(t,s){return h.arrayFindRight(this.buttons,(s=>s.x<t))||null}async handleClick(t){if(this.bounds.contains(t.x,t.y)){let s=this.getButtonAt(t.x,t.y);return!!s&&(s instanceof f?await c(this,s):s instanceof d&&await s.activate(),!0)}return!1}addButton(t,s){this.needsRedraw=!0;const i=this.buttons.reduce(((t,s)=>t+s.text.length+this.separator.length),this.lead.length+this.bounds.x);if(i+t.length+2>this.bounds.width)throw new Error("Button makes menu too wide :"+t);let e;"function"==typeof s?e=new d(t,s):(e=new f(this,null,t,s),e.setBounds(i,this.bounds.y?this.bounds.y-1:1,0)),e.x=i,this.buttons.push(e)}draw(t=!1){if(!this.needsRedraw&&!t)return!1;const s=this.ui.buffer;return this.drawInto(s)}drawInto(t){this.needsRedraw=!1,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,1,0,0,0);let s=this.bounds.x;const i=this.bounds.y;return t.drawText(s,i,this.lead,this.fg),this.buttons.forEach((e=>{const h=e.hovered?this.hoverFg:this.fg;t.drawText(e.x,i,e.text,h),s=e.x+e.text.length,t.drawText(s,i,this.separator,this.fg)})),!0}},t.Messages=class{constructor(t){const s=t.ui.buffer;this.bounds=new h.xy.Bounds(t.x,t.y,Math.min(t.width||s.width,s.width-t.x),Math.min(t.height||s.height,s.height-t.y)),this.cache=new h.message.MessageCache({width:this.bounds.width,length:s.height}),this.ui=t.ui,this.bg=h.color.from(t.bg||"black"),this.fg=h.color.from(t.fg||"white")}contains(t){return this.bounds.contains(t.x,t.y)}get needsUpdate(){return this.cache.needsUpdate}get buffer(){return this.ui.buffer}draw(t=!1){if(!t&&!this.cache.needsUpdate)return!1;let s;const i=h.color.make(),e=this.bounds.y<10;return this.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",0,this.bg),this.cache.forEach(((t,r,o)=>{if(o>=this.bounds.height)return;s=i,s.copy(this.fg),r&&(s.mix(this.bg,50),s.mix(this.bg,75*o/(2*this.bounds.height)));const n=e?this.bounds.height-o-1:o,a=this.toBufferY(n);h.text.eachChar(t,((t,e,h,n)=>{const u=this.toBufferX(n);e&&s!==e&&r&&(e.mix(this.bg,50),e.mix(this.bg,75*o/(2*this.bounds.height))),s=e||i,this.buffer.draw(u,a,t,s,this.bg)}))})),this.cache.needsUpdate=!1,!0}toBufferY(t){return this.bounds.y+t}toBufferX(t){return this.bounds.x+t}async showArchive(){let t,s,i,e=0,h=0;if(this.cache.forEach((()=>++h)),h<=this.bounds.height)return;const r=this.bounds.y<10,o=this.ui.startDialog();for(t=0;t<=1;t++){for(i=!1,e=t?h:this.bounds.height;t?e>=this.bounds.height:e<=h;e+=t?-1:1)this.ui.resetDialogBuffer(o),this.cache.forEach(((t,i,h)=>{if(h>=e||h>=o.height)return;const n=r?h:o.height-h-1;s=Math.floor(50*(e-h)/e);const a=this.fg.clone().mix(this.bg,s);o.wrapText(this.toBufferX(0),n,this.bounds.width,t,a,this.bg)})),o.render(),!i&&await this.ui.loop.pause(t?15:45)&&(i=!0,e=t?this.bounds.height+1:h-1);if(!t){const t=r?0:o.height-1,s=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,this.buffer.width-8);o.wrapText(s,t,8,"--DONE--",this.bg,this.fg),o.render(),await this.ui.loop.waitForAck()}}this.ui.finishDialog(),this.cache.confirmAll(),this.cache.needsUpdate=!0}},t.Sidebar=class{constructor(t){this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.mixer=new h.sprite.Mixer,this.currentY=0,this.follow=null,this.highlight=null,this.currentEntry=null,this.ui=t.ui,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.bg=h.color.from(t.bg||"black"),this.fg=h.color.from(t.fg||"purple")}get buffer(){return this.ui.buffer}contains(t){return this.bounds.contains(t.x,t.y)}toInnerY(t){return h.clamp(t-this.bounds.top,0,this.bounds.height)}updateHighlight(t){return this.contains(t)?this.highlightRow(this.toInnerY(t.y)):(this.clearHighlight(),!1)}highlightRow(t){const s=h.clamp(t,0,this.bounds.height);return this.highlight=null,this.entries.forEach((t=>{t.sidebarY<=s&&-1!==t.sidebarY&&(this.highlight=t)})),!!this.highlight&&(this.highlight.highlight=!0,!0)}clearHighlight(){this.highlight=null}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((s,i)=>{const e=t.cell(s,i);e.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(e)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new n(t)}_makeItemEntry(t){return new a(t)}_makeCellEntry(t){return new u(t)}_getPriority(t,s,i,e){return e?e.isDirectlyVisible(s,i)?1:e.isAnyKindOfVisible(s,i)?2:e.isRevealed(s,i)?3:-1:t.cell(s,i).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(!!this.highlight||t.priority>2)}_addActorEntry(t,s,i,e,r){const o=this._getPriority(s,t.x,t.y,r);if(o<0)return!1;const n=this._makeActorEntry(t);return n.dist=h.xy.distanceBetween(i,e,t.x,t.y),n.priority=t.isPlayer()?0:o,this.entries.push(n),!0}_addItemEntry(t,s,i,e,r){const o=this._getPriority(s,t.x,t.y,r);if(o<0)return!1;const n=this._makeItemEntry(t);return n.dist=h.xy.distanceBetween(i,e,t.x,t.y),n.priority=o,this.entries.push(n),!0}_addCellEntry(t,s,i,e,r){const o=this._getPriority(s,t.x,t.y,r);if(o<0)return!1;const n=this._makeCellEntry(t);return n.dist=h.xy.distanceBetween(i,e,t.x,t.y),n.priority=o,this.entries.push(n),!0}findEntries(t,s,i,e){if(t===this.lastMap&&s===this.lastX&&i===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=s,this.lastY=i,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const o=h.x,n=h.y;r[o][n]||this._addActorEntry(h,t,s,i,e)&&(r[o][n]=1)})),t.eachItem((h=>{const o=h.x,n=h.y;r[o][n]||this._addItemEntry(h,t,s,i,e)&&(r[o][n]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,s,i,e)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),h.grid.free(r)}clearSidebar(){this.ui.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg)}drawFor(t){return this.draw(t.memory||t.map,t.x,t.y,t.fov)}draw(t,s,i,e){if(arguments.length<3){if(this.follow)return this.drawFor(this.follow);throw new Error("Not following a subject - map, cx, cy required.")}this.updateCellCache(t),this.findEntries(t,s,i,e),this.clearSidebar(),this.currentY=this.bounds.y,this.entries.forEach((t=>t.sidebarY=-1));for(let t=0;t<this.entries.length&&this.currentY<this.bounds.bottom;++t)this.currentEntry=this.entries[t],this.currentEntry.sidebarY=this.currentY,this.currentEntry.draw(this),++this.currentY;return this.currentEntry=null,!0}drawTitle(t,s,i){i=h.color.from(i||this.fg);const e=this._isDim(this.currentEntry)?i.clone().darken(50):i;this.buffer.drawSprite(this.bounds.x+1,this.currentY,t),this.buffer.wrapText(this.bounds.x+3,this.currentY,this.bounds.width-3,s,e),++this.currentY}drawTextLine(t,s){s=h.color.from(s||this.fg);const i=this._isDim(this.currentEntry)?s.clone().darken(50):s;this.buffer.drawText(this.bounds.x+3,this.currentY,t,i,this.bounds.width-3),++this.currentY}drawProgressBar(t,s,i,e,r,o){e=h.color.from(e||this.fg),r=h.color.from(r||e.clone().darken(50)),o=h.color.from(o||e.clone().lighten(50)),this._isDim(this.currentEntry)&&(r.darken(50),o.darken(50),e.darken(50)),this.buffer.fillRect(this.bounds.x+1,this.currentY,this.bounds.width-1,1,void 0,void 0,r);const n=Math.floor((this.bounds.width-1)*t/s);this.buffer.fillRect(this.bounds.x+1,this.currentY,n,1,void 0,void 0,e);const a=h.text.center(i,this.bounds.width);this.buffer.drawText(this.bounds.x+1,this.currentY,a,o,void 0,this.bounds.width-1),++this.currentY}},t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}startDialog(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||new h.canvas.Buffer(this.canvas),this.buffer.copy(t),this.buffer}resetDialogBuffer(t){const s=this.layers[this.layers.length-1]||this.canvas.buffer;t.copy(s)}finishDialog(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.render(),this.inDialog=this.layers.length>0)}},t.Viewport=class{constructor(t){this.center=!1,this.snap=!1,this.filter=null,this.offsetX=0,this.offsetY=0,this.lockX=!1,this.lockY=!1,this._follow=null,this.ui=t.ui,this.snap=t.snap||!1,this.bounds=new h.xy.Bounds(t.x,t.y,t.width,t.height),this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}get follow(){return this._follow}set follow(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight(),this.centerOn(t.x,t.y,t.map)),this._follow=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}contains(t){return this.bounds.contains(t.x,t.y)}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,s,i){this.center=!0,this.updateOffset({x:t,y:s},i)}updateOffset(t,s){const i=s||this.bounds;if(t&&h.xy.contains(i,t.x,t.y))if(this.snap){let s=this.offsetX,e=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<s||t.x>e)&&(s=this.offsetX=t.x-this.halfWidth(),e=s+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const o=Math.floor(this.bounds.width/5),n=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);s+o>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):e-o<=t.x&&(this.offsetX=Math.min(t.x-a,i.width-this.bounds.width));const u=Math.floor(this.bounds.height/3);h+n>=t.y?this.offsetY=Math.max(0,t.y+u-this.bounds.height):r-n<=t.y&&(this.offsetY=Math.min(t.y-u,i.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&s&&(this.offsetX=h.clamp(this.offsetX,0,s.width-this.bounds.width)),this.lockY&&s&&(this.offsetY=h.clamp(this.offsetY,0,s.height-this.bounds.height))}drawFor(t){if(!t.map)throw new Error("No map!");return this.draw(t.memory||t.map,t.fov)}draw(t,s){if(!t){if(!this._follow)throw new Error("Either map or follow must be set.");return this.drawFor(this._follow)}this.updateOffset(this._follow,t);const i=new h.sprite.Mixer;for(let e=0;e<this.bounds.width;++e)for(let h=0;h<this.bounds.height;++h){const r=e+this.offsetX,o=h+this.offsetY;if(t.hasXY(r,o)){const e=t.cell(r,o);t.drawer.drawCell(i,e,s)}else i.blackOut();this.filter&&this.filter(i,r,o,t),this.ui.buffer.drawSprite(e+this.bounds.x,h+this.bounds.y,i)}return!0}},t.showDropDown=c,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
