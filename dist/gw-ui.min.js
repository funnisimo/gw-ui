!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,e,i){"use strict";function s(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var h=s(e),r=s(i);class n{constructor(t,e){this.active=!1,this.hovered=!1,this.tabStop=!1,this.depth=0,this.fg=4095,this.bg=-1,this.activeFg=4095,this.activeBg=-1,this.hoverFg=4095,this.hoverBg=-1,this.text="",this.align="left",this.valign="middle",this.bounds=new h.xy.Bounds(-1,-1,-1,-1),this.id=t,e&&this.init(e),this.reset()}init(t){void 0!==t.x&&(this.bounds.x=t.x),void 0!==t.y&&(this.bounds.y=t.y),void 0!==t.width&&(this.bounds.width=t.width),void 0!==t.height&&(this.bounds.height=t.height),void 0!==t.depth&&(this.depth=t.depth),t.text&&(this.text=t.text,this.bounds.width<=0&&(this.bounds.width=t.text.length),this.bounds.height<=0&&(this.bounds.height=1)),this.bounds.height<=0&&(this.bounds.height=1),void 0!==t.fg&&(this.fg=t.fg,this.activeFg=t.fg,this.hoverFg=t.fg),void 0!==t.bg&&(this.bg=t.bg,this.activeBg=t.bg,this.hoverBg=t.bg),void 0!==t.activeFg&&(this.activeFg=t.activeFg,this.hoverFg=t.activeFg),void 0!==t.activeBg&&(this.activeBg=t.activeBg,this.hoverBg=t.activeBg),void 0!==t.hoverFg&&(this.hoverFg=t.hoverFg),void 0!==t.hoverBg&&(this.hoverBg=t.hoverBg),void 0!==t.tabStop&&(this.tabStop=t.tabStop),this.action=t.action||this.id}reset(){}activate(t=!1){this.active=!0}deactivate(){this.active=!1}contains(t,e){return 1==arguments.length?this.bounds.contains(t):this.bounds.contains(t,e)}mousemove(t,e){return this.hovered=this.contains(t),this.hovered}tick(t,e){}click(t,e){return!1}keypress(t,e){return!1}dir(t,e){return!1}draw(t){const e=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,i=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg,s=h.text.length(this.text);(this.bounds.width>s||this.bounds.height>1)&&t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",e,i);let r=this.bounds.x;"center"==this.align?r+=Math.floor((this.bounds.width-s)/2):"right"==this.align&&(r+=this.bounds.width-s);let n=this.bounds.y;this.bounds.height>1&&("middle"==this.valign?n+=Math.floor(this.bounds.height/2):"bottom"==this.valign&&(n+=this.bounds.height-1)),t.drawText(r,n,this.text,e,i)}}class o extends n{constructor(t,e){super(t,e)}init(t){if(this.text=t.text||"",t.wrap)this.wrap=!0,t.width=t.wrap,this.lines=h.text.splitIntoLines(this.text,t.width);else{const e=h.text.length(this.text);t.width=t.width||e||10,t.width<e&&(t.text=h.text.truncate(this.text,t.width)),this.lines=[this.text]}t.height=Math.max(this.lines.length,t.height||1),super.init(t)}setText(t){if(this.text=t,this.wrap)this.lines=h.text.splitIntoLines(this.text,this.bounds.width);else{h.text.length(this.text)>this.bounds.width&&(this.text=h.text.truncate(this.text,this.bounds.width)),this.lines=[this.text]}}draw(t){const e=this.active?this.activeFg:this.fg,i=this.active?this.activeBg:this.bg;this.lines.forEach(((s,h)=>{t.drawText(this.bounds.x,this.bounds.y+h,s,e,i,this.bounds.width)}))}}class a extends n{constructor(t,e){super(t,e)}init(t){if(!t.text)throw new Error("Must have text value in config for Button widget - "+this.id);t.tabStop=h.first(t.tabStop,!0),super.init(t)}async click(t,e){return!!this.contains(t)&&(await e.fireAction(this.action,this),!0)}async keypress(t,e){return!!t.key&&("Enter"===t.key&&(await e.fireAction(this.action,this),!0))}}class d extends n{constructor(t,e){super(t,e)}init(t){this.minLength=t.minLength||1,t.width||(t.width=Math.max(this.minLength,10)),t.tabStop=h.first(t.tabStop,!0),super.init(t),this.default=t.default||"",this.errorFg=t.errorFg||this.fg,this.hint=t.hint||"",this.hintFg=t.hintFg||this.errorFg,this.numbersOnly=t.numbersOnly||!1,this.min=h.first(t.min,Number.MIN_SAFE_INTEGER),this.max=h.first(t.max,Number.MAX_SAFE_INTEGER),this.bounds.width<=0&&(this.hint&&(this.bounds.width=this.hint.length),this.default&&(this.bounds.width=this.default.length)),this.bounds.height<=0&&(this.bounds.height=1),this.reset()}reset(){this.text=this.default}isValid(){if(this.numbersOnly){const t=Number.parseInt(this.text);return!(void 0!==this.min&&t<this.min)&&(!(void 0!==this.max&&t>this.max)&&t>0)}return this.text.length>=this.minLength}get value(){return this.numbersOnly?Number.parseInt(this.text):this.text}keypress(t,e){const i=this.numbersOnly?["0","9"]:[" ","~"];if(!t.key)return!1;if("Enter"===t.key&&this.isValid()){const t=e.fireAction(this.action,this);return!t||t.then((()=>!0))}return"Delete"==t.key||"Backspace"==t.key?(this.text.length&&(this.text=h.text.spliceRaw(this.text,this.text.length-1,1)),!0):!(t.key.length>1)&&(t.key>=i[0]&&t.key<=i[1]&&this.text.length<this.bounds.width&&(this.text+=t.key),!0)}draw(t){const e=this.bounds.x,i=this.bounds.y,s=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,h=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;if(t.fillRect(e,i,this.bounds.width,1," ",s,h),!this.text.length&&this.hint&&this.hint.length)t.drawText(e,i,this.hint,this.hintFg);else{const h=this.isValid()?s:this.errorFg;t.drawText(e,i,this.text,h)}}}class l{constructor(t){this.active=!1,this.hovered=!1,this.fg=null,this.bg=null,this.activeFg=null,this.activeBg=null,this.hoverFg=null,this.hoverBg=null,this.align="left",this.header="",this.empty="",this._value=h.IDENTITY,this.x=-1,this.width=-1,this.index=-1,h.object.assignOmitting("value",this,t),this.width<=0&&(this.width=this.header.length||1),"string"==typeof t.value?this._value=h.text.compile(t.value):this._value=t.value||h.IDENTITY,t.align&&(this.align=t.align)}value(t,e){const i=this._value(t,e);return h.text.truncate(i,this.width)}}class u extends n{constructor(t,e){super(t,e),this.data=null,this.selectedColumn=null,this.selectedIndex=-1}init(t){if(!t.height)throw new Error("Height is required.");if(!t.columns||0==t.columns.length)throw new Error("Must have at least 1 column.");t.tabStop=h.first(t.tabStop,!0),super.init(t),this.headers=h.first(t.headers,!0),this.letters=h.first(t.letters,!0),this.columns=[],this.hoverType=t.hover||"row",this.wrapColumns=h.first(t.wrapColumns,t.wrap,!0),this.wrapRows=h.first(t.wrapRows,t.wrap,!0),this.headerFg=t.headerFg||this.fg,this.headerBg=t.headerBg||this.bg;let e=0;t.letters&&(this.columns.push(new l({width:2,value:(t,e)=>String.fromCharCode(97+e)+")"})),e+=2),t.columns&&t.columns.forEach((t=>{const i=new l(t);this.columns.push(i),e+=i.width})),this.columns.forEach(((t,e)=>t.index=e)),this.bounds.width=this.bounds.width>0?this.bounds.width:e}setData(t){this.data=t,this.selectedIndex=-1}selectRow(t){if(!this.data)return!1;return!(t>=(Array.isArray(this.data)?this.data.length:h.list.length(this.data)))&&(!(t<-1)&&(this.selectedIndex=t,!0))}selectNextRow(t=!0){if(!this.data)return-1;const e=Array.isArray(this.data)?this.data.length:h.list.length(this.data);return this.selectedIndex=h.nextIndex(this.selectedIndex,e,t),this.selectedIndex>-1&&!this.selectedColumn&&(this.selectedColumn=this.columns[0]),this.selectedIndex}selectPrevRow(t=!0){if(!this.data)return-1;const e=Array.isArray(this.data)?this.data.length:h.list.length(this.data);return this.selectedIndex=h.prevIndex(this.selectedIndex,e,t),this.selectedIndex>-1&&!this.selectedColumn&&(this.selectedColumn=this.columns[0]),this.selectedIndex}selectNextColumn(t=!0){if(this.selectedColumn){let e=h.nextIndex(this.selectedColumn.index,this.columns.length,t);this.selectedColumn=this.columns[e]||null}else this.selectedColumn=this.columns[0];return this.selectedColumn&&this.selectedIndex<0&&this.data&&(this.selectedIndex=0),this.selectedColumn}selectPrevColumn(t=!0){if(this.selectedColumn){let e=h.prevIndex(this.selectedColumn.index,this.columns.length,t);this.selectedColumn=this.columns[e]||null}else this.selectedColumn=this.columns[this.columns.length-1];return this.selectedColumn&&this.selectedIndex<0&&this.data&&(this.selectedIndex=0),this.selectedColumn}get selectedData(){return this.data?Array.isArray(this.data)?this.data[this.selectedIndex]||null:h.list.at(this.data,this.selectedIndex):null}draw(t){const e=this.bounds;t.fillRect(e.x,e.y,e.width,e.height," ",this.bg,this.bg);let i=e.x;this.columns.forEach((e=>{this.drawColumn(t,e,i),i+=e.width}))}drawColumn(t,e,i){let s=this.bounds.y;e.header&&(t.fillRect(i,s,e.width,1," ",this.headerFg,this.headerBg),t.drawText(i,s,e.header,this.headerFg,this.headerBg,e.width,e.align),++s),this.data&&(Array.isArray(this.data)?this.data.forEach(((h,r)=>{this.drawCell(t,e,h,r,i,s),++s})):h.list.forEach(this.data,((h,r)=>{this.drawCell(t,e,h,r,i,s),++s})))}drawCell(t,e,i,s,h,r){if(r>this.bounds.bottom)return;let n=e._value(i,s);0==n.length&&(n=e.empty);let o=this.fg,a=this.bg;"row"===this.hoverType?s===this.selectedIndex&&(o=this.hoverFg,a=this.hoverBg):"column"===this.hoverType?e===this.selectedColumn&&(o=this.hoverFg,a=this.hoverBg):"cell"===this.hoverType&&e===this.selectedColumn&&s===this.selectedIndex&&(o=this.hoverFg,a=this.hoverBg),t.fillRect(h,r,e.width,1," ",a,a),t.drawText(h,r,n,o,a,e.width,e.align)}async mousemove(t,e){if(!super.mousemove(t,e))return!1;const i=this.selectedColumn,s=this.selectedIndex;let h=t.x-this.bounds.x;const r=this.selectedColumn=this.columns.find((t=>t.width>=h||(h-=t.width,!1)))||null;let n=-1;return this.data&&(n=t.y-this.bounds.y-(this.headers?1:0),Array.isArray(this.data)&&n>=this.data.length&&(n=-1)),this.selectedIndex=n,i===r&&s===n||(e.fireAction(this.id+"_HOVER",this),e.requestRedraw()),!0}dir(t){return!!t.dir&&(t.dir[0]>0?this.selectNextColumn(this.wrapColumns):t.dir[0]<0&&this.selectPrevColumn(this.wrapColumns),t.dir[1]>0?this.selectNextRow(this.wrapRows):t.dir[1]<0&&this.selectPrevRow(this.wrapRows),!0)}}class c extends n{constructor(t,e){super(t,e?(void 0===e.depth&&(e.depth=-10),e.title&&(e.text=e.title),e.bg=e.bg||"gray",e):e)}init(t){super.init(t),this.borderBg=t.borderBg||null}mousemove(t,e){return!1}draw(t){const e=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,i=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;this.borderBg?(t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.borderBg,this.borderBg),t.fillRect(this.bounds.x+1,this.bounds.y+1,this.bounds.width-2,this.bounds.height-2," ",i,i)):t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",i,i),this.text&&t.drawText(this.bounds.x,this.bounds.y,this.text,e,-1,this.bounds.width,"center")}}class g{constructor(t,e){this.widgets=[],this.eventHandlers={},this._activeWidget=null,this.result=null,this.done=!1,this.timers={},this.needsRedraw=!0,this.ui=t,this.id=e||"DIALOG"}init(){this.widgets.sort(((t,e)=>t.depth<e.depth?-1:1))}get activeWidget(){return this._activeWidget}setActiveWidget(t,e=!1){t!==this._activeWidget&&(this._activeWidget&&this._activeWidget.deactivate(),this._activeWidget=t,this._activeWidget&&this._activeWidget.activate(e))}requestRedraw(){this.needsRedraw=!0}setTimeout(t,e){this.timers[t]=e}clearTimeout(t){delete this.timers[t]}async fireAction(t,e){const i=this.eventHandlers[t];i&&await i(t,this,e)}setEventHandlers(t){Object.assign(this.eventHandlers,t)}async show(){this.done=!1,this.widgets.forEach((t=>t.reset())),this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null);const t=this.ui.startLayer();return await this.ui.loop.run({keypress:this.keypress.bind(this),dir:this.dir.bind(this),mousemove:this.mousemove.bind(this),click:this.click.bind(this),tick:this.tick.bind(this),draw:()=>{this.draw(t),t.render()}},100),this.ui.finishLayer(),this.result}close(t){this.result=t,this.done=!0}widgetAt(t,e){return this.widgets.find((i=>i.contains(t,e)&&i.depth>=0))||null}getWidget(t){return this.widgets.find((e=>e.id===t))||null}nextTabstop(){if(!this.activeWidget)return this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null),!!this.activeWidget;const t=h.arrayNext(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.setActiveWidget(t),!0)}prevTabstop(){if(!this.activeWidget)return this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null),!!this.activeWidget;const t=h.arrayPrev(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.setActiveWidget(t,!0),!0)}async tick(t){const e=t.dt;let i=[];Object.entries(this.timers).forEach((([t,s])=>{(s-=e)<=0?(delete this.timers[t],i.push(this.fireAction(t,null))):this.timers[t]=s}));for(let e of this.widgets)i.push(e.tick(t,this));return i.length?Promise.all(i).then((()=>this.done)):this.done}async mousemove(t){return await Promise.all(this.widgets.map((async e=>{await e.mousemove(t,this),e.hovered&&e.tabStop&&this.setActiveWidget(e)}))),this.done}async click(t){const e=this.widgetAt(t.x,t.y);let i=null;if(e){if(await e.click(t,this))return this.done;i=this.eventHandlers[e.id]}return i=i||this.eventHandlers[this.id]||this.eventHandlers.click,i&&await i(t,this,this.activeWidget),this.done}async keypress(t){if(!t.key)return!1;if(this.activeWidget&&await this.activeWidget.keypress(t,this))return this.done;const e=this.eventHandlers[t.key]||this.eventHandlers[t.code]||this.eventHandlers.keypress;return e&&await e(t,this,this.activeWidget)?this.done:"Tab"===t.key?(this.nextTabstop(),!1):"TAB"===t.key?(this.prevTabstop(),!1):this.done}async dir(t){if(this.activeWidget&&await this.activeWidget.dir(t,this))return this.done;const e=this.eventHandlers.dir||this.eventHandlers.keypress;return e&&await e(t,this,this.activeWidget),this.done}draw(t,e=!1){(this.needsRedraw||e)&&(this.ui.resetLayerBuffer(),this.widgets.forEach((e=>e.draw(t))))}}class f{constructor(t,e,i){this.nextY=0,this.box=null,this.nextY=1,this.dialog=new g(t),this.bounds=new h.xy.Bounds(-1,-1,e,i)}with(t,e){const i=this.bounds;return e?(void 0!==e.right?(i.width=Math.max(i.width,t.bounds.width+e.right),t.bounds.right=i.width-e.right-1):(t.bounds.x=e.x||0,i.width=Math.max(i.width,t.bounds.width+t.bounds.x)),void 0!==e.bottom?(i.height=Math.max(i.height,t.bounds.height+e.bottom),t.bounds.bottom=i.height-e.bottom-1):(t.bounds.y=e.y||0,i.height=Math.max(i.height,t.bounds.height+t.bounds.y))):(i.width=Math.max(i.width,t.bounds.right),i.height=Math.max(i.height,t.bounds.bottom)),this.dialog.widgets.push(t),this.nextY=Math.max(this.nextY,t.bounds.bottom+1),this}center(){const t=this.dialog.ui.buffer,e=this.bounds;return e.x=Math.floor((t.width-e.width)/2),e.y=Math.floor((t.height-e.height)/2),this}place(t,e){const i=this.bounds;return i.x=t,i.y=e,this}addBox(t){return this.box=t||{},this}done(){if(this.bounds.x<0&&(this.bounds.x=0),this.bounds.y<0&&(this.bounds.y=0),this.bounds.right>this.dialog.ui.buffer.width)throw new Error("Dialog is off screen!");if(this.bounds.bottom>this.dialog.ui.buffer.height)throw new Error("Dialog is off screen!");if(this.box){const t=this.box.padX||this.box.pad||1,e=this.box.padY||this.box.pad||1;this.box.x=0,this.box.y=0,this.box.width=this.bounds.width+2*t,this.box.height=this.bounds.height+2*e;const i=new c(this.dialog.id+"_BOX",this.box);this.dialog.widgets.forEach((i=>{i.bounds.x+=t,i.bounds.y+=e})),this.dialog.widgets.unshift(i)}return this.dialog.widgets.forEach((t=>{t.bounds.x+=this.bounds.x,t.bounds.y+=this.bounds.y})),this.dialog}}function p(t,e=0,i=0){return new f(t,e,i)}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class b{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,e){return 0}}class y extends b{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,e){return this.actor.drawStatus(t,e)}}class m extends b{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,e){return this.item.drawStatus(t,e)}}class x extends b{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,e){return this.cell.drawStatus(t,e)}}class w{constructor(t){this.hovered=!1,this.x=999,this.text=t}get width(){return this.text.length}}class _ extends w{constructor(t,e){super(t),this.action=e}}class v extends w{constructor(t,e,i,s){super(i),this.buttons=[],this.parent=null,this.menu=t,this.parent=e,this.text=i,this.bounds=new h.xy.Bounds(0,0,0,0),Object.entries(s).forEach((([t,e])=>{this.addButton(t,e)}))}addButton(t,e){let i;i="string"==typeof e?new _(t,e):new v(this.menu,this,t,e),this.buttons.push(i),++this.bounds.height,this.bounds.width=Math.max(this.bounds.width,t.length+2)}setBounds(t,e,i,s){const h=e+s,r=t.width;if(this.bounds.width<r-h)this.bounds.x=h;else{if(!(this.bounds.width<e))throw new Error("Menu does not fit - too wide.");this.bounds.x=e-this.bounds.width}const n=t.height;if(this.bounds.height<=n-i)this.bounds.y=i;else{if(!(this.bounds.height<n))throw new Error("Menu does not fit - too tall.");this.bounds.y=n-this.bounds.height-1}}contains(t){return this.bounds.contains(t)}buttonAt(t){const e=t.y-this.bounds.y;return this.buttons[e]||null}draw(t){const e=this.bounds.width,i=this.bounds.height,s=this.bounds.x;let h=this.bounds.y;t.fillRect(s,h,e,i,0,0,this.menu.dropBg),this.buttons.forEach((e=>{t.drawText(s+1,h,e.text,e.hovered?this.menu.activeFg:this.menu.dropFg,e.hovered?this.menu.activeBg:this.menu.dropBg),++h})),this.parent&&this.parent.draw(t)}}async function E(t,e,i){const s=t.ui,r=s.startLayer();i.buttons.forEach((t=>t.hovered=!1));let n=i;await s.loop.run({Escape:()=>!0,Tab(){e.activeIndex=(e.activeIndex+1)%e.buttons.length;const i=e.buttons[e.activeIndex];return i&&(i.hovered=!0),n&&i instanceof v?(n.hovered=!1,n=i):n=null,t.requestRedraw(),!n},TAB(){e.activeIndex=(e.buttons.length+e.activeIndex-1)%e.buttons.length;const i=e.buttons[e.activeIndex];return i&&(i.hovered=!0),n&&i instanceof v?(n.hovered=!1,n=i):n=null,t.requestRedraw(),!n},mousemove:i=>{if(!n)return!0;let h=n;for(;h&&!h.contains(i);)h=h.parent;if(h){n=h;const t=n.buttonAt(i);t&&(n.buttons.forEach((t=>{t.hovered=!1})),t.hovered=!0,t instanceof v&&(t.buttons.forEach((t=>{t.hovered=!1})),t.buttons[0].hovered=!0,t.setBounds(s.buffer,n.bounds.x,i.y,n.bounds.width),n=t))}else if(e.contains(i)){t&&t.requestRedraw();const s=e.getButtonAt(i.x,i.y);s&&(s.hovered=!0,e.activeIndex=e.buttons.indexOf(s)),s instanceof v?(n.hovered=!1,n=s):n=null,t&&t.requestRedraw()}return!n},click:async i=>{if(!n)return!0;if(!n.contains(i))return e.clearHighlight(),!0;const s=n.buttonAt(i);return!s||s instanceof _&&(e.actionButton=s,await t.fireAction(s.action,e),!0)},dir:async t=>{if(!n)return!0;if(t.dir&&t.dir[1]){const e=n.buttons.findIndex((t=>t.hovered));if(e<1&&t.dir[1]<0)return n.buttons.forEach((t=>t.hovered=!1)),!0;const i=h.clamp(e+t.dir[1],0,n.buttons.length-1);n.buttons.forEach(((t,e)=>t.hovered=e===i));const r=n.buttons[i];r instanceof v&&(r.buttons.forEach((t=>{t.hovered=!1})),r.buttons[0].hovered=!0,r.setBounds(s.buffer,n.bounds.x,t.y,n.bounds.width),n=r)}},draw:()=>{n&&(s.resetLayerBuffer(),n.draw(r),e.draw(r),r.render())}}),s.finishLayer(),e.clearHighlight()}function k(t){return e=>e.classes.includes(t)}function B(t){return t.startsWith("first")?t=>!!t.parent&&t.parent.children[0]===t:t.startsWith("last")?t=>!!t.parent&&t.parent.children[t.parent.children.length-1]===t:e=>!!e.prop(t)}function T(t){return e=>!t(e)}class I{constructor(t){this.priority=0,this.match=[],(t.startsWith(":")||t.startsWith("."))&&(t="*"+t),this.text=t;let e=0;if(t.startsWith("*"))e=1;else if(t.startsWith("#")){this.priority+=1e3;const i=t.match(/#([^\.:]+)/);if(!i)throw new Error("Invalid selector - Failed to match ID: "+t);e=i[0].length,this.match.push((s=i[1],t=>t.attr("id")===s))}else if(t.startsWith("$"))this.priority+=1e4,e=1;else{this.priority+=10;const s=t.match(/([^\.:]+)/);if(!s)throw new Error("Invalid selector - Failed to match tag: "+t);e=s[0].length,this.match.push((i=s[1],t=>t.tag===i))}var i,s;const h=new RegExp(/(?:\.([^\.:]+))|(?::(?:(?:not\(\.([^\)]+)\))|(?:not\(:([^\)]+)\))|([^\.:]+)))/g);h.lastIndex=e;let r=h.exec(t);for(;r;){let e;if(r[1])this.priority+=100,e=k(r[1]);else if(r[2])this.priority+=100,e=T(k(r[2]));else if(r[3])this.priority+=1,e=T(B(r[3]));else{this.priority+=1;const t=r[4];e="invalid"===t?T(B("valid")):"optional"===t?T(B("required")):"enabled"===t?T(B("disabled")):"unchecked"===t?T(B("checked")):B(r[4])}this.match.push(e),r=h.exec(t)}}matches(t){return this.match.every((e=>e(t)))}}class C{constructor(t="$",e){this._dirty=!1,this.selector=new I(t),e&&this.set(e),this._dirty=!1}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get fg(){return this._fg}get bg(){return this._bg}get border(){return this._border}get align(){return this._align}get valign(){return this._valign}get position(){return this._position}get minWidth(){return this._minWidth}get maxWidth(){return this._maxWidth}get width(){return this._width}get minHeight(){return this._minHeight}get maxHeight(){return this._maxHeight}get height(){return this._height}get x(){return this._x}get left(){return this._left}get right(){return this._right}get y(){return this._y}get top(){return this._top}get bottom(){return this._bottom}get padLeft(){return this._padLeft}get padRight(){return this._padRight}get padTop(){return this._padTop}get padBottom(){return this._padBottom}get marginLeft(){return this._marginLeft}get marginRight(){return this._marginRight}get marginTop(){return this._marginTop}get marginBottom(){return this._marginBottom}get(t){return this["_"+t]}set(t,e,i=!0){if("string"==typeof t)if("padding"===t)"number"==typeof e?e=[e]:"string"==typeof e&&(e=e.split(" ").map((t=>Number.parseInt(t)))),1==e.length?this._padLeft=this._padRight=this._padTop=this._padBottom=e[0]:2==e.length?(this._padLeft=this._padRight=e[1],this._padTop=this._padBottom=e[0]):3==e.length?(this._padTop=e[0],this._padRight=e[1],this._padBottom=e[2],this._padLeft=e[1]):4==e.length&&(this._padTop=e[0],this._padRight=e[1],this._padBottom=e[2],this._padLeft=e[3]);else if("margin"===t)"number"==typeof e?e=[e]:"string"==typeof e&&(e=e.split(" ").map((t=>Number.parseInt(t)))),1==e.length?this._marginLeft=this._marginRight=this._marginTop=this._marginBottom=e[0]:2==e.length?(this._marginLeft=this._marginRight=e[1],this._marginTop=this._marginBottom=e[0]):3==e.length?(this._marginTop=e[0],this._marginRight=e[1],this._marginBottom=e[2],this._marginLeft=e[1]):4==e.length&&(this._marginTop=e[0],this._marginRight=e[1],this._marginBottom=e[2],this._marginLeft=e[3]);else{this["_"+t]=e}else t instanceof C?(i=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{"selector"!==t&&"_dirty"!==t&&(null!=e?this[t]=e:null===e&&this.unset(t))}))):(i=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{null===e?this.unset(t):this.set(t,e,i)})));return this.dirty||(this.dirty=i),this}unset(t){return delete this[t.startsWith("_")?t:"_"+t],this.dirty=!0,this}clone(){const t=new this.constructor;return t.copy(this),t}copy(t){return Object.assign(this,t),this}}class A extends C{constructor(t){super(),this.sources=[],t&&(t.sort(((t,e)=>t.selector.priority-e.selector.priority)),this.sources=t),this.sources.forEach((t=>super.set(t))),this._dirty=!1}get dirty(){return this._dirty||this.sources.some((t=>t.dirty))}set dirty(t){this._dirty=t}}class S{constructor(t){this.rules=[],this._dirty=!0,void 0===t&&(t=F),t&&(this.rules=t.rules.slice())}get dirty(){return this._dirty}set dirty(t){this._dirty=t,this._dirty||this.rules.forEach((t=>t.dirty=!1))}add(t,e){if(t.includes(",")){const i=t.split(",").map((t=>t.trim())).map((t=>this.add(t,e)));return i[i.length-1]}if(t.includes(" "))throw new Error("Hierarchical selectors not supported.");let i=new C(t,e);const s=this.rules.findIndex((t=>t.selector.text===i.selector.text));if(s>-1){const t=this.rules[s];t.set(i),i=t}else this.rules.push(i);return this.dirty=!0,i}get(t){return this.rules.find((e=>e.selector.text===t))||null}remove(t){const e=this.rules.findIndex((e=>e.selector.text===t));e>-1&&(this.rules.splice(e,1),this.dirty=!0)}computeFor(t){const e=this.rules.filter((e=>e.selector.matches(t))),i=t.style();return i&&e.push(i),i.dirty=!1,new A(e)}}const F=new S(null);F.add("*",{fg:"white",bg:"black",align:"left",valign:"top",position:"static"});class R{constructor(t,e){this.parent=null,this._props={},this._attrs={},this.classes=[],this.children=[],this.events={},this._bounds=new h.xy.Bounds(0,0,0,0),this._text="",this._lines=[],this._dirty=!1,this._attached=!1,this._style=null,this.tag=t,this._usedStyle=e?e.computeFor(this):new A}contains(t,e){return"number"==typeof t?this._bounds.contains(t,e):this._bounds.contains(t)}clone(){if(this._attached&&!this.parent)throw new Error("Cannot clone a root widget.");const t=new this.constructor(this.tag);return Object.assign(t._props,this._props),t.classes=this.classes.slice(),t._text=this._text,this._style&&(t._style=this._style.clone()),t.parent=null,t._attached=!1,t.dirty=!0,t.children=this.children.map((t=>t.clone())),t.children.forEach((e=>e.parent=t)),t}get dirty(){return this._dirty||this._usedStyle.dirty}set dirty(t){if(this._dirty=t,this.parent&&t){const t=this.used("position");"static"!==t&&"relative"!==t||(this.parent.dirty=!0)}}attr(t,e){return void 0===e?this._attrs[t]:(this._setAttr(t,e),this)}_setAttr(t,e){this._attrs[t]=e}_attrInt(t,e=0){let i=this._attrs[t];return void 0===i?e:"string"==typeof i?Number.parseInt(i):"boolean"==typeof i?i?1:0:i}_attrString(t){let e=this._attrs[t]||"";return"string"==typeof e?e:""+e}_attrBool(t){const e=this._attrs[t]||!1;return"boolean"==typeof e?e:"number"==typeof e?0!=e:e.length>0&&"false"!==e}prop(t,e){return void 0===e?this._props[t]:(this._setProp(t,e),this)}_setProp(t,e){this._props[t]!==e&&(this._props[t]=e,this._usedStyle.dirty=!0)}toggleProp(t){const e=this._props[t]||!1;return this._setProp(t,!e),this}val(t){return void 0===t?this.prop("value"):(this._setProp("value",t),this)}onblur(t){this.prop("focus",!1)}onfocus(t,e){this.prop("focus",!0)}_propInt(t,e=0){let i=this._props[t];return void 0===i?e:"string"==typeof i?Number.parseInt(i):"boolean"==typeof i?i?1:0:i}_propString(t){let e=this._props[t]||"";return"string"==typeof e?e:""+e}_propBool(t){return!!(this._props[t]||!1)}addChild(t,e=-1){if(t.parent){if(t.parent===this)return this;throw new Error("Cannot add a currently attached child to another element.  Detach it first.")}return 0==e?this.children.unshift(t):e>0&&e<=this.children.length-1?this.children.splice(e,0,t):this.children.push(t),t.parent=this,t.dirty=!0,this.dirty=!0,this}removeChild(t){if(!t.parent)return this;if(t.parent!==this)throw new Error("Cannot remove child that is not attached to this widget.");return h.arrayDelete(this.children,t)&&(t.parent=null,t.dirty=!0,this.dirty=!0),this}empty(){this.text("");const t=this.children;return this.children=[],t.forEach((t=>{t.parent=null,t.dirty=!0})),this.dirty=!0,t}root(){let t=this;for(;t.parent;)t=t.parent;return t!==this?t:null}positionedParent(){const t=this._usedStyle.position||"static";if("static"===t)return null;if("relative"===t)return this;if("fixed"===t)return this.root();let e=this.parent;if(e)for(;e&&!e.isPositioned();)e=e.parent;return e||this.root()}get bounds(){return this._bounds}get innerLeft(){return this._bounds.left+(this._usedStyle.padLeft||0)+(this._usedStyle.marginLeft||0)+(this._usedStyle.border?1:0)}get innerRight(){return this._bounds.right-(this._usedStyle.padRight||0)-(this._usedStyle.marginRight||0)-(this._usedStyle.border?1:0)}get innerWidth(){return Math.max(0,this._bounds.width-(this._usedStyle.padLeft||0)-(this._usedStyle.padRight||0)-(this._usedStyle.marginLeft||0)-(this._usedStyle.marginRight||0)-(this._usedStyle.border?2:0))}get innerHeight(){return Math.max(0,this._bounds.height-(this._usedStyle.padTop||0)-(this._usedStyle.padBottom||0)-(this._usedStyle.marginTop||0)-(this._usedStyle.marginBottom||0)-(this._usedStyle.border?2:0))}get innerTop(){return this._bounds.top+(this._usedStyle.padTop||0)+(this._usedStyle.marginTop||0)+(this._usedStyle.border?1:0)}get innerBottom(){return this._bounds.bottom-(this._usedStyle.padBottom||0)-(this._usedStyle.marginBottom||0)-(this._usedStyle.border?1:0)}updateLayout(){return this._updateWidth(),this._updateHeight(),this._updateLeft(),this._updateTop(),this.dirty=!1,this.children.forEach((t=>t.dirty=!1)),this}_updateWidth(){const t=this._usedStyle,e=this._bounds;if(e.width=t.width||0,!e.width){const i=t.position||"static";["static","relative"].includes(i)&&this.parent&&(e.width=this.parent.innerWidth||0),e.width||(e.width=(t.padLeft||0)+(t.padRight||0)+(t.marginLeft||0)+(t.marginRight||0)+(t.border?2:0),this.children.length?e.width+=this.children.reduce(((t,e)=>Math.max(t,e._updateWidth())),0):e.width+=this._calcContentWidth())}e.width=h.clamp(e.width,t.minWidth||e.width,t.maxWidth||e.width),this.children.forEach((t=>t._updateWidth()));const i=t.position||"static";return["fixed","absolute"].includes(i)?0:e.width}_updateHeight(){const t=this._usedStyle,e=this._bounds;let i=0;e.height=t.height||0,e.height||(e.height=(t.padTop||0)+(t.padBottom||0)+(t.marginTop||0)+(t.marginBottom||0)+(t.border?2:0),this.children.length?e.height+=this.children.reduce(((t,e)=>t+e._updateHeight()),0):(i=this._calcContentHeight(),e.height+=i)),e.height=h.clamp(e.height,t.minHeight||e.height,t.maxHeight||e.height),i>this.innerHeight&&this._updateContentHeight(),this.children.forEach((t=>t._updateHeight()));const s=t.position||"static";return["fixed","absolute"].includes(s)?0:e.height}_updateLeft(){const t=this._usedStyle,e=this._bounds,i=t.position||"static";if(e.left=0,"static"===i)this.parent&&(e.left=this.parent.innerLeft);else{const i=this.positionedParent();void 0!==t.left?e.left=(i?i.bounds.left:0)+t.left:void 0!==t.right?i&&(e.right=i.bounds.right-t.right):e.left=i?i.bounds.left:0}this.children.forEach((t=>t._updateLeft()))}_updateTop(t=0){const e=this._usedStyle,i=this._bounds,s=e.position||"static";if(["fixed","absolute"].includes(s)){const t=this.positionedParent();void 0!==e.top?i.top=(t?t.bounds.top:0)+e.top:void 0!==e.bottom?t&&(i.bottom=t.bounds.bottom-e.bottom):i.top=t?t.bounds.top:0}else i.top=t,"relative"===s&&(void 0!==e.top?i.top+=e.top:void 0!==e.bottom&&(i.top-=e.bottom));if(this.children.length){let t=this.innerTop;this.children.forEach((e=>{t+=e._updateTop(t)}))}return["fixed","absolute"].includes(s)?0:i.height}style(...t){if(this._style||(this._style=new C),0===t.length)return this._style;if(1===t.length){const e=t[0];if("string"==typeof e)return this._style.get(e);this._style.set(t[0],!1),this._usedStyle.set(t[0],!1),this.dirty=!0}else this._style.set(t[0],t[1],!1),this._usedStyle.set(t[0],t[1],!1),this.dirty=!0;return this}removeStyle(t){return this._style?(this._style.unset(t),this._usedStyle.dirty=!0,this):this}used(t){return t?t instanceof A?(this._usedStyle=t,this.dirty=!0,this):this._usedStyle.get(t):this._usedStyle}addClass(t){return t.split(" ").forEach((t=>{0!=t.length&&(this.classes.includes(t)||(this._usedStyle.dirty=!0,this.classes.push(t)))})),this}removeClass(t){return t.split(" ").forEach((t=>{0!=t.length&&h.arrayDelete(this.classes,t)&&(this._usedStyle.dirty=!0)})),this}toggleClass(t){return t.split(" ").forEach((t=>{0!=t.length&&(h.arrayDelete(this.classes,t)||this.classes.push(t),this._usedStyle.dirty=!0)})),this}pos(...t){if(0===t.length)return this.bounds;let e,i="fixed";return e="number"==typeof t[0]?{left:t.shift(),top:t.shift()}:t.shift(),t[0]&&t[0].length?(i=t[0],this.style("position",i)):this.isPositioned()||this.style("position","fixed"),void 0!==e.right&&this.style("right",e.right),void 0!==e.left&&this.style("left",e.left),void 0!==e.top&&this.style("top",e.top),void 0!==e.bottom&&this.style("bottom",e.bottom),this}isPositioned(){const t=this._usedStyle.position;return!!t&&"static"!==t}size(t,e){return void 0===t?this.bounds:("number"==typeof t&&(t={width:t,height:e}),void 0!==t.minWidth&&this.style("minWidth",t.minWidth),void 0!==t.minHeight&&this.style("minHeight",t.minHeight),void 0!==t.maxWidth&&this.style("maxWidth",t.maxWidth),void 0!==t.maxHeight&&this.style("maxHeight",t.maxHeight),void 0!==t.width&&this.style("width",t.width),void 0!==t.height&&this.style("height",t.height),this)}text(t){return void 0===t?this._text:(this._text=t,this.dirty=!0,this._usedStyle.dirty=!0,this)}_calcContentWidth(){return this._lines=h.text.splitIntoLines(this._text),this._lines.reduce(((t,e)=>Math.max(t,e.length)),0)}_calcContentHeight(){return this._lines=h.text.splitIntoLines(this._text,this.innerWidth),this._lines.length}_updateContentHeight(){this._lines.length=this.innerHeight}draw(t){return this._usedStyle.border&&this._drawBorder(t),this._fill(t),this.children.length?(this.children.forEach((e=>{e.isPositioned()||e.draw(t)})),this.children.forEach((e=>{e.isPositioned()&&e.draw(t)}))):this._drawContent(t),this.dirty=!1,!0}_drawBorder(t){const e=this._usedStyle,i=this.bounds;h.xy.forBorder(i.x+(e.marginLeft||0),i.y+(e.marginTop||0),i.width-(e.marginLeft||0)-(e.marginRight||0),i.height-(e.marginTop||0)-(e.marginBottom||0),((i,s)=>{t.draw(i,s,0,e.border,e.border)}))}_fill(t){const e=this._usedStyle,i=e.bg,s=this.bounds;t.fillRect(s.x+(e.marginLeft||0)+(e.border?1:0),s.y+(e.marginTop||0)+(e.border?1:0),s.width-(e.marginLeft||0)-(e.marginRight||0)-(e.border?2:0),s.height-(e.marginTop||0)-(e.marginBottom||0)-(e.border?2:0)," ",i,i)}_drawContent(t){if(this._lines.length){const e=this.used("fg")||"white",i=this.innerTop,s=this.innerWidth,h=this.innerLeft,r=this.used("align");this._lines.forEach(((n,o)=>{t.drawText(h,i+o,n,e,-1,s,r)}))}}on(t,e){let i=this.events[t];return i||(i=this.events[t]=[]),i.includes(e)||i.push(e),this}off(t,e){let i=this.events[t];return i?(e?h.arrayDelete(i,e):i.length=0,this):this}elementFromPoint(t,e){let i=null;for(let s of this.children)s.isPositioned()&&s.contains(t,e)&&(i=s.elementFromPoint(t,e)||i);if(i)return i;for(let s of this.children)!s.isPositioned()&&s.contains(t,e)&&(i=s.elementFromPoint(t,e)||i);return i||(!i&&this.contains(t,e)&&(i=this),i)}}const W={};function L(t,e){W[t]=e}function M(t,e){if(t.startsWith("<")&&!t.endsWith(">"))throw new Error('Need brackets around new tag - e.g. "<tag>"');const i={},s=new RegExp(/<(\w+)/g,"g"),h=new RegExp(/(\w+)(?: *= *(?:(?:\'([^\']*)\')|(?:\"([^\"]*)\")|(\w+)))?/g,"g"),r=new RegExp(/ *>/g,"g"),n=new RegExp(/>(.+?)(?=(<\/|$))/g,"g");let o=s.exec(t);if(o){if(i.tag=o[1]," "===t[s.lastIndex])for(h.lastIndex=s.lastIndex,o=h.exec(t);o;){i[o[1]]=o[2]||o[3]||o[4]||!0,n.lastIndex=h.lastIndex,r.lastIndex=h.lastIndex;const e=r.exec(t);if(e&&e.index===h.lastIndex)break;o=h.exec(t)}else n.lastIndex=s.lastIndex;const e=n.exec(t);e&&(i.text=e[1])}else i.tag="div";const a=W[i.tag],d=a?a(i.tag,e):new R(i.tag,e);return Object.entries(i).forEach((([t,e])=>{if("tag"!==t)if("text"===t)d.text(e);else if("id"===t)d.attr("id",e);else if("style"===t){e.split(";").forEach((t=>{t.split("=").map((t=>t.trim())).forEach((t=>{const[e,i]=t.split(":").map((t=>t.trim()));e&&i&&d.style(e,i)}))}))}else"string"==typeof e?d.attr(t,e):d.prop(t,e)})),d}F.add("input",{fg:"black",bg:"gray"});class O extends R{constructor(t,e){super(t,e),this.on("keypress",this.keypress.bind(this)),this.prop("tabindex",!0),this.prop("value","")}_setAttr(t,e){super._setAttr(t,e),"value"===t&&this._setProp("value",e),super._setProp("valid",this.isValid())}_setProp(t,e){if("value"===t){e=""+e;const t=this._attrInt("maxLength",0);t&&e.length>t&&(e=e.substring(0,t)),super._setProp("empty",0==e.length),this._props.value=e,this.dirty=!0}else super._setProp(t,e);super._setProp("valid",this.isValid())}get isTypeNumber(){return"number"===this._attrs.type}_calcContentWidth(){const t=this._attrs.size||"";return t.length?Number.parseInt(t):10}_calcContentHeight(){return 1}_updateContentHeight(){}isValid(){const t=this._propString("value");if(this.isTypeNumber){const e=this._propInt("value");if(e<this._attrInt("min",Number.MIN_SAFE_INTEGER))return!1;return!(e>this._attrInt("max",Number.MAX_SAFE_INTEGER))&&t.length>0}const e=this._propInt("required",0);return t.length>=this._attrInt("minLength",e)&&t.length<=this._attrInt("maxLength",Number.MAX_SAFE_INTEGER)}_drawContent(t){const e=this.used("fg")||"white",i=this.innerTop,s=this.innerWidth,h=this.innerLeft,r=this.used("align");let n=this._propString("value");0==n.length&&(n=this._attrString("placeholder")),t.drawText(h,i,n,e,-1,s,r)}onblur(t){super.onblur(t),this.val()!==this.attr("value")&&t._fireEvent(this,"change")}keypress(t,e,i){if(!i)return!1;if("Enter"===i.key)return t.nextTabStop(),!0;if("Escape"===i.key)return this._setProp("value",""),t._fireEvent(this,"input",i),!0;if("Backspace"===i.key||"Delete"===i.key){const e=this._propString("value");return this._setProp("value",e.substring(0,e.length-1)),t._fireEvent(this,"input",i),!0}if(i.key.length>1)return!1;const s=this.isTypeNumber?["0","9"]:[" ","~"];if(i.key>=s[0]&&i.key<=s[1]){const e=this._propString("value");this._setProp("value",e+i.key),t._fireEvent(this,"input",i)}return!0}}L("input",((t,e)=>new O(t,e)));class P extends R{constructor(t,e){super(t,e),this.on("keypress",this.keypress.bind(this)),this.on("click",this.click.bind(this)),this.prop("tabindex",!0),this.prop("checked",!1),Object.entries(P.default).forEach((([t,e])=>this.attr(t,e)))}_setAttr(t,e){this._attrs[t]=e,"value"===t&&this._setProp("value",e)}_calcContentWidth(){return 2+super._calcContentWidth()}_calcContentHeight(){return this._lines=h.text.splitIntoLines(this._text,this.innerWidth-2),Math.max(1,this._lines.length)}_drawContent(t){const e=this.used("fg")||"white",i=this.innerTop,s=this.innerWidth,h=this.innerLeft,r=this.used("align"),n=this.prop("checked")?"check":"uncheck";let o=this._attrs[n];t.drawText(h,i,o,e,-1),this._lines.forEach(((n,o)=>{t.drawText(h+2,i+o,n,e,-1,s-2,r)}))}onblur(t){super.onblur(t),t._fireEvent(this,"change")}keypress(t,e,i){return!!i&&("Enter"===i.key||" "===i.key?(this.toggleProp("checked"),t._fireEvent(this,"input",i),!0):("Backspace"===i.key||"Delete"===i.key)&&(this.prop("checked",!1),t._fireEvent(this,"input",i),!0))}click(t,e,i){return!!i&&(!!this.contains(i)&&(this.toggleProp("checked"),t.setActiveElement(this),t._fireEvent(this,"input",i),!0))}}P.default={uncheck:"☐",check:"☒",padCheck:"1",value:"on"},L("checkbox",((t,e)=>new P(t,e))),F.add("button",{fg:"black",bg:"gray"});class H extends R{constructor(t,e){super(t,e),this.on("keypress",this.keypress.bind(this)),this.on("click",this.click.bind(this)),this.prop("tabindex",!0),Object.entries(H.default).forEach((([t,e])=>{"boolean"==typeof e?this.prop(t,e):this.attr(t,e)}))}_setAttr(t,e){this._attrs[t]=e,"value"===t&&this._setProp("value",e)}keypress(t,e,i){return!!i&&(("Enter"===i.key||" "===i.key)&&(t._fireEvent(this,"click",i),!0))}click(t,e,i){return!!i&&(!!this.contains(i)&&(this.prop("clickfocus")&&t.setActiveElement(this),!0))}}H.default={clickfocus:!1},L("button",((t,e)=>new H(t,e))),F.add("fieldset",{margin:1,border:"dark_gray",fg:"white",bg:-1,padding:1});class D extends R{constructor(t,e){super(t,e),Object.entries(D.default).forEach((([t,e])=>{"boolean"==typeof e?this.prop(t,e):void 0!==e&&this.attr(t,""+e)}))}_drawBorder(t){super._drawBorder(t);const e=this.attr("legend");if(!e||0==e.length)return;const i=this._usedStyle,s=i.fg||"white",h=this.innerTop-(i.padTop||0)-1,r=this.innerWidth,n=this.innerLeft,o=i.align;t.drawText(n,h,e,s,-1,r,o)}}D.default={},L("fieldset",((t,e)=>new D(t,e)));class N{constructor(t,e=[]){this.document=t,this.selected=e.slice()}get(t){return void 0===t?this.selected:t<0?this.selected[this.selected.length+t]:this.selected[t]}length(){return this.selected.length}slice(t,e){return new N(this.document,this.selected.slice(t,e))}add(t){return t instanceof N||(t=this.document.$(t)),t.forEach((t=>{this.selected.includes(t)||this.selected.push(t)})),this}clone(){return this.selected=this.selected.map((t=>t.clone())),this}forEach(t){return this.selected.forEach(t),this}after(t){if(t instanceof N||(t=this.document.$(t)),0==t.length())return this;t.detach();let e=t;const i=this.selected.length-1;return this.selected.forEach(((s,h)=>{if(!s.parent)throw new Error("Cannot add after detached widgets.");e=h<i?t.clone():t;const r=s.parent;let n=r.children.indexOf(s)+1;e.forEach((t=>{r.addChild(t,n),r._attached&&this.document._attach(t)}))})),this}append(t){if(t instanceof N||(t=this.document.$(t)),0==t.length())return this;t.detach();let e=t;const i=this.selected.length-1;return this.selected.forEach(((s,h)=>{e=h<i?t.clone():t,e.forEach((t=>{s.addChild(t),s._attached&&this.document._attach(t)}))})),this}appendTo(t){return t instanceof N||(t=this.document.$(t)),t.append(this),this}before(t){if(t instanceof N||(t=this.document.$(t)),0==t.length())return this;t.detach();let e=t;const i=this.selected.length-1;return this.selected.forEach(((s,h)=>{if(!s.parent)throw new Error("Cannot add before detached widgets.");e=h<i?t.clone():t;const r=s.parent;let n=r.children.indexOf(s);e.forEach((t=>{r.addChild(t,n++),r._attached&&this.document._attach(t)}))})),this}detach(){return this.selected.forEach((t=>{if(t._attached){if(!t.parent)throw new Error("Cannot detach root widget.");t.parent.removeChild(t),this.document._detach(t)}})),this}empty(){return this.selected.forEach((t=>{const e=t.empty();this.document._detach(e)})),this}insertAfter(t){return t instanceof N||(t=this.document.$(t)),t.after(this),this}insertBefore(t){return t instanceof N||(t=this.document.$(t)),t.before(this),this}prepend(t){if(t instanceof N||(t=this.document.$(t)),0==t.length())return this;t.detach();let e=t;const i=this.selected.length-1;return this.selected.forEach(((s,h)=>{e=h<i?t.clone():t,e.forEach((t=>{s.addChild(t,0),s._attached&&this.document._attach(t)}))})),this}prependTo(t){return t instanceof N||(t=this.document.$(t)),t.prepend(this),this}remove(t){return this.detach()}replaceAll(t){return t instanceof N||(t=this.document.$(t)),t.before(this),t.detach(),this}replaceWith(t){return t instanceof N||(t=this.document.$(t)),t.replaceAll(this),this}text(t){return t?(this.selected.forEach((e=>e.text(t))),this):this.selected.length?this.selected[0].text():""}attr(t,e){if(void 0===e){if(0==this.selected.length)return;return this.selected[0].attr(t)}return this.selected.forEach((i=>i.attr(t,e))),this}prop(t,e){if(void 0===e){if(0==this.selected.length)return;return this.selected[0].prop(t)}return this.selected.forEach((i=>i.prop(t,e))),this}addClass(t){return this.selected.forEach((e=>e.addClass(t))),this}hasClass(t){return 0!=this.selected.length&&this.selected[0].classes.includes(t)}removeClass(t){return this.selected.forEach((e=>e.removeClass(t))),this}toggleClass(t){return this.selected.forEach((e=>e.toggleClass(t))),this}style(t,e){return t?void 0===e&&"string"==typeof t?this.selected[0].style(t):(this.selected.forEach((i=>{"string"==typeof t?i.style(t,e):i.style(t)})),this):this.selected[0].style()}removeStyle(t){return this.selected.forEach((e=>e.removeStyle(t))),this}pos(...t){if(0==t.length){if(0==this.selected.length)return;return this.selected[0].pos()}return this.selected.forEach((e=>e.pos(t[0],t[1],t[2]))),this}size(...t){if(0==t.length){if(0==this.selected.length)return;return this.selected[0].size()}return this.selected.forEach((e=>e.size(t[0],t[1]))),this}animate(t,e){return this}clearQueue(t){return this}delay(t,e){return this}dequeue(){return this}fadeIn(t){return this}fadeOut(t){return this}fadeTo(t,e){return this}fadeToggle(t){return this}finish(t){return this}hide(t){return this}queue(...t){return[]}show(t){return this}slideDown(t){return this}slideToggle(t){return this}slideUp(t){return this}stop(){return this}toggle(t){return this}on(t,e){return this.selected.forEach((i=>{i.on(t,e)})),this}off(t,e){return this.selected.forEach((i=>{i.off(t,e)})),this}fire(t,e){return e||(e=h.io.makeCustomEvent(t)),this.selected.forEach((i=>{const s=i.events[t];s&&s.forEach((t=>t(this.document,i,e)))})),this}}var j=Object.freeze({__proto__:null,Callbacks:class{constructor(t){this._items=[],this._disabled=!1,this._fired=!1,this._once=!1,this._stopOnFalse=!1,this._unique=!1;const e=t.split(" ");this._once=e.includes("once"),this._stopOnFalse=e.includes("stopOnFalse"),this._unique=e.includes("unique")}add(t){return Array.isArray(t)?t.forEach((t=>this.add(t))):this._unique&&this._items.includes(t)||this._items.push(t),this}disable(){return this._disabled=!0,this}disabled(){return!this._disabled}empty(){return this._items.length=0,this}async fire(...t){if(this._disabled)return this;if(this._once&&this._fired)return this;this._fired=!0;for(let e of this._items){const i=await e(...t);if(this._stopOnFalse&&!1===i)break}return this}fired(){return this._fired}async fireWith(t,e){if(this._disabled)return this;if(this._once&&this._fired)return this;this._fired=!0;for(let i of this._items){const s=await i.apply(t,e);if(this._stopOnFalse&&!1===s)break}return this}has(t){return this._items.includes(t)}remove(t){const e=this._items.indexOf(t);return e>=0&&this._items.splice(e,1),this}},isTruthy:function(t){return!!t&&("string"!=typeof t||"false"!==t&&"0"!==t)},Selector:I,selector:function(t){return new I(t)},Style:C,ComputedStyle:A,Sheet:S,defaultStyle:F,Element:R,elements:W,installElement:L,makeElement:M,Input:O,CheckBox:P,Button:H,FieldSet:D,Document:class{constructor(t,e="body"){this._activeElement=null,this._done=!1,this.ui=t,this.stylesheet=new S,this.body=new R(e),this.body.style({width:t.buffer.width,maxWidth:t.buffer.width,height:t.buffer.height,maxHeight:t.buffer.height,position:"fixed",top:0,left:0}),this.body._attached=!0,this.children=[this.body]}$(t){return this.select(t)}select(t){let e;if(void 0===t)e=[this.body];else{if(t instanceof N)return t;if("string"==typeof t)if(t.startsWith("<"))e=[this.createElement(t)];else if("document"===t)e=[this.body];else{const i=new I(t);e=this.children.filter((t=>i.matches(t)))}else e=Array.isArray(t)?t:[t]}return new N(this,e)}createElement(t){return M(t,this.stylesheet)}create(t){return this.select(this.createElement(t))}rule(t,e){if("string"==typeof t){if(e)return this.stylesheet.add(t,e),this;let i=this.stylesheet.get(t);return i||this.stylesheet.add(t,{})}return Object.entries(t).forEach((([t,e])=>{this.stylesheet.add(t,e)})),this}removeRule(t){return this.stylesheet.remove(t),this}_attach(t){return Array.isArray(t)?(t.forEach((t=>this._attach(t))),this):(this.children.includes(t)||(this.children.push(t),t._attached=!0,t.children.forEach((t=>this._attach(t)))),this)}_detach(t){if(Array.isArray(t))return t.forEach((t=>this._detach(t))),this;if(t===this.body)throw new Error("Cannot detach root widget.");return h.arrayDelete(this.children,t),t._attached=!1,t.children.forEach((t=>this._detach(t))),this}computeStyles(){let t=!1;return this.children.forEach((e=>{(e.used().dirty||this.stylesheet.dirty)&&(e.used(this.stylesheet.computeFor(e)),t=!0)})),this.stylesheet.dirty=!1,t}updateLayout(t){(t=t||this.body).updateLayout()}draw(t){this._prepareDraw()&&(t=t||this.ui.buffer,this.body.draw(t),t.render())}_prepareDraw(){return this.computeStyles()?(this.updateLayout(),!0):this.children.some((t=>t.dirty))}get activeElement(){return this._activeElement}setActiveElement(t,e=!1){if(t===this._activeElement)return!0;const i={target:t,dir:[e?-1:1,0]};return(!this._activeElement||!this._fireEvent(this._activeElement,"blur",i))&&((!t||!this._fireEvent(t,"focus",i))&&(this._activeElement&&this._activeElement.onblur(this),this._activeElement=t,this._activeElement&&this._activeElement.onfocus(this,e),!0))}nextTabStop(){if(!this._activeElement)return this.setActiveElement(this.children.find((t=>!t.prop("disabled")&&t.prop("tabindex")))||null),!!this._activeElement;const t=h.arrayNext(this.children,this._activeElement,(t=>!!t.prop("tabindex")&&!t.prop("disabled")));return!!t&&(this.setActiveElement(t),!0)}prevTabStop(){if(!this._activeElement)return this.setActiveElement(this.children.find((t=>!t.prop("disabled")&&t.prop("tabindex")))||null),!!this._activeElement;const t=h.arrayPrev(this.children,this._activeElement,(t=>!!t.prop("tabindex")&&!t.prop("disabled")));return!!t&&(this.setActiveElement(t,!0),!0)}elementFromPoint(t,e){return this.body.elementFromPoint(t,e)||this.body}_fireEvent(t,e,i){i&&i.type||(i=h.io.makeCustomEvent(e,i));return(t.events[e]||[]).reduce(((e,s)=>s(this,t,i)||e),!1)}_bubbleEvent(t,e,i){let s=t;for(;s;){if((s.events[e]||[]).reduce(((t,e)=>e(this,s,i)||t),!1))return!0;s=s.parent}return!1}click(t){let e=this.elementFromPoint(t.x,t.y);return!!e&&(!e.prop("disabled")&&(this._bubbleEvent(e,"click",t)?this._done:(e.prop("tabindex")&&this.setActiveElement(e),!1)))}mousemove(t){let e=this.elementFromPoint(t.x,t.y);const i=[];let s=e;for(;s;)i.push(s),s.prop("hover",!0),s=s.parent;return this.children.forEach((t=>{i.includes(t)||t.prop("hover",!1)})),!(!e||!this._bubbleEvent(e,"mousemove",t))&&this._done}dir(t){const e=this.activeElement||this.body;return!(!e||!this._bubbleEvent(e,"dir",t))&&this._done}keypress(t){const e=this.activeElement||this.body;if(e){if(this._bubbleEvent(e,t.key,t))return this._done;if(this._bubbleEvent(e,t.code,t))return this._done;if(this._bubbleEvent(e,"keypress",t))return this._done}return"Tab"===t.key?this.nextTabStop():"TAB"===t.key&&this.prevTabStop(),!1}},Selection:N});t.ActionButton=_,t.ActorEntry=y,t.Box=c,t.Button=a,t.CellEntry=x,t.Column=l,t.Dialog=g,t.DialogBuilder=f,t.DropDownButton=v,t.EntryBase=b,t.Flavor=class extends o{constructor(t,e){super(t,e)}init(t){t.fg=t.fg||"flavorText",t.bg=t.bg||"black",super.init(t),this.promptFg=h.color.from(t.promptFg||"flavorPrompt"),this.overflow=t.overflow||!1,this.isPrompt=!1}showText(t){this.text=h.text.capitalize(t);h.text.length(this.text)>this.bounds.width?(this.lines=h.text.splitIntoLines(this.text,this.bounds.width),!this.overflow&&this.lines.length>this.bounds.height&&(1==this.bounds.height?(this.text=h.text.truncate(this.text,this.bounds.width),this.lines=[this.text]):this.lines.length=this.bounds.height)):this.lines=[this.text],this.isPrompt=!1}clear(){this.text="",this.lines=[""],this.isPrompt=!1}showPrompt(t){this.showText(t),this.isPrompt=!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),super.draw(t)}getFlavorText(t,e,i,s){const n=t.cell(e,i);let o,a="";const d=!s||s.isAnyKindOfVisible(e,i),l=!s||s.isDirectlyVisible(e,i),u=!!s&&s.isRevealed(e,i),c=!!s&&s.isMagicMapped(e,i);let g;if(l)g="you see";else if(d)g="you sense";else if(u)g="you remember";else{if(!c)return"";g="you expect to see"}const f=n.hasActor()?t.actorAt(e,i):null,p=n.hasItem()?t.itemAt(e,i):null,b=n.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let y=!1;f?(a=f.getFlavor({color:!1,article:!0,action:!0}),y=!0):p&&(a=p.getFlavor({color:!1,article:!0}),y=!0);let m=b?" in ":" on ";const x=n.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,w=n.depthTile(r.flags.Depth.SURFACE),_=n.depthTile(r.flags.Depth.LIQUID);let v="";if(w){y&&(y=!1,a+=" on "),w.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(m=" over "),v=w.getFlavor()+m}let E="";_&&(E=_.getFlavor()+" covering ",y&&(y=!1,a+=" in ")),y&&(y=!1,a+=" on ");let k=x.getFlavor({article:!0});return o=h.text.apply("§intro§ §text§.",{intro:g,text:a+v+E+k}),o}},t.Input=d,t.ItemEntry=m,t.List=class extends u{constructor(t,e){super(t,(()=>{const t=e;return t.columns=[e],t.headers=!!e.header,t.hover=!1===e.hover?"none":"row",t})())}},t.Menu=class extends n{constructor(t,e){super(t,e),this.activeIndex=-1,this.actionButton=null}init(t){t.fg=h.first(t.fg,"black"),t.bg=h.first(t.bg,"light_gray"),t.height=t.height||1,t.tabStop=h.first(t.tabStop,!0),super.init(t),this.dropFg=h.color.from(t.dropFg||this.fg),this.dropBg=h.color.from(t.dropBg||this.bg),this.buttons=[],this.separator=t.separator||" | ",this.lead=t.lead||" ",Object.entries(t.buttons).forEach((([t,e])=>{this._addButton(t,e)})),t.separator&&(this.separator=t.separator),void 0!==t.lead&&(this.lead=t.lead?t.lead:"")}reset(){super.reset();const t=this.bounds.y<=10;this.buttons.forEach((e=>{e instanceof v&&(t?e.bounds.top=this.bounds.bottom+1:e.bounds.bottom=this.bounds.top-1)}))}activate(t=!1){super.activate(t),this.activeIndex<0&&(this.activeIndex=t?this.buttons.length-1:0)}deactivate(){super.deactivate(),this.activeIndex=-1}mousemove(t,e){if(this.buttons.forEach((t=>{t.hovered&&(t.hovered=!1)})),!super.mousemove(t,e))return!1;if(this.bounds.contains(t)){let i=null;return this.buttons.forEach((e=>{e.hovered=!1,e.x<t.x&&(i=e)})),i&&(i.hovered=!0,this.activeIndex=this.buttons.indexOf(i)),e&&e.requestRedraw(),!0}return!1}clearHighlight(){this.buttons.forEach((t=>{t.hovered=!1}))}getButtonAt(t,e){return h.arrayFindRight(this.buttons,(e=>e.x<t))||null}async click(t,e){if(this.bounds.contains(t)){let i=this.getButtonAt(t.x,t.y);return!!i&&(this.activeIndex=this.buttons.indexOf(i),i instanceof v?await E(e,this,i):i instanceof _&&(this.actionButton=i,await e.fireAction(i.action,this)),!0)}return!1}async keypress(t,e){if(this.active){if("Tab"===t.key)return++this.activeIndex,!(this.activeIndex>=this.buttons.length)||(this.deactivate(),!1);if("TAB"===t.key)return--this.activeIndex,!(this.activeIndex<0)||(this.deactivate(),!1);if("Enter"===t.key){const t=this.buttons[this.activeIndex];return t instanceof v?await E(e,this,t):t instanceof _&&(this.actionButton=t,await e.fireAction(t.action,this)),!0}}return super.keypress(t,e)}_addButton(t,e){const i=this.buttons.reduce(((t,e)=>t+e.text.length+this.separator.length),this.lead.length+this.bounds.x);if(i+t.length+this.separator.length>this.bounds.width)throw new Error("Button makes menu too wide :"+t);let s;if("string"==typeof e)s=new _(t,e);else{const h=new v(this,null,t,e);h.bounds.x=i-1,s=h}s.x=i,this.buttons.push(s)}draw(t){const e=this.active?this.activeBg:this.bg,i=this.active?this.activeFg:this.fg;t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,1,0,e,e);let s=this.bounds.x;const h=this.bounds.y;return t.drawText(s,h,this.lead,i),this.buttons.forEach(((r,n)=>{const o=n===this.activeIndex,a=o?this.hoverFg:i,d=o?this.hoverBg:e;t.drawText(r.x,h,r.text,a,d),s=r.x+r.text.length,t.drawText(s,h,this.separator,i)})),!0}},t.MenuButton=w,t.Messages=class extends n{constructor(t,e){super(t,e)}init(t){if(t.x=t.x||0,t.y=t.y||0,super.init(t),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:t.length||40,match:(t,e)=>!0})}click(t,e){return!!this.contains(t)&&this.showArchive(e).then((()=>!0))}draw(t){const e=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),this.cache.forEach(((i,s,h)=>{if(h>=this.bounds.height)return;const r=(e?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,r,i,this.fg),s&&t.mix(this.bg,50,this.bounds.x,r,this.bounds.width,1)})),!0}async showArchive(t){let e,i,s=0;const r=t.ui;let n=this.cache.length;if(n<=this.bounds.height)return!1;const o=this.bounds.y<10,a=r.startLayer(),d=h.color.from(this.fg);for(n=Math.min(n,o?a.height-this.bounds.top:this.bounds.bottom),e=0;e<=1;e++){i=!1;const t=e?-1:1,h=e?n:this.bounds.height,l=e?this.bounds.height+t+1:n+t;for(let n=h;n!=l;n+=t){const h=o?this.bounds.y+n-1:this.bounds.bottom-n,u=o?this.bounds.y:this.bounds.bottom,c=o?-1:1;r.resetLayerBuffer(),a.fillRect(this.bounds.x,Math.min(h,u),this.bounds.width,n," ",this.bg,this.bg),this.cache.forEach(((t,e,i)=>{const r=h+i*c;if(o){if(r<u)return}else if(r>u)return;s=Math.floor(50*i/n);const l=d.clone().mix(this.bg,s);a.drawText(this.bounds.x,r,t,l,this.bg)})),a.render(),i||await r.loop.pause(e?15:45)&&(i=!0,n=l-2*t)}if(!e){const t=o?0:a.height-1,e=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,a.width-8);a.wrapText(e,t,8,"--DONE--",this.bg,this.fg),a.render(),await r.loop.waitForAck()}}return r.finishLayer(),this.cache.confirmAll(),t.requestRedraw(),!0}},t.Sidebar=class extends n{constructor(t,e){super(t,e),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}init(t){t.fg=t.fg||"purple",t.bg=t.bg||"black",super.init(t)}reset(){super.reset(),this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((e=>e.sidebarY<=t.y&&-1!==e.sidebarY))||null}mousemove(t,e){return super.mousemove(t,e),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const e=this.highlight;return this.highlight=null,this.entries.forEach((e=>{e.sidebarY<=t&&-1!==e.sidebarY&&(this.highlight=e)})),this.highlight!==e}clearHighlight(){const t=!!this.highlight;return this.highlight=null,t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((e,i)=>{const s=t.cell(e,i);s.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(s)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new y(t)}_makeItemEntry(t){return new m(t)}_makeCellEntry(t){return new x(t)}_getPriority(t,e,i,s){return s?s.isDirectlyVisible(e,i)?1:s.isAnyKindOfVisible(e,i)?2:s.isRevealed(e,i)?3:-1:t.cell(e,i).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,e,i,s,r){const n=this._getPriority(e,t.x,t.y,r);if(n<0)return!1;const o=this._makeActorEntry(t);return o.dist=h.xy.distanceBetween(i,s,t.x,t.y),o.priority=t.isPlayer()?0:n,this.entries.push(o),!0}_addItemEntry(t,e,i,s,r){const n=this._getPriority(e,t.x,t.y,r);if(n<0)return!1;const o=this._makeItemEntry(t);return o.dist=h.xy.distanceBetween(i,s,t.x,t.y),o.priority=n,this.entries.push(o),!0}_addCellEntry(t,e,i,s,r){const n=this._getPriority(e,t.x,t.y,r);if(n<0)return!1;const o=this._makeCellEntry(t);return o.dist=h.xy.distanceBetween(i,s,t.x,t.y),o.priority=n,this.entries.push(o),!0}findEntries(t,e,i,s){if(t===this.lastMap&&e===this.lastX&&i===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=e,this.lastY=i,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const n=h.x,o=h.y;r[n][o]||this._addActorEntry(h,t,e,i,s)&&(r[n][o]=1)})),t.eachItem((h=>{const n=h.x,o=h.y;r[n][o]||this._addItemEntry(h,t,e,i,s)&&(r[n][o]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,e,i,s)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,e)=>t.priority!=e.priority?t.priority-e.priority:t.dist-e.dist)),h.grid.free(r)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,e,i,s){return this.updateCellCache(t),this.findEntries(t,e,i,s),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg),this.entries.forEach((t=>t.sidebarY=-1));const e=this.bounds.clone();let i;for(let s=0;s<this.entries.length&&e.height>0;++s){i=this.entries[s],i.sidebarY=e.y;let h=i.draw(t,e);this._isDim(i)&&t.mix(this.bg,50,e.x,e.y,e.width,h),h&&(++h,e.y+=h,e.height-=h)}return!0}},t.Table=u,t.Text=o,t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}get baseBuffer(){return this.layers[this.layers.length-1]||this.canvas.buffer}get canvasBuffer(){return this.canvas.buffer}startLayer(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||this.canvas.buffer.clone(),this.buffer.copy(t),this.buffer.changed=!1,this.buffer}resetLayerBuffer(){const t=this.baseBuffer;this.buffer.copy(t),this.buffer.changed=!1}finishLayer(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.changed=!0,this.buffer.render(),this.inDialog=this.layers.length>0)}async fadeTo(t="black",e=1e3){t=h.color.from(t);const i=this.startLayer();let s=0,r=0;for(;r<e;)r+=32,await this.loop.pause(32)&&(r=e),s=Math.floor(100*r/e),this.resetLayerBuffer(),i.mix(t,s),i.render();this.finishLayer()}async alert(t,e,i){"number"==typeof t&&(t={duration:t}),i&&(e=h.text.apply(e,i));const s=t.width||h.text.length(e);t.box=t.box||{bg:t.bg};const r={fg:t.fg,text:e,x:0,y:0,wrap:s},n=new o("TEXT",r),a=p(this,s,n.bounds.height).with(n,{x:0,y:0}).addBox(t.box).center().done();return a.setEventHandlers({click:()=>a.close(!0),keypress:()=>a.close(!0),TIMEOUT:()=>a.close(!1)}),t.waitForAck||a.setTimeout("TIMEOUT",t.duration||3e3),await a.show()}async confirm(...t){let e,i,s=null;t.length<=2&&"string"==typeof t[0]?(e={},i=t[0],s=t[1]||null):(e=t[0],i=t[1],s=t[2]||null),s&&(i=h.text.apply(i,s));const r=e.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(i)),n={fg:e.fg,text:i,wrap:r},d=new o("TEXT",n),l=d.bounds.height+2;e.allowCancel=!1!==e.allowCancel,e.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},e.buttons||{}),"string"==typeof e.ok&&(e.ok={text:e.ok}),"string"==typeof e.cancel&&(e.cancel={text:e.cancel}),e.ok=e.ok||{},e.cancel=e.cancel||{};const u=Object.assign({},e.buttons,{text:"OK"},e.ok),c=Object.assign({},e.buttons,{text:"CANCEL"},e.cancel),g=p(this,r,l).with(d,{x:0,y:0}).with(new a("OK",u),{x:0,bottom:0});e.allowCancel&&g.with(new a("CANCEL",c),{right:0,bottom:0});const f=g.center().addBox(e.box).done();return f.setEventHandlers({OK(){f.close(!0)},CANCEL(){f.close(!1)},Escape(){f.close(!1)},Enter(){f.close(!0)}}),await f.show()}async showWidget(t,e={}){const i=t.bounds.x<0||t.bounds.y<0,s={x:t.bounds.x,y:t.bounds.y},h=p(this).with(t,{x:0,y:0});i?h.center():h.place(s.x,s.y);const r=h.done();return e.Escape=e.Escape||(()=>{r.close(!1)}),r.setEventHandlers(e),await r.show()}async getInputAt(t,e,i,s={}){s.width=i,s.x=t,s.y=e;const h=new d("INPUT",s);return this.showWidget(h,{INPUT(t,e){e.close(h.text)},Escape(t,e){e.close("")}})}async inputBox(t,e,i){i&&(e=h.text.apply(e,i));const s=t.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(e)),r={fg:t.fg,text:e,wrap:s},n=new o("TEXT",r),l=n.bounds.height+2+2;t.allowCancel=!1!==t.allowCancel,t.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},t.buttons||{}),"string"==typeof t.ok&&(t.ok={text:t.ok}),"string"==typeof t.cancel&&(t.cancel={text:t.cancel}),t.ok=t.ok||{},t.cancel=t.cancel||{};const u=Object.assign({},t.buttons,{text:"OK"},t.ok),c=Object.assign({},t.buttons,{text:"CANCEL"},t.cancel);t.input=t.input||{},t.input.width=t.input.width||s,t.input.bg=t.input.bg||t.fg,t.input.fg=t.input.fg||t.bg;const g=new d("INPUT",t.input||{}),f=p(this,s,l).with(n,{x:0,y:0}).with(g,{bottom:2,x:0}).with(new a("OK",u),{bottom:0,x:0}).addBox(t.box);t.allowCancel&&f.with(new a("CANCEL",c),{bottom:0,right:0});const b=f.center().done();return b.setEventHandlers({OK(){b.close(g.text)},CANCEL(){b.close("")},Escape(){b.close("")},INPUT(){b.close(g.text)}}),await b.show()}},t.Viewport=class extends n{constructor(t,e){super(t,e),this.offsetX=0,this.offsetY=0,this._subject=null}init(t){t.bg=t.bg||"black",t.x=t.x||0,t.y=t.y||0,super.init(t),this.snap=t.snap||!1,this.center=t.center||!1,this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}get subject(){return this._subject}set subject(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t}set lock(t){this.lockX=t,this.lockY=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,e,i){this.center=!0,this.subject={x:e,y:i,map:t}}showMap(t,e=0,i=0){this.subject={x:e,y:i,map:t},this.offsetX=e,this.offsetY=i,this.center=!1,this.snap=!1}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,e=t.memory||t.map,i=e;if(t&&e.hasXY(t.x,t.y))if(this.snap){let e=this.offsetX,s=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<e||t.x>s)&&(e=this.offsetX=t.x-this.halfWidth(),s=e+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const n=Math.floor(this.bounds.width/5),o=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);e+n>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):s-n<=t.x&&(this.offsetX=Math.min(t.x-a,i.width-this.bounds.width));const d=Math.floor(this.bounds.height/3);h+o>=t.y?this.offsetY=Math.max(0,t.y+d-this.bounds.height):r-o<=t.y&&(this.offsetY=Math.min(t.y-d,i.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&e&&(this.offsetX=h.clamp(this.offsetX,0,e.width-this.bounds.width)),this.lockY&&e&&(this.offsetY=h.clamp(this.offsetY,0,e.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this.bg),!this._subject)return!1;this.updateOffset();const e=this._subject.memory||this._subject.map,i=this._subject.fov,s=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let r=0;r<this.bounds.height;++r){const n=h+this.offsetX,o=r+this.offsetY;if(e.hasXY(n,o)){const t=e.cell(n,o);e.drawer.drawCell(s,t,i)}else s.draw(" ",this.bg,this.bg);this.filter&&this.filter(s,n,o,e),t.drawSprite(h+this.bounds.x,r+this.bounds.y,s)}return!0}},t.Widget=n,t.buildDialog=p,t.html=j,t.makeTable=function(t,e){return new u(t,e)},t.showDropDown=E,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
