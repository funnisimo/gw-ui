!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,e){"use strict";function i(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(e){if("default"!==e){var i=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(s,e,i.get?i:{enumerable:!0,get:function(){return t[e]}})}})),s.default=t,Object.freeze(s)}var h=i(s),n=i(e);class o{constructor(t,s){this.active=!1,this.hovered=!1,this.tabStop=!1,this.depth=0,this.fg=4095,this.bg=-1,this.activeFg=4095,this.activeBg=-1,this.hoverFg=4095,this.hoverBg=-1,this.text="",this.align="left",this.valign="middle",this.bounds=new h.xy.Bounds(-1,-1,-1,-1),this.id=t,s&&this.init(s),this.reset()}init(t){void 0!==t.x&&(this.bounds.x=t.x),void 0!==t.y&&(this.bounds.y=t.y),void 0!==t.width&&(this.bounds.width=t.width),void 0!==t.height&&(this.bounds.height=t.height),void 0!==t.depth&&(this.depth=t.depth),t.text&&(this.text=t.text,this.bounds.width<=0&&(this.bounds.width=t.text.length),this.bounds.height<=0&&(this.bounds.height=1)),this.bounds.height<=0&&(this.bounds.height=1),void 0!==t.fg&&(this.fg=t.fg,this.activeFg=t.fg,this.hoverFg=t.fg),void 0!==t.bg&&(this.bg=t.bg,this.activeBg=t.bg,this.hoverBg=t.bg),void 0!==t.activeFg&&(this.activeFg=t.activeFg,this.hoverFg=t.activeFg),void 0!==t.activeBg&&(this.activeBg=t.activeBg,this.hoverBg=t.activeBg),void 0!==t.hoverFg&&(this.hoverFg=t.hoverFg),void 0!==t.hoverBg&&(this.hoverBg=t.hoverBg),void 0!==t.tabStop&&(this.tabStop=t.tabStop),this.action=t.action||this.id}reset(){}activate(t=!1){this.active=!0}deactivate(){this.active=!1}contains(t,s){return 1==arguments.length?this.bounds.contains(t):this.bounds.contains(t,s)}mousemove(t,s){return this.hovered=this.contains(t),this.hovered}tick(t,s){}click(t,s){return!1}keypress(t,s){return!1}dir(t,s){return!1}draw(t){const s=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,e=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg,i=h.text.length(this.text);(this.bounds.width>i||this.bounds.height>1)&&t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",s,e);let n=this.bounds.x;"center"==this.align?n+=Math.floor((this.bounds.width-i)/2):"right"==this.align&&(n+=this.bounds.width-i);let o=this.bounds.y;this.bounds.height>1&&("middle"==this.valign?o+=Math.floor(this.bounds.height/2):"bottom"==this.valign&&(o+=this.bounds.height-1)),t.drawText(n,o,this.text,s,e)}}class r extends o{constructor(t,s){super(t,s)}init(t){if(this.text=t.text||"",t.wrap)this.wrap=!0,t.width=t.wrap,this.lines=h.text.splitIntoLines(this.text,t.width);else{const s=h.text.length(this.text);t.width=t.width||s||10,t.width<s&&(t.text=h.text.truncate(this.text,t.width)),this.lines=[this.text]}t.height=Math.max(this.lines.length,t.height||1),super.init(t)}setText(t){if(this.text=t,this.wrap)this.lines=h.text.splitIntoLines(this.text,this.bounds.width);else{h.text.length(this.text)>this.bounds.width&&(this.text=h.text.truncate(this.text,this.bounds.width)),this.lines=[this.text]}}draw(t){const s=this.active?this.activeFg:this.fg,e=this.active?this.activeBg:this.bg;this.lines.forEach(((i,h)=>{t.drawText(this.bounds.x,this.bounds.y+h,i,s,e,this.bounds.width)}))}}class a extends o{constructor(t,s){super(t,s)}init(t){if(!t.text)throw new Error("Must have text value in config for Button widget - "+this.id);t.tabStop=h.first(t.tabStop,!0),super.init(t)}async click(t,s){return!!this.contains(t)&&(await s.fireAction(this.action,this),!0)}async keypress(t,s){return!!t.key&&("Enter"===t.key&&(await s.fireAction(this.action,this),!0))}}class d extends o{constructor(t,s){super(t,s)}init(t){this.minLength=t.minLength||1,t.width||(t.width=Math.max(this.minLength,10)),t.tabStop=h.first(t.tabStop,!0),super.init(t),this.default=t.default||"",this.errorFg=t.errorFg||this.fg,this.hint=t.hint||"",this.hintFg=t.hintFg||this.errorFg,this.numbersOnly=t.numbersOnly||!1,this.min=h.first(t.min,Number.MIN_SAFE_INTEGER),this.max=h.first(t.max,Number.MAX_SAFE_INTEGER),this.bounds.width<=0&&(this.hint&&(this.bounds.width=this.hint.length),this.default&&(this.bounds.width=this.default.length)),this.bounds.height<=0&&(this.bounds.height=1),this.reset()}reset(){this.text=this.default}isValid(){if(this.numbersOnly){const t=Number.parseInt(this.text);return!(void 0!==this.min&&t<this.min)&&(!(void 0!==this.max&&t>this.max)&&t>0)}return this.text.length>=this.minLength}get value(){return this.numbersOnly?Number.parseInt(this.text):this.text}keypress(t,s){const e=this.numbersOnly?["0","9"]:[" ","~"];if(!t.key)return!1;if("Enter"===t.key&&this.isValid()){const t=s.fireAction(this.action,this);return!t||t.then((()=>!0))}return"Delete"==t.key||"Backspace"==t.key?(this.text.length&&(this.text=h.text.spliceRaw(this.text,this.text.length-1,1)),!0):!(t.key.length>1)&&(t.key>=e[0]&&t.key<=e[1]&&this.text.length<this.bounds.width&&(this.text+=t.key),!0)}draw(t){const s=this.bounds.x,e=this.bounds.y,i=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,h=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;if(t.fillRect(s,e,this.bounds.width,1," ",i,h),!this.text.length&&this.hint&&this.hint.length)t.drawText(s,e,this.hint,this.hintFg);else{const h=this.isValid()?i:this.errorFg;t.drawText(s,e,this.text,h)}}}class l{constructor(t){this.active=!1,this.hovered=!1,this.fg=null,this.bg=null,this.activeFg=null,this.activeBg=null,this.hoverFg=null,this.hoverBg=null,this.align="left",this.header="",this.empty="",this._value=h.IDENTITY,this.x=-1,this.width=-1,this.index=-1,h.object.assignOmitting("value",this,t),this.width<=0&&(this.width=this.header.length||1),"string"==typeof t.value?this._value=h.text.compile(t.value):this._value=t.value||h.IDENTITY,t.align&&(this.align=t.align)}value(t,s){const e=this._value(t,s);return h.text.truncate(e,this.width)}}class u extends o{constructor(t,s){super(t,s),this.data=null,this.selectedColumn=null,this.selectedIndex=-1}init(t){if(!t.height)throw new Error("Height is required.");if(!t.columns||0==t.columns.length)throw new Error("Must have at least 1 column.");t.tabStop=h.first(t.tabStop,!0),super.init(t),this.headers=h.first(t.headers,!0),this.letters=h.first(t.letters,!0),this.columns=[],this.hoverType=t.hover||"row",this.wrapColumns=h.first(t.wrapColumns,t.wrap,!0),this.wrapRows=h.first(t.wrapRows,t.wrap,!0),this.headerFg=t.headerFg||this.fg,this.headerBg=t.headerBg||this.bg;let s=0;t.letters&&(this.columns.push(new l({width:2,value:(t,s)=>String.fromCharCode(97+s)+")"})),s+=2),t.columns&&t.columns.forEach((t=>{const e=new l(t);this.columns.push(e),s+=e.width})),this.columns.forEach(((t,s)=>t.index=s)),this.bounds.width=this.bounds.width>0?this.bounds.width:s}setData(t){this.data=t,this.selectedIndex=-1}selectRow(t){if(!this.data)return!1;return!(t>=(Array.isArray(this.data)?this.data.length:h.list.length(this.data)))&&(!(t<-1)&&(this.selectedIndex=t,!0))}selectNextRow(t=!0){if(!this.data)return-1;const s=Array.isArray(this.data)?this.data.length:h.list.length(this.data);return this.selectedIndex=h.nextIndex(this.selectedIndex,s,t),this.selectedIndex>-1&&!this.selectedColumn&&(this.selectedColumn=this.columns[0]),this.selectedIndex}selectPrevRow(t=!0){if(!this.data)return-1;const s=Array.isArray(this.data)?this.data.length:h.list.length(this.data);return this.selectedIndex=h.prevIndex(this.selectedIndex,s,t),this.selectedIndex>-1&&!this.selectedColumn&&(this.selectedColumn=this.columns[0]),this.selectedIndex}selectNextColumn(t=!0){if(this.selectedColumn){let s=h.nextIndex(this.selectedColumn.index,this.columns.length,t);this.selectedColumn=this.columns[s]||null}else this.selectedColumn=this.columns[0];return this.selectedColumn&&this.selectedIndex<0&&this.data&&(this.selectedIndex=0),this.selectedColumn}selectPrevColumn(t=!0){if(this.selectedColumn){let s=h.prevIndex(this.selectedColumn.index,this.columns.length,t);this.selectedColumn=this.columns[s]||null}else this.selectedColumn=this.columns[this.columns.length-1];return this.selectedColumn&&this.selectedIndex<0&&this.data&&(this.selectedIndex=0),this.selectedColumn}get selectedData(){return this.data?Array.isArray(this.data)?this.data[this.selectedIndex]||null:h.list.at(this.data,this.selectedIndex):null}draw(t){const s=this.bounds;t.fillRect(s.x,s.y,s.width,s.height," ",this.bg,this.bg);let e=s.x;this.columns.forEach((s=>{this.drawColumn(t,s,e),e+=s.width}))}drawColumn(t,s,e){let i=this.bounds.y;s.header&&(t.fillRect(e,i,s.width,1," ",this.headerFg,this.headerBg),t.drawText(e,i,s.header,this.headerFg,this.headerBg,s.width,s.align),++i),this.data&&(Array.isArray(this.data)?this.data.forEach(((h,n)=>{this.drawCell(t,s,h,n,e,i),++i})):h.list.forEach(this.data,((h,n)=>{this.drawCell(t,s,h,n,e,i),++i})))}drawCell(t,s,e,i,h,n){if(n>this.bounds.bottom)return;let o=s._value(e,i);0==o.length&&(o=s.empty);let r=this.fg,a=this.bg;"row"===this.hoverType?i===this.selectedIndex&&(r=this.hoverFg,a=this.hoverBg):"column"===this.hoverType?s===this.selectedColumn&&(r=this.hoverFg,a=this.hoverBg):"cell"===this.hoverType&&s===this.selectedColumn&&i===this.selectedIndex&&(r=this.hoverFg,a=this.hoverBg),t.fillRect(h,n,s.width,1," ",a,a),t.drawText(h,n,o,r,a,s.width,s.align)}async mousemove(t,s){if(!super.mousemove(t,s))return!1;const e=this.selectedColumn,i=this.selectedIndex;let h=t.x-this.bounds.x;const n=this.selectedColumn=this.columns.find((t=>t.width>=h||(h-=t.width,!1)))||null;let o=-1;return this.data&&(o=t.y-this.bounds.y-(this.headers?1:0),Array.isArray(this.data)&&o>=this.data.length&&(o=-1)),this.selectedIndex=o,e===n&&i===o||(s.fireAction(this.id+"_HOVER",this),s.requestRedraw()),!0}dir(t){return!!t.dir&&(t.dir[0]>0?this.selectNextColumn(this.wrapColumns):t.dir[0]<0&&this.selectPrevColumn(this.wrapColumns),t.dir[1]>0?this.selectNextRow(this.wrapRows):t.dir[1]<0&&this.selectPrevRow(this.wrapRows),!0)}}class c extends o{constructor(t,s){super(t,s?(void 0===s.depth&&(s.depth=-10),s.title&&(s.text=s.title),s.bg=s.bg||"gray",s):s)}init(t){super.init(t),this.borderBg=t.borderBg||null}mousemove(t,s){return!1}draw(t){const s=this.active?this.activeFg:this.hovered?this.hoverFg:this.fg,e=this.active?this.activeBg:this.hovered?this.hoverBg:this.bg;this.borderBg?(t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.borderBg,this.borderBg),t.fillRect(this.bounds.x+1,this.bounds.y+1,this.bounds.width-2,this.bounds.height-2," ",e,e)):t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",e,e),this.text&&t.drawText(this.bounds.x,this.bounds.y,this.text,s,-1,this.bounds.width,"center")}}class g{constructor(t,s){this.widgets=[],this.eventHandlers={},this._activeWidget=null,this.result=null,this.done=!1,this.timers={},this.needsRedraw=!0,this.ui=t,this.id=s||"DIALOG"}init(){this.widgets.sort(((t,s)=>t.depth<s.depth?-1:1))}get activeWidget(){return this._activeWidget}setActiveWidget(t,s=!1){t!==this._activeWidget&&(this._activeWidget&&this._activeWidget.deactivate(),this._activeWidget=t,this._activeWidget&&this._activeWidget.activate(s))}requestRedraw(){this.needsRedraw=!0}setTimeout(t,s){this.timers[t]=s}clearTimeout(t){delete this.timers[t]}async fireAction(t,s){const e=this.eventHandlers[t];e&&await e(t,this,s)}setEventHandlers(t){Object.assign(this.eventHandlers,t)}async show(){this.done=!1,this.widgets.forEach((t=>t.reset())),this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null);const t=this.ui.startLayer();return await this.ui.loop.run({keypress:this.keypress.bind(this),dir:this.dir.bind(this),mousemove:this.mousemove.bind(this),click:this.click.bind(this),tick:this.tick.bind(this),draw:()=>{this.draw(t),t.render()}},100),this.ui.finishLayer(),this.result}close(t){this.result=t,this.done=!0}widgetAt(t,s){return this.widgets.find((e=>e.contains(t,s)&&e.depth>=0))||null}getWidget(t){return this.widgets.find((s=>s.id===t))||null}nextTabstop(){if(!this.activeWidget)return this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null),!!this.activeWidget;const t=h.arrayNext(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.setActiveWidget(t),!0)}prevTabstop(){if(!this.activeWidget)return this.setActiveWidget(this.widgets.find((t=>t.tabStop))||null),!!this.activeWidget;const t=h.arrayPrev(this.widgets,this.activeWidget,(t=>t.tabStop));return!!t&&(this.setActiveWidget(t,!0),!0)}async tick(t){const s=t.dt;let e=[];Object.entries(this.timers).forEach((([t,i])=>{(i-=s)<=0?(delete this.timers[t],e.push(this.fireAction(t,null))):this.timers[t]=i}));for(let s of this.widgets)e.push(s.tick(t,this));return e.length?Promise.all(e).then((()=>this.done)):this.done}async mousemove(t){return await Promise.all(this.widgets.map((async s=>{await s.mousemove(t,this),s.hovered&&s.tabStop&&this.setActiveWidget(s)}))),this.done}async click(t){const s=this.widgetAt(t.x,t.y);let e=null;if(s){if(await s.click(t,this))return this.done;e=this.eventHandlers[s.id]}return e=e||this.eventHandlers[this.id]||this.eventHandlers.click,e&&await e(t,this,this.activeWidget),this.done}async keypress(t){if(!t.key)return!1;if(this.activeWidget&&await this.activeWidget.keypress(t,this))return this.done;const s=this.eventHandlers[t.key]||this.eventHandlers[t.code]||this.eventHandlers.keypress;return s&&await s(t,this,this.activeWidget)?this.done:"Tab"===t.key?(this.nextTabstop(),!1):"TAB"===t.key?(this.prevTabstop(),!1):this.done}async dir(t){if(this.activeWidget&&await this.activeWidget.dir(t,this))return this.done;const s=this.eventHandlers.dir||this.eventHandlers.keypress;return s&&await s(t,this,this.activeWidget),this.done}draw(t,s=!1){(this.needsRedraw||s)&&(this.ui.resetLayerBuffer(),this.widgets.forEach((s=>s.draw(t))))}}class b{constructor(t,s,e){this.nextY=0,this.box=null,this.nextY=1,this.dialog=new g(t),this.bounds=new h.xy.Bounds(-1,-1,s,e)}with(t,s){const e=this.bounds;return s?(void 0!==s.right?(e.width=Math.max(e.width,t.bounds.width+s.right),t.bounds.right=e.width-s.right-1):(t.bounds.x=s.x||0,e.width=Math.max(e.width,t.bounds.width+t.bounds.x)),void 0!==s.bottom?(e.height=Math.max(e.height,t.bounds.height+s.bottom),t.bounds.bottom=e.height-s.bottom-1):(t.bounds.y=s.y||0,e.height=Math.max(e.height,t.bounds.height+t.bounds.y))):(e.width=Math.max(e.width,t.bounds.right),e.height=Math.max(e.height,t.bounds.bottom)),this.dialog.widgets.push(t),this.nextY=Math.max(this.nextY,t.bounds.bottom+1),this}center(){const t=this.dialog.ui.buffer,s=this.bounds;return s.x=Math.floor((t.width-s.width)/2),s.y=Math.floor((t.height-s.height)/2),this}place(t,s){const e=this.bounds;return e.x=t,e.y=s,this}addBox(t){return this.box=t||{},this}done(){if(this.bounds.x<0&&(this.bounds.x=0),this.bounds.y<0&&(this.bounds.y=0),this.bounds.right>this.dialog.ui.buffer.width)throw new Error("Dialog is off screen!");if(this.bounds.bottom>this.dialog.ui.buffer.height)throw new Error("Dialog is off screen!");if(this.box){const t=this.box.padX||this.box.pad||1,s=this.box.padY||this.box.pad||1;this.box.x=0,this.box.y=0,this.box.width=this.bounds.width+2*t,this.box.height=this.bounds.height+2*s;const e=new c(this.dialog.id+"_BOX",this.box);this.dialog.widgets.forEach((e=>{e.bounds.x+=t,e.bounds.y+=s})),this.dialog.widgets.unshift(e)}return this.dialog.widgets.forEach((t=>{t.bounds.x+=this.bounds.x,t.bounds.y+=this.bounds.y})),this.dialog}}function f(t,s=0,e=0){return new b(t,s,e)}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class x{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,s){return 0}}class w extends x{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,s){return this.actor.drawStatus(t,s)}}class p extends x{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,s){return this.item.drawStatus(t,s)}}class v extends x{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,s){return this.cell.drawStatus(t,s)}}class y{constructor(t){this.hovered=!1,this.x=999,this.text=t}get width(){return this.text.length}}class m extends y{constructor(t,s){super(t),this.action=s}}class E extends y{constructor(t,s,e,i){super(e),this.buttons=[],this.parent=null,this.menu=t,this.parent=s,this.text=e,this.bounds=new h.xy.Bounds(0,0,0,0),Object.entries(i).forEach((([t,s])=>{this.addButton(t,s)}))}addButton(t,s){let e;e="string"==typeof s?new m(t,s):new E(this.menu,this,t,s),this.buttons.push(e),++this.bounds.height,this.bounds.width=Math.max(this.bounds.width,t.length+2)}setBounds(t,s,e,i){const h=s+i,n=t.width;if(this.bounds.width<n-h)this.bounds.x=h;else{if(!(this.bounds.width<s))throw new Error("Menu does not fit - too wide.");this.bounds.x=s-this.bounds.width}const o=t.height;if(this.bounds.height<=o-e)this.bounds.y=e;else{if(!(this.bounds.height<o))throw new Error("Menu does not fit - too tall.");this.bounds.y=o-this.bounds.height-1}}contains(t){return this.bounds.contains(t)}buttonAt(t){const s=t.y-this.bounds.y;return this.buttons[s]||null}draw(t){const s=this.bounds.width,e=this.bounds.height,i=this.bounds.x;let h=this.bounds.y;t.fillRect(i,h,s,e,0,0,this.menu.dropBg),this.buttons.forEach((s=>{t.drawText(i+1,h,s.text,s.hovered?this.menu.activeFg:this.menu.dropFg,s.hovered?this.menu.activeBg:this.menu.dropBg),++h})),this.parent&&this.parent.draw(t)}}async function B(t,s,e){const i=t.ui,n=i.startLayer();e.buttons.forEach((t=>t.hovered=!1));let o=e;await i.loop.run({Escape:()=>!0,Tab(){s.activeIndex=(s.activeIndex+1)%s.buttons.length;const e=s.buttons[s.activeIndex];return e&&(e.hovered=!0),o&&e instanceof E?(o.hovered=!1,o=e):o=null,t.requestRedraw(),!o},TAB(){s.activeIndex=(s.buttons.length+s.activeIndex-1)%s.buttons.length;const e=s.buttons[s.activeIndex];return e&&(e.hovered=!0),o&&e instanceof E?(o.hovered=!1,o=e):o=null,t.requestRedraw(),!o},mousemove:e=>{if(!o)return!0;let h=o;for(;h&&!h.contains(e);)h=h.parent;if(h){o=h;const t=o.buttonAt(e);t&&(o.buttons.forEach((t=>{t.hovered=!1})),t.hovered=!0,t instanceof E&&(t.buttons.forEach((t=>{t.hovered=!1})),t.buttons[0].hovered=!0,t.setBounds(i.buffer,o.bounds.x,e.y,o.bounds.width),o=t))}else if(s.contains(e)){t&&t.requestRedraw();const i=s.getButtonAt(e.x,e.y);i&&(i.hovered=!0,s.activeIndex=s.buttons.indexOf(i)),i instanceof E?(o.hovered=!1,o=i):o=null,t&&t.requestRedraw()}return!o},click:async e=>{if(!o)return!0;if(!o.contains(e))return s.clearHighlight(),!0;const i=o.buttonAt(e);return!i||i instanceof m&&(s.actionButton=i,await t.fireAction(i.action,s),!0)},dir:async t=>{if(!o)return!0;if(t.dir&&t.dir[1]){const s=o.buttons.findIndex((t=>t.hovered));if(s<1&&t.dir[1]<0)return o.buttons.forEach((t=>t.hovered=!1)),!0;const e=h.clamp(s+t.dir[1],0,o.buttons.length-1);o.buttons.forEach(((t,s)=>t.hovered=s===e));const n=o.buttons[e];n instanceof E&&(n.buttons.forEach((t=>{t.hovered=!1})),n.buttons[0].hovered=!0,n.setBounds(i.buffer,o.bounds.x,t.y,o.bounds.width),o=n)}},draw:()=>{o&&(i.resetLayerBuffer(),o.draw(n),s.draw(n),n.render())}}),i.finishLayer(),s.clearHighlight()}t.ActionButton=m,t.ActorEntry=w,t.Box=c,t.Button=a,t.CellEntry=v,t.Column=l,t.Dialog=g,t.DialogBuilder=b,t.DropDownButton=E,t.EntryBase=x,t.Flavor=class extends r{constructor(t,s){super(t,s)}init(t){t.fg=t.fg||"flavorText",t.bg=t.bg||"black",super.init(t),this.promptFg=h.color.from(t.promptFg||"flavorPrompt"),this.overflow=t.overflow||!1,this.isPrompt=!1}showText(t){this.text=h.text.capitalize(t);h.text.length(this.text)>this.bounds.width?(this.lines=h.text.splitIntoLines(this.text,this.bounds.width),!this.overflow&&this.lines.length>this.bounds.height&&(1==this.bounds.height?(this.text=h.text.truncate(this.text,this.bounds.width),this.lines=[this.text]):this.lines.length=this.bounds.height)):this.lines=[this.text],this.isPrompt=!1}clear(){this.text="",this.lines=[""],this.isPrompt=!1}showPrompt(t){this.showText(t),this.isPrompt=!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),super.draw(t)}getFlavorText(t,s,e,i){const o=t.cell(s,e);let r,a="";const d=!i||i.isAnyKindOfVisible(s,e),l=!i||i.isDirectlyVisible(s,e),u=!!i&&i.isRevealed(s,e),c=!!i&&i.isMagicMapped(s,e);let g;if(l)g="you see";else if(d)g="you sense";else if(u)g="you remember";else{if(!c)return"";g="you expect to see"}const b=o.hasActor()?t.actorAt(s,e):null,f=o.hasItem()?t.itemAt(s,e):null,x=o.hasTileFlag(n.flags.Tile.T_STAND_IN_TILE);let w=!1;b?(a=b.getFlavor({color:!1,article:!0,action:!0}),w=!0):f&&(a=f.getFlavor({color:!1,article:!0}),w=!0);let p=x?" in ":" on ";const v=o.depthTile(n.flags.Depth.GROUND)||n.tile.tiles.NULL,y=o.depthTile(n.flags.Depth.SURFACE),m=o.depthTile(n.flags.Depth.LIQUID);let E="";if(y){w&&(w=!1,a+=" on "),y.hasTileFlag(n.flags.Tile.T_BRIDGE)&&(p=" over "),E=y.getFlavor()+p}let B="";m&&(B=m.getFlavor()+" covering ",w&&(w=!1,a+=" in ")),w&&(w=!1,a+=" on ");let k=v.getFlavor({article:!0});return r=h.text.apply("§intro§ §text§.",{intro:g,text:a+E+B+k}),r}},t.Input=d,t.ItemEntry=p,t.List=class extends u{constructor(t,s){super(t,(()=>{const t=s;return t.columns=[s],t.headers=!!s.header,t.hover=!1===s.hover?"none":"row",t})())}},t.Menu=class extends o{constructor(t,s){super(t,s),this.activeIndex=-1,this.actionButton=null}init(t){t.fg=h.first(t.fg,"black"),t.bg=h.first(t.bg,"light_gray"),t.height=t.height||1,t.tabStop=h.first(t.tabStop,!0),super.init(t),this.dropFg=h.color.from(t.dropFg||this.fg),this.dropBg=h.color.from(t.dropBg||this.bg),this.buttons=[],this.separator=t.separator||" | ",this.lead=t.lead||" ",Object.entries(t.buttons).forEach((([t,s])=>{this._addButton(t,s)})),t.separator&&(this.separator=t.separator),void 0!==t.lead&&(this.lead=t.lead?t.lead:"")}reset(){super.reset();const t=this.bounds.y<=10;this.buttons.forEach((s=>{s instanceof E&&(t?s.bounds.top=this.bounds.bottom+1:s.bounds.bottom=this.bounds.top-1)}))}activate(t=!1){super.activate(t),this.activeIndex<0&&(this.activeIndex=t?this.buttons.length-1:0)}deactivate(){super.deactivate(),this.activeIndex=-1}mousemove(t,s){if(this.buttons.forEach((t=>{t.hovered&&(t.hovered=!1)})),!super.mousemove(t,s))return!1;if(this.bounds.contains(t)){let e=null;return this.buttons.forEach((s=>{s.hovered=!1,s.x<t.x&&(e=s)})),e&&(e.hovered=!0,this.activeIndex=this.buttons.indexOf(e)),s&&s.requestRedraw(),!0}return!1}clearHighlight(){this.buttons.forEach((t=>{t.hovered=!1}))}getButtonAt(t,s){return h.arrayFindRight(this.buttons,(s=>s.x<t))||null}async click(t,s){if(this.bounds.contains(t)){let e=this.getButtonAt(t.x,t.y);return!!e&&(this.activeIndex=this.buttons.indexOf(e),e instanceof E?await B(s,this,e):e instanceof m&&(this.actionButton=e,await s.fireAction(e.action,this)),!0)}return!1}async keypress(t,s){if(this.active){if("Tab"===t.key)return++this.activeIndex,!(this.activeIndex>=this.buttons.length)||(this.deactivate(),!1);if("TAB"===t.key)return--this.activeIndex,!(this.activeIndex<0)||(this.deactivate(),!1);if("Enter"===t.key){const t=this.buttons[this.activeIndex];return t instanceof E?await B(s,this,t):t instanceof m&&(this.actionButton=t,await s.fireAction(t.action,this)),!0}}return super.keypress(t,s)}_addButton(t,s){const e=this.buttons.reduce(((t,s)=>t+s.text.length+this.separator.length),this.lead.length+this.bounds.x);if(e+t.length+this.separator.length>this.bounds.width)throw new Error("Button makes menu too wide :"+t);let i;if("string"==typeof s)i=new m(t,s);else{const h=new E(this,null,t,s);h.bounds.x=e-1,i=h}i.x=e,this.buttons.push(i)}draw(t){const s=this.active?this.activeBg:this.bg,e=this.active?this.activeFg:this.fg;t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,1,0,s,s);let i=this.bounds.x;const h=this.bounds.y;return t.drawText(i,h,this.lead,e),this.buttons.forEach(((n,o)=>{const r=o===this.activeIndex,a=r?this.hoverFg:e,d=r?this.hoverBg:s;t.drawText(n.x,h,n.text,a,d),i=n.x+n.text.length,t.drawText(i,h,this.separator,e)})),!0}},t.MenuButton=y,t.Messages=class extends o{constructor(t,s){super(t,s)}init(t){if(t.x=t.x||0,t.y=t.y||0,super.init(t),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:t.length||40,match:(t,s)=>!0})}click(t,s){return!!this.contains(t)&&this.showArchive(s).then((()=>!0))}draw(t){const s=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this.bg,this.bg),this.cache.forEach(((e,i,h)=>{if(h>=this.bounds.height)return;const n=(s?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,n,e,this.fg),i&&t.mix(this.bg,50,this.bounds.x,n,this.bounds.width,1)})),!0}async showArchive(t){let s,e,i=0;const n=t.ui;let o=this.cache.length;if(o<=this.bounds.height)return!1;const r=this.bounds.y<10,a=n.startLayer(),d=h.color.from(this.fg);for(o=Math.min(o,r?a.height-this.bounds.top:this.bounds.bottom+1),s=0;s<=1;s++){e=!1;const t=s?-1:1,h=s?o:this.bounds.height,l=s?this.bounds.height+t+1:o+t;for(let o=h;o!=l;o+=t){const h=r?this.bounds.y+o-1:this.bounds.bottom-o+1,u=r?this.bounds.y:this.bounds.bottom,c=r?-1:1;n.resetLayerBuffer(),a.fillRect(this.bounds.x,Math.min(h,u),this.bounds.width,o," ",this.bg,this.bg),this.cache.forEach(((t,s,e)=>{const n=h+e*c;if(r){if(n<u)return}else if(n>u)return;i=Math.floor(50*e/o);const l=d.clone().mix(this.bg,i);a.drawText(this.bounds.x,n,t,l,this.bg)})),a.render(),e||await n.loop.pause(s?15:45)&&(e=!0,o=l-2*t)}if(!s){const t=r?0:a.height-1,s=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,a.width-8);a.wrapText(s,t,8,"--DONE--",this.bg,this.fg),a.render(),await n.loop.waitForAck()}}return n.finishLayer(),this.cache.confirmAll(),t.requestRedraw(),!0}},t.Sidebar=class extends o{constructor(t,s){super(t,s),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}init(t){t.fg=t.fg||"purple",t.bg=t.bg||"black",super.init(t)}reset(){super.reset(),this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((s=>s.sidebarY<=t.y&&-1!==s.sidebarY))||null}mousemove(t,s){return super.mousemove(t,s),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const s=this.highlight;return this.highlight=null,this.entries.forEach((s=>{s.sidebarY<=t&&-1!==s.sidebarY&&(this.highlight=s)})),this.highlight!==s}clearHighlight(){const t=!!this.highlight;return this.highlight=null,t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(n.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((s,e)=>{const i=t.cell(s,e);i.hasEntityFlag(n.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(i)})),t.clearMapFlag(n.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new w(t)}_makeItemEntry(t){return new p(t)}_makeCellEntry(t){return new v(t)}_getPriority(t,s,e,i){return i?i.isDirectlyVisible(s,e)?1:i.isAnyKindOfVisible(s,e)?2:i.isRevealed(s,e)?3:-1:t.cell(s,e).hasCellFlag(n.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,s,e,i,n){const o=this._getPriority(s,t.x,t.y,n);if(o<0)return!1;const r=this._makeActorEntry(t);return r.dist=h.xy.distanceBetween(e,i,t.x,t.y),r.priority=t.isPlayer()?0:o,this.entries.push(r),!0}_addItemEntry(t,s,e,i,n){const o=this._getPriority(s,t.x,t.y,n);if(o<0)return!1;const r=this._makeItemEntry(t);return r.dist=h.xy.distanceBetween(e,i,t.x,t.y),r.priority=o,this.entries.push(r),!0}_addCellEntry(t,s,e,i,n){const o=this._getPriority(s,t.x,t.y,n);if(o<0)return!1;const r=this._makeCellEntry(t);return r.dist=h.xy.distanceBetween(e,i,t.x,t.y),r.priority=o,this.entries.push(r),!0}findEntries(t,s,e,i){if(t===this.lastMap&&s===this.lastX&&e===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=s,this.lastY=e,this.entries.length=0;const n=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const o=h.x,r=h.y;n[o][r]||this._addActorEntry(h,t,s,e,i)&&(n[o][r]=1)})),t.eachItem((h=>{const o=h.x,r=h.y;n[o][r]||this._addItemEntry(h,t,s,e,i)&&(n[o][r]=1)})),this.cellCache.forEach((h=>{n[h.x][h.y]||this._addCellEntry(h,t,s,e,i)&&(n[h.x][h.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),h.grid.free(n)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,s,e,i){return this.updateCellCache(t),this.findEntries(t,s,e,i),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg),this.entries.forEach((t=>t.sidebarY=-1));const s=this.bounds.clone();let e;for(let i=0;i<this.entries.length&&s.height>0;++i){e=this.entries[i],e.sidebarY=s.y;let h=e.draw(t,s);this._isDim(e)&&t.mix(this.bg,50,s.x,s.y,s.width,h),h&&(++h,s.y+=h,s.height-=h)}return!0}},t.Table=u,t.Text=r,t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||h.loop}render(){this.buffer.render()}get baseBuffer(){return this.layers[this.layers.length-1]||this.canvas.buffer}get canvasBuffer(){return this.canvas.buffer}startLayer(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||this.canvas.buffer.clone(),this.buffer.copy(t),this.buffer.changed=!1,this.buffer}resetLayerBuffer(){const t=this.baseBuffer;this.buffer.copy(t),this.buffer.changed=!1}finishLayer(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.changed=!0,this.buffer.render(),this.inDialog=this.layers.length>0)}async fadeTo(t="black",s=1e3){t=h.color.from(t);const e=this.startLayer();let i=0,n=0;for(;n<s;)n+=32,await this.loop.pause(32)&&(n=s),i=Math.floor(100*n/s),this.resetLayerBuffer(),e.mix(t,i),e.render();this.finishLayer()}async alert(t,s,e){"number"==typeof t&&(t={duration:t}),e&&(s=h.text.apply(s,e));const i=t.width||h.text.length(s);t.box=t.box||{bg:t.bg};const n={fg:t.fg,text:s,x:0,y:0,wrap:i},o=new r("TEXT",n),a=f(this,i,o.bounds.height).with(o,{x:0,y:0}).addBox(t.box).center().done();return a.setEventHandlers({click:()=>a.close(!0),keypress:()=>a.close(!0),TIMEOUT:()=>a.close(!1)}),t.waitForAck||a.setTimeout("TIMEOUT",t.duration||3e3),await a.show()}async confirm(...t){let s,e,i=null;t.length<=2&&"string"==typeof t[0]?(s={},e=t[0],i=t[1]||null):(s=t[0],e=t[1],i=t[2]||null),i&&(e=h.text.apply(e,i));const n=s.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(e)),o={fg:s.fg,text:e,wrap:n},d=new r("TEXT",o),l=d.bounds.height+2;s.allowCancel=!1!==s.allowCancel,s.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},s.buttons||{}),"string"==typeof s.ok&&(s.ok={text:s.ok}),"string"==typeof s.cancel&&(s.cancel={text:s.cancel}),s.ok=s.ok||{},s.cancel=s.cancel||{};const u=Object.assign({},s.buttons,{text:"OK"},s.ok),c=Object.assign({},s.buttons,{text:"CANCEL"},s.cancel),g=f(this,n,l).with(d,{x:0,y:0}).with(new a("OK",u),{x:0,bottom:0});s.allowCancel&&g.with(new a("CANCEL",c),{right:0,bottom:0});const b=g.center().addBox(s.box).done();return b.setEventHandlers({OK(){b.close(!0)},CANCEL(){b.close(!1)},Escape(){b.close(!1)},Enter(){b.close(!0)}}),await b.show()}async showWidget(t,s={}){const e=t.bounds.x<0||t.bounds.y<0,i={x:t.bounds.x,y:t.bounds.y},h=f(this).with(t,{x:0,y:0});e?h.center():h.place(i.x,i.y);const n=h.done();return s.Escape=s.Escape||(()=>{n.close(!1)}),n.setEventHandlers(s),await n.show()}async getInputAt(t,s,e,i={}){i.width=e,i.x=t,i.y=s;const h=new d("INPUT",i);return this.showWidget(h,{INPUT(t,s){s.close(h.text)},Escape(t,s){s.close("")}})}async inputBox(t,s,e){e&&(s=h.text.apply(s,e));const i=t.width||Math.min(Math.floor(this.buffer.width/2),h.text.length(s)),n={fg:t.fg,text:s,wrap:i},o=new r("TEXT",n),l=o.bounds.height+2+2;t.allowCancel=!1!==t.allowCancel,t.buttons=Object.assign({fg:"white",activeFg:"teal",bg:"dark_gray",activeBg:"darkest_gray"},t.buttons||{}),"string"==typeof t.ok&&(t.ok={text:t.ok}),"string"==typeof t.cancel&&(t.cancel={text:t.cancel}),t.ok=t.ok||{},t.cancel=t.cancel||{};const u=Object.assign({},t.buttons,{text:"OK"},t.ok),c=Object.assign({},t.buttons,{text:"CANCEL"},t.cancel);t.input=t.input||{},t.input.width=t.input.width||i,t.input.bg=t.input.bg||t.fg,t.input.fg=t.input.fg||t.bg;const g=new d("INPUT",t.input||{}),b=f(this,i,l).with(o,{x:0,y:0}).with(g,{bottom:2,x:0}).with(new a("OK",u),{bottom:0,x:0}).addBox(t.box);t.allowCancel&&b.with(new a("CANCEL",c),{bottom:0,right:0});const x=b.center().done();return x.setEventHandlers({OK(){x.close(g.text)},CANCEL(){x.close("")},Escape(){x.close("")},INPUT(){x.close(g.text)}}),await x.show()}},t.Viewport=class extends o{constructor(t,s){super(t,s),this.offsetX=0,this.offsetY=0,this._subject=null}init(t){t.bg=t.bg||"black",t.x=t.x||0,t.y=t.y||0,super.init(t),this.snap=t.snap||!1,this.center=t.center||!1,this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}get subject(){return this._subject}set subject(t){this.center=!!t,t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t}set lock(t){this.lockX=t,this.lockY=t}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,s,e){this.center=!0,this.subject={x:s,y:e,map:t}}showMap(t,s=0,e=0){this.subject={x:s,y:e,map:t},this.offsetX=s,this.offsetY=e,this.center=!1,this.snap=!1}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,s=t.memory||t.map,e=s;if(t&&s.hasXY(t.x,t.y))if(this.snap){let s=this.offsetX,i=this.offsetX+this.bounds.width,h=this.offsetY,n=this.offsetY+this.bounds.height;(t.x<s||t.x>i)&&(s=this.offsetX=t.x-this.halfWidth(),i=s+this.bounds.width),(t.y<h||t.y>n)&&(h=this.offsetY=t.y-this.halfHeight(),n=h+this.bounds.height);const o=Math.floor(this.bounds.width/5),r=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);s+o>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):i-o<=t.x&&(this.offsetX=Math.min(t.x-a,e.width-this.bounds.width));const d=Math.floor(this.bounds.height/3);h+r>=t.y?this.offsetY=Math.max(0,t.y+d-this.bounds.height):n-r<=t.y&&(this.offsetY=Math.min(t.y-d,e.height-this.bounds.height))}else this.center?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&s&&(this.offsetX=h.clamp(this.offsetX,0,s.width-this.bounds.width)),this.lockY&&s&&(this.offsetY=h.clamp(this.offsetY,0,s.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this.bg),!this._subject)return!1;this.updateOffset();const s=this._subject.memory||this._subject.map,e=this._subject.fov,i=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let n=0;n<this.bounds.height;++n){const o=h+this.offsetX,r=n+this.offsetY;if(s.hasXY(o,r)){const t=s.cell(o,r);s.drawer.drawCell(i,t,e)}else i.draw(" ",this.bg,this.bg);this.filter&&this.filter(i,o,r,s),t.drawSprite(h+this.bounds.x,n+this.bounds.y,i)}return!0}},t.Widget=o,t.buildDialog=f,t.makeTable=function(t,s){return new u(t,s)},t.showDropDown=B,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
