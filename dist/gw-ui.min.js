!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,e){"use strict";function i(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(e){if("default"!==e){var i=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(s,e,i.get?i:{enumerable:!0,get:function(){return t[e]}})}})),s.default=t,Object.freeze(s)}var h=i(s),r=i(e);class o extends h.widget.Widget{constructor(t,s){if(super(t,(s.tag=s.tag||"messages",s)),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:s.length||40,match:(t,s)=>(this.layer.needsDraw=!0,!0)})}click(t){return!!this.contains(t)&&(this._showArchive(),!0)}draw(t){const s=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this._used.bg,this._used.bg),this.cache.forEach(((e,i,h)=>{if(h>=this.bounds.height)return;const r=(s?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,r,e,this._used.fg),i&&this._used.bg&&t.mix(this._used.bg,50,this.bounds.x,r,this.bounds.width,1)})),!0}_showArchive(){this.cache.length<=this.bounds.height||l(this)}}class n extends h.widget.Widget{constructor(t,s){super(t,{id:"ARCHIVE",tag:"messages",class:s.classes.concat("archive").join(" "),height:s.bounds.height,width:s.bounds.width,x:0,y:0,tabStop:!0,depth:100}),this.mode="forward",this._timeout=null,this.source=s,this.isOnTop=this.source.bounds.y<10,this.bounds.height=this.isOnTop?t.height-s.bounds.y:s.bounds.bottom,this.totalCount=Math.min(s.cache.length,this.isOnTop?t.height-this.source.bounds.top:this.source.bounds.bottom),this.shown=s.bounds.height,this._timeout=this.layer.setTimeout((()=>this._forward()),16),this.source.cache.confirmAll()}contains(){return!0}finish(){this.layer.finish()}keypress(t){return this.click(t)}click(t){return"ack"===this.mode?(this.mode="reverse",this.layer.needsDraw=!0,this._timeout&&this.layer.clearTimeout(this._timeout),this._timeout=this.layer.setTimeout((()=>this._reverse()),16)):"reverse"===this.mode?this.finish():(this.mode="ack",this.shown=this.totalCount,this._timeout&&(this.layer.clearTimeout(this._timeout),this._timeout=null),this.layer.needsDraw=!0),!0}_forward(){return++this.shown,this._timeout=null,this.layer.needsDraw=!0,this.shown<this.totalCount?this._timeout=this.layer.setTimeout((()=>this._forward()),16):(this.mode="ack",this.shown=this.totalCount),!0}_reverse(){return--this.shown,this._timeout=null,this.shown<=this.source.bounds.height?this.finish():(this.layer.needsDraw=!0,this._timeout=this.layer.setTimeout((()=>this._reverse()),16)),!0}_draw(t){let s=0;const e=this.isOnTop,i=t,r=h.color.from(this.source._used.fg),o=e?this.shown-1:this.bounds.bottom-this.shown,n=e?0:this.bounds.bottom-1,l=e?-1:1;if(i.fillRect(this.source.bounds.x,Math.min(o,n),this.bounds.width,this.shown," ",this._used.bg,this._used.bg),this.source.cache.forEach(((t,h,a)=>{const u=o+a*l;if(e){if(u<n)return}else if(u>n)return;s=Math.floor(50*a/this.shown);const d=r.mix(this._used.bg,s);i.drawText(this.source.bounds.x,u,t,d,this._used.bg)})),"ack"===this.mode){const t=this.isOnTop?0:i.height-1,s=this.source.bounds.x>8?this.source.bounds.x-8:Math.min(this.source.bounds.x+this.bounds.width,i.width-8);i.wrapText(s,t,8,"--DONE--",this._used.bg,this._used.fg)}return!0}}async function l(t){const s=new h.widget.WidgetLayer(t.layer.ui);new n(s,t),await s.run()}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);class a extends h.widget.Text{constructor(t,s){super(t,(s.tag=s.tag||"flavor",s.text="",s)),this.overflow=s.overflow||!1,this.isPrompt=!1}showText(t){return this.text(t),this.removeClass("prompt"),this}clear(){return this.text(""),this.removeClass("prompt"),this}showPrompt(t){return this.showText(t),this.addClass("prompt"),this}getFlavorText(t,s,e,i){const o=t.cell(s,e);let n,l="";const a=!i||i.isAnyKindOfVisible(s,e),u=!i||i.isDirectlyVisible(s,e),d=!!i&&i.isRevealed(s,e),c=!!i&&i.isMagicMapped(s,e);let f;if(u)f="You see";else if(a)f="You sense";else if(d)f="You remember";else{if(!c)return"";f="You expect to see"}const g=o.hasActor()?t.actorAt(s,e):null,b=o.hasItem()?t.itemAt(s,e):null,y=o.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let p=!1;g?(l=g.getFlavor({color:!1,article:!0,action:!0}),p=!0):b&&(l=b.getFlavor({color:!1,article:!0}),p=!0);let w=y?" in ":" on ";const m=o.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,_=o.depthTile(r.flags.Depth.SURFACE),x=o.depthTile(r.flags.Depth.LIQUID);let E="";if(_){p&&(p=!1,l+=" on "),_.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(w=" over "),E=_.getFlavor()+w}let M="";x&&(M=x.getFlavor()+" covering ",p&&(p=!1,l+=" in ")),p&&(p=!1,l+=" on ");let v=m.getFlavor({article:!0});return n=h.text.apply("§intro§ §text§.",{intro:f,text:l+E+M+v}),n}}h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class u{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,s){return 0}}class d extends u{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,s){return this.actor.drawStatus(t,s)}}class c extends u{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,s){return this.item.drawStatus(t,s)}}class f extends u{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,s){return this.cell.drawStatus(t,s)}}class g extends h.widget.Widget{constructor(t,s){super(t,s),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}reset(){this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((s=>s.sidebarY<=t.y&&-1!==s.sidebarY))||null}mousemove(t){return super.mousemove(t),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const s=this.highlight;return this.highlight=null,this.entries.forEach((s=>{s.sidebarY<=t&&-1!==s.sidebarY&&(this.highlight=s)})),this.highlight!==s}clearHighlight(){const t=!!this.highlight;return this.highlight=null,t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((s,e)=>{const i=t.cell(s,e);i.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(i)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new d(t)}_makeItemEntry(t){return new c(t)}_makeCellEntry(t){return new f(t)}_getPriority(t,s,e,i){return i?i.isDirectlyVisible(s,e)?1:i.isAnyKindOfVisible(s,e)?2:i.isRevealed(s,e)?3:-1:t.cell(s,e).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,s,e,i,r){const o=this._getPriority(s,t.x,t.y,r);if(o<0)return!1;const n=this._makeActorEntry(t);return n.dist=h.xy.distanceBetween(e,i,t.x,t.y),n.priority=t.isPlayer()?0:o,this.entries.push(n),!0}_addItemEntry(t,s,e,i,r){const o=this._getPriority(s,t.x,t.y,r);if(o<0)return!1;const n=this._makeItemEntry(t);return n.dist=h.xy.distanceBetween(e,i,t.x,t.y),n.priority=o,this.entries.push(n),!0}_addCellEntry(t,s,e,i,r){const o=this._getPriority(s,t.x,t.y,r);if(o<0)return!1;const n=this._makeCellEntry(t);return n.dist=h.xy.distanceBetween(e,i,t.x,t.y),n.priority=o,this.entries.push(n),!0}findEntries(t,s,e,i){if(t===this.lastMap&&s===this.lastX&&e===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=s,this.lastY=e,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const o=h.x,n=h.y;r[o][n]||this._addActorEntry(h,t,s,e,i)&&(r[o][n]=1)})),t.eachItem((h=>{const o=h.x,n=h.y;r[o][n]||this._addItemEntry(h,t,s,e,i)&&(r[o][n]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,s,e,i)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),h.grid.free(r)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,s,e,i){return this.updateCellCache(t),this.findEntries(t,s,e,i),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this._used.bg),this.entries.forEach((t=>t.sidebarY=-1));const s=this.bounds.clone();let e;for(let i=0;i<this.entries.length&&s.height>0;++i){e=this.entries[i],e.sidebarY=s.y;let h=e.draw(t,s);this._isDim(e)&&this._used.bg&&t.mix(this._used.bg,50,s.x,s.y,s.width,h),h&&(++h,s.y+=h,s.height-=h)}return!0}}class b extends h.widget.Widget{constructor(t,s){super(t,s),this.offsetX=0,this.offsetY=0,this._subject=null,this.attr("snap",s.snap||!1),this.attr("center",s.center||!1),this.filter=s.filter||null,this.attr("lockX",s.lock||s.lockX||!1),this.attr("lockY",s.lock||s.lockY||!1)}get subject(){return this._subject}set subject(t){this.attr("center",!!t),t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t}set lock(t){this.attr("lockX",t),this.attr("lockY",t)}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,s,e){this.attr("center",!0),this.subject={x:s,y:e,map:t}}showMap(t,s=0,e=0){this.subject={x:s,y:e,map:t},this.offsetX=s,this.offsetY=e,this.attr("center",!1),this.attr("snap",!1)}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,s=t.memory||t.map,e=s;if(t&&s.hasXY(t.x,t.y))if(this._attrBool("snap")){let s=this.offsetX,i=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<s||t.x>i)&&(s=this.offsetX=t.x-this.halfWidth(),i=s+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const o=Math.floor(this.bounds.width/5),n=Math.floor(this.bounds.height/5),l=Math.floor(this.bounds.width/3);s+o>=t.x?this.offsetX=Math.max(0,t.x+l-this.bounds.width):i-o<=t.x&&(this.offsetX=Math.min(t.x-l,e.width-this.bounds.width));const a=Math.floor(this.bounds.height/3);h+n>=t.y?this.offsetY=Math.max(0,t.y+a-this.bounds.height):r-n<=t.y&&(this.offsetY=Math.min(t.y-a,e.height-this.bounds.height))}else this._attrBool("center")?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this._attrBool("lockX")&&s&&(this.offsetX=h.clamp(this.offsetX,0,s.width-this.bounds.width)),this._attrBool("lockY")&&s&&(this.offsetY=h.clamp(this.offsetY,0,s.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this._used.bg),!this._subject)return!1;this.updateOffset();const s=this._subject.memory||this._subject.map,e=this._subject.fov,i=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let r=0;r<this.bounds.height;++r){const o=h+this.offsetX,n=r+this.offsetY;if(s.hasXY(o,n)){const t=s.cell(o,n);s.drawer.drawCell(i,t,e)}else i.draw(" ",this._used.bg,this._used.bg);this.filter&&this.filter(i,o,n,s),t.drawSprite(h+this.bounds.x,r+this.bounds.y,i)}return!0}}var y=Object.freeze({__proto__:null,Messages:o,MessageArchive:n,showArchive:l,Flavor:a,EntryBase:u,ActorEntry:d,ItemEntry:c,CellEntry:f,Sidebar:g,Viewport:b});t.game=y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
