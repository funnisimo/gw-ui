!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,i){"use strict";function e(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var e=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(s,i,e.get?e:{enumerable:!0,get:function(){return t[i]}})}})),s.default=t,Object.freeze(s)}var r=e(s),h=e(i);r.color.install("flavorText",50,40,90),r.color.install("flavorPrompt",100,90,20);r.color.install("blueBar",15,10,50),r.color.install("redBar",45,10,15),r.color.install("purpleBar",50,0,50),r.color.install("greenBar",10,50,10);class o{constructor(){this.dist=0,this.priority=0,this.changed=!1}draw(t){}}class n extends o{constructor(t){super(),this.actor=t}draw(t){this.actor.drawStatus(t)}}class a extends o{constructor(t){super(),this.item=t}draw(t){this.item.drawStatus(t)}}class l extends o{constructor(t){super(),this.cell=t}draw(t){this.cell.drawStatus(t)}}t.ActorEntry=n,t.CellEntry=l,t.EntryBase=o,t.Flavor=class{constructor(t){var s,i,e;this.text="",this.needsUpdate=!1,this.isPrompt=!1,this.overflow=!1,this.ui=t.ui,this.bounds=new r.xy.Bounds(t.x,t.y,t.width,1),this.fg=r.color.from(null!==(s=t.fg)&&void 0!==s?s:"flavorText"),this.bg=r.color.from(null!==(i=t.bg)&&void 0!==i?i:"black"),this.promptFg=r.color.from(null!==(e=t.promptFg)&&void 0!==e?e:"flavorPrompt")}showText(t){this.text=r.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!1,this.draw()}clear(){this.text="",this.needsUpdate=!0,this.isPrompt=!1,this.draw()}showPrompt(t){this.text=r.text.capitalize(t),this.needsUpdate=!0,this.isPrompt=!0,this.draw()}draw(t=!1){if(!t&&!this.needsUpdate)return!1;const s=this.ui.buffer,i=this.isPrompt?this.fg:this.promptFg,e=s.wrapText(this.bounds.x,this.bounds.y,this.bounds.width,this.text,i,this.bg);return this.overflow=e!==this.bounds.y+1,this.ui.render(),this.needsUpdate=!1,!0}getFlavorText(t,s,i,e){const o=t.cell(s,i);let n,a="";const l=!e||e.isAnyKindOfVisible(s,i),u=!e||e.isDirectlyVisible(s,i),f=!!e&&e.isRevealed(s,i),c=!!e&&e.isMagicMapped(s,i);let d;if(u)d="you see";else if(l)d="you sense";else if(f)d="you remember";else{if(!c)return"";d="you expect to see"}const b=o.hasActor()?t.actorAt(s,i):null,g=o.hasItem()?t.itemAt(s,i):null,p=o.hasTileFlag(h.flags.Tile.T_STAND_IN_TILE);let y=!1;b?(a=b.getFlavor({color:!1,article:!0,action:!0}),y=!0):g&&(a=g.getFlavor({color:!1,article:!0}),y=!0);let w=p?" in ":" on ";const x=o.depthTile(h.flags.Depth.GROUND)||h.tile.tiles.NULL,m=o.depthTile(h.flags.Depth.SURFACE),v=o.depthTile(h.flags.Depth.LIQUID);let M="";if(m){y&&(y=!1,a+=" on "),m.hasTileFlag(h.flags.Tile.T_BRIDGE)&&(w=" over "),M=m.getFlavor()+w}let Y="";v&&(Y=v.getFlavor()+" covering ",y&&(y=!1,a+=" in ")),y&&(y=!1,a+=" on ");let E=x.getFlavor({article:!0});return n=r.text.apply("§intro§ §text§.",{intro:d,text:a+M+Y+E}),n}},t.ItemEntry=a,t.Messages=class{constructor(t){const s=t.ui.buffer;this.bounds=new r.xy.Bounds(t.x,t.y,Math.min(t.width||s.width,s.width-t.x),Math.min(t.height||s.height,s.height-t.y)),this.cache=new r.message.MessageCache({width:this.bounds.width,length:s.height}),this.ui=t.ui,this.bg=r.color.from(t.bg||"black"),this.fg=r.color.from(t.fg||"white")}contains(t,s){return this.bounds.contains(t,s)}get needsUpdate(){return this.cache.needsUpdate}get buffer(){return this.ui.buffer}draw(t=!1){if(!t&&!this.cache.needsUpdate)return!1;let s;const i=r.color.make(),e=this.bounds.y<10;return this.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",0,this.bg),this.cache.forEach(((t,h,o)=>{if(o>=this.bounds.height)return;s=i,s.copy(this.fg),h&&(s.mix(this.bg,50),s.mix(this.bg,75*o/(2*this.bounds.height)));const n=e?this.bounds.height-o-1:o,a=this.toBufferY(n);r.text.eachChar(t,((t,e,r,n)=>{const l=this.toBufferX(n);e&&s!==e&&h&&(e.mix(this.bg,50),e.mix(this.bg,75*o/(2*this.bounds.height))),s=e||i,this.buffer.draw(l,a,t,s,this.bg)}))})),this.cache.needsUpdate=!1,!0}toBufferY(t){return this.bounds.y+t}toBufferX(t){return this.bounds.x+t}async showArchive(){let t,s,i,e=0,r=0;if(this.cache.forEach((()=>++r)),r<=this.bounds.height)return;const h=this.bounds.y<10,o=this.ui.startDialog();for(t=0;t<=1;t++){for(i=!1,e=t?r:this.bounds.height;t?e>=this.bounds.height:e<=r;e+=t?-1:1)this.ui.resetDialogBuffer(o),this.cache.forEach(((t,i,r)=>{if(r>=e||r>=o.height)return;const n=h?r:o.height-r-1;s=Math.floor(50*(e-r)/e);const a=this.fg.clone().mix(this.bg,s);o.wrapText(this.toBufferX(0),n,this.bounds.width,t,a,this.bg)})),o.render(),!i&&await this.ui.loop.pause(t?15:45)&&(i=!0,e=t?this.bounds.height+1:r-1);if(!t){const t=h?0:o.height-1,s=this.bounds.x>8?this.bounds.x-8:Math.min(this.bounds.x+this.bounds.width,this.buffer.width-8);o.wrapText(s,t,8,"--DONE--",this.bg,this.fg),o.render(),await this.ui.loop.waitForAck()}}this.ui.finishDialog(),this.cache.confirmAll(),this.cache.needsUpdate=!0}},t.Sidebar=class{constructor(t){this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.mixer=new r.sprite.Mixer,this.currentY=0,this.currentPriority=-1,this.follow=null,this.ui=t.ui,this.bounds=new r.xy.Bounds(t.x,t.y,t.width,t.height),this.bg=r.color.from(t.bg||"black"),this.fg=r.color.from(t.fg||"purple")}get buffer(){return this.ui.buffer}contains(t,s){return this.bounds.contains(t,s)}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(h.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,r.xy.forRect(t.width,t.height,((s,i)=>{const e=t.cell(s,i);e.hasEntityFlag(h.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(e)})),t.clearMapFlag(h.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}makeActorEntry(t){return new n(t)}makeItemEntry(t){return new a(t)}makeCellEntry(t){return new l(t)}getPriority(t,s,i,e){return e?e.isDirectlyVisible(s,i)?1:e.isAnyKindOfVisible(s,i)?2:e.isRevealed(s,i)?3:-1:t.cell(s,i).hasCellFlag(h.flags.Cell.STABLE_MEMORY)?3:1}addActor(t,s,i,e,h){const o=this.getPriority(s,t.x,t.y,h);if(o<0)return!1;const n=this.makeActorEntry(t);return n.dist=r.xy.distanceBetween(i,e,t.x,t.y),n.priority=t.isPlayer()?0:o,this.entries.push(n),!0}addItem(t,s,i,e,h){const o=this.getPriority(s,t.x,t.y,h);if(o<0)return!1;const n=this.makeItemEntry(t);return n.dist=r.xy.distanceBetween(i,e,t.x,t.y),n.priority=o,this.entries.push(n),!0}addCell(t,s,i,e,h){const o=this.getPriority(s,t.x,t.y,h);if(o<0)return!1;const n=this.makeCellEntry(t);return n.dist=r.xy.distanceBetween(i,e,t.x,t.y),n.priority=o,this.entries.push(n),!0}findEntries(t,s,i,e){if(t===this.lastMap&&s===this.lastX&&i===this.lastY)return;this.lastMap=t,this.lastX=s,this.lastY=i,this.entries.length=0;const h=r.grid.alloc(t.width,t.height);t.eachActor((r=>{const o=r.x,n=r.y;h[o][n]||this.addActor(r,t,s,i,e)&&(h[o][n]=1)})),t.eachItem((r=>{const o=r.x,n=r.y;h[o][n]||this.addItem(r,t,s,i,e)&&(h[o][n]=1)})),this.cellCache.forEach((r=>{h[r.x][r.y]||this.addCell(r,t,s,i,e)&&(h[r.x][r.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),r.grid.free(h)}clearSidebar(){this.ui.buffer.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this.bg)}drawFor(t){return this.draw(t.memory||t.map,t.x,t.y,t.fov)}draw(t,s,i,e){if(arguments.length<3){if(this.follow)return this.drawFor(this.follow);throw new Error("Not following a subject - map, cx, cy required.")}this.updateCellCache(t),this.findEntries(t,s,i,e),this.clearSidebar(),this.currentY=this.bounds.y,this.currentPriority=-1;for(let t=0;t<this.entries.length&&this.currentY<this.bounds.bottom;++t){const s=this.entries[t];this.currentPriority=s.priority,s.draw(this),++this.currentY}return this.currentPriority=-1,!0}drawTitle(t,s,i){i=r.color.from(i||this.fg);const e=this.currentPriority<3?i:i.clone().darken(50);this.buffer.drawSprite(this.bounds.x+1,this.currentY,t),this.buffer.wrapText(this.bounds.x+3,this.currentY,this.bounds.width-3,s,e),++this.currentY}drawTextLine(t,s){s=r.color.from(s||this.fg);const i=this.currentPriority<3?s:s.clone().darken(50);this.buffer.drawText(this.bounds.x+3,this.currentY,t,i,this.bounds.width-3),++this.currentY}drawProgressBar(t,s,i,e,h,o){e=r.color.from(e||this.fg),h=r.color.from(h||e.clone().darken(50)),o=r.color.from(o||e.clone().lighten(50)),this.currentPriority<3&&(h.darken(50),o.darken(50),e.darken(50)),this.buffer.fillRect(this.bounds.x+1,this.currentY,this.bounds.width-1,1,void 0,void 0,h);const n=Math.floor((this.bounds.width-1)*t/s);this.buffer.fillRect(this.bounds.x+1,this.currentY,n,1,void 0,void 0,e);const a=r.text.center(i,this.bounds.width);this.buffer.drawText(this.bounds.x+1,this.currentY,a,o,void 0,this.bounds.width-1),++this.currentY}},t.UI=class{constructor(t={}){if(this.layers=[],this.freeBuffers=[],this.inDialog=!1,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.buffer=t.canvas.buffer,this.loop=t.loop||r.loop}render(){this.buffer.render()}startDialog(){this.inDialog=!0;const t=this.buffer||this.canvas.buffer;return this.layers.push(t),this.buffer=this.freeBuffers.pop()||new r.canvas.Buffer(this.canvas),this.buffer.copy(t),this.buffer}resetDialogBuffer(t){const s=this.layers[this.layers.length-1]||this.canvas.buffer;t.copy(s)}finishDialog(){this.inDialog&&(this.buffer!==this.canvas.buffer&&this.freeBuffers.push(this.buffer),this.buffer=this.layers.pop()||this.canvas.buffer,this.buffer.render(),this.inDialog=this.layers.length>0)}},t.Viewport=class{constructor(t){this.follow=null,this.snap=!1,this.filter=null,this.offsetX=0,this.offsetY=0,this.lockX=!1,this.lockY=!1,this.ui=t.ui,this.snap=t.snap||!1,this.bounds=new r.xy.Bounds(t.x,t.y,t.width,t.height),this.filter=t.filter||null,t.lock?(this.lockX=!0,this.lockY=!0):(t.lockX&&(this.lockX=!0),t.lockY&&(this.lockY=!0))}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}contains(t,s){return this.bounds.contains(t,s)}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,s,i){this.updateOffset(t,{x:s,y:i})}updateOffset(t,s){if(s&&r.xy.contains(t,s.x,s.y))if(this.snap){const i=this.offsetX,e=this.offsetX+this.bounds.width,r=this.offsetY,h=this.offsetY+this.bounds.height,o=Math.floor(this.bounds.width/5),n=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);i+o>=s.x?this.offsetX=Math.max(0,s.x+a-this.bounds.width):e-o<=s.x&&(this.offsetX=Math.min(s.x-a,t.width-this.bounds.width));const l=Math.floor(this.bounds.height/3);r+n>=s.y?this.offsetY=Math.max(0,s.y+l-this.bounds.height):h-n<=s.y&&(this.offsetY=Math.min(s.y-l,t.height-this.bounds.height))}else this.offsetX=s.x-this.halfWidth(),this.offsetY=s.y-this.halfHeight();this.lockX&&(this.offsetX=r.clamp(this.offsetX,0,t.width-this.bounds.width)),this.lockY&&(this.offsetY=r.clamp(this.offsetY,0,t.height-this.bounds.height))}draw(t,s){if(!t)return!1;this.updateOffset(t,this.follow);const i=new r.sprite.Mixer;for(let e=0;e<this.bounds.width;++e)for(let r=0;r<this.bounds.height;++r){const h=e+this.offsetX,o=r+this.offsetY;if(t.hasXY(h,o)){const h=t.cell(e,r);t.drawer.drawCell(i,h,s)}else i.blackOut();this.filter&&this.filter(i,h,o,t),this.ui.buffer.drawSprite(e+this.bounds.x,r+this.bounds.y,i)}return!0}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
