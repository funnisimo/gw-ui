!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("gw-utils"),require("gw-map")):"function"==typeof define&&define.amd?define(["exports","gw-utils","gw-map"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).GWI={},t.GWU,t.GWM)}(this,(function(t,s,e){"use strict";function i(t){if(t&&t.__esModule)return t;var s=Object.create(null);return t&&Object.keys(t).forEach((function(e){if("default"!==e){var i=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(s,e,i.get?i:{enumerable:!0,get:function(){return t[e]}})}})),s.default=t,Object.freeze(s)}var h=i(s),r=i(e);class n{constructor(t){this._left=0,this._top=0,this._colWidths=[],this._rowHeights=[],this._col=0,this._row=-1,this.target=t;const s=t.pos();this._left=s.x,this._top=s.y}cols(...t){return 0===t.length?this._colWidths:(2==t.length&&(t[0]=new Array(t[0]).fill(t[1])),Array.isArray(t[0])&&(this._colWidths=t[0]),this)}rows(...t){return 0===t.length?this._rowHeights:("number"==typeof t[0]&&(t[0]=new Array(t[0]).fill(t[1]||1)),Array.isArray(t[0])&&(this._rowHeights=t[0]),this)}col(t){return void 0===t&&(t=this._col),this._col=h.clamp(t,0,this._colWidths.length-1),this._setPos()}nextCol(){return this.col(this._col+1)}row(t){return void 0===t&&(t=this._row),this._row=h.clamp(t,0,this._rowHeights.length-1),this._setPos()}nextRow(){return this.row(this._row+1).col(0)}endRow(t){return t<=0||(this._rowHeights[this._row]=t),this}_setPos(){let t=this._left;for(let s=0;s<this._col;++s)t+=this._colWidths[s];let s=this._top;for(let t=0;t<this._row;++t)s+=this._rowHeights[t];return this.target.pos(t,s),this}}class o{constructor(t){this.priority=0,(t.startsWith(":")||t.startsWith("."))&&(t="*"+t),this.text=t,this.matchFn=this._parse(t)}_parse(t){const s=t.split(/ +/g).map((t=>t.trim())),e=[];for(let t=0;t<s.length;++t){let i=s[t];">"===i?(e.push(this._parentMatch()),++t,i=s[t]):t>0&&e.push(this._ancestorMatch()),e.push(this._matchElement(i))}return e.reduce(((t,s)=>s.bind(void 0,t)),h.TRUE)}_parentMatch(){return function(t,s){return!!s.parent&&t(s.parent)}}_ancestorMatch(){return function(t,s){let e=s.parent;for(;e;)if(t(e))return!0;return!1}}_matchElement(t){const s=[],e=new RegExp(/(?:(\w+|\*|\$)|#(\w+)|\.([^\.: ]+))|(?::(?:(?:not\(\.([^\)]+)\))|(?:not\(:([^\)]+)\))|([^\.: ]+)))/g,"g");let i=e.exec(t);for(;i;){if(i[1]){const t=this._matchTag(i[1]);t&&s.push(t)}else i[2]?s.push(this._matchId(i[2])):i[3]?s.push(this._matchClass(i[3])):i[4]?s.push(this._matchNot(this._matchClass(i[4]))):i[5]?s.push(this._matchNot(this._matchProp(i[5]))):s.push(this._matchProp(i[6]));i=e.exec(t)}return(t,e)=>!!s.every((t=>t(e)))&&t(e)}_matchTag(t){return"*"===t?null:"$"===t?(this.priority+=1e4,null):(this.priority+=10,s=>s.tag===t)}_matchClass(t){return this.priority+=100,s=>s.classes.includes(t)}_matchProp(t){return t.startsWith("first")?this._matchFirst():t.startsWith("last")?this._matchLast():"invalid"===t?this._matchNot(this._matchProp("valid")):"optional"===t?this._matchNot(this._matchProp("required")):"enabled"===t?this._matchNot(this._matchProp("disabled")):"unchecked"===t?this._matchNot(this._matchProp("checked")):(this.priority+=1,s=>!!s.prop(t))}_matchId(t){return this.priority+=1e3,s=>s.attr("id")===t}_matchFirst(){return this.priority+=1,t=>!!t.parent&&!!t.parent.children&&t.parent.children[0]===t}_matchLast(){return this.priority+=1,t=>!!t.parent&&(!!t.parent.children&&t.parent.children[t.parent.children.length-1]===t)}_matchNot(t){return s=>!t(s)}matches(t){return this.matchFn(t)}}class a{constructor(t="$",s){this._dirty=!1,this.selector=new o(t),s&&this.set(s),this._dirty=!1}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get fg(){return this._fg}get bg(){return this._bg}dim(t=25,s=!0,e=!1){return s&&(this._fg=h.color.from(this._fg).darken(t)),e&&(this._bg=h.color.from(this._bg).darken(t)),this}bright(t=25,s=!0,e=!1){return s&&(this._fg=h.color.from(this._fg).lighten(t)),e&&(this._bg=h.color.from(this._bg).lighten(t)),this}invert(){return[this._fg,this._bg]=[this._bg,this._fg],this}get align(){return this._align}get valign(){return this._valign}get(t){return this["_"+t]}set(t,s,e=!0){if("string"==typeof t){const e="_"+t;"string"==typeof s&&(s.match(/^[+-]?\d+$/)?s=Number.parseInt(s):"true"===s?s=!0:"false"===s&&(s=!1)),this[e]=s}else t instanceof a?(e=!(!s&&void 0!==s),Object.entries(t).forEach((([t,s])=>{"selector"!==t&&"_dirty"!==t&&(null!=s?this[t]=s:null===s&&this.unset(t))}))):(e=!(!s&&void 0!==s),Object.entries(t).forEach((([t,s])=>{null===s?this.unset(t):this.set(t,s,e)})));return this.dirty||(this.dirty=e),this}unset(t){return delete this[t.startsWith("_")?t:"_"+t],this.dirty=!0,this}clone(){const t=new this.constructor;return t.copy(this),t}copy(t){return Object.assign(this,t),this}}class d extends a{constructor(t,s=100){super(),this.sources=[],this._opacity=100,this._baseFg=null,this._baseBg=null,t&&(t.sort(((t,s)=>t.selector.priority-s.selector.priority)),this.sources=t),this.sources.forEach((t=>super.set(t))),this.opacity=s,this._dirty=!1}get opacity(){return this._opacity}set opacity(t){if(t=h.clamp(t,0,100),this._opacity=t,100===t)return this._fg=this._baseFg||this._fg,void(this._bg=this._baseBg||this._bg);void 0!==this._fg&&(this._baseFg=this._baseFg||h.color.from(this._fg),this._fg=this._baseFg.alpha(t)),void 0!==this._bg&&(this._baseBg=this._baseBg||h.color.from(this._bg),this._bg=this._baseBg.alpha(t))}get dirty(){return this._dirty||this.sources.some((t=>t.dirty))}set dirty(t){this._dirty=t}}class l{constructor(t){this.rules=[],this._dirty=!0,void 0===t&&(t=u),t&&(this.rules=t.rules.slice())}get dirty(){return this._dirty}set dirty(t){this._dirty=t,this._dirty||this.rules.forEach((t=>t.dirty=!1))}add(t,s){if(t.includes(","))return t.split(",").map((t=>t.trim())).forEach((t=>this.add(t,s))),this;if(t.includes(" "))throw new Error("Hierarchical selectors not supported.");let e=new a(t,s);const i=this.rules.findIndex((t=>t.selector.text===e.selector.text));if(i>-1){const t=this.rules[i];t.set(e),e=t}else this.rules.push(e);return this.dirty=!0,this}get(t){return this.rules.find((s=>s.selector.text===t))||null}remove(t){const s=this.rules.findIndex((s=>s.selector.text===t));s>-1&&(this.rules.splice(s,1),this.dirty=!0)}computeFor(t){const s=this.rules.filter((s=>s.selector.matches(t))),e=t.style();return e&&s.push(e),e.dirty=!1,new d(s,t.opacity)}}const u=new l(null);u.add("*",{fg:"white",bg:-1,align:"left",valign:"top"});class c{constructor(t,s={}){this.tag="text",this.bounds=new h.xy.Bounds(0,0,0,1),this._depth=0,this.events={},this.children=[],this._style=new a,this._parent=null,this.classes=[],this._props={},this._attrs={},this.layer=t,this.bounds.x=s.x||0,this.bounds.y=s.y||0,this.bounds.width=s.width||0,this.bounds.height=s.height||1,s.tag&&(this.tag=s.tag),s.id&&(this.attr("id",s.id),this.attr("action",s.id)),void 0!==s.depth&&(this._depth=s.depth),this._style.set(s),s.class&&(this.classes=s.class.split(/ +/g).map((t=>t.trim()))),s.tabStop&&this.prop("tabStop",!0),s.action,s.disabled&&this.prop("disabled",!0),s.hidden&&this.prop("hidden",!0),s.action&&this.attr("action",s.action),this.attr("action")&&this.on("click",((t,s,e)=>{const i=this._attrStr("action");return i&&this._bubbleEvent(i,s,e),!1})),this.layer.attach(this),this.updateStyle(),void 0!==s.opacity&&(this._used.opacity=s.opacity)}get depth(){return this._depth}set depth(t){this._depth=t,this.layer.sortWidgets()}get parent(){return this._parent}set parent(t){this.setParent(t)}setParent(t,s={}){this._parent&&this._parent._removeChild(this),this._parent=t,this._parent&&(this.depth=this._depth||this._parent.depth+1,this._parent._addChild(this,s))}pos(t,s){return void 0===t?this.bounds:("number"==typeof t?(this.bounds.x=t,this.bounds.y=s||0):(this.bounds.x=t.x,this.bounds.y=t.y),this.layer.needsDraw=!0,this)}center(t){return this.centerX(t).centerY(t)}centerX(t){t=t||this.layer.body.bounds;const s=this.bounds.width,e=Math.round((t.width-s)/2);return this.bounds.x=t.x+e,this}centerY(t){t=t||this.layer.body.bounds;const s=this.bounds.height,e=Math.round((t.height-s)/2);return this.bounds.y=t.y+e,this}text(t){return void 0===t?this._attrStr("text"):(this.attr("text",t),this)}attr(t,s){return void 0===s?this._attrs[t]:(this._attrs[t]=s,this)}_attrInt(t){const s=this._attrs[t]||0;return"number"==typeof s?s:"string"==typeof s?Number.parseInt(s):s?1:0}_attrStr(t){const s=this._attrs[t]||"";return"string"==typeof s?s:"number"==typeof s?""+s:s?"true":"false"}_attrBool(t){return!!this._attrs[t]}prop(t,s){if(void 0===s)return this._props[t];return this._props[t]!==s&&this._setProp(t,s),this}_setProp(t,s){this._props[t]=s,this.updateStyle()}_propInt(t){const s=this._props[t]||0;return"number"==typeof s?s:"string"==typeof s?Number.parseInt(s):s?1:0}_propStr(t){const s=this._props[t]||"";return"string"==typeof s?s:"number"==typeof s?""+s:s?"true":"false"}_propBool(t){return!!this._props[t]}toggleProp(t){const s=!!this._props[t];return this.prop(t,!s),this}incProp(t,s=1){let e=this.prop(t)||0;return"boolean"==typeof e?e=e?1:0:"string"==typeof e&&(e=Number.parseInt(e)||0),e+=s,this.prop(t,e),this}contains(...t){return this.bounds.contains(t[0],t[1])}style(t){return void 0===t?this._style:(this._style.set(t),this.updateStyle(),this)}addClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)||this.classes.push(t)})),this}removeClass(t){return t.split(/ +/g).forEach((t=>{h.arrayDelete(this.classes,t)})),this}hasClass(t){const s=t.split(/ +/g);return h.arrayIncludesAll(this.classes,s)}toggleClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)?h.arrayDelete(this.classes,t):this.classes.push(t)})),this}get focused(){return!!this.prop("focus")}focus(t=!1){return!!this.prop("focus")||(this.prop("focus",!0),this._fireEvent("focus",this,{reverse:t}))}blur(t=!1){return!!this.prop("focus")&&(this.prop("focus",!1),this._fireEvent("blur",this,{reverse:t}))}get hovered(){return!!this.prop("hover")}set hovered(t){this.prop("hover",t)}get hidden(){let t=this;for(;t;){if(t.prop("hidden"))return!0;t=t.parent}return!1}set hidden(t){this.prop("hidden",t),t||0!=this._used.opacity||(this._used.opacity=100)}get opacity(){let t=100,s=this;for(;s;)s._used&&(t=Math.min(t,s._used.opacity)),s=s.parent;return t}set opacity(t){t!==this._used.opacity&&(this._used.opacity=t,this.hidden=0==this._used.opacity,this.layer.needsDraw=!0)}updateStyle(){this._used=this.layer.styles.computeFor(this),this.layer.needsDraw=!0}draw(t){return!this.hidden&&this._draw(t)}fadeIn(t){return this.fadeTo(100,t)}fadeOut(t){return this.fadeTo(0,t)}fadeTo(t,s){const e=h.tween.make({pct:this._used.opacity}).to({pct:t}).duration(s).onUpdate((t=>{this.opacity=t.pct}));return this.layer.animate(e),this}fadeToggle(t){return this.fadeTo(this._used.opacity?0:100,t)}_draw(t){return this._drawFill(t),!0}_drawFill(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this._used.bg,this._used.bg)}childAt(...t){return this.children.find((s=>s.contains(t[0],t[1])))||null}_addChild(t,s){let e=-1;if(s&&void 0!==s.beforeIndex&&(e=s.beforeIndex),t._parent&&t._parent!==this)throw new Error("Trying to add child that already has a parent.");return this.children.includes(t)||(e<0||e>=this.children.length?this.children.push(t):this.children.splice(e,0,t)),t._parent=this,this}_removeChild(t){if(!t._parent||t._parent!==this)throw new Error("Removing child that does not have this widget as parent.");return t._parent=null,h.arrayDelete(this.children,t),this}resize(t,s){return this.bounds.width=t||this.bounds.width,this.bounds.height=s||this.bounds.height,this.layer.needsDraw=!0,this}mouseenter(t,s){this.contains(t)&&(this.hovered||(this.hovered=!0,this._fireEvent("mouseenter",this,t),this._parent&&this._parent.mouseenter(t,s)))}mousemove(t){return!this.contains(t)||t.defaultPrevented||this.hidden?this.mouseleave(t):this._fireEvent("mousemove",this,t),!1}mouseleave(t){this.contains(t)||this.hovered&&(this.hovered=!1,this._fireEvent("mouseleave",this,t))}click(t){return!this.hidden&&this._fireEvent("click",this,t)}keypress(t){return this._fireEvent("keypress",this,t)}dir(t){return this._fireEvent("dir",this,t)}tick(t){return this._fireEvent("tick",this,t)}on(t,s){let e=this.events[t];return e||(e=this.events[t]=[]),e.includes(s)||e.push(s),this}off(t,s){let e=this.events[t];return e?(s?h.arrayDelete(e,s):e.length=0,this):this}_fireEvent(t,s,e){return(this.events[t]||[]).reduce(((i,h)=>h(t,s||this,e)||i),!1)}_bubbleEvent(t,s,e){let i=this;for(;i;){if(i._fireEvent(t,s,e))return!0;i=i.parent}return!1}}class p extends c{constructor(t){super(t,{tag:"body",id:"BODY",depth:-1,width:t.width,height:t.height})}_drawFill(t){t.blend(this._used.bg)}}class g{constructor(t,s={}){this.needsDraw=!0,this.result=void 0,this._attachOrder=[],this._depthOrder=[],this._focusWidget=null,this._hasTabStop=!1,this.timers=[],this._tweens=[],this._done=null,this._opts={x:0,y:0},this.ui=t,this.buffer=t.canvas.buffer.clone(),this.styles=new l(s.styles||t.styles),this.body=new p(this),this.promise=new Promise((t=>{this._done=t}))}get width(){return this.ui.width}get height(){return this.ui.height}reset(){return this._opts={x:0,y:0},this}fg(t){return this._opts.fg=t,this}bg(t){return this._opts.bg=t,this}dim(t=25,s=!0,e=!1){return s&&(this._opts.fg=h.color.from(this._opts.fg||"white").darken(t)),e&&(this._opts.bg=h.color.from(this._opts.bg||"black").darken(t)),this}bright(t=25,s=!0,e=!1){return s&&(this._opts.fg=h.color.from(this._opts.fg||"white").lighten(t)),e&&(this._opts.bg=h.color.from(this._opts.bg||"black").lighten(t)),this}invert(){return[this._opts.fg,this._opts.bg]=[this._opts.bg,this._opts.fg],this}style(t){return Object.assign(this._opts,t),this}class(t){return this._opts.class=this._opts.class||"",this._opts.class+=" "+t,this}pos(t,s){return void 0===t?this._opts:(this._opts.x=h.clamp(t,0,this.width),this._opts.y=h.clamp(s,0,this.height),this)}moveTo(t,s){return this.pos(t,s)}move(t,s){return this._opts.x=h.clamp(this._opts.x+t,0,this.width),this._opts.y=h.clamp(this._opts.y+s,0,this.height),this}up(t=1){return this.move(0,-t)}down(t=1){return this.move(0,t)}left(t=1){return this.move(-t,0)}right(t=1){return this.move(t,0)}nextLine(t=1){return this.pos(0,this._opts.y+t)}prevLine(t=1){return this.pos(0,this._opts.y-t)}grid(){return new n(this)}clear(t){return this.body.children=[],this._depthOrder=[this.body],t?this.body.style().set("bg",t):this.body.style().unset("bg"),this}sortWidgets(){return this._depthOrder.sort(((t,s)=>s.depth-t.depth)),this}attach(t){if(!this._attachOrder.includes(t)){const s=this._depthOrder.findIndex((s=>s.depth<=t.depth));s<0?this._depthOrder.push(t):this._depthOrder.splice(s,0,t),this._attachOrder.push(t),this.needsDraw=!0}return!t.parent&&t!==this.body&&this.body&&(t.setParent(this.body),this.needsDraw=!0),this._hasTabStop=this._hasTabStop||t._propBool("tabStop"),this}detach(t){return t.setParent(null),h.arrayDelete(this._depthOrder,t),h.arrayDelete(this._attachOrder,t),this._focusWidget===t&&(this._hasTabStop=this.nextTabStop()),this.needsDraw=!0,this}widgetAt(...t){return this._depthOrder.find((s=>s.contains(t[0],t[1])&&!s.hidden))||this.body}get focusWidget(){return this._focusWidget}setFocusWidget(t,s=!1){t!==this._focusWidget&&(this._focusWidget&&this._focusWidget.blur(s)||t&&t.focus(s)||(this._focusWidget=t))}getWidget(t){return this._depthOrder.find((s=>s.attr("id")===t))||null}nextTabStop(){if(!this.focusWidget)return this.setFocusWidget(this._attachOrder.find((t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden))||null),!!this.focusWidget;const t=h.arrayNext(this._attachOrder,this.focusWidget,(t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden));return!!t&&(this.setFocusWidget(t),!0)}prevTabStop(){if(!this.focusWidget)return this.setFocusWidget(this._attachOrder.find((t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden))||null),!!this.focusWidget;const t=h.arrayPrev(this._attachOrder,this.focusWidget,(t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden));return!!t&&(this.setFocusWidget(t,!0),!0)}on(t,s){return this.body.on(t,s),this}off(t,s){return this.body.off(t,s),this}mousemove(t){const s=this.widgetAt(t);return s.mouseenter(t,s),this._depthOrder.forEach((s=>{s.mousemove(t)})),!1}click(t){let s=this.widgetAt(t),e=!1;for(;s;){if(e||!s.prop("tabStop")||s.prop("disabled")||(this.setFocusWidget(s),e=!0),s.click(t))return!1;s=s.parent}return!1}keypress(t){if(!t.key)return!1;let s=this.focusWidget||this.body;for(;s;){if(s.keypress(t))return!1;s=s.parent}return t.defaultPrevented||("Tab"===t.key?this.nextTabStop():"TAB"===t.key&&this.prevTabStop()),!1}dir(t){let s=this.focusWidget||this.body;for(;s;){if(s.dir(t))return!1;s=s.parent}return!1}tick(t){const s=t.dt;this._tweens.forEach((t=>t.tick(s))),this._tweens=this._tweens.filter((t=>t.isRunning())),this.timers.forEach((t=>{t.time<=0||(t.time-=s,t.time<=0&&("string"==typeof t.action?this.body._fireEvent(t.action,this.body):t.action()))}));for(let s of this._depthOrder)s.tick(t);return!1}draw(){if(this._hasTabStop&&!this._focusWidget&&this.nextTabStop(),this.styles.dirty&&(this.needsDraw=!0,this._depthOrder.forEach((t=>t.updateStyle())),this.styles.dirty=!1),this.needsDraw){this.needsDraw=!1,this.ui.copyUIBuffer(this.buffer);for(let t=this._depthOrder.length-1;t>=0;--t){this._depthOrder[t].draw(this.buffer)}console.log("draw"),this.buffer.render()}}setTimeout(t,s){const e=this.timers.findIndex((t=>t.time<=0));e<0?this.timers.push({action:t,time:s}):this.timers[e]={action:t,time:s}}clearTimeout(t){const s=this.timers.find((s=>s.action===t));s&&(s.time=-1)}animate(t){return t.isRunning()||t.start(),this._tweens.push(t),this}finish(t){this.result=t,this.ui.finishLayer(this)}_finish(){this._done&&(this.body._fireEvent("finish",this.body,this.result),this._done(this.result),this._done=null)}}g.prototype.alert=function(t,s,e){"number"==typeof t&&(t={duration:t}),e&&(s=h.text.apply(s,e)),t.class=t.class||"alert",t.border=t.border||"ascii",t.pad=t.pad||1;const i=this.ui.startNewLayer(),r=void 0!==t.opacity?t.opacity:50;i.body.style().set("bg",h.color.BLACK.alpha(r));const n=i.text(s,{id:"TEXT",class:t.textClass||t.class,width:t.width,height:t.height}).center();Object.assign(t,{width:n.bounds.width,height:n.bounds.height,x:n.bounds.x,y:n.bounds.y,id:"DIALOG"});const o=i.dialog(t);return n.setParent(o),i.on("click",(()=>(i.finish(!0),!0))),i.on("keypress",(()=>(i.finish(!0),!0))),i.setTimeout((()=>{i.finish(!1)}),t.duration||3e3),i},g.prototype.fadeTo=function(t=0,s=1e3){const e=this.ui.startNewLayer();let i=0;return e.on("tick",((r,n,o)=>{i+=o.dt;const a=h.clamp(Math.round(100*i/s),0,100);return this.ui.copyUIBuffer(e.buffer),e.buffer.mix(t,a),e.buffer.render(),a>=100&&e.finish(),!0})),e};const f={};function _(t,s){f[t]=s}class b extends c{constructor(t,s){super(t,s),this._text="",this._lines=[],this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!s.height,this._fixedWidth=!!s.width,this.bounds.width=s.width||0,this.bounds.height=s.height||1,this.text(s.text)}text(t){if(void 0===t)return this._text;this._text=t;let s=this._fixedWidth?this.bounds.width:100;return this._lines=h.text.splitIntoLines(this._text,s),this._fixedWidth||(this.bounds.width=this._lines.reduce(((t,s)=>Math.max(t,h.text.length(s))),0)),this._fixedHeight?this._lines.length>this.bounds.height&&(this._lines.length=this.bounds.height):this.bounds.height=Math.max(1,this._lines.length),this.layer.needsDraw=!0,this}resize(t,s){return super.resize(t,s),this._fixedWidth=t>0,this._fixedHeight=s>0,this.text(this._text),this}_draw(t){this._drawFill(t);let s=0;return"bottom"===this._used.valign?s=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(s=Math.floor((this.bounds.height-this._lines.length)/2)),this._lines.forEach(((e,i)=>{t.drawText(this.bounds.x,this.bounds.y+i+s,e,this._used.fg,-1,this.bounds.width,this._used.align)})),!0}}_("text",((t,s)=>new b(t,s))),g.prototype.text=function(t,s={}){const e=Object.assign({},this._opts,s,{text:t}),i=new b(this,e);return s.parent&&i.setParent(s.parent,s),this.pos(i.bounds.x,i.bounds.bottom),i};class y extends b{constructor(t,s){super(t,(()=>{if(s.text=s.text||"",s.action=s.action||s.id,s.tag=s.tag||"button",!s.text&&!s.width)throw new Error("Buttons must have text or width.");return s})())}keypress(t){if(!t.key)return!1;if(this._fireEvent("keypress",this,t))return!0;if("Enter"===t.key){const t=this._attrStr("action");return t&&t.length&&this._bubbleEvent(t,this),!0}return!1}click(t){if(!this.contains(t))return!1;if(this._fireEvent("click",this,t))return!0;const s=this._attrStr("action");return!(!s||!s.length)&&this._bubbleEvent(s,this)}}_("button",((t,s)=>new y(t,s))),g.prototype.button=function(t,s){const e=Object.assign({},this._opts,s,{text:t}),i=new y(this,e);return s.parent&&i.setParent(s.parent,s),this.pos(i.bounds.x,i.bounds.bottom),i},g.prototype.confirm=function(t,s,e){"string"==typeof t&&(e=s,s=t,t={}),e&&(s=h.text.apply(s,e)),t.class=t.class||"confirm",t.border=t.border||"ascii",t.pad=t.pad||1;const i=this.ui.startNewLayer(),r=void 0!==t.opacity?t.opacity:50;i.body.style().set("bg",h.color.BLACK.alpha(r)),void 0===t.cancel||!0===t.cancel?t.cancel="Cancel":t.cancel||(t.cancel=""),t.ok=t.ok||"Ok";let n=t.buttonWidth||0;n||(n=Math.max(t.ok.length,t.cancel.length));const o=Math.max(t.width||0,2*n+2),a=i.text(s,{class:t.textClass||t.class,width:o,height:t.height}).center();Object.assign(t,{width:a.bounds.width,height:a.bounds.height+2,x:a.bounds.x,y:a.bounds.y,tag:"confirm"});const d=i.dialog(t);return a.setParent(d),i.button(t.ok,{class:t.okClass||t.class,width:n,id:"OK",parent:d,x:d._innerLeft+d._innerWidth-n,y:d._innerTop+d._innerHeight-1}).on("click",(()=>(i.finish(!0),!0))),t.cancel.length&&i.button(t.cancel,{class:t.cancelClass||t.class,width:n,id:"CANCEL",parent:d,x:d._innerLeft,y:d._innerTop+d._innerHeight-1}).on("click",(()=>(i.finish(!1),!0))),i.on("keypress",((t,s,e)=>("Escape"===e.key?i.finish(!1):"Enter"===e.key&&i.finish(!0),!0))),i},g.prototype.inputbox=function(t,s,e){"string"==typeof t&&(e=s,s=t,t={}),e&&(s=h.text.apply(s,e)),t.class=t.class||"confirm",t.border=t.border||"ascii",t.pad=t.pad||1;const i=this.ui.startNewLayer(),r=void 0!==t.opacity?t.opacity:50;i.body.style().set("bg",h.color.BLACK.alpha(r));const n=i.text(s,{class:t.textClass||t.class,width:t.width,height:t.height}).center();Object.assign(t,{width:n.bounds.width,height:n.bounds.height+2,x:n.bounds.x,y:n.bounds.y,tag:"inputbox"});const o=i.dialog(t);n.setParent(o);let a=o._innerWidth,d=o._innerLeft;if(t.label){const s=i.text(t.label,{class:t.labelClass||t.class,tag:"label",parent:o,x:d,y:o._innerTop+o._innerHeight-1});d+=s.bounds.width+1,a-=s.bounds.width+1}return i.input({class:t.inputClass||t.class,width:a,id:"INPUT",parent:o,x:d,y:o._innerTop+o._innerHeight-1}).on("INPUT",((t,s,e)=>(s&&i.finish(s.text()),!0))),i.on("keypress",((t,s,e)=>"Escape"===e.key&&(i.finish(null),!0))),i};class m extends c{constructor(t,s){super(t,s),this.ascii=!1,(s.ascii||s.fg&&!1!==s.ascii)&&(this.ascii=!0)}contains(...t){return!1}_draw(t){const s=this.bounds.width,e=this.bounds.height,i=this.bounds.x,h=this.bounds.y,r=this.ascii;return w(t,i,h,s,e,this._used,r),!0}}function w(t,s,e,i,r,n,o){const a=n.fg,d=n.bg;if(o){for(let h=1;h<i;++h)t.draw(s+h,e,"-",a,d),t.draw(s+h,e+r-1,"-",a,d);for(let h=1;h<r;++h)t.draw(s,e+h,"|",a,d),t.draw(s+i-1,e+h,"|",a,d);t.draw(s,e,"+",a,d),t.draw(s+i-1,e,"+",a,d),t.draw(s,e+r-1,"+",a,d),t.draw(s+i-1,e+r-1,"+",a,d)}else h.xy.forBorder(s,e,i,r,((s,e)=>{t.draw(s,e," ",d,d)}))}function x(t){if(!t)return[0,0,0,0];if(!0===t)return[1,1,1,1];if("number"==typeof t)return[t,t,t,t];if(1==t.length){const s=t[0];return[s,s,s,s]}if(2==t.length){const[s,e]=t;return[s,e,s,e]}throw new Error("Invalid pad: "+t)}_("border",((t,s)=>new m(t,s))),g.prototype.border=function(t){const s=Object.assign({},this._opts,t),e=new m(this,s);return t.parent&&e.setParent(t.parent,t),e};class v extends c{constructor(t,s){super(t,(s.tag=s.tag||v.default.tag,s)),this.legend=null;let e=s.border||v.default.border;this.attr("border",e);const i=x(s.pad||v.default.pad);if(this.attr("padTop",i[0]),this.attr("padRight",i[1]),this.attr("padBottom",i[2]),this.attr("padLeft",i[3]),"none"!==e)for(let t=0;t<4;++t)i[t]+=1;this._adjustBounds(i),this.attr("legendTag",s.legendTag||v.default.legendTag),this.attr("legendClass",s.legendClass||s.class||v.default.legendClass),this.attr("legendAlign",s.legendAlign||v.default.legendAlign),this._addLegend(s)}_adjustBounds(t){return this.bounds.width+=t[1]+t[3],this.bounds.height+=t[0]+t[2],this.bounds.x-=t[3],this.bounds.y-=t[0],this}get _innerLeft(){const t=this._attrStr("border"),s=this._attrInt("padLeft");return this.bounds.x+s+("none"===t?0:1)}get _innerWidth(){const t=this._attrStr("border"),s=this._attrInt("padLeft")+this._attrInt("padRight");return this.bounds.width-s-("none"===t?0:2)}get _innerTop(){const t=this._attrStr("border"),s=this._attrInt("padTop");return this.bounds.y+s+("none"===t?0:1)}get _innerHeight(){const t=this._attrStr("border"),s=this._attrInt("padTop")+this._attrInt("padBottom");return this.bounds.height-s-("none"===t?0:2)}_addLegend(t){if(!t.legend)return"none"===this._attrStr("border")&&(this.bounds.height=0),this;const s="none"!==this._attrStr("border"),e=h.text.length(t.legend),i=this.bounds.width-(s?4:0),r=this._attrStr("legendAlign");let n=this.bounds.x+(s?2:0);return"center"===r?n+=Math.floor((i-e)/2):"right"===r&&(n+=i-e),this.legend=new b(this.layer,{text:t.legend,x:n,y:this.bounds.y,depth:this.depth+1,tag:this._attrStr("legendTag"),class:this._attrStr("legendClass")}),this.legend.setParent(this),this}_draw(t){this._drawFill(t);const s=this._attrStr("border");return"none"!==s&&(w(t,this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this._used,"ascii"===s),!0)}}v.default={tag:"dialog",border:"none",pad:!1,legendTag:"legend",legendClass:"",legendAlign:"left"},g.prototype.dialog=function(t){const s=Object.assign({},this._opts,t),e=new v(this,s);return t.parent&&e.setParent(t.parent,t),e};class T extends v{constructor(t,s){super(t,(s.tag=s.tag||T.default.tag,s.border=s.border||T.default.border,s.legendTag=s.legendTag||T.default.legendTag,s.legendClass=s.legendClass||T.default.legendClass,s.legendAlign=s.legendAlign||T.default.legendAlign,s.width=s.width||0,s.height=s.height||0,s)),this.fields=[],this.attr("separator",s.separator||T.default.separator),this.attr("dataTag",s.dataTag||T.default.dataTag),this.attr("dataClass",s.dataClass||T.default.dataClass),this.attr("dataWidth",s.dataWidth),this.attr("labelTag",s.labelTag||T.default.labelTag),this.attr("labelClass",s.labelClass||T.default.labelClass),this.attr("labelWidth",this._innerWidth-s.dataWidth),this._addLegend(s)}_adjustBounds(t){return this.bounds.width=Math.max(this.bounds.width,t[1]+t[3]),this.bounds.height=Math.max(this.bounds.height,t[0]+t[2]),this}get _labelLeft(){const t=this._attrStr("border"),s=this._attrInt("padLeft");return this.bounds.x+s+("none"===t?0:1)}get _dataLeft(){return this._labelLeft+this._attrInt("labelWidth")}get _nextY(){const t=this._attrStr("border"),s=this._attrInt("padBottom");return this.bounds.bottom-("none"===t?0:1)-s}add(t,s){const e=this._attrStr("separator"),i=h.text.padEnd(t,this._attrInt("labelWidth")-e.length," ")+e;this.layer.text(i,{x:this._labelLeft,y:this._nextY,width:this._attrInt("labelWidth"),tag:this._attrStr("labelTag"),class:this._attrStr("labelClass")}),"string"==typeof s&&(s={format:s}),s.x=this._dataLeft,s.y=this._nextY,s.width=this._attrInt("dataWidth"),s.tag=s.tag||this._attrStr("dataTag"),s.class=s.class||this._attrStr("dataClass");const r=new E(this.layer,s);return r.setParent(this),this.bounds.height+=1,this.fields.push(r),this}data(t){return this.fields.forEach((s=>s.data(t))),this.layer.needsDraw=!0,this}}T.default={tag:"fieldset",border:"none",separator:" : ",pad:!1,legendTag:"legend",legendClass:"legend",legendAlign:"left",labelTag:"label",labelClass:"",dataTag:"field",dataClass:""},g.prototype.fieldset=function(t){const s=Object.assign({},this._opts,t),e=new T(this,s);return t.parent&&e.setParent(t.parent,t),e};class E extends b{constructor(t,s){super(t,(()=>{const t=s;return t.tag=t.tag||"field",t.text="",t})()),"string"==typeof s.format?this._format=h.text.compile(s.format):this._format=s.format}data(t){const s=this._format(t)||"";return this.text(s)}}class C extends c{constructor(t,s){super(t,(s.tag=s.tag||"ol",s)),this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!s.height,this._fixedWidth=!!s.width,this.prop("pad",s.pad||C.default.pad)}_addChild(t,s={}){return t.bounds.x=this.bounds.x+2,this._fixedHeight||(t.bounds.y=this.bounds.bottom-2,this.bounds.height+=t.bounds.height),this._fixedWidth?t.bounds.width=Math.min(t.bounds.width,this.bounds.width-4):t.bounds.width>this.bounds.width-4&&(this.bounds.width=t.bounds.width+4),super._addChild(t,s)}_draw(t){return this._drawFill(t),this.children.forEach(((s,e)=>{this._drawBulletFor(s,t,e)})),!0}_getBullet(t){return""+(t+1)}_drawBulletFor(t,s,e){const i=this._getBullet(e),h=this._attrInt("pad")+i.length,r=t.bounds.x-h,n=t.bounds.y;s.drawText(r,n,i,t._used.fg,t._used.bg,h)}}C.default={pad:1};class k extends C{constructor(t,s){super(t,(s.tag=s.tag||"ul",s)),this.prop("bullet",s.bullet||k.default.bullet),this.prop("pad",s.pad||k.default.pad)}_getBullet(t){return this._attrStr("bullet")}}k.default={bullet:"•",pad:1},g.prototype.ol=function(t={}){const s=Object.assign({},this._opts,t),e=new C(this,s);return t.parent&&e.setParent(t.parent,t),e},g.prototype.ul=function(t={}){const s=Object.assign({},this._opts,t),e=new k(this,s);return t.parent&&e.setParent(t.parent,t),e},u.add("input",{bg:"light_gray",fg:"black",align:"left",valign:"top"}),u.add("input:invalid",{fg:"red"}),u.add("input:empty",{fg:"darkest_green"}),u.add("input:focus",{bg:"lighter_gray"});class S extends b{constructor(t,s){super(t,(s.text=s.text||"",s.tag=s.tag||"input",s.tabStop=void 0===s.tabStop||s.tabStop,s.action=s.action||s.id,s.width=s.width||s.maxLength||Math.max(s.minLength||0,10),s)),this.minLength=0,this.maxLength=0,this.numbersOnly=!1,this.min=0,this.max=0,this.attr("default",this._text),this.attr("placeholder",s.placeholder||S.default.placeholder),s.numbersOnly?(this.numbersOnly=!0,this.min=s.min||0,this.max=s.max||0):(this.minLength=s.minLength||0,this.maxLength=s.maxLength||0),s.required&&(this.attr("required",!0),this.prop("required",!0)),s.disabled&&(this.attr("disabled",!0),this.prop("disabled",!0)),this.prop("valid",this.isValid()),this.on("blur",(()=>this._fireEvent("change",this))),this.reset()}reset(){this.text(this._attrStr("default"))}_setProp(t,s){super._setProp(t,s),this._props.valid=this.isValid()}isValid(){const t=this._text||"";if(this.numbersOnly){const s=Number.parseInt(t);return!(void 0!==this.min&&s<this.min)&&(!(void 0!==this.max&&s>this.max)&&s>0)}const s=Math.max(this.minLength,this.prop("required")?1:0);return t.length>=s&&(!this.maxLength||t.length<=this.maxLength)}keypress(t){if(!t.key)return!1;const s=this.numbersOnly?["0","9"]:[" ","~"];if("Enter"===t.key&&this.isValid()){const t=this._attrStr("action");return t&&t.length?this._fireEvent(t,this):this.layer.nextTabStop(),!0}return"Delete"==t.key||"Backspace"==t.key?(this._text.length&&(this.text(h.text.spliceRaw(this._text,this._text.length-1,1)),this._fireEvent("input",this),this._draw(this.layer.buffer)),!0):!(t.key.length>1)&&(t.key>=s[0]&&t.key<=s[1]&&(!this.maxLength||this._text.length<this.maxLength)&&(this.text(this._text+t.key),this._fireEvent("input",this),this._draw(this.layer.buffer)),!0)}text(t){return void 0===t?this._text:(super.text(t),this.prop("empty",0===this._text.length),this.prop("valid",this.isValid()),this)}_draw(t,s=!1){this._drawFill(t);let e=0;"bottom"===this._used.valign?e=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(e=Math.floor((this.bounds.height-this._lines.length)/2));let i=this._text;return 0==i.length&&(i=this._attrStr("placeholder")),this._text.length>this.bounds.width&&(i=this._text.slice(this._text.length-this.bounds.width)),t.drawText(this.bounds.x,this.bounds.y+e,i,this._used.fg,-1,this.bounds.width,this._used.align),!0}}S.default={tag:"input",width:10,placeholder:""},_("input",((t,s)=>new S(t,s))),g.prototype.input=function(t){const s=Object.assign({},this._opts,t),e=new S(this,s);return t.parent&&e.setParent(t.parent,t),e};class I{constructor(t){this.format=h.IDENTITY,this.width=t.width||O.default.columnWidth,"function"==typeof t.format?this.format=t.format:t.format&&(this.format=h.text.compile(t.format)),this.header=t.header||"",this.headerTag=t.headerTag||O.default.headerTag,this.empty=t.empty||O.default.empty,this.dataTag=t.dataTag||O.default.dataTag}addHeader(t,s,e,i){const h=new b(t.layer,{x:s,y:e,class:t.classes.join(" "),tag:t._attrStr("headerTag"),width:this.width,height:t.rowHeight,depth:t.depth+1,text:this.header});return h.prop("row",-1),h.prop("col",i),h.setParent(t),t.layer.attach(h),h}addData(t,s,e,i,h,r){let n;n=Array.isArray(s)?""+(s[h]||this.empty):"object"!=typeof s?""+s:this.format(s);const o=new P(t.layer,{text:n,x:e,y:i,class:t.classes.join(" "),tag:t._attrStr("dataTag"),width:this.width,height:t.rowHeight,depth:t.depth+1});return o.prop(r%2==0?"even":"odd",!0),o.prop("row",r),o.prop("col",h),o.setParent(t),t.layer.attach(o),o}addEmpty(t,s,e,i,h){return this.addData(t,[],s,e,i,h)}}I.default={select:"row",hover:"select",tag:"datatable",headerTag:"th",dataTag:"td",border:"ascii"};class O extends c{constructor(t,s){super(t,(s.tag=s.tag||O.default.tag,s.tabStop=void 0===s.tabStop||s.tabStop,s)),this._data=[],this.columns=[],this.showHeader=!1,this.rowHeight=1,this.selectedRow=-1,this.selectedColumn=0,this.size=s.size||t.height,this.bounds.width=0,s.columns.forEach((t=>{const s=new I(t);this.columns.push(s),this.bounds.width+=s.width})),s.border?!0===s.border&&(s.border="ascii"):!1===s.border&&(s.border="none"),this.attr("border",s.border||O.default.border),this.rowHeight=s.rowHeight||1,this.bounds.height=1,this.attr("wrap",void 0===s.wrap?O.default.wrap:s.wrap),this.attr("header",void 0===s.header?O.default.header:s.header),this.attr("headerTag",s.headerTag||O.default.headerTag),this.attr("dataTag",s.dataTag||O.default.dataTag),this.attr("prefix",s.prefix||O.default.prefix),this.attr("select",s.select||O.default.select),this.attr("hover",s.hover||O.default.hover),this.data(s.data||[])}get selectedData(){if(!(this.selectedRow<0))return this._data[this.selectedRow]}select(t,s){if(!this._data||0==this._data.length)return this.selectedRow=this.selectedColumn=0,this;this.attr("wrap")&&((t<0||t>=this.columns.length)&&(t+=this.columns.length,t%=this.columns.length),(s<0||s>=this._data.length)&&(s+=this._data.length,s%=this._data.length)),t=this.selectedColumn=h.clamp(t,0,this.columns.length-1),s=this.selectedRow=h.clamp(s,0,this._data.length-1);const e=this._attrStr("select");return"none"===e?this.children.forEach((t=>{t.prop("selected",!1)})):"row"===e?this.children.forEach((t=>{const e=s==t.prop("row");t.prop("selected",e)})):"column"===e?this.children.forEach((s=>{const e=t==s.prop("col");s.prop("selected",e)})):"cell"===e&&this.children.forEach((e=>{const i=t==e.prop("col")&&s==e.prop("row");e.prop("selected",i)})),this._bubbleEvent("input",this,{row:s,col:t,data:this.selectedData}),this}selectNextRow(){return this.select(this.selectedColumn,this.selectedRow+1)}selectPrevRow(){return this.select(this.selectedColumn,this.selectedRow-1)}selectNextCol(){return this.select(this.selectedColumn+1,this.selectedRow)}selectPrevCol(){return this.select(this.selectedColumn-1,this.selectedRow)}blur(t){return this._bubbleEvent("change",this,{col:this.selectedColumn,row:this.selectedRow,data:this.selectedData}),super.blur(t)}data(t){if(!t)return this._data;this._data=t;for(let t=this.children.length-1;t>=0;--t){const s=this.children[t];s.tag!==this.attr("headerTag")&&this.layer.detach(s)}const s="none"!==this.attr("border")?1:0;let e=this.bounds.x+s,i=this.bounds.y+s;return this.attr("header")&&(this.columns.forEach(((t,h)=>{t.addHeader(this,e,i,h),e+=t.width+s})),i+=this.rowHeight+s),this._data.forEach(((t,h)=>{h>=this.size||(e=this.bounds.x+s,this.columns.forEach(((r,n)=>{r.addData(this,t,e,i,n,h),e+=r.width+s})),i+=this.rowHeight+s)})),0==this._data.length?(e=this.bounds.x+s,this.columns.forEach(((t,h)=>{t.addEmpty(this,e,i,h,0),e+=t.width+s})),i+=1,this.select(-1,-1)):this.select(0,0),this.bounds.height=i-this.bounds.y,this.bounds.width=e-this.bounds.x,this.updateStyle(),this}_draw(t){return this._drawFill(t),this.children.forEach((s=>{s.prop("row")>=this.size||"none"!==this.attr("border")&&w(t,s.bounds.x-1,s.bounds.y-1,s.bounds.width+2,s.bounds.height+2,this._used,"ascii"==this.attr("border"))})),!0}mouseenter(t,s){if(super.mouseenter(t,s),!this.hovered)return;const e=this.children.find((s=>s.contains(t)));if(e){const t=e._propInt("col"),s=e._propInt("row");if(t!==this.selectedColumn||s!==this.selectedRow){this.selectedColumn=t,this.selectedRow=s;let e=!1,i=this._attrStr("hover");"select"===i&&(i=this._attrStr("select"),e=!0),"none"===i?this.children.forEach((t=>{t.hovered=!1,e&&t.prop("selected",!1)})):"row"===i?this.children.forEach((t=>{const i=s==t.prop("row");t.hovered=i,e&&t.prop("selected",i)})):"column"===i?this.children.forEach((s=>{const i=t==s.prop("col");s.hovered=i,e&&s.prop("selected",i)})):"cell"===i&&this.children.forEach((i=>{const h=t==i.prop("col")&&s==i.prop("row");i.hovered=h,e&&i.prop("selected",h)})),this._bubbleEvent("input",this,{row:s,col:t,data:this.selectedData})}}}click(t){return!!this.contains(t)&&(this._bubbleEvent("change",this,{row:this.selectedRow,col:this.selectedColumn,data:this.selectedData}),!1)}keypress(t){return!!t.key&&("Enter"===t.key&&(this._bubbleEvent("change",this,{row:this.selectedRow,col:this.selectedColumn,data:this.selectedData}),!0))}dir(t){return!!t.dir&&(1==t.dir[1]?this.selectNextRow():-1==t.dir[1]&&this.selectPrevRow(),1==t.dir[0]?this.selectNextCol():-1==t.dir[0]&&this.selectPrevCol(),!0)}}O.default={columnWidth:10,header:!0,empty:"-",tag:"datatable",headerTag:"th",dataTag:"td",select:"cell",hover:"select",prefix:"none",border:"ascii",wrap:!0},_("datatable",((t,s)=>new O(t,s)));class P extends b{mouseleave(t){if(super.mouseleave(t),this.parent){const t=this.parent;"row"===t.attr("select")?this.hovered=this._propInt("row")===t.selectedRow:"column"===t.attr("select")&&(this.hovered=this._propInt("col")===t.selectedColumn)}}}g.prototype.datatable=function(t){const s=Object.assign({},this._opts,t),e=new O(this,s);return t.parent&&e.setParent(t.parent,t),e};class W extends O{constructor(t,s){super(t,(()=>{const t=s;return"none"!==s.border&&s.width&&(s.width-=2),t.columns=[Object.assign({},s)],s.header&&s.header.length||(t.header=!1),t})())}}_("list",((t,s)=>new W(t,s))),g.prototype.datalist=function(t){const s=Object.assign({},this._opts,t),e=new W(this,s);return t.parent&&e.setParent(t.parent,t),e};class M extends c{constructor(t,s){super(t,(s.tag=s.tag||M.default.tag,s.class=s.class||M.default.class,s)),Array.isArray(s.buttonClass)?this.attr("buttonClass",s.buttonClass.join(" ")):this.attr("buttonClass",s.buttonClass||M.default.buttonClass),this.attr("buttonTag",s.buttonTag||M.default.buttonTag),this.attr("marker",s.marker||M.default.marker),this._initButtons(s),this.bounds.height=this.children.length,this.on("mouseenter",((t,s,e)=>(this.children.forEach((t=>{t.contains(e)?t.expand():t.collapse()})),!0)))}_initButtons(t){this.children=[];const s=t.buttons,e=this._attrStr("marker"),i=Object.entries(s);this.bounds.width<=0&&(this.bounds.width=Math.max(t.minWidth||0,i.reduce(((t,[s,i])=>{const r=h.text.length(s)+("string"==typeof i?0:e.length);return Math.max(t,r)}),0))),i.forEach((([t,s],i)=>{const r={x:this.bounds.x,y:this.bounds.y+i,class:this._attrStr("buttonClass"),tag:this._attrStr("buttonTag"),width:this.bounds.width,height:1,depth:this.depth+1,buttons:s,text:t};"string"==typeof s?r.action=s:r.text=h.text.padEnd(t,this.bounds.width-e.length," ")+e;const n=new A(this.layer,r);n.setParent(this),n.on("mouseenter",(()=>(this._bubbleEvent("change",n),!1))),n.setParent(this)}))}collapse(){return this.children.forEach((t=>{t.collapse()})),this}}M.default={tag:"menu",class:"",buttonClass:"",buttonTag:"mi",marker:" ▶",minWidth:4};class A extends b{constructor(t,s){super(t,(s.tag=s.tag||"mi",s)),this.menu=null,this.tag=s.tag||"mi","string"!=typeof s.buttons&&(this.menu=this._initMenu(s),this.on("mouseenter",(()=>(this.menu.hidden=!1,this.menu._bubbleEvent("change",this),!0))),this.on("mouseleave",((t,s,e)=>{var i;return!!(null===(i=this.parent)||void 0===i?void 0:i.contains(e))&&(this.menu.hidden=!0,!0)})),this.on("click",(()=>!0)))}collapse(){return this.menu&&(this.menu.collapse(),this.menu.hidden=!0),this}expand(){return this.menu&&(this.menu.hidden=!1),this}_setMenuPos(t,s){t.x=this.bounds.x+this.bounds.width,t.y=this.bounds.y;const e=Object.keys(s.buttons).length;t.y+e>=this.layer.height&&(t.y=this.layer.height-e-1)}_initMenu(t){if("string"==typeof t.buttons)return null;const s={x:this.bounds.x+this.bounds.width,y:this.bounds.y,class:t.class,tag:t.tag||"mi",buttons:t.buttons,depth:this.depth+1};this._setMenuPos(s,t);const e=new M(this.layer,s);return e.hidden=!0,e.setParent(this),e}}_("menu",((t,s)=>new M(t,s))),g.prototype.menu=function(t){const s=Object.assign({},this._opts,t),e=new M(this,s);return t.parent&&e.setParent(t.parent,t),e};class R extends c{constructor(t,s){super(t,(s.tabStop=!0,s.tag=s.tag||"menu",s)),this._buttons=[],this._selectedIndex=-1,s.buttonClass?Array.isArray(s.buttonClass)?this.attr("buttonClass",s.buttonClass.join(" ")):this.attr("buttonClass",s.buttonClass):this.attr("buttonClass",R.default.buttonClass),this.attr("buttonTag",s.buttonTag||R.default.buttonTag),s.menuClass?Array.isArray(s.menuClass)?this.attr("menuClass",s.menuClass.join(" ")):this.attr("menuClass",s.menuClass):this.attr("menuClass",R.default.menuClass),this.attr("menuTag",s.menuTag||R.default.menuTag),this.attr("prefix",s.prefix||R.default.prefix),this.attr("separator",s.separator||R.default.separator),this._initButtons(s),this.on("click",this._buttonClick.bind(this))}get selectedIndex(){return this._selectedIndex}set selectedIndex(t){this._selectedIndex>=0&&this._buttons[this._selectedIndex].prop("focus",!1).collapse(),this._selectedIndex=t,t>=0&&t<this._buttons.length?this._buttons[t].prop("focus",!0).expand():this._selectedIndex=-1}get selectedButton(){return this._buttons[this._selectedIndex]}focus(t=!1){return this.selectedIndex=t?this._buttons.length-1:0,super.focus(t)}blur(t=!1){return this.selectedIndex=-1,super.blur(t)}collapse(){return this._buttons.reduce(((t,s)=>s.collapse()||t),!1)}keypress(t){return!!t.key&&(!!this.focused&&("Tab"===t.key?(this.selectedIndex+=1,this._selectedIndex>=0):"TAB"===t.key&&(this.selectedIndex-=1,this._selectedIndex>=0)))}mousemove(t){if(!this.contains(t)||!this.focused)return super.mousemove(t);const s=this._buttons.findIndex((s=>s.contains(t)));return!(s<0||s===this._selectedIndex)&&(this.selectedIndex=s,!0)}_initButtons(t){this._config=t.buttons;const s=Object.entries(this._config),e=this._attrStr("buttonTag"),i=this._attrStr("buttonClass");let h=this.bounds.x;const r=this.bounds.y;s.forEach((([t,s],n)=>{const o=0==n?this._attrStr("prefix"):this._attrStr("separator");this.layer.text(o,{x:h,y:r,parent:this}),h+=o.length;const a=new D(this.layer,{text:t,x:h,y:r,tag:e,class:i,depth:this.depth+1,buttons:s});a.setParent(this),this._buttons.push(a),h+=a.bounds.width}))}_buttonClick(t,s){if(!s)return!1;this.layer.setFocusWidget(this),console.log("clicked = "+s.text(),s._attrStr("action"));const e=s;return this.selectedIndex=this._buttons.indexOf(e),e.menu?e.expand():this.collapse(),!0}}R.default={buttonClass:"",buttonTag:"mi",menuClass:"",menuTag:"mi",prefix:" ",separator:" | "},_("menubar",((t,s)=>new R(t,s)));class D extends b{constructor(t,s){super(t,(s.tag=s.tag||"mi","string"==typeof s.buttons&&(s.action=s.buttons),s)),this.menu=null,this.tag=s.tag||"mi","string"!=typeof s.buttons&&(this.menu=this._initMenu(s),this.on("mouseenter",(()=>(this.menu.hidden=!1,this.menu._bubbleEvent("change",this),!0))),this.on("mouseleave",((t,s,e)=>{var i;return!!(null===(i=this.parent)||void 0===i?void 0:i.contains(e))&&(this.menu.hidden=!0,!0)})),this.on("click",(()=>!0)))}collapse(){return!(!this.menu||this.menu.hidden)&&(this.menu.collapse(),this.menu.hidden=!0,!0)}expand(){return this.menu&&(this.menu.hidden=!1),this}_setMenuPos(t,s){t.x=this.bounds.x;const e=s.height||Object.keys(s.buttons).length;this.bounds.y<e?t.y=this.bounds.y+1:t.y=this.bounds.top-e}_initMenu(t){if("string"==typeof t.buttons)return null;const s={x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"mi",height:t.height,buttons:t.buttons,depth:this.depth+1};this._setMenuPos(s,t);const e=new M(this.layer,s);return e.hidden=!0,e.setParent(this),e}}g.prototype.menubar=function(t){const s=Object.assign({},this._opts,t),e=new R(this,s);return t.parent&&e.setParent(t.parent,t),e};class B extends c{constructor(t,s){super(t,s),this.tag=s.tag||"select",this._initText(s),this._initMenu(s),this.bounds.height=1}_initText(t){this.dropdown=new b(this.layer,{text:t.text+" ▼",x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"select",width:this.bounds.width,height:1,depth:this.depth+1}).on("click",(()=>(this.menu.toggleProp("hidden"),!1))),this.dropdown.setParent(this,{beforeIndex:0})}_initMenu(t){this.menu=new M(this.layer,{x:this.bounds.x,y:this.bounds.y+1,class:t.buttonClass,tag:t.buttonTag||"select",width:t.width,minWidth:this.dropdown.bounds.width,height:t.height,buttons:t.buttons,depth:this.depth+1}).on("click",(()=>(this.menu.hidden=!0,!1))),this.menu.hidden=!0,this.menu.setParent(this)}}_("select",((t,s)=>new B(t,s))),g.prototype.select=function(t){const s=Object.assign({},this._opts,t),e=new B(this,s);return t.parent&&e.setParent(t.parent,t),e};class L extends c{constructor(t,s){super(t,(s.tag=s.tag||L.default.tag,s)),this._prompt=null,this._done=null,this.choiceWidth=s.choiceWidth,this.attr("border",s.border||L.default.border),this.attr("promptTag",s.promptTag||L.default.promptTag),this.attr("promptClass",s.promptClass||L.default.promptClass),this.attr("choiceTag",s.choiceTag||L.default.choiceTag),this.attr("choiceClass",s.choiceClass||L.default.choiceClass),this.attr("infoTag",s.infoTag||L.default.infoTag),this.attr("infoClass",s.infoClass||L.default.infoClass),this._addLegend(),this._addList(),this._addInfo(),s.prompt&&this.showPrompt(s.prompt)}showPrompt(t,s){return this._prompt=t,t.choose(0),this.prompt.text(t.prompt(s)),this.list.data(t.choices()),this.info.text(t.info(s)),this._bubbleEvent("input",this,this._prompt),new Promise((t=>this._done=t))}_addList(){return this.list=new W(this.layer,{height:this.bounds.height-2,x:this.bounds.x+1,width:this.choiceWidth,y:this.bounds.y+1,dataTag:this._attrStr("choiceTag"),dataClass:this._attrStr("choiceClass"),tabStop:!0,border:"none",hover:"select"}),this.list.setParent(this),this.list.on("input",(()=>{if(!this._prompt)return!1;const t=this._prompt,s=this.list.selectedRow;return t.choose(s),this.info.text(t.info()),this._bubbleEvent("input",this,t),!0})),this.list.on("change",(()=>{if(!this._prompt)return!1;const t=this._prompt;return t.choose(this.list.selectedRow),this._bubbleEvent("change",this,t),this._done(t.value()),!0})),this}_addInfo(){return this.info=new b(this.layer,{text:"",x:this.bounds.x+this.choiceWidth+2,y:this.bounds.y+1,width:this.bounds.width-this.choiceWidth-3,height:this.bounds.height-2,tag:this._attrStr("infoTag"),class:this._attrStr("infoClass")}),this.info.setParent(this),this}_addLegend(){return this.prompt=new b(this.layer,{text:"",width:this.bounds.width-4,x:this.bounds.x+2,y:this.bounds.y,tag:this._attrStr("promptTag"),class:this._attrStr("promptClass")}),this.prompt.setParent(this),this}_draw(t){let s=this.choiceWidth+2;const e=this.bounds.height;let i=this.bounds.x;const h=this.bounds.y,r="ascii"===this.attr("border");return w(t,i,h,s,e,this._used,r),s=this.bounds.width-this.choiceWidth-1,i=this.bounds.x+this.choiceWidth+1,w(t,i,h,s,e,this._used,r),!0}}L.default={tag:"choice",border:"ascii",promptTag:"prompt",promptClass:"",choiceTag:"ci",choiceClass:"",infoTag:"info",infoClass:""},g.prototype.choice=function(t){const s=Object.assign({},this._opts,t),e=new L(this,s);return t.parent&&e.setParent(t.parent,t),e};var j=Object.freeze({__proto__:null,Widget:c,Body:p,Text:b,Border:m,drawBorder:w,Button:y,toPadArray:x,Dialog:v,Fieldset:T,Field:E,OrderedList:C,UnorderedList:k,Input:S,Column:I,DataTable:O,TD:P,DataList:W,Menu:M,MenuButton:A,Menubar:R,MenubarButton:D,MenuViewer:class extends c{constructor(t,s){super(t.layer,{tabStop:!0,x:0,y:0,width:t.layer.width,height:t.layer.height,tag:t.attr("menuTag"),class:t.attr("menuClass")}),this.menubar=t,this.mainMenu=this._initMenu(s)}contains(){return!0}finish(){this.layer.finish()}_initMenu(t){return new M(this.layer,{buttonTag:this.menubar._attrStr("buttonTag"),buttonClass:this.menubar._attrStr("buttonClass"),minWidth:this.menubar.selectedButton.bounds.width,buttons:t})}keypress(t){return!!t.key&&("Escape"===t.key?(this.finish(),!0):("Tab"===t.key||"TAB"===t.key)&&(this.finish(),this.menubar.keypress(t),!0))}},Select:B,Prompt:class{constructor(t,s={}){this._id=null,this._defaultNext=null,this.selection=-1,"string"==typeof s&&(s={field:s}),this._prompt=t,this._field=s.field||"",this._choices=[],this._infos=[],this._values=[],this._next=[],this._defaultNext=s.next||null,this._id=s.id||s.field||""}reset(){this.selection=-1}field(t){return void 0===t?this._field:(this._field=t,this)}id(t){return void 0===t?this._id:(this._id=t,this)}prompt(t){return"string"==typeof this._prompt?this._prompt:this._prompt(t)}next(t){return void 0===t?this._next[this.selection]||this._defaultNext:(this._defaultNext=t,this)}choices(t,s){if(void 0===t)return this._choices;if(Array.isArray(t)?Array.isArray(s)||(s=new Array(t.length).fill("")):(s=Object.values(t),t=Object.keys(t)),s=s.map((t=>"string"==typeof t?{info:t}:t)),t.length!==s.length)throw new Error("Choices and Infos must have same length.");return t.forEach(((t,e)=>{this.choice(t,s[e])})),this}choice(t,s={}){return"string"==typeof s&&(s={info:s}),this._choices.push(t),this._infos.push(s.info||""),this._next.push(s.next||null),this._values.push(s.value||t),this}info(t){const s=this._infos[this.selection]||"";return"string"==typeof s?s:s(t)}choose(t){return this.selection=t,this}value(){return this._values[this.selection]}updateResult(t){return this.selection<0||(t[this._field]=this.value()),this}},Choice:L,Inquiry:class{constructor(t){this._prompts=[],this.events={},this._result={},this._stack=[],this._current=null,this.widget=t,this._keypress=this._keypress.bind(this),this._change=this._change.bind(this)}prompts(t,...s){return Array.isArray(t)?this._prompts=t.slice():(s.unshift(t),this._prompts=s),this}_finish(){this.widget.off("keypress",this._keypress),this.widget.off("change",this._change),this._fireEvent("finish",this.widget,this._result)}_cancel(){this.widget.off("keypress",this._keypress),this.widget.off("change",this._change),this._fireEvent("cancel",this.widget)}start(){this._current=this._prompts[0],this._result={},this.widget.on("keypress",this._keypress),this.widget.on("change",this._change),this.widget.showPrompt(this._current,this._result)}back(){this._current.reset(),this._current=this._stack.pop()||null,this._current?(this._current.reset(),this._result={},this._prompts.forEach((t=>t.updateResult(this._result))),this.widget.showPrompt(this._current,this._result)):this._cancel()}restart(){this._prompts.forEach((t=>t.reset())),this._result={},this._current=this._prompts[0],this.widget.showPrompt(this._current,this._result)}quit(){this._cancel()}_keypress(t,s,e){return!!e.key&&("Escape"===e.key?(this.back(),!0):"R"===e.key?(this.restart(),!0):"Q"===e.key&&(this.quit(),!0))}_change(t,s,e){e.updateResult(this._result);const i=e.next();return i&&(this._current=this._prompts.find((t=>t.id()===i))||null,this._current)?(this._stack.push(e),this.widget.showPrompt(this._current,this._result),this._fireEvent("step",this.widget,{prompt:this._current,data:this._result}),!0):(this._finish(),!0)}on(t,s){let e=this.events[t];return e||(e=this.events[t]=[]),e.includes(s)||e.push(s),this}off(t,s){let e=this.events[t];return e?(s?h.arrayDelete(e,s):e.length=0,this):this}_fireEvent(t,s,e){let i=(this.events[t]||[]).reduce(((i,h)=>h(t,s||this.widget,e)||i),!1);return i||(i=this.widget._bubbleEvent(t,s||this.widget,e)),i}}});class F extends c{constructor(t,s){super(t,{id:"ARCHIVE",tag:"messages",class:s.classes.concat("archive").join(" "),height:s.bounds.height,width:s.bounds.width,x:0,y:0,tabStop:!0,depth:100}),this.mode="forward",this.source=s,this.isOnTop=this.source.bounds.y<10,this.bounds.height=this.isOnTop?t.height-s.bounds.y:s.bounds.bottom,this.totalCount=Math.min(s.cache.length,this.isOnTop?t.height-this.source.bounds.top:this.source.bounds.bottom),this.shown=s.bounds.height,this.layer.on("FORWARD",this._forward.bind(this)),this.layer.on("REVERSE",this._reverse.bind(this)),this.layer.setTimeout("FORWARD",16),this.source.cache.confirmAll()}contains(){return!0}finish(){this.layer.finish()}keypress(t){if("ack"===this.mode)this.mode="reverse",this.layer.needsDraw=!0,this.layer.setTimeout("REVERSE",16);else{if("reverse"===this.mode)return this.finish(),!0;this.mode="ack",this.shown=this.totalCount,this.layer.clearTimeout("FORWARD"),this.layer.needsDraw=!0}return!0}click(t){return"ack"===this.mode?(this.mode="reverse",this.layer.needsDraw=!0,this.layer.setTimeout("REVERSE",16)):"reverse"===this.mode?this.finish():(this.mode="ack",this.shown=this.totalCount,this.layer.needsDraw=!0),!0}_forward(){return++this.shown,this.layer.needsDraw=!0,this.shown<this.totalCount?this.layer.setTimeout("FORWARD",16):(this.mode="ack",this.shown=this.totalCount),!0}_reverse(){return--this.shown,this.shown<=this.source.bounds.height?this.finish():(this.layer.needsDraw=!0,this.layer.setTimeout("REVERSE",16)),!0}_draw(t){let s=0;const e=this.isOnTop,i=t,r=h.color.from(this.source._used.fg),n=e?this.shown-1:this.bounds.bottom-this.shown,o=e?0:this.bounds.bottom-1,a=e?-1:1;if(i.fillRect(this.source.bounds.x,Math.min(n,o),this.bounds.width,this.shown," ",this._used.bg,this._used.bg),this.source.cache.forEach(((t,h,d)=>{const l=n+d*a;if(e){if(l<o)return}else if(l>o)return;s=Math.floor(50*d/this.shown);const u=r.mix(this._used.bg,s);i.drawText(this.source.bounds.x,l,t,u,this._used.bg)})),"ack"===this.mode){const t=this.isOnTop?0:i.height-1,s=this.source.bounds.x>8?this.source.bounds.x-8:Math.min(this.source.bounds.x+this.bounds.width,i.width-8);i.wrapText(s,t,8,"--DONE--",this._used.bg,this._used.fg)}return!0}}h.color.install("flavorText",50,40,90),h.color.install("flavorPrompt",100,90,20);h.color.install("blueBar",15,10,50),h.color.install("redBar",45,10,15),h.color.install("purpleBar",50,0,50),h.color.install("greenBar",10,50,10);class Y{constructor(){this.dist=0,this.priority=0,this.changed=!1,this.sidebarY=-1}draw(t,s){return 0}}class N extends Y{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}draw(t,s){return this.actor.drawStatus(t,s)}}class H extends Y{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}draw(t,s){return this.item.drawStatus(t,s)}}class X extends Y{constructor(t){super(),this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,s){return this.cell.drawStatus(t,s)}}var V=Object.freeze({__proto__:null,Messages:class extends c{constructor(t,s){if(super(t,(s.tag=s.tag||"messages",s)),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new h.message.MessageCache({width:this.bounds.width,length:s.length||40,match:(t,s)=>(this.layer.needsDraw=!0,!0)})}click(t){return!!this.contains(t)&&(this.showArchive(),!0)}draw(t){const s=this.bounds.y<10;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this._used.bg,this._used.bg),this.cache.forEach(((e,i,h)=>{if(h>=this.bounds.height)return;const r=(s?this.bounds.height-h-1:h)+this.bounds.y;t.drawText(this.bounds.x,r,e,this._used.fg),i&&this._used.bg&&t.mix(this._used.bg,50,this.bounds.x,r,this.bounds.width,1)})),!0}showArchive(){if(this.cache.length<=this.bounds.height)return;const t=this.layer.ui.startNewLayer();new F(t,this)}},MessageArchive:F,Flavor:class extends b{constructor(t,s){super(t,(s.tag=s.tag||"flavor",s.text="",s)),this.overflow=s.overflow||!1,this.isPrompt=!1}showText(t){return this.text(t),this.removeClass("prompt"),this}clear(){return this.text(""),this.removeClass("prompt"),this}showPrompt(t){return this.showText(t),this.addClass("prompt"),this}getFlavorText(t,s,e,i){const n=t.cell(s,e);let o,a="";const d=!i||i.isAnyKindOfVisible(s,e),l=!i||i.isDirectlyVisible(s,e),u=!!i&&i.isRevealed(s,e),c=!!i&&i.isMagicMapped(s,e);let p;if(l)p="You see";else if(d)p="You sense";else if(u)p="You remember";else{if(!c)return"";p="You expect to see"}const g=n.hasActor()?t.actorAt(s,e):null,f=n.hasItem()?t.itemAt(s,e):null,_=n.hasTileFlag(r.flags.Tile.T_STAND_IN_TILE);let b=!1;g?(a=g.getFlavor({color:!1,article:!0,action:!0}),b=!0):f&&(a=f.getFlavor({color:!1,article:!0}),b=!0);let y=_?" in ":" on ";const m=n.depthTile(r.flags.Depth.GROUND)||r.tile.tiles.NULL,w=n.depthTile(r.flags.Depth.SURFACE),x=n.depthTile(r.flags.Depth.LIQUID);let v="";if(w){b&&(b=!1,a+=" on "),w.hasTileFlag(r.flags.Tile.T_BRIDGE)&&(y=" over "),v=w.getFlavor()+y}let T="";x&&(T=x.getFlavor()+" covering ",b&&(b=!1,a+=" in ")),b&&(b=!1,a+=" on ");let E=m.getFlavor({article:!0});return o=h.text.apply("§intro§ §text§.",{intro:p,text:a+v+T+E}),o}},EntryBase:Y,ActorEntry:N,ItemEntry:H,CellEntry:X,Sidebar:class extends c{constructor(t,s){super(t,s),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null}reset(){this.lastMap=null,this.lastX=-1,this.lastY=-1}entryAt(t){return this.entries.find((s=>s.sidebarY<=t.y&&-1!==s.sidebarY))||null}mousemove(t){return super.mousemove(t),this.contains(t)?this.highlightRow(t.y):this.clearHighlight()}highlightRow(t){const s=this.highlight;return this.highlight=null,this.entries.forEach((s=>{s.sidebarY<=t&&-1!==s.sidebarY&&(this.highlight=s)})),this.highlight!==s}clearHighlight(){const t=!!this.highlight;return this.highlight=null,t}updateCellCache(t){this.lastMap&&t===this.lastMap&&!t.hasMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED)||(this.lastMap=null,this.cellCache.length=0,h.xy.forRect(t.width,t.height,((s,e)=>{const i=t.cell(s,e);i.hasEntityFlag(r.flags.Entity.L_LIST_IN_SIDEBAR)&&this.cellCache.push(i)})),t.clearMapFlag(r.flags.Map.MAP_SIDEBAR_TILES_CHANGED))}_makeActorEntry(t){return new N(t)}_makeItemEntry(t){return new H(t)}_makeCellEntry(t){return new X(t)}_getPriority(t,s,e,i){return i?i.isDirectlyVisible(s,e)?1:i.isAnyKindOfVisible(s,e)?2:i.isRevealed(s,e)?3:-1:t.cell(s,e).hasCellFlag(r.flags.Cell.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(t.priority>2||!!this.highlight)}_addActorEntry(t,s,e,i,r){const n=this._getPriority(s,t.x,t.y,r);if(n<0)return!1;const o=this._makeActorEntry(t);return o.dist=h.xy.distanceBetween(e,i,t.x,t.y),o.priority=t.isPlayer()?0:n,this.entries.push(o),!0}_addItemEntry(t,s,e,i,r){const n=this._getPriority(s,t.x,t.y,r);if(n<0)return!1;const o=this._makeItemEntry(t);return o.dist=h.xy.distanceBetween(e,i,t.x,t.y),o.priority=n,this.entries.push(o),!0}_addCellEntry(t,s,e,i,r){const n=this._getPriority(s,t.x,t.y,r);if(n<0)return!1;const o=this._makeCellEntry(t);return o.dist=h.xy.distanceBetween(e,i,t.x,t.y),o.priority=n,this.entries.push(o),!0}findEntries(t,s,e,i){if(t===this.lastMap&&s===this.lastX&&e===this.lastY)return;this.clearHighlight(),this.lastMap=t,this.lastX=s,this.lastY=e,this.entries.length=0;const r=h.grid.alloc(t.width,t.height);t.eachActor((h=>{const n=h.x,o=h.y;r[n][o]||this._addActorEntry(h,t,s,e,i)&&(r[n][o]=1)})),t.eachItem((h=>{const n=h.x,o=h.y;r[n][o]||this._addItemEntry(h,t,s,e,i)&&(r[n][o]=1)})),this.cellCache.forEach((h=>{r[h.x][h.y]||this._addCellEntry(h,t,s,e,i)&&(r[h.x][h.y]=1)})),this.entries.sort(((t,s)=>t.priority!=s.priority?t.priority-s.priority:t.dist-s.dist)),h.grid.free(r)}update(){if(!this.subject)throw new Error("Update requires a subject to follow.");return this.updateFor(this.subject)}updateFor(t){return this.updateAt(t.memory||t.map,t.x,t.y,t.fov)}updateAt(t,s,e,i){return this.updateCellCache(t),this.findEntries(t,s,e,i),!0}draw(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,0,0,this._used.bg),this.entries.forEach((t=>t.sidebarY=-1));const s=this.bounds.clone();let e;for(let i=0;i<this.entries.length&&s.height>0;++i){e=this.entries[i],e.sidebarY=s.y;let h=e.draw(t,s);this._isDim(e)&&this._used.bg&&t.mix(this._used.bg,50,s.x,s.y,s.width,h),h&&(++h,s.y+=h,s.height-=h)}return!0}},Viewport:class extends c{constructor(t,s){super(t,s),this.offsetX=0,this.offsetY=0,this._subject=null,this.attr("snap",s.snap||!1),this.attr("center",s.center||!1),this.filter=s.filter||null,this.attr("lockX",s.lock||s.lockX||!1),this.attr("lockY",s.lock||s.lockY||!1)}get subject(){return this._subject}set subject(t){this.attr("center",!!t),t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t}set lock(t){this.attr("lockX",t),this.attr("lockY",t)}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,s,e){this.attr("center",!0),this.subject={x:s,y:e,map:t}}showMap(t,s=0,e=0){this.subject={x:s,y:e,map:t},this.offsetX=s,this.offsetY=e,this.attr("center",!1),this.attr("snap",!1)}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,s=t.memory||t.map,e=s;if(t&&s.hasXY(t.x,t.y))if(this._attrBool("snap")){let s=this.offsetX,i=this.offsetX+this.bounds.width,h=this.offsetY,r=this.offsetY+this.bounds.height;(t.x<s||t.x>i)&&(s=this.offsetX=t.x-this.halfWidth(),i=s+this.bounds.width),(t.y<h||t.y>r)&&(h=this.offsetY=t.y-this.halfHeight(),r=h+this.bounds.height);const n=Math.floor(this.bounds.width/5),o=Math.floor(this.bounds.height/5),a=Math.floor(this.bounds.width/3);s+n>=t.x?this.offsetX=Math.max(0,t.x+a-this.bounds.width):i-n<=t.x&&(this.offsetX=Math.min(t.x-a,e.width-this.bounds.width));const d=Math.floor(this.bounds.height/3);h+o>=t.y?this.offsetY=Math.max(0,t.y+d-this.bounds.height):r-o<=t.y&&(this.offsetY=Math.min(t.y-d,e.height-this.bounds.height))}else this._attrBool("center")?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this._attrBool("lockX")&&s&&(this.offsetX=h.clamp(this.offsetX,0,s.width-this.bounds.width)),this._attrBool("lockY")&&s&&(this.offsetY=h.clamp(this.offsetY,0,s.height-this.bounds.height))}draw(t){if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this._used.bg),!this._subject)return!1;this.updateOffset();const s=this._subject.memory||this._subject.map,e=this._subject.fov,i=new h.sprite.Mixer;for(let h=0;h<this.bounds.width;++h)for(let r=0;r<this.bounds.height;++r){const n=h+this.offsetX,o=r+this.offsetY;if(s.hasXY(n,o)){const t=s.cell(n,o);s.drawer.drawCell(i,t,e)}else i.draw(" ",this._used.bg,this._used.bg);this.filter&&this.filter(i,n,o,s),t.drawSprite(h+this.bounds.x,r+this.bounds.y,i)}return!0}}});t.ComputedStyle=d,t.Grid=n,t.Layer=g,t.Selector=o,t.Sheet=l,t.Style=a,t.UI=class{constructor(t={}){if(this.layer=null,this.layers=[],this._done=!1,this._promise=null,!t.canvas)throw new Error("Need a canvas.");this.canvas=t.canvas,this.loop=t.loop||h.loop}get width(){return this.canvas.width}get height(){return this.canvas.height}get styles(){return u}get baseBuffer(){const t=this.layers[this.layers.length-2]||null;return t?t.buffer:this.canvas.buffer}get canvasBuffer(){return this.canvas.buffer}get buffer(){return this.layer?this.layer.buffer:this.canvas.buffer}startNewLayer(){const t=new g(this,{styles:this.layer?this.layer.styles:this.styles});return this.layers.push(t),this._promise||(this._promise=this.loop.run(this)),this.layer=t,t}copyUIBuffer(t){const s=this.baseBuffer;t.copy(s),t.changed=!1}finishLayer(t){t._finish(),h.arrayDelete(this.layers,t),this.layer===t&&(this.layer=this.layers[this.layers.length-1]||null,this.layer&&(this.layer.needsDraw=!0))}stop(){for(this._done=!0;this.layer;)this.finishLayer(this.layer)}mousemove(t){return this.layer&&this.layer.mousemove(t),this._done}click(t){return this.layer&&this.layer.click(t),this._done}keypress(t){return this.layer&&this.layer.keypress(t),this._done}dir(t){return this.layer&&this.layer.dir(t),this._done}tick(t){return this.layer&&this.layer.tick(t),this._done}draw(){this.layer&&this.layer.draw()}},t.compile=function(t){return new o(t)},t.defaultStyle=u,t.game=V,t.makeStyle=function(t,s="$"){const e={};return t.trim().split(";").map((t=>t.trim())).forEach((t=>{const[s,i]=t.split(":").map((t=>t.trim()));if(!s)return;const h=i.split(/ +/g);1==h.length?e[s]=i:e[s]=h})),new a(s,e)},t.widget=j,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-ui.min.js.map
